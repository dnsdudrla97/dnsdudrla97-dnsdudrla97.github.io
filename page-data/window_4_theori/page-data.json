{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/window_4_theori/",
    "result": {"data":{"cur":{"id":"60cba5e7-39d0-5855-a5bc-bcc248468cd4","html":"<h1 id=\"teb-thread-environment-block\" style=\"position:relative;\"><a href=\"#teb-thread-environment-block\" aria-label=\"teb thread environment block permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TEB (Thread Environment Block)</h1>\n<ul>\n<li>프로세스에서 실행되는 스레드에 대한 정보를 담고 있는 구조체</li>\n<li>스레드별로 TEB 구조체가 하나씩 할당된다.</li>\n<li>OS 종류별로 해당 모양이 조금씩 달라진다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_TEB</span> <span class=\"token punctuation\">{</span>\n  PVOID Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PPEB  ProcessEnvironmentBlock<span class=\"token punctuation\">;</span>\n  PVOID Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">399</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  BYTE  Reserved3<span class=\"token punctuation\">[</span><span class=\"token number\">1952</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID TlsSlots<span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  BYTE  Reserved4<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID Reserved5<span class=\"token punctuation\">[</span><span class=\"token number\">26</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID ReservedForOle<span class=\"token punctuation\">;</span>\n  PVOID Reserved6<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID TlsExpansionSlots<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> TEB<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PTEB<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">001</span><span class=\"token operator\">></span> dt _TEB\nntdll<span class=\"token operator\">!</span>_TEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> NtTib            <span class=\"token operator\">:</span> _NT_TIB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> EnvironmentPointer <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> ClientId         <span class=\"token operator\">:</span> _CLIENT_ID\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> ActiveRpcHandle  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> ThreadLocalStoragePointer <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessEnvironmentBlock <span class=\"token operator\">:</span> Ptr32 _PEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x034</span> LastErrorValue   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x038</span> CountOfOwnedCriticalSections <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x03c</span> CsrClientThread  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x040</span> Win32ThreadInfo  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x044</span> User32Reserved   <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">26</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0ac</span> UserReserved     <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c0</span> WOW32Reserved    <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c4</span> CurrentLocale    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c8</span> FpSoftwareStatusRegister <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0cc</span> ReservedForDebuggerInstrumentation <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x10c</span> SystemReserved1  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">26</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x174</span> PlaceholderCompatibilityMode <span class=\"token operator\">:</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x175</span> PlaceholderHydrationAlwaysExplicit <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x176</span> PlaceholderReserved <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x180</span> ProxiedProcessId <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x184</span> _ActivationStack <span class=\"token operator\">:</span> _ACTIVATION_CONTEXT_STACK\n   <span class=\"token operator\">+</span><span class=\"token number\">0x19c</span> WorkingOnBehalfTicket <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1a4</span> ExceptionCode    <span class=\"token operator\">:</span> Int4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1a8</span> ActivationContextStackPointer <span class=\"token operator\">:</span> Ptr32 _ACTIVATION_CONTEXT_STACK\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1ac</span> InstrumentationCallbackSp <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1b0</span> InstrumentationCallbackPreviousPc <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1b4</span> InstrumentationCallbackPreviousSp <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1b8</span> InstrumentationCallbackDisabled <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1b9</span> SpareBytes       <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">23</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1d0</span> TxFsContext      <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1d4</span> GdiTebBatch      <span class=\"token operator\">:</span> _GDI_TEB_BATCH\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6b4</span> RealClientId     <span class=\"token operator\">:</span> _CLIENT_ID\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6bc</span> GdiCachedProcessHandle <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6c0</span> GdiClientPID     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6c4</span> GdiClientTID     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6c8</span> GdiThreadLocalInfo <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6cc</span> Win32ClientInfo  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">62</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c4</span> glDispatchTable  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">233</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xb68</span> glReserved1      <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">29</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbdc</span> glReserved2      <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbe0</span> glSectionInfo    <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbe4</span> glSection        <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbe8</span> glTable          <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbec</span> glCurrentRC      <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbf0</span> glContext        <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbf4</span> LastStatusValue  <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbf8</span> StaticUnicodeString <span class=\"token operator\">:</span> _UNICODE_STRING\n   <span class=\"token operator\">+</span><span class=\"token number\">0xc00</span> StaticUnicodeBuffer <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">261</span><span class=\"token punctuation\">]</span> Wchar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xe0c</span> DeallocationStack <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xe10</span> TlsSlots         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf10</span> TlsLinks         <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf18</span> Vdm              <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf1c</span> ReservedForNtRpc <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf20</span> DbgSsReserved    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf28</span> HardErrorMode    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf2c</span> Instrumentation  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf50</span> ActivityId       <span class=\"token operator\">:</span> _GUID\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf60</span> SubProcessTag    <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf64</span> PerflibData      <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf68</span> EtwTraceData     <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf6c</span> WinSockData      <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf70</span> GdiBatchCount    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf74</span> CurrentIdealProcessor <span class=\"token operator\">:</span> _PROCESSOR_NUMBER\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf74</span> IdealProcessorValue <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf74</span> ReservedPad0     <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf75</span> ReservedPad1     <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf76</span> ReservedPad2     <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf77</span> IdealProcessor   <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf78</span> GuaranteedStackBytes <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf7c</span> ReservedForPerf  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf80</span> ReservedForOle   <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf84</span> WaitingOnLoaderLock <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf88</span> SavedPriorityState <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf8c</span> ReservedForCodeCoverage <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf90</span> ThreadPoolData   <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf94</span> TlsExpansionSlots <span class=\"token operator\">:</span> Ptr32 Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf98</span> MuiGeneration    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf9c</span> IsImpersonating  <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfa0</span> NlsCache         <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfa4</span> pShimData        <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfa8</span> HeapData         <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfac</span> CurrentTransactionHandle <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfb0</span> ActiveFrame      <span class=\"token operator\">:</span> Ptr32 _TEB_ACTIVE_FRAME\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfb4</span> FlsData          <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfb8</span> PreferredLanguages <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfbc</span> UserPrefLanguages <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfc0</span> MergedPrefLanguages <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfc4</span> MuiImpersonation <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfc8</span> CrossTebFlags    <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfc8</span> SpareCrossTebBits <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SameTebFlags     <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SafeThunkCall    <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> InDebugPrint     <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> HasFiberData     <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SkipThreadAttach <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> WerInShipAssertCode <span class=\"token operator\">:</span> Pos <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> RanProcessInit   <span class=\"token operator\">:</span> Pos <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> ClonedThread     <span class=\"token operator\">:</span> Pos <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SuppressDebugMsg <span class=\"token operator\">:</span> Pos <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> DisableUserStackWalk <span class=\"token operator\">:</span> Pos <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> RtlExceptionAttached <span class=\"token operator\">:</span> Pos <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> InitialThread    <span class=\"token operator\">:</span> Pos <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SessionAware     <span class=\"token operator\">:</span> Pos <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> LoadOwner        <span class=\"token operator\">:</span> Pos <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> LoaderWorker     <span class=\"token operator\">:</span> Pos <span class=\"token number\">13</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SkipLoaderInit   <span class=\"token operator\">:</span> Pos <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SpareSameTebBits <span class=\"token operator\">:</span> Pos <span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfcc</span> TxnScopeEnterCallback <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfd0</span> TxnScopeExitCallback <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfd4</span> TxnScopeContext  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfd8</span> LockCount        <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfdc</span> WowTebOffset     <span class=\"token operator\">:</span> Int4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfe0</span> ResourceRetValue <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfe4</span> ReservedForWdf   <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfe8</span> ReservedForCrt   <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xff0</span> EffectiveContainerId <span class=\"token operator\">:</span> _GUID</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">001</span><span class=\"token operator\">></span> dt _TEB\nntdll<span class=\"token operator\">!</span>_TEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> NtTib            <span class=\"token operator\">:</span> _NT_TIB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> EnvironmentPointer <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> ClientId         <span class=\"token operator\">:</span> _CLIENT_ID\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> ActiveRpcHandle  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> ThreadLocalStoragePointer <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessEnvironmentBlock <span class=\"token operator\">:</span> Ptr32 _PEB\n\t <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h3 id=\"processenvironmentblock-member\" style=\"position:relative;\"><a href=\"#processenvironmentblock-member\" aria-label=\"processenvironmentblock member permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ProcessEnvironmentBlock member</h3>\n<ul>\n<li>0x30 offset 에 위치한 ProcessEnvironmentBlock member</li>\n<li>PEB(Process Environment Block) 구조체의 포인터이다.</li>\n<li>PEB는 프로세스 별로 하나만 생성된다.</li>\n</ul>\n<h3 id=\"nttib-member\" style=\"position:relative;\"><a href=\"#nttib-member\" aria-label=\"nttib member permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NtTib member</h3>\n<ul>\n<li>TEB 구조체의 첫 번째 멤버는 <code class=\"language-text\">_NT_TIB</code> 구조체이다.</li>\n<li>_NT_TIB (_NT_Thread information Block)</li>\n<li>현재 실행 중인 스레드에 대한 정보를 저장하고 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_NT_TIB</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_EXCEPTION_REGISTRATION_RECORD</span> <span class=\"token operator\">*</span>ExceptionList<span class=\"token punctuation\">;</span>\n    PVOID StackBase<span class=\"token punctuation\">;</span>\n    PVOID StackLimit<span class=\"token punctuation\">;</span>\n    PVOID SubSystemTib<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>_MSC_EXTENSIONS<span class=\"token punctuation\">)</span></span></span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        PVOID FiberData<span class=\"token punctuation\">;</span>\n        DWORD Version<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span>\n    PVOID FiberData<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span>\n    PVOID ArbitraryUserPointer<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_NT_TIB</span> <span class=\"token operator\">*</span>Self<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> NT_TIB<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> NT_TIB <span class=\"token operator\">*</span>PNT_TIB<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>ExceptionList member는 _EXCEPTION_REGISTRATION_RECORD 구조체 연결 리스트를 가리키고 있다. 이것은 SEH(Structured Exception Handler) 라고 하는 Window OS의 예외 처리 메커니즘에 사용된다.</li>\n<li>Self 멤버는 _NT_TIB 구조체의 셀프 포인터이며 곧 TEB 구조체 포인터이기도 한다. (TEB 구조체 첫 번째 멤버가 _NT_TIB 구조체이기 때문이다.)</li>\n</ul>\n<h2 id=\"유저-모드-teb-접근-방법\" style=\"position:relative;\"><a href=\"#%EC%9C%A0%EC%A0%80-%EB%AA%A8%EB%93%9C-teb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\" aria-label=\"유저 모드 teb 접근 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>유저 모드 TEB 접근 방법</h2>\n<h3 id=\"ntdllntcurrentteb\" style=\"position:relative;\"><a href=\"#ntdllntcurrentteb\" aria-label=\"ntdllntcurrentteb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ntdll.NtCurrentTeb()</h3>\n<ul>\n<li>Ntdll.NtCurrentTeb() API는 현재 스레드의 TEB 구조체 주소를 리턴하는 함수이다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAABAElEQVQY0y3L4XJDMAAAYO//Ul23m2okKSEJcYoeIorS0uoWs+tud9/fz8C+54uEcEFFjBziHmDAaBCEruezMDomSZZmsqqklEVZ5sVLWUopK6WUgTGwgRVw6mDoYGCZW2zv7f2OEsQpCZknOGWMHqCNEHQhwMBk1BMBi6PQyGNO7I/qFKaC5DHFuy0yN87+vcrE86rmQfUq6+rie2y+bmc9NsvULvdOT62eWqPOY+6Cvj6lws+PDFlbaG4CYs9Xtepx1ePjdh4a+TP3+t4tj8v6HNa5f3kOBvh84wTWRXIMvTSiHrZctIuY01anoSmubdnItD/Ln8dFT91y7/7nn19hlAa2U/3ljAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/313b08180b86b127459eec3e7216e166/37523/0.png\"\n        srcset=\"/static/313b08180b86b127459eec3e7216e166/e9ff0/0.png 180w,\n/static/313b08180b86b127459eec3e7216e166/f21e7/0.png 360w,\n/static/313b08180b86b127459eec3e7216e166/37523/0.png 720w,\n/static/313b08180b86b127459eec3e7216e166/302a4/0.png 1080w,\n/static/313b08180b86b127459eec3e7216e166/b5cea/0.png 1140w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABHElEQVQY02XPW2+CMACGYf7/31l2sSsWzSYagR5oQWgplEpBxkHUTd0mC0vc4pY8F+93+RmXYzec+12tObTlykuZryWrtfR8GDFaZrIISZWLusiaUnVV/k03WvZKGCqJtOQiCsBijhwbI4AhoBhaEDjQ9SD07CVBgGAYBjQVcRLzEWcpC41qHW8UqxQvFWuL9NDk+3p9aPVw7C5v7egan6/NrdYYPvbD+2503g3nfjhtR8ft2D/zdJ23jMCnCNiUYOAsMQau7XjIJQR6rkUxJhitqEcQiHmUCP6H8Twxp+Z0tnhy3Lk5M+/uHyazRxfNA+KIkEQ+bEvZbVS3yf4zMLQiBaPMFQXkGqQviPKljS0R0zKPlQz7Wv9eu/UFCPh13YKrvi4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/0ddfab9384ee51c255ffd546801bd9a8/37523/1.png\"\n        srcset=\"/static/0ddfab9384ee51c255ffd546801bd9a8/e9ff0/1.png 180w,\n/static/0ddfab9384ee51c255ffd546801bd9a8/f21e7/1.png 360w,\n/static/0ddfab9384ee51c255ffd546801bd9a8/37523/1.png 720w,\n/static/0ddfab9384ee51c255ffd546801bd9a8/eafa0/1.png 939w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>NtCurrentTeb() 의 내부 코드는 아주 간단하게 구성되어 있다.</li>\n<li><code class=\"language-text\">FS:[18]</code> 주소의 값을 리턴 한다.</li>\n<li>FS:[18] 실제 주소 <code class=\"language-text\">00281018</code> 을 확인할 수 있는데 메모리 창에서 주소를 확인해보면 <code class=\"language-text\">00281000</code> 값이 들어 있다.</li>\n<li>NtCuurentTeb() API 는 이 값을 리턴하고 있다.</li>\n<li>따라서 이 값이 바로 현재 스레드의 TEB 주소 이다.</li>\n<li>TEB 주소(00281000) 주소는 FS 세그먼트 레지스터가 가리키는 세그먼트 메모리의 베이스 주소와 일치한다.</li>\n</ul>\n<h2 id=\"fs-segment-register\" style=\"position:relative;\"><a href=\"#fs-segment-register\" aria-label=\"fs segment register permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS Segment Register</h2>\n<ul>\n<li>FS 세그먼트 레지스터는 현재 스레드의 TEB를 지시하는데 사용한다.</li>\n<li><code class=\"language-text\">IA32</code> 시스템에서는 프로세스의 가상 메모리 크기가 4GB이므로 32비트 크기의 포인터를 이용해야 전체 메모리 공간에 접근이 가능하다.</li>\n<li>FS 레지스터의 크기는 16비트밖에 안된다.</li>\n<li>FS 레지스터는 직접 TEB 주소를 가리키는 것이 아니라, 실제 TEB 주소를 가지고 있는 <code class=\"language-text\">Segment Descriptor Table</code> 의 Index를 가지고 있는것이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">Segment Descriptor Table은 커널 메모리 영역에 존재하며\n특수 레지스터인 <span class=\"token function\">GDTR</span><span class=\"token punctuation\">(</span>Global Descriptor Table Register<span class=\"token punctuation\">)</span>에 그 주소가 저장되어 있다<span class=\"token punctuation\">.</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUUlEQVQoz3WS3UsUURjG95/JdeecmTMzO64frLtq67q6bquuaWkZq5uaBUEJhWQpCHWRghRSBFb4hZn2BUFEhUUX4YUE1VXdSF1UhFFCCbK/2GmjoLp4eF7OOfx43vO+HiHNrBAKIZTrUrfwaQbB8koSDSmqY3Fi8R1E6xLU1icJFJeh5d8Jaf6WbrlnHqGbSNOflZaDK2Xj0xSOU8LyxU5ez2d4OZNhbbGbq8O78Ek/QiqkNDEME6UslGEhpXLBHqnb2eDhRzSdeZONjazhJAcQhV4su5jnY+18m0rzaXIfW7Od3Dyxk20+E123CIajJFN7iMabSTS2Eaqs+wW0qG3qp75lkPrWIUpDjQhh4DjFvLp8gK17x/ly6yjcP8ad0x14pY0Sisj4OPFnT2l/vEzi6ROi83MoswhPjmqaCqV0V4ah0ISJbRexej7N12t9vJ/u4ftiH4tDuynQLPQcsL+HugunSJ4bJD5xkujIkZ/A3F/4CgWFXg2fV3PT5YCWVcSLiQ42F7pYn+kku5Th9nCr27Jh2FQGq4mU11AVjLq+vbwmn1C3MMMJiiIpnEgzRqACTTNc4OpEBxvXM3yY7WTzxn6W8kDdsAiGIoSrYoQra1wPVUQxlINHkzbV/Sukxz/SevYzgYYhhK8A21/Cyuhe1q908e5Smo2pDAsDLRRouaGY7or8Sx4hc0UJUi9F6mVI3XEvbDvA2+k0POiFu92w3MfD0bb8lM2/9zAvj9RzhfGHFLrhx7aLGUsnmT7YxGRvI3OHUgy01lEocrD/J/wByl+GNmQQIYoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./SGT.png\"\n        title=\"./SGT.png\"\n        src=\"/static/072d5e551d215b08984b841e81b2b639/37523/SGT.png\"\n        srcset=\"/static/072d5e551d215b08984b841e81b2b639/e9ff0/SGT.png 180w,\n/static/072d5e551d215b08984b841e81b2b639/f21e7/SGT.png 360w,\n/static/072d5e551d215b08984b841e81b2b639/37523/SGT.png 720w,\n/static/072d5e551d215b08984b841e81b2b639/302a4/SGT.png 1080w,\n/static/072d5e551d215b08984b841e81b2b639/07a9c/SGT.png 1440w,\n/static/072d5e551d215b08984b841e81b2b639/74e37/SGT.png 1732w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>세그먼트 레지스터는 실제로 Segment Descriptor Table의 Index를 가지고 있기 때문에 Segment Selector 라는 별칭을 가지고 있다.</li>\n<li>FS 세그먼트 셀렉터가 가리키는 세그먼트 메모리의 시작주소 (base address) 에 TEB 구조체가 위치하는 것을 확인할 수 있다.</li>\n</ul>\n<h3 id=\"fs0x18--teb-base-address\" style=\"position:relative;\"><a href=\"#fs0x18--teb-base-address\" aria-label=\"fs0x18  teb base address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS:[0x18] = TEB base address</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>NtTib<span class=\"token punctuation\">.</span>Self <span class=\"token operator\">=</span> address of TIB <span class=\"token operator\">=</span> address of TEB <span class=\"token operator\">=</span> FS<span class=\"token operator\">:</span><span class=\"token number\">0</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x2810100</span>\n\nFS<span class=\"token operator\">:</span><span class=\"token number\">0</span> 의 의미는 FS 레지스터가 Indexing 하는 Segment Descriptor가 가리키는 Segment Memory의\n시작 주소이다<span class=\"token punctuation\">.</span></code></pre></div>\n<h3 id=\"fs0x30--peb-base-address\" style=\"position:relative;\"><a href=\"#fs0x30--peb-base-address\" aria-label=\"fs0x30  peb base address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS:[0x30] = PEB base address</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>ProcessEnvironmentBlock <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<h3 id=\"fs0x0--seh-base-address\" style=\"position:relative;\"><a href=\"#fs0x0--seh-base-address\" aria-label=\"fs0x0  seh base address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS:[0x0] = SEH base address</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>NtTib<span class=\"token punctuation\">.</span>ExceptionList <span class=\"token operator\">=</span> address of SEH</code></pre></div>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<ul>\n<li><a href=\"#processenvironmentblock-member\">ProcessEnvironmentBlock member</a></li>\n<li><a href=\"#nttib-member\">NtTib member</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9C%A0%EC%A0%80-%EB%AA%A8%EB%93%9C-teb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\">유저 모드 TEB 접근 방법</a></p>\n<ul>\n<li><a href=\"#ntdllntcurrentteb\">Ntdll.NtCurrentTeb()</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#fs-segment-register\">FS Segment Register</a></p>\n<ul>\n<li><a href=\"#fs0x18--teb-base-address\">FS:[0x18] = TEB base address</a></li>\n<li><a href=\"#fs0x30--peb-base-address\">FS:[0x30] = PEB base address</a></li>\n<li><a href=\"#fs0x0--seh-base-address\">FS:[0x0] = SEH base address</a></li>\n</ul>\n</li>\n</ul>\n</div>","excerpt":"TEB (Thread Environment Block) 프로세스에서 실행되는 스레드에 대한 정보를 담고 있는 구조체 스레드별로 TEB 구조체가 하나씩 할당된다. OS 종류별로 해당 모양이 조금씩 달라진다. ProcessEnvironmentBlock member 0x30 offset 에 위치한 ProcessEnvironmentBlock member PEB(Process Environment Block) 구조체의 포인터이다. PEB는 프로세스 별로 하나만 생성된다. NtTib member TEB 구조체의 첫 번째 멤버는  구조체이다. _NT_TIB (_NT_Thread information Block) 현재 실행 중인 스레드에 대한 정보를 저장하고 있다. ExceptionList member는 _EXCEPTION_REGISTRATION_RECORD 구조체 연결 리스트를 가리키고 있다. 이것은 SEH(Structured Exception Handler) 라고 하는 Window OS의 예…","frontmatter":{"date":"January 03, 2021","title":"TEB (Thread Environment Block)","categories":"Windows","author":"Zer0Luck","emoji":"🍬"},"fields":{"slug":"/window_4_theori/"}},"next":{"id":"a2b2882f-79f1-5058-be0a-cc4ee51e785c","html":"<h2 id=\"seh\" style=\"position:relative;\"><a href=\"#seh\" aria-label=\"seh permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SEH</h2>\n<ul>\n<li><code class=\"language-text\">exception handlers</code> 는 각 Thread와 관련된 <code class=\"language-text\">Singly-linked list</code> 구성된다.</li>\n<li>원칙적으로 해당 목록의 노드는 stack에 할당된다.</li>\n<li>목록의 Head는 TEB(Thred Environment Block)의 시작 부분에 있는 포인터로 가리키므로 코드가 새 예외처리기를 추가하려는 경우 새 노드가 목록의 헤드와 포인터에 추가된다.</li>\n<li>TEB에서 새 노드를 가리키도록 변경된다.</li>\n<li>각 노드는 <code class=\"language-text\">_EXCEPTION_REGISTRATION_RECORD</code> 유형이며 핸들러의 주소와 목록의 다음 노드에 대한 포인터를 저장한다.</li>\n<li>이상하게도 목록의 마지막 노드의 “next pointer” 는 NULL이 아니지만 <code class=\"language-text\">0xFFFFFFFF</code> 와 같다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">000</span><span class=\"token operator\">></span> dt _EXCEPTION_REGISTRATION_RECORD\nntdll<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n<span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD\n<span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_DISPOSITION\n\n<span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">005</span><span class=\"token operator\">></span> dt _EXCEPTION_REGISTRATION_RECORD\ncombase<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> Ptr32     _EXCEPTION_DISPOSITION</code></pre></div>\n<ul>\n<li>TEB는 FS:[0] 부터 시작하는 <code class=\"language-text\">selector</code> FS를 통해서도 액세스 할 수 있으므로 다음과 같은 코드르 보는 것이 일반적이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">mov eax<span class=\"token punctuation\">,</span> dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> retrieve the head\npush eax <span class=\"token punctuation\">;</span> save the old head\nlea eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">10</span>h<span class=\"token punctuation\">]</span>\nmov dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> eax <span class=\"token punctuation\">;</span> set the <span class=\"token keyword\">new</span> head\nmov ecx<span class=\"token punctuation\">,</span> dword ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">10</span>h<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> get the old <span class=\"token function\">head</span> <span class=\"token punctuation\">(</span>NEXT field of the current head<span class=\"token punctuation\">)</span>\nmov dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ecx <span class=\"token punctuation\">;</span> restore the old head</code></pre></div>\n<ul>\n<li>\n<p>컴파일러는 일반적으로 프로그램의 어느 영역이 실행되고 있는지 (전역 변수에 의존) 알고 호출될 될 때 그에 따라 동작하는 단일 전역 처리기를 등록한다.</p>\n</li>\n<li>\n<p>각 스레드에는 다른 <code class=\"language-text\">TEB</code> 가 있으므로 운영 체제는 <code class=\"language-text\">FS</code> 에 의해 선택된 세그먼트가 항상 올바른 TEB(즉, 현재 스레드 중 하나)를 참조하는지 확인한다.</p>\n</li>\n<li>\n<p>TEB의 주소를 얻을려면 TEB의 Self 필드에 해당하는 <code class=\"language-text\">FS:[18h]</code>를 읽어야 한다.</p>\n</li>\n<li>\n<p>TEB를 확인해 보자</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>teb\nTEB at <span class=\"token number\">00</span>b95000\n    ExceptionList<span class=\"token operator\">:</span>        <span class=\"token number\">032</span>af770\n    StackBase<span class=\"token operator\">:</span>            <span class=\"token number\">032</span>b0000\n    StackLimit<span class=\"token operator\">:</span>           <span class=\"token number\">032</span>ac000\n    SubSystemTib<span class=\"token operator\">:</span>         <span class=\"token number\">00000000</span>\n    FiberData<span class=\"token operator\">:</span>            <span class=\"token number\">00001e00</span>\n    ArbitraryUserPointer<span class=\"token operator\">:</span> <span class=\"token number\">00000000</span>\n    Self<span class=\"token operator\">:</span>                 <span class=\"token number\">00</span>b95000\n    EnvironmentPointer<span class=\"token operator\">:</span>   <span class=\"token number\">00000000</span>\n    ClientId<span class=\"token operator\">:</span>             <span class=\"token number\">0000351</span>c <span class=\"token punctuation\">.</span> <span class=\"token number\">00004360</span>\n    RpcHandle<span class=\"token operator\">:</span>            <span class=\"token number\">00000000</span>\n    Tls Storage<span class=\"token operator\">:</span>          <span class=\"token number\">00000000</span>\n    PEB Address<span class=\"token operator\">:</span>          <span class=\"token number\">00</span>b50000\n    LastErrorValue<span class=\"token operator\">:</span>       <span class=\"token number\">0</span>\n    LastStatusValue<span class=\"token operator\">:</span>      <span class=\"token number\">0</span>\n    Count Owned Locks<span class=\"token operator\">:</span>    <span class=\"token number\">0</span>\n    HardErrorMode<span class=\"token operator\">:</span>        <span class=\"token number\">0</span></code></pre></div>\n<p>FS 세그먼트가 TEB를 참조하는 지 확인해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dg fs\n                                  P Si Gr Pr Lo\nSel    Base     Limit     Type    l ze an es ng Flags\n<span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">-</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span>\n<span class=\"token number\">0053</span> <span class=\"token number\">00</span>b95000 <span class=\"token number\">00000fff</span> Data RW Ac <span class=\"token number\">3</span> Bg By P  Nl <span class=\"token number\">000004f</span>3</code></pre></div>\n<ul>\n<li>FS:[18h] 에는 TEB의 주소가 포함되어 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">?</span><span class=\"token function\">poi</span><span class=\"token punctuation\">(</span>fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nEvaluate expression<span class=\"token operator\">:</span> <span class=\"token number\">12144640</span> <span class=\"token operator\">=</span> <span class=\"token number\">00</span>b95000</code></pre></div>\n<ul>\n<li>ExceptionList가 가리키는 Structure를 확인해보도록 하겠다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dt nt<span class=\"token operator\">!</span>_NT_TIB ExceptionList\nntdll<span class=\"token operator\">!</span>_NT_TIB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> ExceptionList <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD</code></pre></div>\n<ul>\n<li>각 노드는 _EXCPETION_REGISTRATION_RECORD의 Instance이다. 전체 목록을 확인하고 싶으면 <code class=\"language-text\">!slist</code> 를 사용하자</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>slist $teb _EXCEPTION_REGISTRATION_RECORD\nSLIST HEADER<span class=\"token operator\">:</span>\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Alignment          <span class=\"token operator\">:</span> <span class=\"token number\">32</span>b0000032af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next               <span class=\"token operator\">:</span> <span class=\"token number\">32</span>af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Depth              <span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Sequence           <span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n\nSLIST CONTENTS<span class=\"token operator\">:</span>\n<span class=\"token number\">032</span>af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7dc</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span>\n<span class=\"token number\">032</span>af7dc\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7f4</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span>\n<span class=\"token number\">032</span>af7f4\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0xffffffff</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x7776734b</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>FinalExceptionHandlerPad27<span class=\"token operator\">+</span><span class=\"token number\">0</span>\nffffffff\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span> \n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span> \nCan<span class=\"token number\">'</span>t read memory at ffffffff<span class=\"token punctuation\">,</span> error <span class=\"token number\">0</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">$teb</code> 는 TEB의 주소이다.</p>\n</li>\n<li>\n<p>SEH chain을 표시하는 더 간단한 방법은 다음을 사용하는 것이다.</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>exchain\n<span class=\"token number\">032</span>af770<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">77759990</span><span class=\"token punctuation\">)</span>\n  CRT scope  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> filter<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>DbgUiRemoteBreakin<span class=\"token operator\">+</span><span class=\"token number\">3</span>b <span class=\"token punctuation\">(</span><span class=\"token number\">7778</span>db7b<span class=\"token punctuation\">)</span>\n                func<span class=\"token operator\">:</span>   ntdll<span class=\"token operator\">!</span>DbgUiRemoteBreakin<span class=\"token operator\">+</span><span class=\"token number\">3f</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7778</span>db7f<span class=\"token punctuation\">)</span>\n<span class=\"token number\">032</span>af7dc<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">77759990</span><span class=\"token punctuation\">)</span>\n  CRT scope  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> filter<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>__RtlUserThreadStart<span class=\"token operator\">+</span><span class=\"token number\">3</span>d6c5 <span class=\"token punctuation\">(</span><span class=\"token number\">77784</span>c8a<span class=\"token punctuation\">)</span>\n                func<span class=\"token operator\">:</span>   ntdll<span class=\"token operator\">!</span>__RtlUserThreadStart<span class=\"token operator\">+</span><span class=\"token number\">3</span>d75e <span class=\"token punctuation\">(</span><span class=\"token number\">77784</span>d23<span class=\"token punctuation\">)</span>\n<span class=\"token number\">032</span>af7f4<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>FinalExceptionHandlerPad27<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7776734</span>b<span class=\"token punctuation\">)</span>\nInvalid exception stack at ffffffff</code></pre></div>\n<ul>\n<li>SEH chain을 수동으로 검사 할 수 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dt <span class=\"token number\">032</span>af770 _EXCEPTION_REGISTRATION_RECORD\nntdll<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7dc</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span></code></pre></div>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#seh\">SEH</a></li>\n</ul>\n</div>","frontmatter":{"date":"January 03, 2021","title":"Windows SEH (Structured Exception Handler) 1","categories":"Windows","author":"Zer0Luck","emoji":"🥖"},"fields":{"slug":"/window_2_theori/"}},"prev":{"id":"c815f14e-ef2b-5028-8e13-3ac996822daa","html":"<h1 id=\"thread-local-storage-tls\" style=\"position:relative;\"><a href=\"#thread-local-storage-tls\" aria-label=\"thread local storage tls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thread Local Storage (TLS)</h1>\n<ul>\n<li>프로세스의 모든 스레드는 가상 주소 공간을 공유한다.</li>\n<li>함수의 지역 변수는 함수를 실행하는 각 스레드에 공유한다.</li>\n<li>정적 및 전역 변수는 프로세스의 모든 스레드에서 공유된다.</li>\n<li>즉, 스레드 별로 독립된 데이터 저장 공간이며 스레드 내에서 프로세스의 전역(Global) 데이터나 정적(static) 데이터를 마치 지역(Local) 데이터 처럼 독립적으로 취급하고 싶을 때 사용한다.</li>\n</ul>\n<p><a href=\"http://msdn.microsoft.com/en-us/library/ms686749(VS.85),aspx\"></a></p>\n<h3 id=\"image_data_directory9\" style=\"position:relative;\"><a href=\"#image_data_directory9\" aria-label=\"image_data_directory9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IMAGE_DATA_DIRECTORY[9]</h3>\n<ul>\n<li>PE 헤더의 TLS Table 항목이 세팅된다.</li>\n<li>IMAGE_NT_HEADERS - IMAGE_OPTIONAL_HEADER - IMAGE_DATA_DIRECTORY[9]</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABH0lEQVQY03WO20rDQBRF8/9/IeIFQRR80zcFLU2TTFKENplOMjknE01rbWPmFmsjrYii7WI9bdjs7URhROmEsdT3fMTCGGOttW2rlEIoRCG01nYPTuD541FME9rv9bM001p/9WXTICDksFgsrbVmFw4JSMpSSunA9XjGv5etVqrAAnKYzV7att29HBGSxAmbsDCMGGN1Xcstb3UNOQBAWZZyD84wGtKE8jQLSQSAP7elREAhSiHKaTXdfdvzgjimSTJxXS/jeaO01EYaWzcSUQCKajaXymzCfzqjMBCcQUofB/2q4B/rtuveu261XpllVb4+4Vzkzfx5G/7VObwhJ3fj49v44Jqc3bMLUl2G042kuvLx3IWjB37ay3/yX34CADW01zVfHdMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/951b7d99cad673b600e2b007c4632544/37523/0.png\"\n        srcset=\"/static/951b7d99cad673b600e2b007c4632544/e9ff0/0.png 180w,\n/static/951b7d99cad673b600e2b007c4632544/f21e7/0.png 360w,\n/static/951b7d99cad673b600e2b007c4632544/37523/0.png 720w,\n/static/951b7d99cad673b600e2b007c4632544/02cd5/0.png 821w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>{: width=“65%” height=“65%“}</p>\n<ul>\n<li>RVA 01AAF3A0 주소에는 IMAGE_TLS_DIRECTORY 구조체가 있다.</li>\n</ul>\n<h3 id=\"image_tls_directory\" style=\"position:relative;\"><a href=\"#image_tls_directory\" aria-label=\"image_tls_directory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IMAGE_TLS_DIRECTORY</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IMAGE_TLS_DIRECTORY64</span> <span class=\"token punctuation\">{</span>\n    ULONGLONG StartAddressOfRawData<span class=\"token punctuation\">;</span>\n    ULONGLONG EndAddressOfRawData<span class=\"token punctuation\">;</span>\n    ULONGLONG AddressOfIndex<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// PDWORD</span>\n    ULONGLONG AddressOfCallBacks<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// PIMAGE_TLS_CALLBACK *;</span>\n    DWORD SizeOfZeroFill<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        DWORD Characteristics<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n            DWORD Reserved0 <span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n            DWORD Alignment <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n            DWORD Reserved1 <span class=\"token operator\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> DUMMYSTRUCTNAME<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> DUMMYUNIONNAME<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span> IMAGE_TLS_DIRECTORY64<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">typedef</span> IMAGE_TLS_DIRECTORY64 <span class=\"token operator\">*</span> PIMAGE_TLS_DIRECTORY64<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IMAGE_TLS_DIRECTORY32</span> <span class=\"token punctuation\">{</span>\n    DWORD   StartAddressOfRawData<span class=\"token punctuation\">;</span>\n    DWORD   EndAddressOfRawData<span class=\"token punctuation\">;</span>\n    DWORD   AddressOfIndex<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// PDWORD</span>\n    DWORD   AddressOfCallBacks<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// PIMAGE_TLS_CALLBACK *</span>\n    DWORD   SizeOfZeroFill<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        DWORD Characteristics<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n            DWORD Reserved0 <span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n            DWORD Alignment <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n            DWORD Reserved1 <span class=\"token operator\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> DUMMYSTRUCTNAME<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> DUMMYUNIONNAME<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span> IMAGE_TLS_DIRECTORY32<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> IMAGE_TLS_DIRECTORY32 <span class=\"token operator\">*</span> PIMAGE_TLS_DIRECTORY32<span class=\"token punctuation\">;</span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">_WIN64</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IMAGE_ORDINAL_FLAG</span>              <span class=\"token expression\">IMAGE_ORDINAL_FLAG64</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMAGE_ORDINAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span>          <span class=\"token function\">IMAGE_ORDINAL64</span><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token keyword\">typedef</span> IMAGE_THUNK_DATA64              IMAGE_THUNK_DATA<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> PIMAGE_THUNK_DATA64             PIMAGE_THUNK_DATA<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMAGE_SNAP_BY_ORDINAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span>  <span class=\"token function\">IMAGE_SNAP_BY_ORDINAL64</span><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token keyword\">typedef</span> IMAGE_TLS_DIRECTORY64           IMAGE_TLS_DIRECTORY<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> PIMAGE_TLS_DIRECTORY64          PIMAGE_TLS_DIRECTORY<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IMAGE_ORDINAL_FLAG</span>              <span class=\"token expression\">IMAGE_ORDINAL_FLAG32</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMAGE_ORDINAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span>          <span class=\"token function\">IMAGE_ORDINAL32</span><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token keyword\">typedef</span> IMAGE_THUNK_DATA32              IMAGE_THUNK_DATA<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> PIMAGE_THUNK_DATA32             PIMAGE_THUNK_DATA<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMAGE_SNAP_BY_ORDINAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span>  <span class=\"token function\">IMAGE_SNAP_BY_ORDINAL32</span><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token keyword\">typedef</span> IMAGE_TLS_DIRECTORY32           IMAGE_TLS_DIRECTORY<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> PIMAGE_TLS_DIRECTORY32          PIMAGE_TLS_DIRECTORY<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<ul>\n<li>IMAGE_TLS_DIRECTORY 구조체는 x86/x64 bit로 설계되어 있다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9ElEQVQY033PUUvDMBAH8Hz/ryEoE9tVBlqf9+xEtzpZW6attKRZlibXmqYuuaHDsQ3193BwHHd/jlxcng3888FV4F/fDEfhbXgXhmEQBJ7n+d+Gh4Kv4v0gK1Gm70nFFVuD+vjEYwCNWAtoQAjBKial1FobY5x1iEg4Wy3TV0S0duMOWGsRMc/zh8kkjpOnx2k0nUWziHPe933XdcYYwhiL41QpwN9QSvMsrypWFmVRFHUtEXEfQEDBYj4vsjeQom3bXeCOtZZSum+dcyenSS2VN45G99n4pTL90c/WWs45/o1orZ8Xy3mSNd3mZOacA4B/lrdg+oIEw1W7fAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/047eb756a6e49b68888846fb2d4bde8e/37523/1.png\"\n        srcset=\"/static/047eb756a6e49b68888846fb2d4bde8e/e9ff0/1.png 180w,\n/static/047eb756a6e49b68888846fb2d4bde8e/f21e7/1.png 360w,\n/static/047eb756a6e49b68888846fb2d4bde8e/37523/1.png 720w,\n/static/047eb756a6e49b68888846fb2d4bde8e/47aef/1.png 1063w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>RVA 01AAF3A0 해당 위치에 구조체 멤버를 확인해보겠다.</li>\n<li><code class=\"language-text\">AddressOfCallbacks</code> 멤버는 TLS 콜백 함수 주소 (VA 형태) 배열을 가리키며 배열의 끝은 NULL로 표시한다.</li>\n<li>프로그램에 TLS Call Back Function 를 여러 개등록할 수 있다.</li>\n<li>프로세스가 시작될 때 Entry Point 코드 실행 전에 시스템에서 AddressOfCallback 의 배열에 저장된 함수를 하나씩 호출한다.</li>\n</ul>\n<h3 id=\"tls-call-back-function\" style=\"position:relative;\"><a href=\"#tls-call-back-function\" aria-label=\"tls call back function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TLS Call Back Function</h3>\n<ul>\n<li>리버싱 분야에서 Anti-Debugging 기법으로 주로 많이 사용된다.</li>\n<li>TLS Call Back Function은 EP(Entry-Point) 보다 먼저 실행되는 특징을 가지고 있다.</li>\n<li>프로세스의 스레드가 생성/종료될 때 마다 자동으로 호출되는 콜백 함수</li>\n<li>프로세스의 메인 스레드가 생성될 때도 콜백 함수가 호출된다.</li>\n<li>Entry Point 코드보다 먼저 호출되어 Anti-Debugging에서 많이 쓰인다.</li>\n<li>스레드의 생성시점과 종료시점에 2번 자동으로 호출되는 함수이다.</li>\n<li>프로세스의 EP 코드를 실해하는 메인 스레드가 실행될 때 TLS 콜백 함수가 먼저 호출되는 원리이다.</li>\n</ul>\n<h3 id=\"image_tls_callback\" style=\"position:relative;\"><a href=\"#image_tls_callback\" aria-label=\"image_tls_callback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IMAGE_TLS_CALLBACK</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token function\">VOID</span>\n<span class=\"token punctuation\">(</span>NTAPI <span class=\"token operator\">*</span>PIMAGE_TLS_CALLBACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>\n    PVOID DllHandle<span class=\"token punctuation\">,</span>\n    DWORD Reason<span class=\"token punctuation\">,</span>\n    PVOID Reserved\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>TLS 콜백 함수 정의는 DllMain() 함수 정의와 비슷 한 것을 알 수있다.</li>\n</ul>\n<h3 id=\"dllmain\" style=\"position:relative;\"><a href=\"#dllmain\" aria-label=\"dllmain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DllMain()</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">BOOL WINAPI <span class=\"token function\">DllMain</span><span class=\"token punctuation\">(</span>\n    HINSTANCE hinstDLL<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// handle to DLL module</span>\n    <span class=\"token module\">DWORD</span> fdwReason<span class=\"token punctuation\">,</span>     <span class=\"token comment\">// reason for calling function</span>\n    LPVOID lpReserved <span class=\"token punctuation\">)</span>  <span class=\"token comment\">// reserved</span></code></pre></div>\n<ul>\n<li>\n<p>파라미터의 순서와 의미도 동일하다.</p>\n</li>\n<li>\n<p>DllHandle 파라미터는 모듈의 핸들, 로딩 주소 이다.</p>\n</li>\n<li>\n<p>Reason 파라미터는 TLS 콜백 함수가 호출된 이유</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">defind</span> <span class=\"token expression\">DLL_PROCESS_ATTACH  <span class=\"token number\">1</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DLL_THREAD_ATTACH</span>   <span class=\"token expression\"><span class=\"token number\">2</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DLL_THREAD_DETACH</span>   <span class=\"token expression\"><span class=\"token number\">3</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token expression\">DEFINE </span><span class=\"token macro-name\">DLL_PROCESS_DETACH</span>  <span class=\"token expression\"><span class=\"token number\">0</span></span></span></code></pre></div>\n</li>\n</ul>\n<h3 id=\"dll_process_attach\" style=\"position:relative;\"><a href=\"#dll_process_attach\" aria-label=\"dll_process_attach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLL_PROCESS_ATTACH</h3>\n<ul>\n<li>프로세스의 메인 스레드가 main 함수를 호출하기 전에 등록된 TLS 콜백 함수들이 호출된다.</li>\n<li>이때 Reason  값은 1(DLL_PROCESS_ATTACH)</li>\n</ul>\n<h3 id=\"dll_thread_attach\" style=\"position:relative;\"><a href=\"#dll_thread_attach\" aria-label=\"dll_thread_attach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLL_THREAD_ATTACH</h3>\n<ul>\n<li>TLS 콜백 함수들이 모두 종료되면 main 함수가 실행된다.</li>\n<li>사용자 스레드를 생성하는 순간 Reason = 2(DLL_THREAD_ATTACH)로 TLS 콜백 함수들이 동작한다.</li>\n</ul>\n<h3 id=\"dll_thread_detach\" style=\"position:relative;\"><a href=\"#dll_thread_detach\" aria-label=\"dll_thread_detach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLL_THREAD_DETACH</h3>\n<ul>\n<li>TLS 콜백 함수들이 모두 종료되면 사용자 스레드로 생성한 해당 함수가 실행된다.</li>\n<li>그리고 스레드 함수가 종료되는 순간 Reason = 3(DLL_THREAD_DETACH)로 TLS 콜백 함수들이 호출된다.</li>\n</ul>\n<h3 id=\"dll_process_detach\" style=\"position:relative;\"><a href=\"#dll_process_detach\" aria-label=\"dll_process_detach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLL_PROCESS_DETACH</h3>\n<ul>\n<li>사용자 쓰레드가 종료되면 스레드의 종료를 기다리던 main 함수(메인 스레드) 역시 종료한다.</li>\n<li>이때 마지막으로 Reason = 0 (DLL_PROCESS_DETACH) 값으로 TLS 콜백 함수들이 호출된다.</li>\n</ul>","frontmatter":{"date":"January 03, 2021","title":"TLS(Thread Local Storage CallBack)","categories":"Windows","author":"Zer0Luck","emoji":"🍯"},"fields":{"slug":"/window_5_theori/"}},"site":{"siteMetadata":{"siteUrl":"https://zer0luck.kr","comments":{"utterances":{"repo":"dnsdudrla97/dnsdudrla97.github.io"}}}}},"pageContext":{"slug":"/window_4_theori/","nextSlug":"/window_2_theori/","prevSlug":"/window_5_theori/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}