{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/window_2_theori/",
    "result": {"data":{"cur":{"id":"a2b2882f-79f1-5058-be0a-cc4ee51e785c","html":"<h2 id=\"seh\" style=\"position:relative;\"><a href=\"#seh\" aria-label=\"seh permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SEH</h2>\n<ul>\n<li><code class=\"language-text\">exception handlers</code> 는 각 Thread와 관련된 <code class=\"language-text\">Singly-linked list</code> 구성된다.</li>\n<li>원칙적으로 해당 목록의 노드는 stack에 할당된다.</li>\n<li>목록의 Head는 TEB(Thred Environment Block)의 시작 부분에 있는 포인터로 가리키므로 코드가 새 예외처리기를 추가하려는 경우 새 노드가 목록의 헤드와 포인터에 추가된다.</li>\n<li>TEB에서 새 노드를 가리키도록 변경된다.</li>\n<li>각 노드는 <code class=\"language-text\">_EXCEPTION_REGISTRATION_RECORD</code> 유형이며 핸들러의 주소와 목록의 다음 노드에 대한 포인터를 저장한다.</li>\n<li>이상하게도 목록의 마지막 노드의 “next pointer” 는 NULL이 아니지만 <code class=\"language-text\">0xFFFFFFFF</code> 와 같다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">000</span><span class=\"token operator\">></span> dt _EXCEPTION_REGISTRATION_RECORD\nntdll<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n<span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD\n<span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_DISPOSITION\n\n<span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">005</span><span class=\"token operator\">></span> dt _EXCEPTION_REGISTRATION_RECORD\ncombase<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> Ptr32     _EXCEPTION_DISPOSITION</code></pre></div>\n<ul>\n<li>TEB는 FS:[0] 부터 시작하는 <code class=\"language-text\">selector</code> FS를 통해서도 액세스 할 수 있으므로 다음과 같은 코드르 보는 것이 일반적이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">mov eax<span class=\"token punctuation\">,</span> dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> retrieve the head\npush eax <span class=\"token punctuation\">;</span> save the old head\nlea eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">10</span>h<span class=\"token punctuation\">]</span>\nmov dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> eax <span class=\"token punctuation\">;</span> set the <span class=\"token keyword\">new</span> head\nmov ecx<span class=\"token punctuation\">,</span> dword ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">10</span>h<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> get the old <span class=\"token function\">head</span> <span class=\"token punctuation\">(</span>NEXT field of the current head<span class=\"token punctuation\">)</span>\nmov dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ecx <span class=\"token punctuation\">;</span> restore the old head</code></pre></div>\n<ul>\n<li>\n<p>컴파일러는 일반적으로 프로그램의 어느 영역이 실행되고 있는지 (전역 변수에 의존) 알고 호출될 될 때 그에 따라 동작하는 단일 전역 처리기를 등록한다.</p>\n</li>\n<li>\n<p>각 스레드에는 다른 <code class=\"language-text\">TEB</code> 가 있으므로 운영 체제는 <code class=\"language-text\">FS</code> 에 의해 선택된 세그먼트가 항상 올바른 TEB(즉, 현재 스레드 중 하나)를 참조하는지 확인한다.</p>\n</li>\n<li>\n<p>TEB의 주소를 얻을려면 TEB의 Self 필드에 해당하는 <code class=\"language-text\">FS:[18h]</code>를 읽어야 한다.</p>\n</li>\n<li>\n<p>TEB를 확인해 보자</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>teb\nTEB at <span class=\"token number\">00</span>b95000\n    ExceptionList<span class=\"token operator\">:</span>        <span class=\"token number\">032</span>af770\n    StackBase<span class=\"token operator\">:</span>            <span class=\"token number\">032</span>b0000\n    StackLimit<span class=\"token operator\">:</span>           <span class=\"token number\">032</span>ac000\n    SubSystemTib<span class=\"token operator\">:</span>         <span class=\"token number\">00000000</span>\n    FiberData<span class=\"token operator\">:</span>            <span class=\"token number\">00001e00</span>\n    ArbitraryUserPointer<span class=\"token operator\">:</span> <span class=\"token number\">00000000</span>\n    Self<span class=\"token operator\">:</span>                 <span class=\"token number\">00</span>b95000\n    EnvironmentPointer<span class=\"token operator\">:</span>   <span class=\"token number\">00000000</span>\n    ClientId<span class=\"token operator\">:</span>             <span class=\"token number\">0000351</span>c <span class=\"token punctuation\">.</span> <span class=\"token number\">00004360</span>\n    RpcHandle<span class=\"token operator\">:</span>            <span class=\"token number\">00000000</span>\n    Tls Storage<span class=\"token operator\">:</span>          <span class=\"token number\">00000000</span>\n    PEB Address<span class=\"token operator\">:</span>          <span class=\"token number\">00</span>b50000\n    LastErrorValue<span class=\"token operator\">:</span>       <span class=\"token number\">0</span>\n    LastStatusValue<span class=\"token operator\">:</span>      <span class=\"token number\">0</span>\n    Count Owned Locks<span class=\"token operator\">:</span>    <span class=\"token number\">0</span>\n    HardErrorMode<span class=\"token operator\">:</span>        <span class=\"token number\">0</span></code></pre></div>\n<p>FS 세그먼트가 TEB를 참조하는 지 확인해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dg fs\n                                  P Si Gr Pr Lo\nSel    Base     Limit     Type    l ze an es ng Flags\n<span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">-</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span>\n<span class=\"token number\">0053</span> <span class=\"token number\">00</span>b95000 <span class=\"token number\">00000fff</span> Data RW Ac <span class=\"token number\">3</span> Bg By P  Nl <span class=\"token number\">000004f</span>3</code></pre></div>\n<ul>\n<li>FS:[18h] 에는 TEB의 주소가 포함되어 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">?</span><span class=\"token function\">poi</span><span class=\"token punctuation\">(</span>fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nEvaluate expression<span class=\"token operator\">:</span> <span class=\"token number\">12144640</span> <span class=\"token operator\">=</span> <span class=\"token number\">00</span>b95000</code></pre></div>\n<ul>\n<li>ExceptionList가 가리키는 Structure를 확인해보도록 하겠다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dt nt<span class=\"token operator\">!</span>_NT_TIB ExceptionList\nntdll<span class=\"token operator\">!</span>_NT_TIB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> ExceptionList <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD</code></pre></div>\n<ul>\n<li>각 노드는 _EXCPETION_REGISTRATION_RECORD의 Instance이다. 전체 목록을 확인하고 싶으면 <code class=\"language-text\">!slist</code> 를 사용하자</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>slist $teb _EXCEPTION_REGISTRATION_RECORD\nSLIST HEADER<span class=\"token operator\">:</span>\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Alignment          <span class=\"token operator\">:</span> <span class=\"token number\">32</span>b0000032af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next               <span class=\"token operator\">:</span> <span class=\"token number\">32</span>af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Depth              <span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Sequence           <span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n\nSLIST CONTENTS<span class=\"token operator\">:</span>\n<span class=\"token number\">032</span>af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7dc</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span>\n<span class=\"token number\">032</span>af7dc\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7f4</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span>\n<span class=\"token number\">032</span>af7f4\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0xffffffff</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x7776734b</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>FinalExceptionHandlerPad27<span class=\"token operator\">+</span><span class=\"token number\">0</span>\nffffffff\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span> \n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span> \nCan<span class=\"token number\">'</span>t read memory at ffffffff<span class=\"token punctuation\">,</span> error <span class=\"token number\">0</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">$teb</code> 는 TEB의 주소이다.</p>\n</li>\n<li>\n<p>SEH chain을 표시하는 더 간단한 방법은 다음을 사용하는 것이다.</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>exchain\n<span class=\"token number\">032</span>af770<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">77759990</span><span class=\"token punctuation\">)</span>\n  CRT scope  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> filter<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>DbgUiRemoteBreakin<span class=\"token operator\">+</span><span class=\"token number\">3</span>b <span class=\"token punctuation\">(</span><span class=\"token number\">7778</span>db7b<span class=\"token punctuation\">)</span>\n                func<span class=\"token operator\">:</span>   ntdll<span class=\"token operator\">!</span>DbgUiRemoteBreakin<span class=\"token operator\">+</span><span class=\"token number\">3f</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7778</span>db7f<span class=\"token punctuation\">)</span>\n<span class=\"token number\">032</span>af7dc<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">77759990</span><span class=\"token punctuation\">)</span>\n  CRT scope  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> filter<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>__RtlUserThreadStart<span class=\"token operator\">+</span><span class=\"token number\">3</span>d6c5 <span class=\"token punctuation\">(</span><span class=\"token number\">77784</span>c8a<span class=\"token punctuation\">)</span>\n                func<span class=\"token operator\">:</span>   ntdll<span class=\"token operator\">!</span>__RtlUserThreadStart<span class=\"token operator\">+</span><span class=\"token number\">3</span>d75e <span class=\"token punctuation\">(</span><span class=\"token number\">77784</span>d23<span class=\"token punctuation\">)</span>\n<span class=\"token number\">032</span>af7f4<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>FinalExceptionHandlerPad27<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7776734</span>b<span class=\"token punctuation\">)</span>\nInvalid exception stack at ffffffff</code></pre></div>\n<ul>\n<li>SEH chain을 수동으로 검사 할 수 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dt <span class=\"token number\">032</span>af770 _EXCEPTION_REGISTRATION_RECORD\nntdll<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7dc</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span></code></pre></div>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#seh\">SEH</a></li>\n</ul>\n</div>","excerpt":"SEH  는 각 Thread와 관련된  구성된다. 원칙적으로 해당 목록의 노드는 stack에 할당된다. 목록의 Head는 TEB(Thred Environment Block)의 시작 부분에 있는 포인터로 가리키므로 코드가 새 예외처리기를 추가하려는 경우 새 노드가 목록의 헤드와 포인터에 추가된다. TEB에서 새 노드를 가리키도록 변경된다. 각 노드는  유형이며 핸들러의 주소와 목록의 다음 노드에 대한 포인터를 저장한다. 이상하게도 목록의 마지막 노드의 “next pointer” 는 NULL이 아니지만  와 같다. TEB는 FS:[0] 부터 시작하는  FS를 통해서도 액세스 할 수 있으므로 다음과 같은 코드르 보는 것이 일반적이다. 컴파일러는 일반적으로 프로그램의 어느 영역이 실행되고 있는지 (전역 변수에 의존) 알고 호출될 될 때 그에 따라 동작하는 단일 전역 처리기를 등록한다. 각 스레드에는 다른  가 있으므로 운영 체제는  에 의해 선택된 세그먼트가 항상 올바른 TEB(즉, 현재…","frontmatter":{"date":"January 03, 2021","title":"Windows SEH (Structured Exception Handler) 1","categories":"Windows","author":"Zer0Luck","emoji":"🥖"},"fields":{"slug":"/window_2_theori/"}},"next":{"id":"c815f14e-ef2b-5028-8e13-3ac996822daa","html":"<h1 id=\"thread-local-storage-tls\" style=\"position:relative;\"><a href=\"#thread-local-storage-tls\" aria-label=\"thread local storage tls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thread Local Storage (TLS)</h1>\n<ul>\n<li>프로세스의 모든 스레드는 가상 주소 공간을 공유한다.</li>\n<li>함수의 지역 변수는 함수를 실행하는 각 스레드에 공유한다.</li>\n<li>정적 및 전역 변수는 프로세스의 모든 스레드에서 공유된다.</li>\n<li>즉, 스레드 별로 독립된 데이터 저장 공간이며 스레드 내에서 프로세스의 전역(Global) 데이터나 정적(static) 데이터를 마치 지역(Local) 데이터 처럼 독립적으로 취급하고 싶을 때 사용한다.</li>\n</ul>\n<p><a href=\"http://msdn.microsoft.com/en-us/library/ms686749(VS.85),aspx\"></a></p>\n<h3 id=\"image_data_directory9\" style=\"position:relative;\"><a href=\"#image_data_directory9\" aria-label=\"image_data_directory9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IMAGE_DATA_DIRECTORY[9]</h3>\n<ul>\n<li>PE 헤더의 TLS Table 항목이 세팅된다.</li>\n<li>IMAGE_NT_HEADERS - IMAGE_OPTIONAL_HEADER - IMAGE_DATA_DIRECTORY[9]</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABH0lEQVQY03WO20rDQBRF8/9/IeIFQRR80zcFLU2TTFKENplOMjknE01rbWPmFmsjrYii7WI9bdjs7URhROmEsdT3fMTCGGOttW2rlEIoRCG01nYPTuD541FME9rv9bM001p/9WXTICDksFgsrbVmFw4JSMpSSunA9XjGv5etVqrAAnKYzV7att29HBGSxAmbsDCMGGN1Xcstb3UNOQBAWZZyD84wGtKE8jQLSQSAP7elREAhSiHKaTXdfdvzgjimSTJxXS/jeaO01EYaWzcSUQCKajaXymzCfzqjMBCcQUofB/2q4B/rtuveu261XpllVb4+4Vzkzfx5G/7VObwhJ3fj49v44Jqc3bMLUl2G042kuvLx3IWjB37ay3/yX34CADW01zVfHdMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/951b7d99cad673b600e2b007c4632544/37523/0.png\"\n        srcset=\"/static/951b7d99cad673b600e2b007c4632544/e9ff0/0.png 180w,\n/static/951b7d99cad673b600e2b007c4632544/f21e7/0.png 360w,\n/static/951b7d99cad673b600e2b007c4632544/37523/0.png 720w,\n/static/951b7d99cad673b600e2b007c4632544/02cd5/0.png 821w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>{: width=“65%” height=“65%“}</p>\n<ul>\n<li>RVA 01AAF3A0 주소에는 IMAGE_TLS_DIRECTORY 구조체가 있다.</li>\n</ul>\n<h3 id=\"image_tls_directory\" style=\"position:relative;\"><a href=\"#image_tls_directory\" aria-label=\"image_tls_directory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IMAGE_TLS_DIRECTORY</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IMAGE_TLS_DIRECTORY64</span> <span class=\"token punctuation\">{</span>\n    ULONGLONG StartAddressOfRawData<span class=\"token punctuation\">;</span>\n    ULONGLONG EndAddressOfRawData<span class=\"token punctuation\">;</span>\n    ULONGLONG AddressOfIndex<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// PDWORD</span>\n    ULONGLONG AddressOfCallBacks<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// PIMAGE_TLS_CALLBACK *;</span>\n    DWORD SizeOfZeroFill<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        DWORD Characteristics<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n            DWORD Reserved0 <span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n            DWORD Alignment <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n            DWORD Reserved1 <span class=\"token operator\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> DUMMYSTRUCTNAME<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> DUMMYUNIONNAME<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span> IMAGE_TLS_DIRECTORY64<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">typedef</span> IMAGE_TLS_DIRECTORY64 <span class=\"token operator\">*</span> PIMAGE_TLS_DIRECTORY64<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IMAGE_TLS_DIRECTORY32</span> <span class=\"token punctuation\">{</span>\n    DWORD   StartAddressOfRawData<span class=\"token punctuation\">;</span>\n    DWORD   EndAddressOfRawData<span class=\"token punctuation\">;</span>\n    DWORD   AddressOfIndex<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// PDWORD</span>\n    DWORD   AddressOfCallBacks<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// PIMAGE_TLS_CALLBACK *</span>\n    DWORD   SizeOfZeroFill<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        DWORD Characteristics<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n            DWORD Reserved0 <span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n            DWORD Alignment <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n            DWORD Reserved1 <span class=\"token operator\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> DUMMYSTRUCTNAME<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> DUMMYUNIONNAME<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span> IMAGE_TLS_DIRECTORY32<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> IMAGE_TLS_DIRECTORY32 <span class=\"token operator\">*</span> PIMAGE_TLS_DIRECTORY32<span class=\"token punctuation\">;</span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">_WIN64</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IMAGE_ORDINAL_FLAG</span>              <span class=\"token expression\">IMAGE_ORDINAL_FLAG64</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMAGE_ORDINAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span>          <span class=\"token function\">IMAGE_ORDINAL64</span><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token keyword\">typedef</span> IMAGE_THUNK_DATA64              IMAGE_THUNK_DATA<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> PIMAGE_THUNK_DATA64             PIMAGE_THUNK_DATA<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMAGE_SNAP_BY_ORDINAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span>  <span class=\"token function\">IMAGE_SNAP_BY_ORDINAL64</span><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token keyword\">typedef</span> IMAGE_TLS_DIRECTORY64           IMAGE_TLS_DIRECTORY<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> PIMAGE_TLS_DIRECTORY64          PIMAGE_TLS_DIRECTORY<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IMAGE_ORDINAL_FLAG</span>              <span class=\"token expression\">IMAGE_ORDINAL_FLAG32</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMAGE_ORDINAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span>          <span class=\"token function\">IMAGE_ORDINAL32</span><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token keyword\">typedef</span> IMAGE_THUNK_DATA32              IMAGE_THUNK_DATA<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> PIMAGE_THUNK_DATA32             PIMAGE_THUNK_DATA<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMAGE_SNAP_BY_ORDINAL</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span>  <span class=\"token function\">IMAGE_SNAP_BY_ORDINAL32</span><span class=\"token punctuation\">(</span>Ordinal<span class=\"token punctuation\">)</span></span></span>\n<span class=\"token keyword\">typedef</span> IMAGE_TLS_DIRECTORY32           IMAGE_TLS_DIRECTORY<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> PIMAGE_TLS_DIRECTORY32          PIMAGE_TLS_DIRECTORY<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<ul>\n<li>IMAGE_TLS_DIRECTORY 구조체는 x86/x64 bit로 설계되어 있다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9ElEQVQY033PUUvDMBAH8Hz/ryEoE9tVBlqf9+xEtzpZW6attKRZlibXmqYuuaHDsQ3193BwHHd/jlxcng3888FV4F/fDEfhbXgXhmEQBJ7n+d+Gh4Kv4v0gK1Gm70nFFVuD+vjEYwCNWAtoQAjBKial1FobY5x1iEg4Wy3TV0S0duMOWGsRMc/zh8kkjpOnx2k0nUWziHPe933XdcYYwhiL41QpwN9QSvMsrypWFmVRFHUtEXEfQEDBYj4vsjeQom3bXeCOtZZSum+dcyenSS2VN45G99n4pTL90c/WWs45/o1orZ8Xy3mSNd3mZOacA4B/lrdg+oIEw1W7fAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/047eb756a6e49b68888846fb2d4bde8e/37523/1.png\"\n        srcset=\"/static/047eb756a6e49b68888846fb2d4bde8e/e9ff0/1.png 180w,\n/static/047eb756a6e49b68888846fb2d4bde8e/f21e7/1.png 360w,\n/static/047eb756a6e49b68888846fb2d4bde8e/37523/1.png 720w,\n/static/047eb756a6e49b68888846fb2d4bde8e/47aef/1.png 1063w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>RVA 01AAF3A0 해당 위치에 구조체 멤버를 확인해보겠다.</li>\n<li><code class=\"language-text\">AddressOfCallbacks</code> 멤버는 TLS 콜백 함수 주소 (VA 형태) 배열을 가리키며 배열의 끝은 NULL로 표시한다.</li>\n<li>프로그램에 TLS Call Back Function 를 여러 개등록할 수 있다.</li>\n<li>프로세스가 시작될 때 Entry Point 코드 실행 전에 시스템에서 AddressOfCallback 의 배열에 저장된 함수를 하나씩 호출한다.</li>\n</ul>\n<h3 id=\"tls-call-back-function\" style=\"position:relative;\"><a href=\"#tls-call-back-function\" aria-label=\"tls call back function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TLS Call Back Function</h3>\n<ul>\n<li>리버싱 분야에서 Anti-Debugging 기법으로 주로 많이 사용된다.</li>\n<li>TLS Call Back Function은 EP(Entry-Point) 보다 먼저 실행되는 특징을 가지고 있다.</li>\n<li>프로세스의 스레드가 생성/종료될 때 마다 자동으로 호출되는 콜백 함수</li>\n<li>프로세스의 메인 스레드가 생성될 때도 콜백 함수가 호출된다.</li>\n<li>Entry Point 코드보다 먼저 호출되어 Anti-Debugging에서 많이 쓰인다.</li>\n<li>스레드의 생성시점과 종료시점에 2번 자동으로 호출되는 함수이다.</li>\n<li>프로세스의 EP 코드를 실해하는 메인 스레드가 실행될 때 TLS 콜백 함수가 먼저 호출되는 원리이다.</li>\n</ul>\n<h3 id=\"image_tls_callback\" style=\"position:relative;\"><a href=\"#image_tls_callback\" aria-label=\"image_tls_callback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IMAGE_TLS_CALLBACK</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token function\">VOID</span>\n<span class=\"token punctuation\">(</span>NTAPI <span class=\"token operator\">*</span>PIMAGE_TLS_CALLBACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>\n    PVOID DllHandle<span class=\"token punctuation\">,</span>\n    DWORD Reason<span class=\"token punctuation\">,</span>\n    PVOID Reserved\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>TLS 콜백 함수 정의는 DllMain() 함수 정의와 비슷 한 것을 알 수있다.</li>\n</ul>\n<h3 id=\"dllmain\" style=\"position:relative;\"><a href=\"#dllmain\" aria-label=\"dllmain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DllMain()</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">BOOL WINAPI <span class=\"token function\">DllMain</span><span class=\"token punctuation\">(</span>\n    HINSTANCE hinstDLL<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// handle to DLL module</span>\n    <span class=\"token module\">DWORD</span> fdwReason<span class=\"token punctuation\">,</span>     <span class=\"token comment\">// reason for calling function</span>\n    LPVOID lpReserved <span class=\"token punctuation\">)</span>  <span class=\"token comment\">// reserved</span></code></pre></div>\n<ul>\n<li>\n<p>파라미터의 순서와 의미도 동일하다.</p>\n</li>\n<li>\n<p>DllHandle 파라미터는 모듈의 핸들, 로딩 주소 이다.</p>\n</li>\n<li>\n<p>Reason 파라미터는 TLS 콜백 함수가 호출된 이유</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">defind</span> <span class=\"token expression\">DLL_PROCESS_ATTACH  <span class=\"token number\">1</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DLL_THREAD_ATTACH</span>   <span class=\"token expression\"><span class=\"token number\">2</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DLL_THREAD_DETACH</span>   <span class=\"token expression\"><span class=\"token number\">3</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token expression\">DEFINE </span><span class=\"token macro-name\">DLL_PROCESS_DETACH</span>  <span class=\"token expression\"><span class=\"token number\">0</span></span></span></code></pre></div>\n</li>\n</ul>\n<h3 id=\"dll_process_attach\" style=\"position:relative;\"><a href=\"#dll_process_attach\" aria-label=\"dll_process_attach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLL_PROCESS_ATTACH</h3>\n<ul>\n<li>프로세스의 메인 스레드가 main 함수를 호출하기 전에 등록된 TLS 콜백 함수들이 호출된다.</li>\n<li>이때 Reason  값은 1(DLL_PROCESS_ATTACH)</li>\n</ul>\n<h3 id=\"dll_thread_attach\" style=\"position:relative;\"><a href=\"#dll_thread_attach\" aria-label=\"dll_thread_attach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLL_THREAD_ATTACH</h3>\n<ul>\n<li>TLS 콜백 함수들이 모두 종료되면 main 함수가 실행된다.</li>\n<li>사용자 스레드를 생성하는 순간 Reason = 2(DLL_THREAD_ATTACH)로 TLS 콜백 함수들이 동작한다.</li>\n</ul>\n<h3 id=\"dll_thread_detach\" style=\"position:relative;\"><a href=\"#dll_thread_detach\" aria-label=\"dll_thread_detach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLL_THREAD_DETACH</h3>\n<ul>\n<li>TLS 콜백 함수들이 모두 종료되면 사용자 스레드로 생성한 해당 함수가 실행된다.</li>\n<li>그리고 스레드 함수가 종료되는 순간 Reason = 3(DLL_THREAD_DETACH)로 TLS 콜백 함수들이 호출된다.</li>\n</ul>\n<h3 id=\"dll_process_detach\" style=\"position:relative;\"><a href=\"#dll_process_detach\" aria-label=\"dll_process_detach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLL_PROCESS_DETACH</h3>\n<ul>\n<li>사용자 쓰레드가 종료되면 스레드의 종료를 기다리던 main 함수(메인 스레드) 역시 종료한다.</li>\n<li>이때 마지막으로 Reason = 0 (DLL_PROCESS_DETACH) 값으로 TLS 콜백 함수들이 호출된다.</li>\n</ul>","frontmatter":{"date":"January 03, 2021","title":"TLS(Thread Local Storage CallBack)","categories":"Windows","author":"Zer0Luck","emoji":"🍯"},"fields":{"slug":"/window_5_theori/"}},"prev":{"id":"3c959693-35cd-5fa0-bdb5-e82315df4c6d","html":"<ul>\n<li>window NT 데이터 구조체 이며 프로세스 정보를 담고 있는 구조체</li>\n</ul>\n<h2 id=\"peb-접근-방법\" style=\"position:relative;\"><a href=\"#peb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\" aria-label=\"peb 접근 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB 접근 방법</h2>\n<ul>\n<li>TEB.ProcessEnvironmentBlock 멤버가 PEB 구조체의 주소</li>\n<li>TEB 구조체는 FS 세그먼트 셀렉터가 가리키는 세그먼트 메모리의 base address에 위치한다.</li>\n<li>그리고 ProcessEnvironmentBlock 멤버는 TEB 구조체 시작 부터 30 옵셋만큼 떨어져 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>ProcessEnvironmentBlock <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<h2 id=\"method-1\" style=\"position:relative;\"><a href=\"#method-1\" aria-label=\"method 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>method 1</h2>\n<ul>\n<li>바로 PEB 주소를 구하는 방법</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">MOV EAX<span class=\"token punctuation\">,</span> DWORD PTR FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span>      <span class=\"token punctuation\">;</span> FS<span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<h2 id=\"method-2\" style=\"position:relative;\"><a href=\"#method-2\" aria-label=\"method 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>method 2</h2>\n<ul>\n<li>TEB 주소를 구한후 ProcessEnvironmentBlock 멤버를 이용</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">MOV EAX<span class=\"token punctuation\">,</span> DWORD PTR FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span>       <span class=\"token punctuation\">;</span> FS<span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of TEB\nMOV EAX<span class=\"token punctuation\">,</span> DWORD PTR DS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>EAX<span class=\"token operator\">+</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span>   <span class=\"token punctuation\">;</span> DS<span class=\"token punctuation\">[</span>EAX<span class=\"token operator\">+</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoklEQVQozz3RUW/TMBAH8Hz/j0EHLwjEHsZomQQMqahjaJ0G7douTVIncRyf47MTJ07axqgKVPo93Mtfuvuf51rsKp4n2zKPdgBB+mlfLZ2tnMWjEQfNnMVBbzEJNyzaSEaqItubwsvjUgsIlo+YBCz1k3hSwqqrZFeCxcxK2pUwaEsQaVBlYQnJwYDrlHcwyiBELwtkRFMf6NSqP3sj9kZ0JewrGOYBI9uCBrWkrc6dRc+1qimBxds8WqWMvkRfK/jYVSvXYt/IvpGuxUHf4m67kmzXW3UwxbGWnrOq0ZARP9k8reNgsf7CyEiJy6566ht9Cg8HN/JYSyULhagVKkSF0nOdqkugxIfd2qc7n9zZ4nOtvp0Kq+W/cIuu032rcs4ZB84BhCik9ICGGlKeRgpSCZnIGfJMAVVADfJGi0YLg7xgcVVky/mv+Wy6fv4d+mtKQm/24/tkfD25uZ5cXd2Oxw/3MxYHkJEzweKMBM8P93S7tDS0OTn3793eTF6NLi4+vBm9e/3+8u3dz+lpyfNvT4WpWuWL+ZwnoetN3yr331/SJuwAkbF/mwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/0e108b97323267fb25a1db164ed8e537/37523/0.png\"\n        srcset=\"/static/0e108b97323267fb25a1db164ed8e537/e9ff0/0.png 180w,\n/static/0e108b97323267fb25a1db164ed8e537/f21e7/0.png 360w,\n/static/0e108b97323267fb25a1db164ed8e537/37523/0.png 720w,\n/static/0e108b97323267fb25a1db164ed8e537/302a4/0.png 1080w,\n/static/0e108b97323267fb25a1db164ed8e537/07a9c/0.png 1440w,\n/static/0e108b97323267fb25a1db164ed8e537/3a5d5/0.png 1807w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>FS:[0x30] 주소 값을 확인할 수 있다.</li>\n</ul>\n<h2 id=\"peb-구조체-정의\" style=\"position:relative;\"><a href=\"#peb-%EA%B5%AC%EC%A1%B0%EC%B2%B4-%EC%A0%95%EC%9D%98\" aria-label=\"peb 구조체 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB 구조체 정의</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_PEB</span> <span class=\"token punctuation\">{</span>\n  BYTE                          Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  BYTE                          BeingDebugged<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved3<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PPEB_LDR_DATA                 Ldr<span class=\"token punctuation\">;</span>\n  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved4<span class=\"token punctuation\">[</span><span class=\"token number\">104</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved5<span class=\"token punctuation\">[</span><span class=\"token number\">52</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved6<span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved7<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  ULONG                         SessionId<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> PEB<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PPEB<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">ntdll<span class=\"token operator\">!</span>_PEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> InheritedAddressSpace <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x001</span> ReadImageFileExecOptions <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x002</span> BeingDebugged    <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> BitField         <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> ImageUsesLargePages <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsProtectedProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsImageDynamicallyRelocated <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> SkipPatchingUser32Forwarders <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsPackagedProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsAppContainer   <span class=\"token operator\">:</span> Pos <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsProtectedProcessLight <span class=\"token operator\">:</span> Pos <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsLongPathAwareProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Padding0         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> Mutant           <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> ImageBaseAddress <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> Ldr              <span class=\"token operator\">:</span> Ptr64 _PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> ProcessParameters <span class=\"token operator\">:</span> Ptr64 _RTL_USER_PROCESS_PARAMETERS\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> SubSystemData    <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessHeap      <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x038</span> FastPebLock      <span class=\"token operator\">:</span> Ptr64 _RTL_CRITICAL_SECTION\n   <span class=\"token operator\">+</span><span class=\"token number\">0x040</span> AtlThunkSListPtr <span class=\"token operator\">:</span> Ptr64 _SLIST_HEADER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x048</span> IFEOKey          <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> CrossProcessFlags <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessInJob     <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessInitializing <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingVEH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingVCH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingFTH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessPreviouslyThrottled <span class=\"token operator\">:</span> Pos <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessCurrentlyThrottled <span class=\"token operator\">:</span> Pos <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessImagesHotPatched <span class=\"token operator\">:</span> Pos <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ReservedBits0    <span class=\"token operator\">:</span> Pos <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x054</span> Padding1         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x058</span> KernelCallbackTable <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x058</span> UserSharedInfoPtr <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x060</span> SystemReserved   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x064</span> AtlThunkSListPtr32 <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x068</span> ApiSetMap        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x070</span> TlsExpansionCounter <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x074</span> Padding2         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x078</span> TlsBitmap        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x080</span> TlsBitmapBits    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x088</span> ReadOnlySharedMemoryBase <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x090</span> SharedData       <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x098</span> ReadOnlyStaticServerData <span class=\"token operator\">:</span> Ptr64 Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0a0</span> AnsiCodePageData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0a8</span> OemCodePageData  <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0b0</span> UnicodeCaseTableData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0b8</span> NumberOfProcessors <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0bc</span> NtGlobalFlag     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c0</span> CriticalSectionTimeout <span class=\"token operator\">:</span> _LARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c8</span> HeapSegmentReserve <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0d0</span> HeapSegmentCommit <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0d8</span> HeapDeCommitTotalFreeThreshold <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0e0</span> HeapDeCommitFreeBlockThreshold <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0e8</span> NumberOfHeaps    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0ec</span> MaximumNumberOfHeaps <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0f0</span> ProcessHeaps     <span class=\"token operator\">:</span> Ptr64 Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0f8</span> GdiSharedHandleTable <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x100</span> ProcessStarterHelper <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x108</span> GdiDCAttributeList <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x10c</span> Padding3         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x110</span> LoaderLock       <span class=\"token operator\">:</span> Ptr64 _RTL_CRITICAL_SECTION\n   <span class=\"token operator\">+</span><span class=\"token number\">0x118</span> OSMajorVersion   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x11c</span> OSMinorVersion   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x120</span> OSBuildNumber    <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x122</span> OSCSDVersion     <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x124</span> OSPlatformId     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x128</span> ImageSubsystem   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x12c</span> ImageSubsystemMajorVersion <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x130</span> ImageSubsystemMinorVersion <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x134</span> Padding4         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x138</span> ActiveProcessAffinityMask <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x140</span> GdiHandleBuffer  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">60</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x230</span> PostProcessInitRoutine <span class=\"token operator\">:</span> Ptr64     <span class=\"token keyword\">void</span> \n   <span class=\"token operator\">+</span><span class=\"token number\">0x238</span> TlsExpansionBitmap <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x240</span> TlsExpansionBitmapBits <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c0</span> SessionId        <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c4</span> Padding5         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c8</span> AppCompatFlags   <span class=\"token operator\">:</span> _ULARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2d0</span> AppCompatFlagsUser <span class=\"token operator\">:</span> _ULARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2d8</span> pShimData        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2e0</span> AppCompatInfo    <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2e8</span> CSDVersion       <span class=\"token operator\">:</span> _UNICODE_STRING\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2f8</span> ActivationContextData <span class=\"token operator\">:</span> Ptr64 _ACTIVATION_CONTEXT_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x300</span> ProcessAssemblyStorageMap <span class=\"token operator\">:</span> Ptr64 _ASSEMBLY_STORAGE_MAP\n   <span class=\"token operator\">+</span><span class=\"token number\">0x308</span> SystemDefaultActivationContextData <span class=\"token operator\">:</span> Ptr64 _ACTIVATION_CONTEXT_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x310</span> SystemAssemblyStorageMap <span class=\"token operator\">:</span> Ptr64 _ASSEMBLY_STORAGE_MAP\n   <span class=\"token operator\">+</span><span class=\"token number\">0x318</span> MinimumStackCommit <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x320</span> SparePointers    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x340</span> SpareUlongs      <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x358</span> WerRegistrationData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x360</span> WerShipAssertPtr <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x368</span> pUnused          <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x370</span> pImageHeaderHash <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> TracingFlags     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> HeapTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> CritSecTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> LibLoaderTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> SpareTracingBits <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x37c</span> Padding6         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x380</span> CsrServerReadOnlySharedMemoryBase <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x388</span> TppWorkerpListLock <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x390</span> TppWorkerpList   <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x3a0</span> WaitOnAddressHashTable <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7a0</span> TelemetryCoverageHeader <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7a8</span> CloudFileFlags   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7ac</span> CloudFileDiagFlags <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b0</span> PlaceholderCompatibilityMode <span class=\"token operator\">:</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b1</span> PlaceholderCompatibilityModeReserved <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b8</span> LeapSecondData   <span class=\"token operator\">:</span> Ptr64 _LEAP_SECOND_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> LeapSecondFlags  <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> SixtySecondEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> Reserved         <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c4</span> NtGlobalFlag2    <span class=\"token operator\">:</span> Uint4B</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">tdll<span class=\"token operator\">!</span>_PEB \n   <span class=\"token operator\">+</span><span class=\"token number\">0x002</span> BeingDebugged    <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> ImageBaseAddress <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> Ldr              <span class=\"token operator\">:</span> Ptr64 _PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessHeap      <span class=\"token operator\">:</span> Ptr64 Void</code></pre></div>\n<h2 id=\"pebbeingdebugged\" style=\"position:relative;\"><a href=\"#pebbeingdebugged\" aria-label=\"pebbeingdebugged permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.BeingDebugged</h2>\n<ul>\n<li>Kernel32!IsDebuggerPresent() API</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">BOOL WINAPI <span class=\"token function\">IsDebuggerPresent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>현재 프로세스가 디버깅을 당하는지를 판단해서 결과를 반환한다.</li>\n<li>API가 참조하는 정보가 바로 PEB.BeingDebugged 멤버이다. (디버깅 중이면1, 아니면 0을 반환)</li>\n</ul>\n<h2 id=\"pebimagebaseaddress\" style=\"position:relative;\"><a href=\"#pebimagebaseaddress\" aria-label=\"pebimagebaseaddress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.ImageBaseAddress</h2>\n<ul>\n<li>PEB.ImageBaseAddress 멤버는 프로세스의 ImageBase 를 표시한다.</li>\n<li>GetModuleHandle() API는 ImageBase를 얻어내는 API이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">HMOUDLE WINAPI <span class=\"token function\">GetModuleHandle</span> <span class=\"token punctuation\">(</span>\n\t__in_opt  LPCTSTR lpModuleName\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>lpModuleName 파라미터에 NULL을 입력하고 GetModuleHandle()을 호출하면 프로세스가 로딩된 ImageBase를 리턴한다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjklEQVQI11XL3QqCMBjGce//HqLzbqC76CgMmU5ci9yYr/vAvVvqFmYEwY/n6PkX6kl5W2nBGLmiFi8rCTlV9ZGXh4GeVzQ56K9oZidR1FG1CSEHXYBgrCmNvEveJA/eDhdKnYHF4mrH/fSzTEPykHHcbHHfdXVp1QN1n2cXnOTdLUedI2wb/iwe0ifbvQEgE6fbOMXfJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/9e888556dc76a2d9f49f2c740922e0b7/37523/1.png\"\n        srcset=\"/static/9e888556dc76a2d9f49f2c740922e0b7/e9ff0/1.png 180w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/f21e7/1.png 360w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/37523/1.png 720w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/024d6/1.png 961w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>\n<p>PEB.ImageBaseAddress 멤버를 EAX 레지스터 에 세팅하는 것을 확인할 수 있다.</p>\n</li>\n</ul>\n<h2 id=\"pebldr\" style=\"position:relative;\"><a href=\"#pebldr\" aria-label=\"pebldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.Ldr</h2>\n<ul>\n<li>_PEB_LDR_DATA 구조체의 포인터이다.</li>\n<li>_PEB_LDR_DAT 구조체</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_PEB_LDR_DATA</span> <span class=\"token punctuation\">{</span>\n  BYTE       Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID      Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  LIST_ENTRY InMemoryOrderModuleList<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> PEB_LDR_DATA<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PPEB_LDR_DATA<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">007</span><span class=\"token operator\">></span> dt _PEB_LDR_DATA\nntdll<span class=\"token operator\">!</span>_PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Length           <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Initialized      <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> SsHandle         <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x00c</span> InLoadOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x014</span> InMemoryOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> InInitializationOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x024</span> EntryInProgress  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> ShutdownInProgress <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> ShutdownThreadId <span class=\"token operator\">:</span> Ptr32 Void</code></pre></div>\n<ul>\n<li>프로세스에 로딩된 모듈(DLL)의 로딩 베이스 주소를 직접 구할 수 있는 방법을 제공하기 때문이다.</li>\n<li>_LIST_ENTRY 타입의 멤버가 세 개 있다.\n<ul>\n<li>InLoadOrderModuleList</li>\n<li>InMemoryOrderModuleList</li>\n<li>InInitializationOrderModuleList</li>\n</ul>\n</li>\n<li>_LIST_ENTRY 구조체 정의는</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token operator\">*</span>Flink<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token operator\">*</span>Blink<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> LIST_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PLIST_ENTRY<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>구조체 정의를 보면 _LIST_ENTRY는 양방향 연결 리스트 메커니즘을 제공하는 구조체이다.</li>\n<li>연결 리스트에는 _LDR_DATA_TABLE_ENTRY 구조체 정보가 담겨 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_DATA_TABLE_ENTRY</span> <span class=\"token punctuation\">{</span>\n    PVOID Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    LIST_ENTRY InMemoryOrderLinks<span class=\"token punctuation\">;</span>\n    PVOID Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    PVOID DllBase<span class=\"token punctuation\">;</span>\n    PVOID EntryPoint<span class=\"token punctuation\">;</span>\n    PVOID Reserved3<span class=\"token punctuation\">;</span>\n    UNICODE_STRING FullDllName<span class=\"token punctuation\">;</span>\n    BYTE Reserved4<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    PVOID Reserved5<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        ULONG CheckSum<span class=\"token punctuation\">;</span>\n        PVOID Reserved6<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    ULONG TimeDateStamp<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> LDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>프로세스에 로딩된 DLL 모듈 마다 _LDR_DATA_TABLE_ENTRY 구조체가 하나씩 생성되고 이 구조체 들은 _LIST_ENTRY 양방향 연결 리스트로 연결된다.</li>\n<li>_LDR_DATA_TABLE_ENTRY 구조체 들이 많이 있는 데 연결 방법을 세 가지를 제공한다.</li>\n</ul>\n<h2 id=\"pebprocessheap--pebntglobalflag\" style=\"position:relative;\"><a href=\"#pebprocessheap--pebntglobalflag\" aria-label=\"pebprocessheap  pebntglobalflag permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.ProcessHeap &#x26; PEB.NtGlobalFlag</h2>\n<ul>\n<li>PEB.ProcessHeap 멤버, PEB.NtGlobalFlag 멤버는 (PEB.BeingDebugged 멤버와 마찬가지로) 안티 디버깅에 사용된다.</li>\n<li>프로세스가 디버깅 중이라면 ProcessHeap, NtGlobalFlag 멤버는 특정한 값을 갖는다.</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#peb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\">PEB 접근 방법</a></li>\n<li><a href=\"#method-1\">method 1</a></li>\n<li><a href=\"#method-2\">method 2</a></li>\n<li><a href=\"#peb-%EA%B5%AC%EC%A1%B0%EC%B2%B4-%EC%A0%95%EC%9D%98\">PEB 구조체 정의</a></li>\n<li><a href=\"#pebbeingdebugged\">PEB.BeingDebugged</a></li>\n<li><a href=\"#pebimagebaseaddress\">PEB.ImageBaseAddress</a></li>\n<li><a href=\"#pebldr\">PEB.Ldr</a></li>\n<li><a href=\"#pebprocessheap--pebntglobalflag\">PEB.ProcessHeap &#x26; PEB.NtGlobalFlag</a></li>\n</ul>\n</div>","frontmatter":{"date":"January 03, 2021","title":"PEB (Process Environment Block)","categories":"Windows","author":"Zer0Luck","emoji":"🧊"},"fields":{"slug":"/window_1_theori/"}},"site":{"siteMetadata":{"siteUrl":"https://zer0luck.kr","comments":{"utterances":{"repo":"dnsdudrla97/dnsdudrla97.github.io"}}}}},"pageContext":{"slug":"/window_2_theori/","nextSlug":"/window_5_theori/","prevSlug":"/window_1_theori/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}