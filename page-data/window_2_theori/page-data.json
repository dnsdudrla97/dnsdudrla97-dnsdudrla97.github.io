{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/window_2_theori/",
    "result": {"data":{"cur":{"id":"a2b2882f-79f1-5058-be0a-cc4ee51e785c","html":"<h2 id=\"seh\" style=\"position:relative;\"><a href=\"#seh\" aria-label=\"seh permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SEH</h2>\n<ul>\n<li><code class=\"language-text\">exception handlers</code> 는 각 Thread와 관련된 <code class=\"language-text\">Singly-linked list</code> 구성된다.</li>\n<li>원칙적으로 해당 목록의 노드는 stack에 할당된다.</li>\n<li>목록의 Head는 TEB(Thred Environment Block)의 시작 부분에 있는 포인터로 가리키므로 코드가 새 예외처리기를 추가하려는 경우 새 노드가 목록의 헤드와 포인터에 추가된다.</li>\n<li>TEB에서 새 노드를 가리키도록 변경된다.</li>\n<li>각 노드는 <code class=\"language-text\">_EXCEPTION_REGISTRATION_RECORD</code> 유형이며 핸들러의 주소와 목록의 다음 노드에 대한 포인터를 저장한다.</li>\n<li>이상하게도 목록의 마지막 노드의 “next pointer” 는 NULL이 아니지만 <code class=\"language-text\">0xFFFFFFFF</code> 와 같다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">000</span><span class=\"token operator\">></span> dt _EXCEPTION_REGISTRATION_RECORD\nntdll<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n<span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD\n<span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_DISPOSITION\n\n<span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">005</span><span class=\"token operator\">></span> dt _EXCEPTION_REGISTRATION_RECORD\ncombase<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> Ptr32     _EXCEPTION_DISPOSITION</code></pre></div>\n<ul>\n<li>TEB는 FS:[0] 부터 시작하는 <code class=\"language-text\">selector</code> FS를 통해서도 액세스 할 수 있으므로 다음과 같은 코드르 보는 것이 일반적이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">mov eax<span class=\"token punctuation\">,</span> dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> retrieve the head\npush eax <span class=\"token punctuation\">;</span> save the old head\nlea eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">10</span>h<span class=\"token punctuation\">]</span>\nmov dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> eax <span class=\"token punctuation\">;</span> set the <span class=\"token keyword\">new</span> head\nmov ecx<span class=\"token punctuation\">,</span> dword ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">10</span>h<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> get the old <span class=\"token function\">head</span> <span class=\"token punctuation\">(</span>NEXT field of the current head<span class=\"token punctuation\">)</span>\nmov dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000000</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ecx <span class=\"token punctuation\">;</span> restore the old head</code></pre></div>\n<ul>\n<li>\n<p>컴파일러는 일반적으로 프로그램의 어느 영역이 실행되고 있는지 (전역 변수에 의존) 알고 호출될 될 때 그에 따라 동작하는 단일 전역 처리기를 등록한다.</p>\n</li>\n<li>\n<p>각 스레드에는 다른 <code class=\"language-text\">TEB</code> 가 있으므로 운영 체제는 <code class=\"language-text\">FS</code> 에 의해 선택된 세그먼트가 항상 올바른 TEB(즉, 현재 스레드 중 하나)를 참조하는지 확인한다.</p>\n</li>\n<li>\n<p>TEB의 주소를 얻을려면 TEB의 Self 필드에 해당하는 <code class=\"language-text\">FS:[18h]</code>를 읽어야 한다.</p>\n</li>\n<li>\n<p>TEB를 확인해 보자</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>teb\nTEB at <span class=\"token number\">00</span>b95000\n    ExceptionList<span class=\"token operator\">:</span>        <span class=\"token number\">032</span>af770\n    StackBase<span class=\"token operator\">:</span>            <span class=\"token number\">032</span>b0000\n    StackLimit<span class=\"token operator\">:</span>           <span class=\"token number\">032</span>ac000\n    SubSystemTib<span class=\"token operator\">:</span>         <span class=\"token number\">00000000</span>\n    FiberData<span class=\"token operator\">:</span>            <span class=\"token number\">00001e00</span>\n    ArbitraryUserPointer<span class=\"token operator\">:</span> <span class=\"token number\">00000000</span>\n    Self<span class=\"token operator\">:</span>                 <span class=\"token number\">00</span>b95000\n    EnvironmentPointer<span class=\"token operator\">:</span>   <span class=\"token number\">00000000</span>\n    ClientId<span class=\"token operator\">:</span>             <span class=\"token number\">0000351</span>c <span class=\"token punctuation\">.</span> <span class=\"token number\">00004360</span>\n    RpcHandle<span class=\"token operator\">:</span>            <span class=\"token number\">00000000</span>\n    Tls Storage<span class=\"token operator\">:</span>          <span class=\"token number\">00000000</span>\n    PEB Address<span class=\"token operator\">:</span>          <span class=\"token number\">00</span>b50000\n    LastErrorValue<span class=\"token operator\">:</span>       <span class=\"token number\">0</span>\n    LastStatusValue<span class=\"token operator\">:</span>      <span class=\"token number\">0</span>\n    Count Owned Locks<span class=\"token operator\">:</span>    <span class=\"token number\">0</span>\n    HardErrorMode<span class=\"token operator\">:</span>        <span class=\"token number\">0</span></code></pre></div>\n<p>FS 세그먼트가 TEB를 참조하는 지 확인해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dg fs\n                                  P Si Gr Pr Lo\nSel    Base     Limit     Type    l ze an es ng Flags\n<span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">-</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span>\n<span class=\"token number\">0053</span> <span class=\"token number\">00</span>b95000 <span class=\"token number\">00000fff</span> Data RW Ac <span class=\"token number\">3</span> Bg By P  Nl <span class=\"token number\">000004f</span>3</code></pre></div>\n<ul>\n<li>FS:[18h] 에는 TEB의 주소가 포함되어 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">?</span><span class=\"token function\">poi</span><span class=\"token punctuation\">(</span>fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nEvaluate expression<span class=\"token operator\">:</span> <span class=\"token number\">12144640</span> <span class=\"token operator\">=</span> <span class=\"token number\">00</span>b95000</code></pre></div>\n<ul>\n<li>ExceptionList가 가리키는 Structure를 확인해보도록 하겠다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dt nt<span class=\"token operator\">!</span>_NT_TIB ExceptionList\nntdll<span class=\"token operator\">!</span>_NT_TIB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> ExceptionList <span class=\"token operator\">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD</code></pre></div>\n<ul>\n<li>각 노드는 _EXCPETION_REGISTRATION_RECORD의 Instance이다. 전체 목록을 확인하고 싶으면 <code class=\"language-text\">!slist</code> 를 사용하자</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>slist $teb _EXCEPTION_REGISTRATION_RECORD\nSLIST HEADER<span class=\"token operator\">:</span>\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Alignment          <span class=\"token operator\">:</span> <span class=\"token number\">32</span>b0000032af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next               <span class=\"token operator\">:</span> <span class=\"token number\">32</span>af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Depth              <span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Sequence           <span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n\nSLIST CONTENTS<span class=\"token operator\">:</span>\n<span class=\"token number\">032</span>af770\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7dc</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span>\n<span class=\"token number\">032</span>af7dc\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7f4</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span>\n<span class=\"token number\">032</span>af7f4\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0xffffffff</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x7776734b</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>FinalExceptionHandlerPad27<span class=\"token operator\">+</span><span class=\"token number\">0</span>\nffffffff\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span> \n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span> \nCan<span class=\"token number\">'</span>t read memory at ffffffff<span class=\"token punctuation\">,</span> error <span class=\"token number\">0</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">$teb</code> 는 TEB의 주소이다.</p>\n</li>\n<li>\n<p>SEH chain을 표시하는 더 간단한 방법은 다음을 사용하는 것이다.</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> <span class=\"token operator\">!</span>exchain\n<span class=\"token number\">032</span>af770<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">77759990</span><span class=\"token punctuation\">)</span>\n  CRT scope  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> filter<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>DbgUiRemoteBreakin<span class=\"token operator\">+</span><span class=\"token number\">3</span>b <span class=\"token punctuation\">(</span><span class=\"token number\">7778</span>db7b<span class=\"token punctuation\">)</span>\n                func<span class=\"token operator\">:</span>   ntdll<span class=\"token operator\">!</span>DbgUiRemoteBreakin<span class=\"token operator\">+</span><span class=\"token number\">3f</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7778</span>db7f<span class=\"token punctuation\">)</span>\n<span class=\"token number\">032</span>af7dc<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">77759990</span><span class=\"token punctuation\">)</span>\n  CRT scope  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> filter<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>__RtlUserThreadStart<span class=\"token operator\">+</span><span class=\"token number\">3</span>d6c5 <span class=\"token punctuation\">(</span><span class=\"token number\">77784</span>c8a<span class=\"token punctuation\">)</span>\n                func<span class=\"token operator\">:</span>   ntdll<span class=\"token operator\">!</span>__RtlUserThreadStart<span class=\"token operator\">+</span><span class=\"token number\">3</span>d75e <span class=\"token punctuation\">(</span><span class=\"token number\">77784</span>d23<span class=\"token punctuation\">)</span>\n<span class=\"token number\">032</span>af7f4<span class=\"token operator\">:</span> ntdll<span class=\"token operator\">!</span>FinalExceptionHandlerPad27<span class=\"token operator\">+</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7776734</span>b<span class=\"token punctuation\">)</span>\nInvalid exception stack at ffffffff</code></pre></div>\n<ul>\n<li>SEH chain을 수동으로 검사 할 수 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">003</span><span class=\"token operator\">></span> dt <span class=\"token number\">032</span>af770 _EXCEPTION_REGISTRATION_RECORD\nntdll<span class=\"token operator\">!</span>_EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Next             <span class=\"token operator\">:</span> <span class=\"token number\">0x032af7dc</span> _EXCEPTION_REGISTRATION_RECORD\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Handler          <span class=\"token operator\">:</span> <span class=\"token number\">0x77759990</span>     _EXCEPTION_DISPOSITION  ntdll<span class=\"token operator\">!</span>_except_handler4<span class=\"token operator\">+</span><span class=\"token number\">0</span></code></pre></div>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#seh\">SEH</a></li>\n</ul>\n</div>","excerpt":"SEH  는 각 Thread와 관련된  구성된다. 원칙적으로 해당 목록의 노드는 stack에 할당된다. 목록의 Head는 TEB(Thred Environment Block)의 시작 부분에 있는 포인터로 가리키므로 코드가 새 예외처리기를 추가하려는 경우 새 노드가 목록의 헤드와 포인터에 추가된다. TEB에서 새 노드를 가리키도록 변경된다. 각 노드는  유형이며 핸들러의 주소와 목록의 다음 노드에 대한 포인터를 저장한다. 이상하게도 목록의 마지막 노드의 “next pointer” 는 NULL이 아니지만  와 같다. TEB는 FS:[0] 부터 시작하는  FS를 통해서도 액세스 할 수 있으므로 다음과 같은 코드르 보는 것이 일반적이다. 컴파일러는 일반적으로 프로그램의 어느 영역이 실행되고 있는지 (전역 변수에 의존) 알고 호출될 될 때 그에 따라 동작하는 단일 전역 처리기를 등록한다. 각 스레드에는 다른  가 있으므로 운영 체제는  에 의해 선택된 세그먼트가 항상 올바른 TEB(즉, 현재…","frontmatter":{"date":"January 03, 2021","title":"Windows SEH (Structured Exception Handler) 1","categories":"Windows","author":"Zer0Luck","emoji":"🥖"},"fields":{"slug":"/window_2_theori/"}},"next":{"id":"3c959693-35cd-5fa0-bdb5-e82315df4c6d","html":"<ul>\n<li>window NT 데이터 구조체 이며 프로세스 정보를 담고 있는 구조체</li>\n</ul>\n<h2 id=\"peb-접근-방법\" style=\"position:relative;\"><a href=\"#peb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\" aria-label=\"peb 접근 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB 접근 방법</h2>\n<ul>\n<li>TEB.ProcessEnvironmentBlock 멤버가 PEB 구조체의 주소</li>\n<li>TEB 구조체는 FS 세그먼트 셀렉터가 가리키는 세그먼트 메모리의 base address에 위치한다.</li>\n<li>그리고 ProcessEnvironmentBlock 멤버는 TEB 구조체 시작 부터 30 옵셋만큼 떨어져 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>ProcessEnvironmentBlock <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<h2 id=\"method-1\" style=\"position:relative;\"><a href=\"#method-1\" aria-label=\"method 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>method 1</h2>\n<ul>\n<li>바로 PEB 주소를 구하는 방법</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">MOV EAX<span class=\"token punctuation\">,</span> DWORD PTR FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span>      <span class=\"token punctuation\">;</span> FS<span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<h2 id=\"method-2\" style=\"position:relative;\"><a href=\"#method-2\" aria-label=\"method 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>method 2</h2>\n<ul>\n<li>TEB 주소를 구한후 ProcessEnvironmentBlock 멤버를 이용</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">MOV EAX<span class=\"token punctuation\">,</span> DWORD PTR FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span>       <span class=\"token punctuation\">;</span> FS<span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of TEB\nMOV EAX<span class=\"token punctuation\">,</span> DWORD PTR DS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>EAX<span class=\"token operator\">+</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span>   <span class=\"token punctuation\">;</span> DS<span class=\"token punctuation\">[</span>EAX<span class=\"token operator\">+</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoklEQVQozz3RUW/TMBAH8Hz/j0EHLwjEHsZomQQMqahjaJ0G7douTVIncRyf47MTJ07axqgKVPo93Mtfuvuf51rsKp4n2zKPdgBB+mlfLZ2tnMWjEQfNnMVBbzEJNyzaSEaqItubwsvjUgsIlo+YBCz1k3hSwqqrZFeCxcxK2pUwaEsQaVBlYQnJwYDrlHcwyiBELwtkRFMf6NSqP3sj9kZ0JewrGOYBI9uCBrWkrc6dRc+1qimBxds8WqWMvkRfK/jYVSvXYt/IvpGuxUHf4m67kmzXW3UwxbGWnrOq0ZARP9k8reNgsf7CyEiJy6566ht9Cg8HN/JYSyULhagVKkSF0nOdqkugxIfd2qc7n9zZ4nOtvp0Kq+W/cIuu032rcs4ZB84BhCik9ICGGlKeRgpSCZnIGfJMAVVADfJGi0YLg7xgcVVky/mv+Wy6fv4d+mtKQm/24/tkfD25uZ5cXd2Oxw/3MxYHkJEzweKMBM8P93S7tDS0OTn3793eTF6NLi4+vBm9e/3+8u3dz+lpyfNvT4WpWuWL+ZwnoetN3yr331/SJuwAkbF/mwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/0e108b97323267fb25a1db164ed8e537/37523/0.png\"\n        srcset=\"/static/0e108b97323267fb25a1db164ed8e537/e9ff0/0.png 180w,\n/static/0e108b97323267fb25a1db164ed8e537/f21e7/0.png 360w,\n/static/0e108b97323267fb25a1db164ed8e537/37523/0.png 720w,\n/static/0e108b97323267fb25a1db164ed8e537/302a4/0.png 1080w,\n/static/0e108b97323267fb25a1db164ed8e537/07a9c/0.png 1440w,\n/static/0e108b97323267fb25a1db164ed8e537/3a5d5/0.png 1807w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>FS:[0x30] 주소 값을 확인할 수 있다.</li>\n</ul>\n<h2 id=\"peb-구조체-정의\" style=\"position:relative;\"><a href=\"#peb-%EA%B5%AC%EC%A1%B0%EC%B2%B4-%EC%A0%95%EC%9D%98\" aria-label=\"peb 구조체 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB 구조체 정의</h2>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_PEB</span> <span class=\"token punctuation\">{</span>\n  BYTE                          Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  BYTE                          BeingDebugged<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved3<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PPEB_LDR_DATA                 Ldr<span class=\"token punctuation\">;</span>\n  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved4<span class=\"token punctuation\">[</span><span class=\"token number\">104</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved5<span class=\"token punctuation\">[</span><span class=\"token number\">52</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine<span class=\"token punctuation\">;</span>\n  BYTE                          Reserved6<span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID                         Reserved7<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  ULONG                         SessionId<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> PEB<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PPEB<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">ntdll<span class=\"token operator\">!</span>_PEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> InheritedAddressSpace <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x001</span> ReadImageFileExecOptions <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x002</span> BeingDebugged    <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> BitField         <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> ImageUsesLargePages <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsProtectedProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsImageDynamicallyRelocated <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> SkipPatchingUser32Forwarders <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsPackagedProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsAppContainer   <span class=\"token operator\">:</span> Pos <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsProtectedProcessLight <span class=\"token operator\">:</span> Pos <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x003</span> IsLongPathAwareProcess <span class=\"token operator\">:</span> Pos <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Padding0         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> Mutant           <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> ImageBaseAddress <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> Ldr              <span class=\"token operator\">:</span> Ptr64 _PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> ProcessParameters <span class=\"token operator\">:</span> Ptr64 _RTL_USER_PROCESS_PARAMETERS\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> SubSystemData    <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessHeap      <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x038</span> FastPebLock      <span class=\"token operator\">:</span> Ptr64 _RTL_CRITICAL_SECTION\n   <span class=\"token operator\">+</span><span class=\"token number\">0x040</span> AtlThunkSListPtr <span class=\"token operator\">:</span> Ptr64 _SLIST_HEADER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x048</span> IFEOKey          <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> CrossProcessFlags <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessInJob     <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessInitializing <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingVEH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingVCH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessUsingFTH  <span class=\"token operator\">:</span> Pos <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessPreviouslyThrottled <span class=\"token operator\">:</span> Pos <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessCurrentlyThrottled <span class=\"token operator\">:</span> Pos <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ProcessImagesHotPatched <span class=\"token operator\">:</span> Pos <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x050</span> ReservedBits0    <span class=\"token operator\">:</span> Pos <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x054</span> Padding1         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x058</span> KernelCallbackTable <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x058</span> UserSharedInfoPtr <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x060</span> SystemReserved   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x064</span> AtlThunkSListPtr32 <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x068</span> ApiSetMap        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x070</span> TlsExpansionCounter <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x074</span> Padding2         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x078</span> TlsBitmap        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x080</span> TlsBitmapBits    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x088</span> ReadOnlySharedMemoryBase <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x090</span> SharedData       <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x098</span> ReadOnlyStaticServerData <span class=\"token operator\">:</span> Ptr64 Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0a0</span> AnsiCodePageData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0a8</span> OemCodePageData  <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0b0</span> UnicodeCaseTableData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0b8</span> NumberOfProcessors <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0bc</span> NtGlobalFlag     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c0</span> CriticalSectionTimeout <span class=\"token operator\">:</span> _LARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c8</span> HeapSegmentReserve <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0d0</span> HeapSegmentCommit <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0d8</span> HeapDeCommitTotalFreeThreshold <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0e0</span> HeapDeCommitFreeBlockThreshold <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0e8</span> NumberOfHeaps    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0ec</span> MaximumNumberOfHeaps <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0f0</span> ProcessHeaps     <span class=\"token operator\">:</span> Ptr64 Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0f8</span> GdiSharedHandleTable <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x100</span> ProcessStarterHelper <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x108</span> GdiDCAttributeList <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x10c</span> Padding3         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x110</span> LoaderLock       <span class=\"token operator\">:</span> Ptr64 _RTL_CRITICAL_SECTION\n   <span class=\"token operator\">+</span><span class=\"token number\">0x118</span> OSMajorVersion   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x11c</span> OSMinorVersion   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x120</span> OSBuildNumber    <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x122</span> OSCSDVersion     <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x124</span> OSPlatformId     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x128</span> ImageSubsystem   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x12c</span> ImageSubsystemMajorVersion <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x130</span> ImageSubsystemMinorVersion <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x134</span> Padding4         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x138</span> ActiveProcessAffinityMask <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x140</span> GdiHandleBuffer  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">60</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x230</span> PostProcessInitRoutine <span class=\"token operator\">:</span> Ptr64     <span class=\"token keyword\">void</span> \n   <span class=\"token operator\">+</span><span class=\"token number\">0x238</span> TlsExpansionBitmap <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x240</span> TlsExpansionBitmapBits <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c0</span> SessionId        <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c4</span> Padding5         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2c8</span> AppCompatFlags   <span class=\"token operator\">:</span> _ULARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2d0</span> AppCompatFlagsUser <span class=\"token operator\">:</span> _ULARGE_INTEGER\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2d8</span> pShimData        <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2e0</span> AppCompatInfo    <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2e8</span> CSDVersion       <span class=\"token operator\">:</span> _UNICODE_STRING\n   <span class=\"token operator\">+</span><span class=\"token number\">0x2f8</span> ActivationContextData <span class=\"token operator\">:</span> Ptr64 _ACTIVATION_CONTEXT_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x300</span> ProcessAssemblyStorageMap <span class=\"token operator\">:</span> Ptr64 _ASSEMBLY_STORAGE_MAP\n   <span class=\"token operator\">+</span><span class=\"token number\">0x308</span> SystemDefaultActivationContextData <span class=\"token operator\">:</span> Ptr64 _ACTIVATION_CONTEXT_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x310</span> SystemAssemblyStorageMap <span class=\"token operator\">:</span> Ptr64 _ASSEMBLY_STORAGE_MAP\n   <span class=\"token operator\">+</span><span class=\"token number\">0x318</span> MinimumStackCommit <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x320</span> SparePointers    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x340</span> SpareUlongs      <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x358</span> WerRegistrationData <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x360</span> WerShipAssertPtr <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x368</span> pUnused          <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x370</span> pImageHeaderHash <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> TracingFlags     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> HeapTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> CritSecTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> LibLoaderTracingEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x378</span> SpareTracingBits <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x37c</span> Padding6         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x380</span> CsrServerReadOnlySharedMemoryBase <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x388</span> TppWorkerpListLock <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x390</span> TppWorkerpList   <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x3a0</span> WaitOnAddressHashTable <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7a0</span> TelemetryCoverageHeader <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7a8</span> CloudFileFlags   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7ac</span> CloudFileDiagFlags <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b0</span> PlaceholderCompatibilityMode <span class=\"token operator\">:</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b1</span> PlaceholderCompatibilityModeReserved <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7b8</span> LeapSecondData   <span class=\"token operator\">:</span> Ptr64 _LEAP_SECOND_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> LeapSecondFlags  <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> SixtySecondEnabled <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c0</span> Reserved         <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c4</span> NtGlobalFlag2    <span class=\"token operator\">:</span> Uint4B</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">tdll<span class=\"token operator\">!</span>_PEB \n   <span class=\"token operator\">+</span><span class=\"token number\">0x002</span> BeingDebugged    <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> ImageBaseAddress <span class=\"token operator\">:</span> Ptr64 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> Ldr              <span class=\"token operator\">:</span> Ptr64 _PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessHeap      <span class=\"token operator\">:</span> Ptr64 Void</code></pre></div>\n<h2 id=\"pebbeingdebugged\" style=\"position:relative;\"><a href=\"#pebbeingdebugged\" aria-label=\"pebbeingdebugged permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.BeingDebugged</h2>\n<ul>\n<li>Kernel32!IsDebuggerPresent() API</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">BOOL WINAPI <span class=\"token function\">IsDebuggerPresent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>현재 프로세스가 디버깅을 당하는지를 판단해서 결과를 반환한다.</li>\n<li>API가 참조하는 정보가 바로 PEB.BeingDebugged 멤버이다. (디버깅 중이면1, 아니면 0을 반환)</li>\n</ul>\n<h2 id=\"pebimagebaseaddress\" style=\"position:relative;\"><a href=\"#pebimagebaseaddress\" aria-label=\"pebimagebaseaddress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.ImageBaseAddress</h2>\n<ul>\n<li>PEB.ImageBaseAddress 멤버는 프로세스의 ImageBase 를 표시한다.</li>\n<li>GetModuleHandle() API는 ImageBase를 얻어내는 API이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">HMOUDLE WINAPI <span class=\"token function\">GetModuleHandle</span> <span class=\"token punctuation\">(</span>\n\t__in_opt  LPCTSTR lpModuleName\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>lpModuleName 파라미터에 NULL을 입력하고 GetModuleHandle()을 호출하면 프로세스가 로딩된 ImageBase를 리턴한다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjklEQVQI11XL3QqCMBjGce//HqLzbqC76CgMmU5ci9yYr/vAvVvqFmYEwY/n6PkX6kl5W2nBGLmiFi8rCTlV9ZGXh4GeVzQ56K9oZidR1FG1CSEHXYBgrCmNvEveJA/eDhdKnYHF4mrH/fSzTEPykHHcbHHfdXVp1QN1n2cXnOTdLUedI2wb/iwe0ifbvQEgE6fbOMXfJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/9e888556dc76a2d9f49f2c740922e0b7/37523/1.png\"\n        srcset=\"/static/9e888556dc76a2d9f49f2c740922e0b7/e9ff0/1.png 180w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/f21e7/1.png 360w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/37523/1.png 720w,\n/static/9e888556dc76a2d9f49f2c740922e0b7/024d6/1.png 961w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>\n<p>PEB.ImageBaseAddress 멤버를 EAX 레지스터 에 세팅하는 것을 확인할 수 있다.</p>\n</li>\n</ul>\n<h2 id=\"pebldr\" style=\"position:relative;\"><a href=\"#pebldr\" aria-label=\"pebldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.Ldr</h2>\n<ul>\n<li>_PEB_LDR_DATA 구조체의 포인터이다.</li>\n<li>_PEB_LDR_DAT 구조체</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_PEB_LDR_DATA</span> <span class=\"token punctuation\">{</span>\n  BYTE       Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID      Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  LIST_ENTRY InMemoryOrderModuleList<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> PEB_LDR_DATA<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PPEB_LDR_DATA<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">007</span><span class=\"token operator\">></span> dt _PEB_LDR_DATA\nntdll<span class=\"token operator\">!</span>_PEB_LDR_DATA\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Length           <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> Initialized      <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> SsHandle         <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x00c</span> InLoadOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x014</span> InMemoryOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> InInitializationOrderModuleList <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0x024</span> EntryInProgress  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> ShutdownInProgress <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> ShutdownThreadId <span class=\"token operator\">:</span> Ptr32 Void</code></pre></div>\n<ul>\n<li>프로세스에 로딩된 모듈(DLL)의 로딩 베이스 주소를 직접 구할 수 있는 방법을 제공하기 때문이다.</li>\n<li>_LIST_ENTRY 타입의 멤버가 세 개 있다.\n<ul>\n<li>InLoadOrderModuleList</li>\n<li>InMemoryOrderModuleList</li>\n<li>InInitializationOrderModuleList</li>\n</ul>\n</li>\n<li>_LIST_ENTRY 구조체 정의는</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token operator\">*</span>Flink<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LIST_ENTRY</span> <span class=\"token operator\">*</span>Blink<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> LIST_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PLIST_ENTRY<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>구조체 정의를 보면 _LIST_ENTRY는 양방향 연결 리스트 메커니즘을 제공하는 구조체이다.</li>\n<li>연결 리스트에는 _LDR_DATA_TABLE_ENTRY 구조체 정보가 담겨 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_DATA_TABLE_ENTRY</span> <span class=\"token punctuation\">{</span>\n    PVOID Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    LIST_ENTRY InMemoryOrderLinks<span class=\"token punctuation\">;</span>\n    PVOID Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    PVOID DllBase<span class=\"token punctuation\">;</span>\n    PVOID EntryPoint<span class=\"token punctuation\">;</span>\n    PVOID Reserved3<span class=\"token punctuation\">;</span>\n    UNICODE_STRING FullDllName<span class=\"token punctuation\">;</span>\n    BYTE Reserved4<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    PVOID Reserved5<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        ULONG CheckSum<span class=\"token punctuation\">;</span>\n        PVOID Reserved6<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    ULONG TimeDateStamp<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> LDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>프로세스에 로딩된 DLL 모듈 마다 _LDR_DATA_TABLE_ENTRY 구조체가 하나씩 생성되고 이 구조체 들은 _LIST_ENTRY 양방향 연결 리스트로 연결된다.</li>\n<li>_LDR_DATA_TABLE_ENTRY 구조체 들이 많이 있는 데 연결 방법을 세 가지를 제공한다.</li>\n</ul>\n<h2 id=\"pebprocessheap--pebntglobalflag\" style=\"position:relative;\"><a href=\"#pebprocessheap--pebntglobalflag\" aria-label=\"pebprocessheap  pebntglobalflag permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEB.ProcessHeap &#x26; PEB.NtGlobalFlag</h2>\n<ul>\n<li>PEB.ProcessHeap 멤버, PEB.NtGlobalFlag 멤버는 (PEB.BeingDebugged 멤버와 마찬가지로) 안티 디버깅에 사용된다.</li>\n<li>프로세스가 디버깅 중이라면 ProcessHeap, NtGlobalFlag 멤버는 특정한 값을 갖는다.</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#peb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\">PEB 접근 방법</a></li>\n<li><a href=\"#method-1\">method 1</a></li>\n<li><a href=\"#method-2\">method 2</a></li>\n<li><a href=\"#peb-%EA%B5%AC%EC%A1%B0%EC%B2%B4-%EC%A0%95%EC%9D%98\">PEB 구조체 정의</a></li>\n<li><a href=\"#pebbeingdebugged\">PEB.BeingDebugged</a></li>\n<li><a href=\"#pebimagebaseaddress\">PEB.ImageBaseAddress</a></li>\n<li><a href=\"#pebldr\">PEB.Ldr</a></li>\n<li><a href=\"#pebprocessheap--pebntglobalflag\">PEB.ProcessHeap &#x26; PEB.NtGlobalFlag</a></li>\n</ul>\n</div>","frontmatter":{"date":"January 03, 2021","title":"PEB (Process Environment Block)","categories":"Windows","author":"Zer0Luck","emoji":"🧊"},"fields":{"slug":"/window_1_theori/"}},"prev":{"id":"60cba5e7-39d0-5855-a5bc-bcc248468cd4","html":"<h1 id=\"teb-thread-environment-block\" style=\"position:relative;\"><a href=\"#teb-thread-environment-block\" aria-label=\"teb thread environment block permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TEB (Thread Environment Block)</h1>\n<ul>\n<li>프로세스에서 실행되는 스레드에 대한 정보를 담고 있는 구조체</li>\n<li>스레드별로 TEB 구조체가 하나씩 할당된다.</li>\n<li>OS 종류별로 해당 모양이 조금씩 달라진다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_TEB</span> <span class=\"token punctuation\">{</span>\n  PVOID Reserved1<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PPEB  ProcessEnvironmentBlock<span class=\"token punctuation\">;</span>\n  PVOID Reserved2<span class=\"token punctuation\">[</span><span class=\"token number\">399</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  BYTE  Reserved3<span class=\"token punctuation\">[</span><span class=\"token number\">1952</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID TlsSlots<span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  BYTE  Reserved4<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID Reserved5<span class=\"token punctuation\">[</span><span class=\"token number\">26</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID ReservedForOle<span class=\"token punctuation\">;</span>\n  PVOID Reserved6<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  PVOID TlsExpansionSlots<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> TEB<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PTEB<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">001</span><span class=\"token operator\">></span> dt _TEB\nntdll<span class=\"token operator\">!</span>_TEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> NtTib            <span class=\"token operator\">:</span> _NT_TIB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> EnvironmentPointer <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> ClientId         <span class=\"token operator\">:</span> _CLIENT_ID\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> ActiveRpcHandle  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> ThreadLocalStoragePointer <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessEnvironmentBlock <span class=\"token operator\">:</span> Ptr32 _PEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x034</span> LastErrorValue   <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x038</span> CountOfOwnedCriticalSections <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x03c</span> CsrClientThread  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x040</span> Win32ThreadInfo  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x044</span> User32Reserved   <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">26</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0ac</span> UserReserved     <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c0</span> WOW32Reserved    <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c4</span> CurrentLocale    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0c8</span> FpSoftwareStatusRegister <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x0cc</span> ReservedForDebuggerInstrumentation <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x10c</span> SystemReserved1  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">26</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x174</span> PlaceholderCompatibilityMode <span class=\"token operator\">:</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x175</span> PlaceholderHydrationAlwaysExplicit <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x176</span> PlaceholderReserved <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> Char\n   <span class=\"token operator\">+</span><span class=\"token number\">0x180</span> ProxiedProcessId <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x184</span> _ActivationStack <span class=\"token operator\">:</span> _ACTIVATION_CONTEXT_STACK\n   <span class=\"token operator\">+</span><span class=\"token number\">0x19c</span> WorkingOnBehalfTicket <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1a4</span> ExceptionCode    <span class=\"token operator\">:</span> Int4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1a8</span> ActivationContextStackPointer <span class=\"token operator\">:</span> Ptr32 _ACTIVATION_CONTEXT_STACK\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1ac</span> InstrumentationCallbackSp <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1b0</span> InstrumentationCallbackPreviousPc <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1b4</span> InstrumentationCallbackPreviousSp <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1b8</span> InstrumentationCallbackDisabled <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1b9</span> SpareBytes       <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">23</span><span class=\"token punctuation\">]</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1d0</span> TxFsContext      <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x1d4</span> GdiTebBatch      <span class=\"token operator\">:</span> _GDI_TEB_BATCH\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6b4</span> RealClientId     <span class=\"token operator\">:</span> _CLIENT_ID\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6bc</span> GdiCachedProcessHandle <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6c0</span> GdiClientPID     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6c4</span> GdiClientTID     <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6c8</span> GdiThreadLocalInfo <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x6cc</span> Win32ClientInfo  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">62</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0x7c4</span> glDispatchTable  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">233</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xb68</span> glReserved1      <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">29</span><span class=\"token punctuation\">]</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbdc</span> glReserved2      <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbe0</span> glSectionInfo    <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbe4</span> glSection        <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbe8</span> glTable          <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbec</span> glCurrentRC      <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbf0</span> glContext        <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbf4</span> LastStatusValue  <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xbf8</span> StaticUnicodeString <span class=\"token operator\">:</span> _UNICODE_STRING\n   <span class=\"token operator\">+</span><span class=\"token number\">0xc00</span> StaticUnicodeBuffer <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">261</span><span class=\"token punctuation\">]</span> Wchar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xe0c</span> DeallocationStack <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xe10</span> TlsSlots         <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf10</span> TlsLinks         <span class=\"token operator\">:</span> _LIST_ENTRY\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf18</span> Vdm              <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf1c</span> ReservedForNtRpc <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf20</span> DbgSsReserved    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf28</span> HardErrorMode    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf2c</span> Instrumentation  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf50</span> ActivityId       <span class=\"token operator\">:</span> _GUID\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf60</span> SubProcessTag    <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf64</span> PerflibData      <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf68</span> EtwTraceData     <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf6c</span> WinSockData      <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf70</span> GdiBatchCount    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf74</span> CurrentIdealProcessor <span class=\"token operator\">:</span> _PROCESSOR_NUMBER\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf74</span> IdealProcessorValue <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf74</span> ReservedPad0     <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf75</span> ReservedPad1     <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf76</span> ReservedPad2     <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf77</span> IdealProcessor   <span class=\"token operator\">:</span> UChar\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf78</span> GuaranteedStackBytes <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf7c</span> ReservedForPerf  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf80</span> ReservedForOle   <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf84</span> WaitingOnLoaderLock <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf88</span> SavedPriorityState <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf8c</span> ReservedForCodeCoverage <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf90</span> ThreadPoolData   <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf94</span> TlsExpansionSlots <span class=\"token operator\">:</span> Ptr32 Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf98</span> MuiGeneration    <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xf9c</span> IsImpersonating  <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfa0</span> NlsCache         <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfa4</span> pShimData        <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfa8</span> HeapData         <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfac</span> CurrentTransactionHandle <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfb0</span> ActiveFrame      <span class=\"token operator\">:</span> Ptr32 _TEB_ACTIVE_FRAME\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfb4</span> FlsData          <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfb8</span> PreferredLanguages <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfbc</span> UserPrefLanguages <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfc0</span> MergedPrefLanguages <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfc4</span> MuiImpersonation <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfc8</span> CrossTebFlags    <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfc8</span> SpareCrossTebBits <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span> Bits\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SameTebFlags     <span class=\"token operator\">:</span> Uint2B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SafeThunkCall    <span class=\"token operator\">:</span> Pos <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> InDebugPrint     <span class=\"token operator\">:</span> Pos <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> HasFiberData     <span class=\"token operator\">:</span> Pos <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SkipThreadAttach <span class=\"token operator\">:</span> Pos <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> WerInShipAssertCode <span class=\"token operator\">:</span> Pos <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> RanProcessInit   <span class=\"token operator\">:</span> Pos <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> ClonedThread     <span class=\"token operator\">:</span> Pos <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SuppressDebugMsg <span class=\"token operator\">:</span> Pos <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> DisableUserStackWalk <span class=\"token operator\">:</span> Pos <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> RtlExceptionAttached <span class=\"token operator\">:</span> Pos <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> InitialThread    <span class=\"token operator\">:</span> Pos <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SessionAware     <span class=\"token operator\">:</span> Pos <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> LoadOwner        <span class=\"token operator\">:</span> Pos <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> LoaderWorker     <span class=\"token operator\">:</span> Pos <span class=\"token number\">13</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SkipLoaderInit   <span class=\"token operator\">:</span> Pos <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfca</span> SpareSameTebBits <span class=\"token operator\">:</span> Pos <span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> Bit\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfcc</span> TxnScopeEnterCallback <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfd0</span> TxnScopeExitCallback <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfd4</span> TxnScopeContext  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfd8</span> LockCount        <span class=\"token operator\">:</span> Uint4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfdc</span> WowTebOffset     <span class=\"token operator\">:</span> Int4B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfe0</span> ResourceRetValue <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfe4</span> ReservedForWdf   <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0xfe8</span> ReservedForCrt   <span class=\"token operator\">:</span> Uint8B\n   <span class=\"token operator\">+</span><span class=\"token number\">0xff0</span> EffectiveContainerId <span class=\"token operator\">:</span> _GUID</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token number\">001</span><span class=\"token operator\">></span> dt _TEB\nntdll<span class=\"token operator\">!</span>_TEB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> NtTib            <span class=\"token operator\">:</span> _NT_TIB\n   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> EnvironmentPointer <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> ClientId         <span class=\"token operator\">:</span> _CLIENT_ID\n   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> ActiveRpcHandle  <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> ThreadLocalStoragePointer <span class=\"token operator\">:</span> Ptr32 Void\n   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> ProcessEnvironmentBlock <span class=\"token operator\">:</span> Ptr32 _PEB\n\t <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h3 id=\"processenvironmentblock-member\" style=\"position:relative;\"><a href=\"#processenvironmentblock-member\" aria-label=\"processenvironmentblock member permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ProcessEnvironmentBlock member</h3>\n<ul>\n<li>0x30 offset 에 위치한 ProcessEnvironmentBlock member</li>\n<li>PEB(Process Environment Block) 구조체의 포인터이다.</li>\n<li>PEB는 프로세스 별로 하나만 생성된다.</li>\n</ul>\n<h3 id=\"nttib-member\" style=\"position:relative;\"><a href=\"#nttib-member\" aria-label=\"nttib member permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NtTib member</h3>\n<ul>\n<li>TEB 구조체의 첫 번째 멤버는 <code class=\"language-text\">_NT_TIB</code> 구조체이다.</li>\n<li>_NT_TIB (_NT_Thread information Block)</li>\n<li>현재 실행 중인 스레드에 대한 정보를 저장하고 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_NT_TIB</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_EXCEPTION_REGISTRATION_RECORD</span> <span class=\"token operator\">*</span>ExceptionList<span class=\"token punctuation\">;</span>\n    PVOID StackBase<span class=\"token punctuation\">;</span>\n    PVOID StackLimit<span class=\"token punctuation\">;</span>\n    PVOID SubSystemTib<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>_MSC_EXTENSIONS<span class=\"token punctuation\">)</span></span></span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        PVOID FiberData<span class=\"token punctuation\">;</span>\n        DWORD Version<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span>\n    PVOID FiberData<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span>\n    PVOID ArbitraryUserPointer<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_NT_TIB</span> <span class=\"token operator\">*</span>Self<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> NT_TIB<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> NT_TIB <span class=\"token operator\">*</span>PNT_TIB<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>ExceptionList member는 _EXCEPTION_REGISTRATION_RECORD 구조체 연결 리스트를 가리키고 있다. 이것은 SEH(Structured Exception Handler) 라고 하는 Window OS의 예외 처리 메커니즘에 사용된다.</li>\n<li>Self 멤버는 _NT_TIB 구조체의 셀프 포인터이며 곧 TEB 구조체 포인터이기도 한다. (TEB 구조체 첫 번째 멤버가 _NT_TIB 구조체이기 때문이다.)</li>\n</ul>\n<h2 id=\"유저-모드-teb-접근-방법\" style=\"position:relative;\"><a href=\"#%EC%9C%A0%EC%A0%80-%EB%AA%A8%EB%93%9C-teb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\" aria-label=\"유저 모드 teb 접근 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>유저 모드 TEB 접근 방법</h2>\n<h3 id=\"ntdllntcurrentteb\" style=\"position:relative;\"><a href=\"#ntdllntcurrentteb\" aria-label=\"ntdllntcurrentteb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ntdll.NtCurrentTeb()</h3>\n<ul>\n<li>Ntdll.NtCurrentTeb() API는 현재 스레드의 TEB 구조체 주소를 리턴하는 함수이다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAABAElEQVQY0y3L4XJDMAAAYO//Ul23m2okKSEJcYoeIorS0uoWs+tud9/fz8C+54uEcEFFjBziHmDAaBCEruezMDomSZZmsqqklEVZ5sVLWUopK6WUgTGwgRVw6mDoYGCZW2zv7f2OEsQpCZknOGWMHqCNEHQhwMBk1BMBi6PQyGNO7I/qFKaC5DHFuy0yN87+vcrE86rmQfUq6+rie2y+bmc9NsvULvdOT62eWqPOY+6Cvj6lws+PDFlbaG4CYs9Xtepx1ePjdh4a+TP3+t4tj8v6HNa5f3kOBvh84wTWRXIMvTSiHrZctIuY01anoSmubdnItD/Ln8dFT91y7/7nn19hlAa2U/3ljAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./0.png\"\n        title=\"./0.png\"\n        src=\"/static/313b08180b86b127459eec3e7216e166/37523/0.png\"\n        srcset=\"/static/313b08180b86b127459eec3e7216e166/e9ff0/0.png 180w,\n/static/313b08180b86b127459eec3e7216e166/f21e7/0.png 360w,\n/static/313b08180b86b127459eec3e7216e166/37523/0.png 720w,\n/static/313b08180b86b127459eec3e7216e166/302a4/0.png 1080w,\n/static/313b08180b86b127459eec3e7216e166/b5cea/0.png 1140w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABHElEQVQY02XPW2+CMACGYf7/31l2sSsWzSYagR5oQWgplEpBxkHUTd0mC0vc4pY8F+93+RmXYzec+12tObTlykuZryWrtfR8GDFaZrIISZWLusiaUnVV/k03WvZKGCqJtOQiCsBijhwbI4AhoBhaEDjQ9SD07CVBgGAYBjQVcRLzEWcpC41qHW8UqxQvFWuL9NDk+3p9aPVw7C5v7egan6/NrdYYPvbD+2503g3nfjhtR8ft2D/zdJ23jMCnCNiUYOAsMQau7XjIJQR6rkUxJhitqEcQiHmUCP6H8Twxp+Z0tnhy3Lk5M+/uHyazRxfNA+KIkEQ+bEvZbVS3yf4zMLQiBaPMFQXkGqQviPKljS0R0zKPlQz7Wv9eu/UFCPh13YKrvi4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./1.png\"\n        title=\"./1.png\"\n        src=\"/static/0ddfab9384ee51c255ffd546801bd9a8/37523/1.png\"\n        srcset=\"/static/0ddfab9384ee51c255ffd546801bd9a8/e9ff0/1.png 180w,\n/static/0ddfab9384ee51c255ffd546801bd9a8/f21e7/1.png 360w,\n/static/0ddfab9384ee51c255ffd546801bd9a8/37523/1.png 720w,\n/static/0ddfab9384ee51c255ffd546801bd9a8/eafa0/1.png 939w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>NtCurrentTeb() 의 내부 코드는 아주 간단하게 구성되어 있다.</li>\n<li><code class=\"language-text\">FS:[18]</code> 주소의 값을 리턴 한다.</li>\n<li>FS:[18] 실제 주소 <code class=\"language-text\">00281018</code> 을 확인할 수 있는데 메모리 창에서 주소를 확인해보면 <code class=\"language-text\">00281000</code> 값이 들어 있다.</li>\n<li>NtCuurentTeb() API 는 이 값을 리턴하고 있다.</li>\n<li>따라서 이 값이 바로 현재 스레드의 TEB 주소 이다.</li>\n<li>TEB 주소(00281000) 주소는 FS 세그먼트 레지스터가 가리키는 세그먼트 메모리의 베이스 주소와 일치한다.</li>\n</ul>\n<h2 id=\"fs-segment-register\" style=\"position:relative;\"><a href=\"#fs-segment-register\" aria-label=\"fs segment register permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS Segment Register</h2>\n<ul>\n<li>FS 세그먼트 레지스터는 현재 스레드의 TEB를 지시하는데 사용한다.</li>\n<li><code class=\"language-text\">IA32</code> 시스템에서는 프로세스의 가상 메모리 크기가 4GB이므로 32비트 크기의 포인터를 이용해야 전체 메모리 공간에 접근이 가능하다.</li>\n<li>FS 레지스터의 크기는 16비트밖에 안된다.</li>\n<li>FS 레지스터는 직접 TEB 주소를 가리키는 것이 아니라, 실제 TEB 주소를 가지고 있는 <code class=\"language-text\">Segment Descriptor Table</code> 의 Index를 가지고 있는것이다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">Segment Descriptor Table은 커널 메모리 영역에 존재하며\n특수 레지스터인 <span class=\"token function\">GDTR</span><span class=\"token punctuation\">(</span>Global Descriptor Table Register<span class=\"token punctuation\">)</span>에 그 주소가 저장되어 있다<span class=\"token punctuation\">.</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUUlEQVQoz3WS3UsUURjG95/JdeecmTMzO64frLtq67q6bquuaWkZq5uaBUEJhWQpCHWRghRSBFb4hZn2BUFEhUUX4YUE1VXdSF1UhFFCCbK/2GmjoLp4eF7OOfx43vO+HiHNrBAKIZTrUrfwaQbB8koSDSmqY3Fi8R1E6xLU1icJFJeh5d8Jaf6WbrlnHqGbSNOflZaDK2Xj0xSOU8LyxU5ez2d4OZNhbbGbq8O78Ek/QiqkNDEME6UslGEhpXLBHqnb2eDhRzSdeZONjazhJAcQhV4su5jnY+18m0rzaXIfW7Od3Dyxk20+E123CIajJFN7iMabSTS2Eaqs+wW0qG3qp75lkPrWIUpDjQhh4DjFvLp8gK17x/ly6yjcP8ad0x14pY0Sisj4OPFnT2l/vEzi6ROi83MoswhPjmqaCqV0V4ah0ISJbRexej7N12t9vJ/u4ftiH4tDuynQLPQcsL+HugunSJ4bJD5xkujIkZ/A3F/4CgWFXg2fV3PT5YCWVcSLiQ42F7pYn+kku5Th9nCr27Jh2FQGq4mU11AVjLq+vbwmn1C3MMMJiiIpnEgzRqACTTNc4OpEBxvXM3yY7WTzxn6W8kDdsAiGIoSrYoQra1wPVUQxlINHkzbV/Sukxz/SevYzgYYhhK8A21/Cyuhe1q908e5Smo2pDAsDLRRouaGY7or8Sx4hc0UJUi9F6mVI3XEvbDvA2+k0POiFu92w3MfD0bb8lM2/9zAvj9RzhfGHFLrhx7aLGUsnmT7YxGRvI3OHUgy01lEocrD/J/wByl+GNmQQIYoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./SGT.png\"\n        title=\"./SGT.png\"\n        src=\"/static/072d5e551d215b08984b841e81b2b639/37523/SGT.png\"\n        srcset=\"/static/072d5e551d215b08984b841e81b2b639/e9ff0/SGT.png 180w,\n/static/072d5e551d215b08984b841e81b2b639/f21e7/SGT.png 360w,\n/static/072d5e551d215b08984b841e81b2b639/37523/SGT.png 720w,\n/static/072d5e551d215b08984b841e81b2b639/302a4/SGT.png 1080w,\n/static/072d5e551d215b08984b841e81b2b639/07a9c/SGT.png 1440w,\n/static/072d5e551d215b08984b841e81b2b639/74e37/SGT.png 1732w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>세그먼트 레지스터는 실제로 Segment Descriptor Table의 Index를 가지고 있기 때문에 Segment Selector 라는 별칭을 가지고 있다.</li>\n<li>FS 세그먼트 셀렉터가 가리키는 세그먼트 메모리의 시작주소 (base address) 에 TEB 구조체가 위치하는 것을 확인할 수 있다.</li>\n</ul>\n<h3 id=\"fs0x18--teb-base-address\" style=\"position:relative;\"><a href=\"#fs0x18--teb-base-address\" aria-label=\"fs0x18  teb base address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS:[0x18] = TEB base address</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>NtTib<span class=\"token punctuation\">.</span>Self <span class=\"token operator\">=</span> address of TIB <span class=\"token operator\">=</span> address of TEB <span class=\"token operator\">=</span> FS<span class=\"token operator\">:</span><span class=\"token number\">0</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x2810100</span>\n\nFS<span class=\"token operator\">:</span><span class=\"token number\">0</span> 의 의미는 FS 레지스터가 Indexing 하는 Segment Descriptor가 가리키는 Segment Memory의\n시작 주소이다<span class=\"token punctuation\">.</span></code></pre></div>\n<h3 id=\"fs0x30--peb-base-address\" style=\"position:relative;\"><a href=\"#fs0x30--peb-base-address\" aria-label=\"fs0x30  peb base address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS:[0x30] = PEB base address</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>ProcessEnvironmentBlock <span class=\"token operator\">=</span> address of PEB</code></pre></div>\n<h3 id=\"fs0x0--seh-base-address\" style=\"position:relative;\"><a href=\"#fs0x0--seh-base-address\" aria-label=\"fs0x0  seh base address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS:[0x0] = SEH base address</h3>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">FS<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> TEB<span class=\"token punctuation\">.</span>NtTib<span class=\"token punctuation\">.</span>ExceptionList <span class=\"token operator\">=</span> address of SEH</code></pre></div>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<ul>\n<li><a href=\"#processenvironmentblock-member\">ProcessEnvironmentBlock member</a></li>\n<li><a href=\"#nttib-member\">NtTib member</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9C%A0%EC%A0%80-%EB%AA%A8%EB%93%9C-teb-%EC%A0%91%EA%B7%BC-%EB%B0%A9%EB%B2%95\">유저 모드 TEB 접근 방법</a></p>\n<ul>\n<li><a href=\"#ntdllntcurrentteb\">Ntdll.NtCurrentTeb()</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#fs-segment-register\">FS Segment Register</a></p>\n<ul>\n<li><a href=\"#fs0x18--teb-base-address\">FS:[0x18] = TEB base address</a></li>\n<li><a href=\"#fs0x30--peb-base-address\">FS:[0x30] = PEB base address</a></li>\n<li><a href=\"#fs0x0--seh-base-address\">FS:[0x0] = SEH base address</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"January 03, 2021","title":"TEB (Thread Environment Block)","categories":"Windows","author":"Zer0Luck","emoji":"🍬"},"fields":{"slug":"/window_4_theori/"}},"site":{"siteMetadata":{"siteUrl":"https://zer0luck.kr","comments":{"utterances":{"repo":"dnsdudrla97/dnsdudrla97.github.io"}}}}},"pageContext":{"slug":"/window_2_theori/","nextSlug":"/window_1_theori/","prevSlug":"/window_4_theori/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}