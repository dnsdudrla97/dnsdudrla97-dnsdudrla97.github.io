---
emoji: ğŸ¦ˆ
title: Sharky CTF Z3 Robot
author: Zer0Luck
date: '2020-08-14'
categories: CTF
tags: reversing Sharky CTF 
---

# ì·¨ì•½ì  ë¶„ì„ 

## ë°”ì´ë„ˆë¦¬ ì •ë³´
![./0.png](./0.png)

## ë°”ì´ë„ˆë¦¬ ì‹¤í–‰

![./1.png](./1.png)

- ì…ë ¥ ê°’ì„ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•˜ë©° ì„ì˜ì˜ ë¬¸ìì—´ì„ ì…ë ¥í•  ì‹œ `3Z Z3 z3 zz3 3zz33` í•´ë‹¹ ë¬¸ìì—´ì„ ì¶œë ¥í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

![./2.png](./2.png)

![./3.png](./3.png)

- `fgets` í•¨ìˆ˜ í˜¸ì¶œ ì¸ì `char *s`, `0x19`, `s1`
- `strcspn` í•¨ìˆ˜ í˜¸ì¶œ ì¸ì `const char *s1`, `const char *s2`, `s1`
    - str1ì— ìˆëŠ” ë¬¸ìì—´ì—ì„œ str2 ë¬¸ìê°€ ìˆì„ ê²½ìš° ê·¸ ë¬¸ì ê¹Œì§€ì˜ ê°œìˆ˜ë¥¼ ë¦¬í„´í•œë‹¤.

![./4.png](./4.png)

- flag ê°’ì„ ì–»ê¸° ìœ„í•´ì„œëŠ” `check_flag` í•¨ìˆ˜ë¥¼ ê±°ì³ì„œ ë°˜í™˜ ê°’ì´ 1ì´ì–´ì•¼ í•œë‹¤.

- ë°˜í™˜ ê°’ì„ ì–»ê¸° ê¹Œì§€ì˜ ì¡°ê±´ë“¤ì´ ë„ˆë¬´ ë”ëŸ½ë‹¤....

![./5.png](./5.png)

```cpp
_BOOL8 __fastcall check_flag(char *a1)
{
  return ((unsigned __int8)a1[20] ^ 0x2B) == a1[7]
      && a1[21] - a1[3] == -20
      && !(a1[2] >> 6)
      && a1[13] == 116
      && 4 * a1[11] == 380
      && a1[7] >> a1[17] % 8 == 5
      && ((unsigned __int8)a1[6] ^ 0x53) == a1[14]
      && a1[8] == 122
      && a1[5] << a1[9] % 8 == 392
      && a1[16] - a1[7] == 20
      && a1[7] << a1[23] % 8 == 190
      && a1[2] - a1[7] == -43
      && a1[21] == 95
      && ((unsigned __int8)a1[2] ^ 0x47) == a1[3]
      && *a1 == 99
      && a1[13] == 116
      && (a1[20] & 0x45) == 68
      && (a1[8] & 0x15) == 16
      && a1[12] == 95
      && a1[4] >> 4 == 7
      && a1[13] == 116
      && *a1 >> *a1 % 8 == 12
      && a1[10] == 95
      && (a1[8] & 0xAC) == 40
      && a1[16] == 115
      && (a1[22] & 0x1D) == 24
      && a1[9] == 51
      && a1[5] == 49
      && 4 * a1[19] == 456
      && a1[20] >> 6 == 1
      && a1[7] >> 1 == 47
      && a1[1] == 108
      && a1[3] >> 4 == 7
      && (a1[19] & 0x49) == 64
      && a1[4] == 115
      && ((unsigned __int8)a1[2] & (unsigned __int8)a1[11]) == 20
      && *a1 == 99
      && a1[4] + a1[5] == 164
      && a1[15] << 6 == 6080
      && ((unsigned __int8)a1[10] ^ 0x2B) == a1[17]
      && ((unsigned __int8)a1[12] ^ 0x2C) == a1[4]
      && a1[19] - a1[21] == 19
      && a1[12] == 95
      && a1[15] >> 1 == 47
      && a1[19] == 114
      && a1[17] + a1[18] == 168
      && a1[22] == 58
      && ((unsigned __int8)a1[23] & (unsigned __int8)a1[21]) == 9
      && a1[6] << a1[19] % 8 == 396
      && a1[3] + a1[7] == 210
      && (a1[22] & 0xED) == 40
      && (a1[12] & 0xAC) == 12
      && ((unsigned __int8)a1[18] ^ 0x6B) == a1[15]
      && (a1[16] & 0x7A) == 114
      && (*a1 & 0x39) == 33
      && ((unsigned __int8)a1[6] ^ 0x3C) == a1[21]
      && a1[20] == 116
      && a1[19] == 114
      && a1[12] == 95
      && a1[2] == 52
      && a1[23] == 41
      && a1[10] == 95
      && ((unsigned __int8)a1[22] & (unsigned __int8)a1[9]) == 50
      && a1[3] + a1[2] == 167
      && a1[17] - a1[14] == 68
      && a1[21] == 95
      && ((unsigned __int8)a1[19] ^ 0x2D) == a1[10]
      && 4 * a1[12] == 380
      && a1[6] & 0x40
      && ((unsigned __int8)a1[12] & (unsigned __int8)a1[22]) == 26
      && a1[7] << a1[19] % 8 == 380
      && ((unsigned __int8)a1[20] ^ 0x4E) == a1[22]
      && a1[6] == 99
      && a1[12] == a1[7]
      && a1[19] - a1[13] == -2
      && a1[14] >> 4 == 3
      && (a1[12] & 0x38) == 24
      && a1[8] << a1[10] % 8 == 15616
      && a1[20] == 116
      && a1[6] >> a1[22] % 8 == 24
      && a1[22] - a1[5] == 9
      && a1[7] << a1[22] % 8 == 380
      && a1[22] == 58
      && a1[16] == 115
      && ((unsigned __int8)a1[23] ^ 0x1D) == a1[18]
      && a1[23] + a1[14] == 89
      && ((unsigned __int8)a1[5] & (unsigned __int8)a1[2]) == 48
      && (a1[15] & 0x9F) == 31
      && a1[4] == 115
      && ((unsigned __int8)a1[23] ^ 0x4A) == *a1
      && ((unsigned __int8)a1[6] ^ 0x3C) == a1[11];
}
```

- í•´ë‹¹ ì¡°ê±´ì„ ë””ì»´íŒŒì¼ í•œ ê²°ê³¼ ì¡°ê±´ì„ ë§Œì¡±í•  ì‹œ ë°˜í™˜ ë˜ëŠ” ê°’ì€ 1ì´ë‹¤. ë¬¸ì œ ì œëª© ì²˜ëŸ¼ Z3ë¥¼ í†µí•´ í’€ì–´ë³´ë„ë¡ í•˜ê² ë‹¤.

# í•´ê²° ë°©ì•ˆ
```python
from z3 import *

s = Solver()
a1 = []

# ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ë“¤ì–´ê°ˆ ì¸í’‹ì„ BitVec íƒ€ì…ìœ¼ë¡œ ì •ì˜í•œë‹¤.
for x in range(25):
    a1.append(BitVec(x, 8))

s.add((a1[20] ^ 0x2B) == a1[7])
s.add(a1[21] - a1[3] == -20)
s.add((a1[2] >> 6) == 0)
s.add(a1[13] == 116)
s.add(4 * a1[11] == 380)
s.add(a1[7] >> (a1[17] % 8) == 5)                
s.add((a1[6] ^ 0x53) == a1[14])
s.add(a1[8] == 122)
s.add(a1[5] << (a1[9] % 8) == 392)
s.add(a1[16] - a1[7] == 20)
s.add(a1[7] << (a1[23] % 8) == 190)
s.add(a1[2] - a1[7] == -43)
s.add(a1[21] == 95)
s.add((a1[2] ^ 0x47) == a1[3])
s.add(a1[0] == 99)
s.add(a1[13] == 116)
s.add((a1[20] & 0x45) == 68)
s.add((a1[8] & 0x15) == 16)
s.add(a1[12] == 95)
s.add(a1[4] >> 4 == 7)
s.add(a1[13] == 116)
s.add(a1[0] >> (a1[0] % 8) == 12)
s.add(a1[10] == 95)
s.add((a1[8] & 0xAC) == 40)
s.add(a1[16] == 115)
s.add((a1[22] & 0x1D) == 24)
s.add(a1[9] == 51)
s.add(a1[5] == 49)
s.add(4 * a1[19] == 456)
s.add(a1[20] >> 6 == 1)
s.add(a1[7] >> 1 == 47)
s.add(a1[1] == 108)
s.add(a1[3] >> 4 == 7)
s.add((a1[19] & 0x49) == 64)
s.add(a1[4] == 115)
s.add(a1[2] & a1[11] == 20)
s.add(a1[0] == 99)
s.add(a1[4] + a1[5] == 164)
s.add(a1[15] << 6 == 6080)
s.add(a1[10] ^ 0x2B == a1[17])
s.add(a1[12] ^ 0x2C == a1[4])
s.add(a1[19] - a1[21] == 19)
s.add(a1[12] == 95)
s.add(a1[15] >> 1 == 47)
s.add(a1[19] == 114)
s.add(a1[17] + a1[18] == 168)
s.add(a1[22] == 58)
s.add(a1[23] & a1[21] == 9)
s.add(a1[6] << (a1[19] % 8) == 396)
s.add(a1[3] + a1[7] == 210)
s.add((a1[22] & 0xED) == 40)
s.add((a1[12] & 0xAC) == 12)
s.add((a1[18] ^ 0x6B) == a1[15])
s.add((a1[16] & 0x7A) == 114)
s.add((a1[0] & 0x39) == 33)
s.add((a1[6] ^ 0x3C) == a1[21])
s.add(a1[20] == 116)
s.add(a1[19] == 114)
s.add(a1[12] == 95)
s.add(a1[2] == 52)
s.add(a1[23] == 41)
s.add(a1[10] == 95)
s.add((a1[22] & a1[9]) == 50)
s.add(a1[3] + a1[2] == 167)
s.add(a1[17] - a1[14] == 68)
s.add(a1[21] == 95)
s.add((a1[19] ^ 0x2D) == a1[10])
s.add(4 * a1[12] == 380)
s.add(a1[6] & 0x40 >= 1)
s.add((a1[12] & a1[22]) == 26)
s.add(a1[7] << (a1[19] % 8) == 380)
s.add((a1[20] ^ 0x4E) == a1[22])
s.add(a1[6] == 99)
s.add(a1[12] == a1[7])
s.add(a1[19] - a1[13] == -2)
s.add(a1[14] >> 4 == 3)
s.add((a1[12] & 0x38) == 24)
s.add(a1[8] << (a1[10] % 8) == 15616)
s.add(a1[20] == 116)
s.add(a1[6] >> (a1[22] % 8) == 24)
s.add(a1[22] - a1[5] == 9)
s.add(a1[7] << (a1[22] % 8) == 380)
s.add(a1[22] == 58)
s.add(a1[16] == 115)
s.add((a1[23] ^ 0x1D) == a1[18])
s.add(a1[23] + a1[14] == 89)
s.add((a1[5] & a1[2]) == 48)
s.add((a1[15] & 0x9F) == 31)
s.add(a1[4] == 115)
s.add((a1[23] ^ 0x4A) == a1[0])
s.add((a1[6] ^ 0x3C) == a1[11])

# ì•ì˜ ì¡°ê±´ì„ ë§Œì¡±í•œë‹¤ë©´ Solver í´ë˜ìŠ¤ì˜ ë§Œì¡± ê²°ê³¼ê°€ ì¶©ì¡±í•˜ëŠ”ì§€ ê²€ì‚¬í•œë‹¤.
assert s.check() == sat

model = s.model()

flag =''
for i in range(len(model)):
    flag +=chr(model[a1[i]].as_long())

print flag
```

- SAT (Boolean SATisfiability problem)
    - ì£¼ì–´ì§„ Boolean ì‹ì„ ì¶©ì¡±ì‹œí‚¤ëŠ” í•´ (Trueë¡œ í‘œí˜„ë˜ëŠ” í•´)ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ê²°ì •í•˜ëŠ” ë¬¸ì œ
    - SATëŠ” ëª…ì œë…¼ë¦¬ì‹ì´ê¸° ë•Œë¬¸ì— ê° ë³€ìˆ˜ì— True/Falseë§Œ í• ë‹¹í•œë‹¤.

``` toc
```