---
emoji: ğŸš²
title: TWCTF2016 ReverseBox ë¶„ì„
author: Zer0Luck
date: '2020-08-14'
categories: CTF
tags: reversing TWCTF
---

# ì·¨ì•½ì  ë¶„ì„

## ë°”ì´ë„ˆë¦¬ ì •ë³´
```python
reverse_box: ELF 32-bit LSB executable
Intel 80386, version 1 (SYSV)
dynamically linked, interpreter /lib/ld-linux.so.2
for GNU/Linux 2.6.24, BuildID[sha1]=5403acba0427c34695b1ebda8f0c678905b33456, stripped
```

- í•´ë‹¹ ë°”ì´ë„ˆë¦¬ë¥¼ ì˜¬ë°”ë¥¸ í”Œë˜ê·¸ì™€ í•¨ê»˜ ì‹¤í–‰í–ˆì„ ë•Œì˜ ì•„ì›ƒí’€ ì •ë³´ë¥¼ ë³´ì—¬ì¤€ë‹¤.

![./0.png](./0.png)

## main í•¨ìˆ˜ ë¶„ì„

![./1.png](./1.png)

- `unsigned int` í˜•ì˜ `auStack276` ë°°ì—´ì€ `init_table` í•¨ìˆ˜ë¡œ ì´ˆê¸°í™”ê°€ ë˜ì–´ì§€ë©°
- argvì˜¤ ì…ë ¥í•œ ê¸¸ì´ ë§Œí¼ ë£¨í‹´ì„ ëŒë©´ì„œ `auStack276` ì˜ ì¸ë±ìŠ¤ ë¡œ ì‚¬ìš©ë˜ì–´ í•´ë‹¹ ê°’ì„ ì¶œë ¥í•œë‹¤.
- ì¸ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , ê³„ì‚° í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ ê²°ê³¼ë¥¼ ì¶œë ¥í•œë‹¤.
- ì¶œë ¥ í˜•ì‹ì„ ë³´ë©´ 16ì§„ìˆ˜ í˜•ì‹ì˜ ê²°ê³¼ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.

## init_table í•¨ìˆ˜ ë¶„ì„

![./2.png](./2.png)

- do~while ë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ `arg_8`ì„ ì´ˆê¸°í™”í•œ í›„ ë‚˜ë¨¸ì§€ `arg_8`ì˜ ê°’ì€ 0ë²ˆì§¸ ê°’ì„ ì´ìš©í•´ ìƒì„±í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ìˆë‹¤.
- `arg_8[0]`ì— ì˜¬ ìˆ˜ ìˆëŠ” ê²½ìš°ì˜ ìˆ˜ëŠ” 256ì´ê¸° ë•Œë¬¸ì— ìƒì„±ë  ìˆ˜ìˆëŠ” `arg_8`ì˜ ìˆ˜ë„ 256ê°€ì§€ ì´ë‹¤.
- ì‹œê°„ì„ ë‚œìˆ˜ ì‹œë“œë¡œ ì‚¬ìš©í•˜ë©° ê²½ìš°ì˜ ìˆ˜ê°€ ë‹¤ìˆ˜ì´ë‹¤. í•´ë‹¹ ì–´ì…ˆë¸”ë¦¬ì–´ë¥¼ ì‚´í´ë³´ë„ë¡ í•œë‹¤.

![./3.png](./3.png)

- í•˜ìœ„ 2 ë¹„íŠ¸, ì¦‰ 0-ffì˜ ê²½ìš° ë‹¤ìŒ *ROR1* ê³„ì‚° ë§Œ ì·¨í•´ ë³´ê² ë‹¤.
- ì´ê²ƒì€ ì•Œê³ ë¦¬ì¦˜ì´ë©° ë‹¤ì‹œ ë˜ëŒë¦¬ìˆ˜ ì—†ë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë¸”ë¼ìŠ¤íŒ…ì˜ ì‚¬ìš©ì€ ì œí•œëœë‹¤.
- ì¡°ê±´
    1. 0-ff
    2. TWCTF (ì§€ì •ëœ í”Œë˜ê·¸ í˜•ì‹ì´ë©°, í•´ë‹¹ ë§¤ê°œ ë³€ìˆ˜ëŠ” ëŸ°íƒ€ì„ì— ì¶”ê°€ë˜ê³ , ì²« ë²ˆì§¸ ê²°ê³¼ëŠ” 95ì¸ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.)
        - boxì˜ ìƒì„±ì€ ì‹œê°„ì— ì˜í•´ ìƒì„±ëœ ë‚œìˆ˜ì™€ ê´€ë ¨ì´ ìˆì§€ë§Œ ìƒì„±ëœ ë‚œìˆ˜ëŠ” 1ë°”ì´íŠ¸ì— ë¶ˆê³¼í•˜ë‹¤
        - ì¦‰ 256 ê°œì˜ ê°€ëŠ¥ì„± ë§Œ ì¡´ì¬í•œë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ëª¨ë“  í…Œì´ë¸”ì„ íƒìƒ‰í•˜ì—¬ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ìˆë‹¤. ê°œì„ íŒì— ë”°ë¥´ë©´ ê¹ƒë°œì€ `TWCTF` ë¡œ ì‹œì‘í•œë‹¤.

![./4.png](./4.png)

- í•´ë‹¹ ë¬¸ìëŠ” ê³ ì •ëœ 12ìë¥¼ ìƒì„±í•œë‹¤.

```cpp
movzx   eax, byte ptr [esp+eax+1Ch]
movzx   eax, al
mov     [esp+4], eax
mov     dword ptr [esp], offset a02x ; "%02x"
call    _printf
```
- eax ë ˆì§€ìŠ¤í„°ëŠ” ì…ë ¥í•œ ë¬¸ìë¥¼ ì €ì¥í•œë‹¤.
- ê·¸ëŸ° ë‹¤ìŒ printf í•¨ìˆ˜ëŠ” eax ìœ„ì¹˜ ì—ì„œ [esp+1ch]ì˜ ë°°ì—´ ìš”ì†Œë¥¼ ì „ë‹¹í•œë‹¤.
- ê·¸ë˜ì„œ í•´ë‹¹ ë°°ì—´ì€ ìš°ë¦¬ì˜ ê²°ê³¼ë¥¼ ë‹´ê³  ìˆë‹¤.
- ìŠ¤íƒì˜ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í•˜ë©´ 268 ë°”ì´íŠ¸ 16ì§„ìˆ˜ ë°°ì—´ì´ í‘œì‹œë˜ê³  ë‚˜ì¤‘ì— ì‚¬ìš©í•˜ê¸° 
ìœ„í•´ arrayë¼ëŠ” ì´ì§„ íŒŒì¼ì— ë°°ì—´ì„ ì €ì¥í•œë‹¤.

- ë°”ì´ë„ˆë¦¬ íŒŒì¼ì„ ëª‡ ë²ˆ ì‹¤í–‰í•˜ë©´ ë°°ì—´ë„ ì–´ë–¤ ë°©ì‹ ìœ¼ë¡œë“  ë¬´ì‘ìœ„ í™” ëœë‹¤.
- ê³„ì‚° í•¨ìˆ˜ì—ì„œ ë°˜í™˜í•œ ì„ì˜ ê°’ê³¼ ê´€ë ¨ì´ ìˆì„ ìˆ˜ ìˆë‹¤.
- ë°”ì´ë„ˆë¦¬ íŒŒì¼ì„ ëª‡ ë²ˆ ë” ì‹¤í–‰í•˜ë©´ ë°°ì—´ì˜ ë‘ ë²ˆì§¸ ìš”ì†Œê°€ ê³„ì‚°ì—ì„œ í•­ìƒ ë‚œìˆ˜ì™€
ë™ì¼í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
- ë”°ë¼ì„œ ë°”ì´ë„ˆë¦¬ íŒŒì¼ì—ëŠ” ê¸°ë³¸ ë°°ì—´ì´ ìˆì–´ì•¼ í•˜ë©° ì„ì˜ì˜ ê°’ì„ ì‚¬ìš©í•˜ì—¬ ì–´ë–¤ ë°©ì‹
ìœ¼ë¡œë“  ì‘ë™í•´ì•¼ í•œë‹¤.
- ì—°ì‚°ì´ ë°œìƒí•  ë•Œë§ˆê°€ ê¸°ë³¸ ë°°ì—´ì˜ ë‘ ë²ˆì§¸ ìš”ì†Œê°€ 0ì´ì–´ì•¼ í•˜ê³  ë‚œìˆ˜ë¥¼ ì–»ëŠ”ë‹¤.
- ë°”ì´ë„ˆë¦¬ê°€ ìˆ˜í–‰í•˜ëŠ” ì‘ì—…ì˜ ì¢…ë¥˜ë¥¼ ì´í•´í•´ ë³´ì
- ì´ì§„ ë°°ì—´ì„ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ì—ë¡œë“œí•˜ì—¬ ì´ë¥¼ ë‹¬ì„±í•œ ë‹¤ìŒ ì €ì¥í•œ ë°°ì—´ ìš”ì†Œì— ëŒ€í•´
ê°€ì •ëœ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì—¬ ê¸°ë³¸ ë°°ì—´ì„ ì–»ê³  ì´ì§„ íŒŒì¼ì„ ì‹¤í–‰í•  ë•Œ ì•Œë ¤ì§„ ì„ì˜ ê°’ì„ ì‚¬ìš©
í•˜ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ê²€ì¦ì„ ìœ„í•´ ë‹¤ë¥¸ ì„ì˜ ê°’ì„ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ë°”ì´ë„ˆë¦¬ ì‹¤í–‰ê³¼
ë¹„êµí•˜ì

- ì²« ë²ˆì§¸ ì˜µì…˜ì€ ê¸°ë³¸ ë°°ì—´ ê°’ì— ì„ì˜ì˜ ê°’ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì´ë‹¤.
- ë‘ ë²ˆì§¸ ìš”ì†Œì—ì„œ ì‘ë™í•˜ì§€ë§Œ ì´ í”„ë¡œì„¸ìŠ¤ë¥¼ ë‹¤ë¥¸ ë°”ì´ë„ˆë¦¬ ì‹¤í–‰ê³¼ ë¹„êµí•˜ëŠ” ê²ƒì€ ì‘ë™
í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ë‘ ë²ˆì§¸ ì¶”ì¸¡ì€ ë°”ì´ë„ˆë¦¬ íŒŒì¼ì´ ê¸°ë³¸ ë°°ì—´ ìš”ì†Œë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ì˜ ê°’ì„ XORí•˜ì—¬ ë‘ ë²ˆì§¸
ë°°ì—´ ìš”ì†Œê°€ ì„ì˜ ê°’ê³¼ ê°™ë„ë¡ í—ˆìš©í•œë‹¤.

- -> ìš°ë¦¬ê°€ ì €ì¥í•œ ë°°ì—´ê³¼ ë°”ì´ë„ˆë¦¬ ì‹¤í–‰ì˜ ì„ì˜ ê°’ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ ë°°ì—´ì„ ì–»ëŠ” ê²ƒì´ë‹¤

### gdb script

```bash
set $i=0 // $i=0 ì´ˆê¸°í™”
set $total=256 // 256ê°€ì§€ì˜ ê²½ìš°ì˜ ìˆ˜

while($i<$total) // 0~256 ê¹Œì§€ í•œ ë°”ì´íŠ¸ì”© ë£¨í‹´
  b *0x80485b4 // cmp     [ebp+var_C], 0
  b *0x8048707 // movzx   eax, al  

  run TWCTF // ì¸ì ê°’ TWCTF ->
  set $i=$i+1 // $i 1ì”© ì¦ê°€
  set *(char*)($ebp-0xc)=$i 
  continue // ê³„ì† í•´ì„œ ëŒë¦¬ë©´ì„œ 0x80485b4 ë¹„êµ ë£¨í‹´ì—ì„œ 1ì”© ì¦ê°€í•˜ë©´ì„œ 
  if ($eax==0x95) // ì¶œë ¥ëœ ê°’ì´ 0x95ë¡œ ì‹œì‘í•œë‹¤ ê·¸ëŸ¬ë©´ ì¶œë ¥í•´ì£¼ê³  
    print $i
    x/256xb $esp+0x1c
    set $i=256
  end
  stop
end
end
```

![./5.png](./5.png)

- ë°˜ë³µ 256ì˜ ê²½ìš°ì˜ ìˆ˜ë¥¼ ë§Œì¡±í•  ìˆ˜ ìˆë„ë¡

![./6.png](./6.png)

![./7.png](./7.png)

# í•´ê²° ë°©ì•ˆ

## solved Code

```python
#encoding=utf-8
correct='95eeaf95ef94234999582f722f492f72b19a7aaf72e6e776b57aee722fe77ab5ad9aaeb156729676ae7a236d99b1df4a'
box=[\
0xd6,0xc9,0xc2,0xce,0x47,0xde,0xda,0x70,\
0x85,0xb4,0xd2,0x9e,0x4b,0x62,0x1e,0xc3,\
0x7f,0x37,0x7c,0xc8,0x4f,0xec,0xf2,0x45,\
0x18,0x61,0x17,0x1a,0x29,0x11,0xc7,0x75,\
0x02,0x48,0x26,0x93,0x83,0x8a,0x42,0x79,\
0x81,0x10,0x50,0x44,0xc4,0x6d,0x84,0xa0,\
0xb1,0x72,0x96,0x76,0xad,0x23,0xb0,0x2f,\
0xb2,0xa7,0x35,0x57,0x5e,0x92,0x07,0xc0,\
0xbc,0x36,0x99,0xaf,0xae,0xdb,0xef,0x15,\
0xe7,0x8e,0x63,0x06,0x9c,0x56,0x9a,0x31,\
0xe6,0x64,0xb5,0x58,0x95,0x49,0x04,0xee,\
0xdf,0x7e,0x0b,0x8c,0xff,0xf9,0xed,0x7a,\
0x65,0x5a,0x1f,0x4e,0xf6,0xf8,0x86,0x30,\
0xf0,0x4c,0xb7,0xca,0xe5,0x89,0x2a,0x1d,\
0xe4,0x16,0xf5,0x3a,0x27,0x28,0x8d,0x40,\
0x09,0x03,0x6f,0x94,0xa5,0x4a,0x46,0x67,\
0x78,0xb9,0xa6,0x59,0xea,0x22,0xf1,0xa2,\
0x71,0x12,0xcb,0x88,0xd1,0xe8,0xac,0xc6,\
0xd5,0x34,0xfa,0x69,0x97,0x9f,0x25,0x3d,\
0xf3,0x5b,0x0d,0xa1,0x6b,0xeb,0xbe,0x6e,\
0x55,0x87,0x8f,0xbf,0xfc,0xb3,0x91,0xe9,\
0x77,0x66,0x19,0xd7,0x24,0x20,0x51,0xcc,\
0x52,0x7d,0x82,0xd8,0x38,0x60,0xfb,0x1c,\
0xd9,0xe3,0x41,0x5f,0xd0,0xcf,0x1b,0xbd,\
0x0f,0xcd,0x90,0x9b,0xa9,0x13,0x01,0x73,\
0x5d,0x68,0xc1,0xaa,0xfe,0x08,0x3e,0x3f,\
0xc5,0x8b,0x00,0xd3,0xfd,0xb6,0x43,0xbb,\
0xd4,0x80,0xe2,0x0c,0x33,0x74,0xa8,0x2b,\
0x54,0x4d,0x2d,0xa4,0xdc,0x6c,0x3b,0x21,\
0x2e,0xab,0x32,0x5c,0x7b,0xe0,0x9d,0x6a,\
0x39,0x14,0x3c,0xb8,0x0a,0x53,0xf7,0xdd,\
0xf4,0x2c,0x98,0xba,0x05,0xe1,0x0e,0xa3\
]

flag=''
for i in range(len(correct)//2):
    idx=box.index(int(correct[2*i:2*i+2],16))
    flag+=chr(idx)
print flag
```

## solved Code2

```c
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#define ROTL8(x, shift) ((uint8_t)((x) << (shift)) | ((x) >> (8 - (shift))))

// S-Box ê³„ì‚°
void init_table(uint8_t sbox[256], int t)
{
    sbox[0] = t;
    /* loop invariant: p * q == 1 in the Galois field => GF(2) */
    uint8_t p = 1, q = 1;

    do
    {
        /* multiply p by x+1 */
        p = p ^ (p << 1) ^ (p & 0x80 ? 0x1B : 0);
        /* divide q by x+1 */
        q ^= q << 1;
        q ^= q << 2;
        q ^= q << 4;
        q ^= q & 0x80 ? 0x09 : 0;
        /* compute the affine transformation */
        sbox[p] = sbox[0] ^ q ^ ROTL8(q, 1) ^ ROTL8(q, 2) ^ ROTL8(q, 3) ^ ROTL8(q, 4);
    } while (p != 1);
    /* 0 is a special case since it has no inverse */
}

int indexof(uint8_t sbox[256], uint8_t enc_c)
{
    int i;
    for (i = 0; i < 0x100; i++)
    {
        if (sbox[i] == enc_c)
        {
            return i;
        }
    }
    return 0;
}

int main(int argc, char *argv[])
{
    uint8_t sbox[256];
    uint8_t enc[] = "\x95\xee\xaf\x95\xef\x94\x23\x49\x99\x58\x2f\x72\x2f\x49\x2f\x72\xb1\x9a\x7a\xaf\x72\xe6\xe7\x76\xb5\x7a\xee\x72\x2f\xe7\x7a\xb5\xad\x9a\xae\xb1\x56\x72\x96\x76\xae\x7a\x23\x6d\x99\xb1\xdf\x4a";
    int i, j;

    for (j = 1; j < 0x100; j++)
    {
        init_table(sbox, j);
        for (i = 0; i < sizeof enc; ++i)
        {
            printf("%c", indexof(sbox, enc[i]));
        }
        putchar('\n');
    }

    return 0;
}
```
```toc
```