---
emoji: π¤­
title: "ν΄λΌμ°λ“ μ„λΉ„μ¤ μ·¨μ•½μ  λ¶„μ„ 6 (CloudGoat: EC2 SSRF)"
author: Zer0Luck
date: '2021-12-31'
categories: CLOUD
tags: Cloud Vulnerability Security
---
# ν΄λΌμ°λ“ μ„λΉ„μ¤ μ·¨μ•½μ  λ¶„μ„ 6

# [Scenario 5]: EC2 SSRF

```bash
Size: Medium
Difficulty: Moderate
Command: $ ./cloudgoat.py create ec2_ssrf
```

## μ‹λ‚λ¦¬μ¤ κ°μ”

### μμ›

- VPC (EC2)
- Lambda Function
- 1 S3 Bucket

### μ·¨μ•½μ 

- Solus IAM μ‚¬μ©μ
- Lambda ν•¨μ μ½κΈ° μ „μ© κ¶ν•
- Lambda ν™κ²½ λ³€μμ•μ— ν•λ“μ½”λ”©λ Wrex Access key
- ν•λ“μ½”λ”©λ λ―Όκ°ν• λ°μ΄ν„° μ •λ³΄
- μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ SSRF μ·¨μ•½μ μΌλ΅ μΈν• AWS λ©”νƒ€λ°μ΄ν„° APIλ¥Ό ν†µν•΄μ„ λ‹¤λ¥Έ Credential μ ‘κ·Ό κ°€λ¥ μ—¬λ¶€
- Admin Credential μ •λ³΄κ°€ S3 Bucket λ‚΄μ— ν•λ“ μ½”λ”©λμ–΄ μ €μ¥

### λ©ν‘

- `cg-lambda-/cloud goat id/` λλ‹¤ ν•¨μλ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤.
- Solus IAM μ‚¬μ©μλ΅ μ‹μ‘ν•΄μ„ Lambda ν•¨μλ¥Ό μ½μ„ μ μλ” κ¶ν•μ„ λ°κ²¬ν•μ€μµλ‹λ‹¤.
- SSRFμ— μ·¨μ•½ν• μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ„ μ‹¤ν–‰ν•λ” EC2 μΈμ¤ν„΄μ¤λ΅ μ λ„ν•©λ‹λ‹¤.
- μ·¨μ•½ν• μ•±μ„ Exploitν•κ³  EC2 Metadata Serviceμ—μ„ Keyλ¥Ό νλ“ν• ν›„ κ³µκ²©μλ” Lambda ν•¨μλ¥Ό νΈμ¶ν•κ³  μ‹λ‚λ¦¬μ¤λ¥Ό μ™„λ£ν•  μ μλ” Keyλ¥Ό νλ“ν•¨μΌλ΅μ¨ κ¶ν•μ„ νƒμ·¨λ¥Ό ν•©λ‹λ‹¤.

### exploit νλ¦„λ„

![31.png](./31.png)

### μ‹λ‚λ¦¬μ¤ ν™κ²½μ„¤μ •

![](./0.png)

### exploit μ‹λ‚λ¦¬μ¤ νλ¦„λ„

1. IAM μ— ν¬ν•¨λ Solus κ³„μ •μ„ ν† λ€λ΅ AWS ν™κ²½μ„ λ¶„μ„ν•κ³  κ³„μ •μ—μ„ Lambda ν•¨μ λ¦¬μ¤νΈλ“¤μ΄ μμμ„ ν™•μΈν•μ€μµλ‹λ‹¤.
2. Lambda ν•¨μ λ‚΄μ—μ„ κ³µκ²©μλ” λ‹¤λ¥Έ μ‚¬μ©μμ¦‰ IAM μ‚¬μ©μ Wrexμ— μ†ν• AWS Access keyλ¥Ό μ°Ύμµλ‹λ‹¤.
3. IAM Wrex μ‚¬μ©μ λ΅ μ‘λ™ν•λ” κ³µκ²¨μλ” SSRF μ·¨μ•½μ μ— μ·¨μ•½ν• μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ„ μ‹¤ν–‰ν•λ” EC2 μΈμ¤ν„΄μ¤λ¥Ό λ°κ²¬ν•©λ‹λ‹¤.
4. GET λ©”μ„λ“λ΅ μ”μ²­μ„ λ³΄λ‚Όλ• `url` νλΌλ―Έν„°λ¥Ό ν†µν•΄ SSRF μ·¨μ•½μ μ„ νΈλ¦¬κ±°ν•μ—¬ κ³µκ²©μλ” EC2 Metadata serviceμ—μ„ AWS ν‚¤λ¥Ό νƒμ·¨ν•©λ‹λ‹¤.
5. κ³µκ²©μλ” EC2 μΈμ¤ν„΄μ¤μ ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ κ¶ν•μ΄ λ” λ†’μ€ μ‚¬μ©μμΈ Shepardμ— λ€ν• λ‹¤λ¥Έ AWS Credential κ°€ ν¬ν•¨λ Private S3 Bucketμ„ λ°κ²¬ν•μ€μµλ‹λ‹¤.
6. Full PrivilegeμΌλ΅ ShepeardμΈμ²™ κ³µκ²©μλ” μ›λμ Lambda ν•¨μλ¥Ό νΈμ¶ν•μ—¬ μ‹λ‚λ¦¬μ¤κ°€ μ™„λ£λ©λ‹λ‹¤

```jsx
IAM : Solus (Read Only Key Access)

Lambda function list -> Secret key

Wrex <-
```

## Exploit μ‹λ‚λ¦¬μ¤

### Solus key μ •λ³΄λ¥Ό μ½κΈ°μ „μ©μ„ μ ‘κ·Ό

![](./1.png)

- ν•΄λ‹Ή ν΄λΌμ°λ“ ν™κ²½μ„ λ¶„μ„ν•λ©΄μ„ `start.txt` λ¬Έμ„λ΅ AWS Credential μ •λ³΄λ¥Ό μ½κΈ° μ „μ©μΌλ΅ ν•΄λ‹Ή μ •λ³΄λ¥Ό ν™•μΈν•  μ μμµλ‹λ‹¤.
- AWS Credential μ„ μ‚¬μ©ν•μ—¬ μ–΄λ–¤ AWS μ‘μ—…μ„ ν•  μ μλ”μ§€ ν™•μΈν•κΈ° μ„ν•΄ IAM λ¦¬μ¤νΈλ¥Ό μ—΄κ±°ν•μ—¬ μ •λ³΄λ¥Ό ν™•μΈν•μ€μµλ‹λ‹¤.

![](./2.png)

- ν•΄λ‹Ή λ¦¬μ¤νΈλ¥Ό ν†µν•΄μ„ Lambda μ„λΉ„μ¤λ¥Ό μ΄μ©ν•  μμλ” λ²΅ν„°κ°€ μ΅΄μ¬ν•λ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤. μ΄μ— κ΄€ν•΄μ„ μΆ€λ” λ¶„μ„μ„ ν•κΈ°λ΅ ν–μµλ‹λ‹¤.

### Lambda ν™κ²½ λ³€μ λ°μ΄ν„° ν™•μΈ

![](./3.png)

- Pacuλ¥Ό ν†µν•΄μ„ lambda service μ—μ„ `cg-lambda-id` νΈμ¶ν•λ” κ°’μ΄ μλ” μ§€ ν™•μΈν• κ²°κ³Ό ENV κ°’μΌλ΅ EC2_ACCESS_KEY_ID, SECRET_KEY_ID κ°€ μλ” κ²ƒμ„ ν™•μΈν•  μ μμ—μµλ‹λ‹¤.

```jsx
[+] Secret (ENV): EC2_ACCESS_KEY_ID= <ACCESS_KEY>
[+] Secret (ENV): EC2_SECRET_KEY_ID= <ACCESS_SECRET_KEY>
```


- λ€μƒ λλ‹¤ ν•¨μλ” AWS κ³„μ •μ— μ΅΄μ¬ν•κ³  lambda ν•¨μμ ν™κ²½λ³€μμ— μΌλ¶€ ν•λ“ μ½”λ”©μ΄ λμ—μ΄κΈ° λ–„λ¬Έμ— μ΄λ” AWS Security Credentialμ΄ μλ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

![](./4.png)

- μ‚¬μ©μ Solusμ—κ² `lambda:InvokeFunction` κ¶ν• μ΄ μ—†κΈ° λ•λ¬Έμ— μ§μ ‘ Lambda ν•¨μλ¥Ό νΈμ¶ν•λ ¤λ” μ‹λ„κ°€ λ™μ‘ν•μ§€λ¥Ό μ•μµλ‹λ‹¤.

![](./5.png)

### Lambda κΈ°λ¥ λ‚μ—΄ λ° λ¶„μ„

- lambda ν™κ²½ λ³€μμ—μ„ μ μ¶λ AWS Credential μ„ PACU `run aws__enum_account` μ‚¬μ©ν•΄μ„ μ¶”κ°€λ΅ λ‚μ—΄ν•μ—¬ μ–΄λ–¤ Credential μ΄ μλ”μ§€ ν™•μΈν•μ€μµλ‹λ‹¤.
- ν•΄λ‹Ή Credentialμ„ ν™•μΈν•΄λ³΄λ©΄ IAM μ‚¬μ©μλ” wrexλΌλ” κ²ƒμ„ ν™•μΈν• μ μμµλ‹λ‹¤.
- ν•΄λ‹Ή Wrexμ μ •λ³΄λ¥Ό ν† λ€λ΅ IAMμ—μ„ μ‚¬μ©ν•  μ μλ” μ„λΉ„μ¤λ¥Ό ν™•μΈν•μ€μµλ‹λ‹¤.

![](./6.png)

- μƒκ°λ³΄λ‹¤ λ§μ€ μ„λΉ„μ¤μ— λ€ν•΄ κ¶ν•μ„ κ°–κ³  μλ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤. μ‹¤ν–‰μ¤‘μΈ EC2 μΈμ¤ν„΄μ¤κ°€ μλ”μ§€λ¥Ό ν™•μΈν•κ² μµλ‹λ‹¤.

![](./7.png)

- μ „μ²΄ μ§€μ—­μ„ λ€μƒμΌλ΅ ec2μ—μ„ μ‚¬μ©λκ³  μλ” μ „μ²΄μ μΈ μ •λ³΄λ¥Ό ν™•μΈν•μ€μµλ‹λ‹¤. ν•„μ”ν• μ •λ³΄λ“¤μ„ μ¶”λ ¤λ‚΄κΈ°μ„ν•΄ μ„Έμ„Έν• μ •λ³΄λ“¤μ€ aws query λ¬Έμ„ ν†µν•΄ μ†μ κ²€μ‚¬λ¥Ό μ§„ν–‰ν•μ€μµλ‹λ‹¤.

![](./8.png)

- μΈμ¤ν„΄μ¤μ μƒνƒμ™€ λ™μ‘μ¤‘μΈ μ„λΉ„μ¤λ¥΄ ν™•μΈν•μ€μ§€λ§ κΈ°μ΅΄μ μΈμ¤ν„΄μ¤λ¥΄ μ μ™Έν•κ³ λ” μ •ν™•ν• μ„λΉ„μ¤ μ •λ³΄λ¥Ό ν™•μΈν•  μ μ—†μ—μµλ‹λ‹¤.

### EC2 λ‚΄μ—μ„ λ™μ‘μ¤‘μΈ μ›Ή μ„λΉ„μ¤ νμ•… λ° λ¶„μ„

- μΆ€λ” μ •ν™•ν• μ„λΉ„μ¤λ¥Ό νμ•…ν•κΈ° μ„ν•΄μ„ μƒλ΅μ΄ μΈμ¤ν„΄μ¤λ¥Ό μ‹μ‘ν•κ³  μ‹¤ν–‰ μ¤‘μΈ μ„λΉ„μ¤κ°€ μλ”μ§€ ν™•μΈν•κ² μµλ‹λ‹¤.

![](./9.png)

- EC2 μΈμ¤ν„΄μ¤μ— μ—°κ²°λ λ³΄μ• κ·Έλ£Ήμ€ μ›Ή μ„λΉ„μ¤κ°€ μ‹¤ν–‰μ¤‘μΈ μƒνƒλ΅ λ‚νƒ€λ‚©λ‹λ‹¤.

![](./10.png)

- νΉμ • μ„λ²„μ μ—°κ²°ν•κΈ° μ„ν•΄ κ³µμ© IP μ£Όμ†λ¥Ό ν™•μΈν•μ€μµλ‹λ‹¤.

![](./11.png)

- 80 portμ—μ„ μ‹¤ν–‰λλ” μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ΄ μλ” κ²ƒμ„ μ¶”μ •ν•  μ κ°€ μκ³  μ΄μ— λ”°λΌ Node js μ—λ¬λ©”μ‹μ§€λ¥Ό ν™•μΈν• κ²°κ³Ό `URL` μ΄λΌλ” νλΌλ―Έν„° κ°’μ— λ¬Έμμ—΄μ΄ μ•„λ‹ NULL κ°’μ΄ λ“¤μ–΄κ°€ μμ–΄ μ—λ¬κ°€ λ‚κ²ƒμ„ ν™•μΈν•  μμμΌλ©° μ΄μ— λ”°λΌ `URL` νλΌλ―Έν„°μ— νΉμ • λ¬Έμμ—΄ νƒ€μ…μ„ μ…λ ¥ν•΄ λ³΄μ•μµλ‹λ‹¤.

![](./12.png)

![](./13.png)

### SSRF μ·¨μ•½μ  λ¶„μ„λ° IMDS κΈ°λ¥μ„ μ΄μ©ν• μ •λ³΄ νƒμ·¨

- ν•΄λ‹Ή μ›Ή μ„λ²„κ°€ SSRF μ·¨μ•½μ μ΄ μ΅΄μ¬ν•λ”μ§€λ¥Ό ν™•μΈν•κΈ° μ„ν•΄μ„ `link address` λ¥Ό μ…λ ¥ ν•¨μΌλ΅μ¨ μ¶λ ¥λλ” κ²°κ³Όλ¥Ό ν™•μΈν•μ€μµλ‹λ‹¤.

![](./14.png)

- ν™•μΈν• κ²°κ³Ό μ¶λ ¥λλ” κ°’μ—λ” ν•΄λ‹Ή μΈμ¤ν„΄μ¤μ ν™κ²½ μ •λ³΄λ“¤μ„ ν™•μΈν•  μ μμ—μµλ‹λ‹¤.
- μ΄λ¥Ό λ°”νƒ•μΌλ΅ μ• ν”λ¦¬μΌ€μ΄μ…μ€ SSRFμ— μ·¨μ•½ν•κ³  EC2 μΈμ¤ν„΄μ¤μ— μκΈ° λ•λ¬Έμ— IMDSv1μ„ ν™μ©ν•μ—¬ IAM Rule credentialsμ„ νƒμ·¨ν•  κ²ƒμ…λ‹λ‹¤.

![](./15.png)

```jsx
cg-ec2-role-ec2_ssrf_cgid84kpkl3ssy
```

- ν•΄λ‹Ή Security-credential μ •λ³΄λ¥Ό ν™•μΈν•  μ μκ³ 

![](./16.png)

```jsx
{ "Code" : "Success",
"LastUpdated" : "2021-08-13T12:26:30Z",
"Type" : "AWS-HMAC",
"AccessKeyId" : "<ACCESS_KEY>",
"SecretAccessKey" : "<ACCESS_SECRET_KEY>",
"Token" : "<ACCESS_SESSION_KEY>",
"Expiration" : "2021-08-13T18:44:43Z" }
```

- νƒμ·¨ν• IAM Rule Credential μ€ λ‹¤λ¥Έ IAM Credential μ²λΌ μ‚¬μ©μ΄ κ°€λ¥ν•©λ‹λ‹¤. μ΄λ¥Ό μ΄μ©ν•μ—¬ Rule Credentialμ„ μ‚¬μ©ν•μ—¬ μν–‰ν•  μ μλ” μ‘μ—…μ„ μ—΄κ±°ν•κΈ° μ„ν•΄ AWS CLIλ¥Ό μ‚¬μ©ν•μ—¬ μƒλ΅μ΄ ν”„λ΅ν•„μ„ μƒμ„±ν•μ§€λ§ IAM Rule Credential μ€ Life-cycleμ΄ μ§§μ€ Session_tokenμ΄ μμµλ‹λ‹¤.
- μ΄λ¥Ό ν†µν•΄ μƒλ΅­κ² μ¶”κ°€λ¥Ό ν•μ€μµλ‹λ‹¤.

![](./17.png)

![](./18.png)

- νƒμ·¨ν• IAM AWS Credential μ •λ³΄λ¥Ό ν†µν•΄μ„ μ‚¬μ©κ°€λ¥ν• λ‚μ—΄μ„ ν•μ—¬ `s3.list_buckets` μ‘μ—…μ΄ μ‘λ™ μ¤‘μΈ κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

### S3 Bucketλ‚΄μ—μ„ λ°μ΄ν„° λ° Credential λ¶„μ„, μ¶”μ¶ λ° ν•¨μ νΈμ¶

- S3κ°€ μ‘λ™μ¤‘μ΄λ‹ ν•΄λ‹Ή λ°μ΄ν„°λ¥Ό pacu λ„κµ¬λ¥Ό ν†µν•΄ λ‹¤μ΄λ΅λ“λ¥Ό λ°›μ•„λ΄¤μµλ‹λ‹¤.

![](./19.png)

![](./20.png)

- λ‹¤μ΄ λ°›μ€ λ°μ΄ν„°λ¥Ό ν†µν•΄ AWS Credential κ°’μ΄ λ“¤μ–΄ μλ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤. λ λ‘κ°™μ΄ ν•΄λ‹Ή λ°μ΄ν„°λ¥Ό ν†µν•΄ μƒλ΅μ΄ ν”„λ΅ν•„μ„ λ§λ“¤μ–΄ λ³΄κ² μµλ‹λ‹¤.

![](./21.png)

- μƒμ„±λ ν”„λ΅νμΌμ— κΈ°λ°ν•μ—¬ μ–΄λ–¤ μ μ €μ—κ² μ†ν•λ”μ§€λ¥Ό νμ•…ν•κΈ° μ„ν•΄ `get-caller-identity` cmdλ¥Ό μ΄μ©ν•μ—¬ ν™•μΈν•μ€μµλ‹λ‹¤.

![](./22.png)

- ν™•μΈν• κ²°κ³Ό `shepard` μ μ €μ—κ² μ°Έμ΅°κ°€ λκ³  μκ³  μ΄μ— λ€ν• μ •μ±…μ„ μ‹λ³„ν•΄λ΄¤μµλ‹λ‹¤.

![](./23.png)

- IAM μ‚¬μ©μ `shepard-ec2_ssrf_cgid84kpkl3ssy` μ— μ—°κ²°λ μ •μ±…μ— λ€ν• κ¶ν•μ„ ν™•μΈν•μ—¬ λ‹¤μ κ³µκ²© λ°©ν–¥μ„ μ΅μ•μµλ‹λ‹¤.

![](./24.png)

- μμƒλ°λ΅ IAM μ‚¬μ©μ "shepard"λ΅μ„ AWS κ³„μ •μ— λ€ν• κ΄€λ¦¬μ μ ‘κ·Ό κ¶ν•μ„ κ°–κ³  μμ—μµλ‹λ‹¤. ν•΄λ‹Ή AWS Credentialμ„ μ‚¬μ©ν•μ—¬ `cg-lambda-ec2_ssrf_cgid84kpkl3ssy` Lambda ν•¨μλ¥Ό νΈμ¶ν•κ² μµλ‹λ‹¤.

![](./25.png)

```toc
```