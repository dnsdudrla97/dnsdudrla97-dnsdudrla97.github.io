---
emoji: π¦©
title: CodeGate2017 angrybird λ¶„μ„
author: Zer0Luck
date: '2020-08-15 13:12:21'
categories: CTF
tags: reversing CodeGate CTF
---

# μ·¨μ•½μ  λ¶„μ„

## Angry Bird λ°”μ΄λ„λ¦¬ λ™μ‘ κ²°κ³Ό


![./0.png](./0.png)

- λ°”μ΄λ„λ¦¬ μ‹¤ν–‰μ‹ μ•„λ¬΄ κ²°κ³Όκ°€ μ•λ‚μ¤λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

## main ν•¨μ λ¶„μ„

![./1.png](./1.png)

- `Stack Smahsing Protector(SSP)` λ³΄νΈκΈ°λ²•μ΄ μ μ©λμ–΄ μμ–΄ Stack Prlogλ¥Ό κ±°μΉλ©΄μ„ `Stack Canary` λ¥Ό `rax` λ μ§€μ¤ν„°μ— `TEB`μ—μ„ μƒμ„±λ κ°’μ„ κ°€μ Έμ™€ ν•΄λ‹Ή κ°’μ„ μ¤νƒμ— μ§‘μ–΄λ„£λ” κ²ƒμ„ ν™•μΈν•  μκ°€ μμΌλ©°
- `eax` λ μ§€μ¤ν„°λ¥Ό 0μΌλ΅ μ΄κΈ°ν™” ν•ν›„ 0κ³Ό λΉ„κµλ¥Ό ν•μ—¬ `exit` ν•¨μλ΅ μ ν”„ν•λ” κ²ƒμ„ λ³Ό μ μλ‹¤.
- κ·Έλμ„, ν•΄λ‹Ή λ°”μ΄λ„λ¦¬λ¥Ό μ‹¤ν–‰ν•μ€μ„ λ• λ°”λ΅ λλ‚λ” λ¨μµμ„ ν™•μΈν•  μ μλ‹¤.

## Nop Sled μ μ©

![./2.png](./2.png)

- `_exit` Hex κ°’μ„ 90(Nop)μΌλ΅ ν¨μΉν•μ—¬ μ ν”„λ¥Ό λ›°μ–΄λ„ λλ‚  μ μ—†λ„λ΅ μ§„ν–‰ν•μ€λ‹¤.

![./3.png](./3.png)

![./4.png](./4.png)

- λ””λ²„κ±°λ¥Ό λ°”νƒ•μΌλ΅ `_exit` ν•¨μλ΅ μ ν”„ν•λ” κ²ƒμ€ μ°νλ¥Ό ν•μ—¬ `you shoul return 21 not 1 :(` λ¬Έμμ—΄μ„ λ°ν™ν•λ” κ²ƒμ„ ν™•μΈν•  μμλ‹¤.

## you should return 21 not 1 :(

- μ¶λ ¥λ κ²°κ³Όλ¥Ό ν™•μΈν•΄ λ³΄λ©΄ 21μ„ λ°ν™ν•΄μ•Ό ν•λ‹¤κ³  ν•λ‹¤.
- ν•΄λ‹Ή ν•¨μλ¥Ό λ¶„μ„ν•΄λ³΄λ„λ΅ ν•κ² λ‹¤.

## Sub_4006F6 ν•¨μ λ¶„μ„

![./5.png](./5.png)

- μ•μ λ¬Έμμ—΄μ„ μ¶λ ¥ν• ν•¨μ λΈ”λ΅ λ‚΄λ¶€μ΄λ©° λ°ν™ λλ” κ°’ `dword_606060` μμ—­μ„ ν™•μΈν•΄λ³΄μ

![./6.png](./6.png)

- ν™•μΈ κ²°κ³Ό `1`μ„ λ‹΄κ³  μλ” κ²ƒμ„ ν™•μΈν•μ€λ‹¤.
- μ°λ¦¬λ” 21μ„ λ°ν™ν•΄μ•Ό ν•κΈ° λ•λ¬Έμ— `21` λ΅ ν¨μΉν•λ„λ΅ ν•λ‹¤.

![./7.png](./7.png)

- ν•μ§€λ§ μ¤‘μ”ν• μ‚¬μ‹¤μ€ λ°ν™λ κ²°κ³Ό κ°’μ„ mov λ…λ Ήμ–΄λ¥Ό λ°”νƒ•μΌλ΅ `[rbp+n]` λ€μ… ν•λ” κ²ƒμ„ ν™•μΈν•  μ μλ” λ° OPER2μ— ν•΄λ‹Ήν•λ” `eax` λ μ§€μ¤ν„°λ” 32bit ν•μ‹μ΄κΈ°μ— `mov` λ…λ Ήμ„ μ‚¬μ©ν•κ² λλ©΄ μ„±μ§μ΄ λ§μ§€ μ•μ•„ `Segment Falut` κ°€ λ¨κ³  λ§λ‹¤.

![./8.png](./8.png)

![./9.png](./9.png)

- `NOP` λ…λ ΉμΌλ΅ ν•΄λ‹Ή κ°’ λ¶€λ¶„μ„ ν¨μΉν•μ—¬ μ°νν•λ„λ΅ ν•λ‹¤.
- sub_40070C  λ¶€λ¶„λ„ λ‘κ°™μ΄ NOPμΌλ΅ μ±„μ› μ°νν•λ„λ΅ ν•λ‹¤.

![./10.png](./10.png)

## sub_40072A ν•¨μ

![./11.png](./11.png)

- μ• μ΅°κ±΄μ„ λ§μΉκ³  ν•΄λ‹Ή ν•¨μλ΅ λ“¤μ–΄μ¤λ”λ° μ—¬κΈ°μ„λ” `"hello"` λ¬Έμμ—΄ κ³Ό μ…λ ¤ κ°’μ„ λΉ„κµν•μ—¬ λ™μΌν•  κ²½μ° μ •μƒμ μΌλ΅ λ°ν™ν•λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.
- `0x606038` μ£Όμ†κ°€ μ–΄λ””μΈμ§€ ν™•μΈν•μ€μΌλ‚ `__libc_start_main` got μμ—­μ μ£Όμ†  κ°’μΈ κ²ƒμ„ μ•μ•μΌλ©° ν•΄λ‹Ή λ¶€λ¶„μ—μ„ μ–΄λ–¤ λ¬Έμμ—΄μ„ κ°€μ Έμ™€ λΉ„κµν•λ”μ§€λ¥Ό λ¨λ¥΄κΈ° λ•λ¬Έμ— `Ghidra` λ””μ»΄νμΌμ„ ν†µν•΄ ν™•μΈν•μ—¬

![./12.png](./12.png)

- ν•΄λ‹Ή μ΅°κ±΄μ„ λ§μ°¬κ°€μ§€λ΅ `NOP` μΌλ΅ μ±„μ› μ°νν•λ„λ΅ ν•κ² λ‹¤.

![./13.png](./13.png)

- μ‹Ήλ”° μ±„μ› λ²„λ Έλ‹¤. π€

![./14.png](./14.png)

- ν¨μΉν›„ `fget` ν•¨μλ¥Ό λ°”νƒ•μΌλ΅ μ…λ ¥μ„ λ°›μ„ μ μλ„λ΅ λμ—λ‹¤.

## λ―ΈμΉ μ΅°κ±΄λ“¤

![./15.png](./15.png)

- λ¬΄μν λ§μ€ μ΅°κ±΄λ“¤μ„ κ±°μΉκ³  κ±°μ³ λ§μ§€λ§‰μ— "you typed : %s\n" μ¶λ ¥ν•λ” κ³³μΌλ΅ κ°€λ΄μ•Ό λ  κ²ƒ κ°™λ‹¤.

![./16.png](./16.png)

- angr λ¨λ“μ„ μ‚¬μ©ν•μ—¬ solve λ¥Ό μ‘μ„±ν•΄λ³΄κ² λ‹¤.

# ν•΄κ²° λ°©μ•
## Solved Code

```python
import angr

def solved():
    p=angr.Project('./angrybird_3', auto_load_libs=False)
		# stateλ¥Ό μ„μλ΅ μ„ ν•¨μλ¥Ό λ¬΄μ‹ν•μ±„ ν•΄λ‹Ή μ§€μ—­λ¶€ν„° μ‹μ‘ν•λ„λ΅ ν•λ‹¤.
    state = p.factory.blank_state(addr=0x4007C2)

    sm = p.factory.simgr(state)
    sm.explore(find=0x404fab) # μµν•λ‹¨ True μ£Όμ† κ°’

    flag = sm.found[0].posix.dumps(0)
    print(flag[:20])
```

## Solved Code2

- μ•μ—μ„ ν•΄λ‹Ή ν•¨μλ“¤μ„ ν¨μΉλ¥Ό μ§„ν–‰ν•μ€λ”λ° ν•΄λ‹Ή ν¨μΉλ¥Ό ν•μ§€ μ•κ³  angr λ¨λ“μ„ μ‚¬μ©ν•μ—¬ μ°νν•λ” λ°©μ•λ„ μ΅΄μ¬ν•λ‹¤.

![./17.png](./17.png)

- ν•΄λ‹Ή `sub_4006F6`, `sub_40070C` ν•¨μλ¥Ό λ¬΄μ‹ν•μ±„ `rbp` κΈ°μ¤€ κ°’μ„ ν„μ¬ `0x4007c2` μ£Όμ†λ΅ κΈ°μ¤€μ„ μ΅λ„λ΅ μμ •ν•λ„λ΅ ν•λ‹¤. μ¦‰, λ©”μΈ ν•¨μ ν”„λ΅¤λ΅κ·Έλ¥Ό ν•΄λ‹Ή μ£Όμ†λ΅ λ°”κΎΈλ” κ²ƒμ΄λ‹¤.

![./18.png](./18.png)

```python
import angr

START_ADDR = 0x4007c2
FIND_ADDR = 0x404fab  # This is right before the printf

def main():
    proj = angr.Project('./angrybird')

    # ν•΄λ‹Ή λ°”μ΄λ„λ¦¬μ—μ„ ν•¨μ λ¶€λ¶„μ„ μ°ν ν•λ‹¤.
    state = proj.factory.entry_state(addr=START_ADDR)
    # ν•¨μ ν”„λ΅¤λ΅κ·Έ λ³€κ²½
    state.regs.rbp = state.regs.rsp
    # 0x40μ κΈΈμ΄ κ°’
    state.mem[state.regs.rbp - 0x74].int = 0x40

    state.mem[state.regs.rbp - 0x70].long = 0x1000 # strncmp@got
    state.mem[state.regs.rbp - 0x68].long = 0x1008 # puts@got
    state.mem[state.regs.rbp - 0x60].long = 0x1010 # _stack_chk_fail@got
    state.mem[state.regs.rbp - 0x58].long = 0x1018 # _lib_start_main

    sm = proj.factory.simulation_manager(state)  # μ‹λ®¬λ μ΄μ… μƒμ„±
    sm.explore(find=FIND_ADDR)

    found = sm.found[-1]
    flag = found.posix.dumps(0)

    print(flag[:20])    

if __name__ == '__main__':
    main()
```

![./19.png](./19.png)

```toc
```